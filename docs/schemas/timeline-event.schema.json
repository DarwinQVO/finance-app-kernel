{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://personal-os.dev/schemas/timeline-event.schema.json",
  "title": "Timeline Event",
  "description": "Schema for timeline events used in timeline visualization (TimelineViewer component). Each event represents a change in the provenance ledger, rendered as a point on the timeline with metadata for visualization.",
  "type": "object",
  "required": [
    "event_id",
    "entity_id",
    "field_name",
    "transaction_time",
    "valid_time",
    "action",
    "value"
  ],
  "properties": {
    "event_id": {
      "type": "string",
      "description": "Unique identifier for this timeline event (usually same as provenance_id)",
      "examples": ["prov_abc123", "750e8400-e29b-41d4-a716-446655440000"]
    },
    "entity_id": {
      "type": "string",
      "description": "ID of the entity this event belongs to",
      "minLength": 1,
      "examples": ["txn_xyz789", "patient_456", "case_2025cv1234"]
    },
    "entity_type": {
      "type": "string",
      "description": "Type of entity (for filtering and grouping)",
      "enum": [
        "transaction",
        "patient_record",
        "case",
        "publication",
        "product",
        "subscription",
        "policy",
        "claim"
      ],
      "examples": ["transaction", "patient_record"]
    },
    "field_name": {
      "type": "string",
      "description": "Name of the field that changed",
      "pattern": "^[a-z_][a-z0-9_]*$",
      "examples": ["merchant", "diagnosis_code", "category"]
    },
    "transaction_time": {
      "type": "string",
      "format": "date-time",
      "description": "When we recorded this change (X-axis on timeline visualization)",
      "examples": ["2025-10-24T10:00:00Z", "2025-02-15T14:30:00Z"]
    },
    "valid_time": {
      "type": "string",
      "format": "date",
      "description": "When this change was true in the real world (Y-axis on bitemporal timeline)",
      "examples": ["2025-01-20", "2025-10-24"]
    },
    "action": {
      "type": "string",
      "description": "Type of change (determines color coding in UI)",
      "enum": [
        "extracted",
        "override",
        "revert",
        "delete",
        "rule_applied",
        "ai_suggested",
        "bulk_update"
      ],
      "examples": ["extracted", "override", "revert"]
    },
    "value": {
      "description": "New value after this change (displayed in tooltip/details)",
      "oneOf": [
        { "type": "string" },
        { "type": "number" },
        { "type": "boolean" },
        { "type": "object" },
        { "type": "array" },
        { "type": "null" }
      ],
      "examples": [
        "Amazon Marketplace",
        "E11.65",
        1234.56
      ]
    },
    "previous_value": {
      "description": "Value before this change (displayed in tooltip/diff view)",
      "oneOf": [
        { "type": "string" },
        { "type": "number" },
        { "type": "boolean" },
        { "type": "object" },
        { "type": "array" },
        { "type": "null" }
      ],
      "examples": [
        "AMZN MKTP US*AB123",
        "E11.9",
        123.45,
        null
      ]
    },
    "changed_by": {
      "type": "string",
      "description": "User ID or system identifier (displayed in tooltip)",
      "examples": ["user_123", "parser_pdf_v2", "normalization_rule"]
    },
    "reason": {
      "type": "string",
      "description": "Optional: Why the change was made (displayed in tooltip)",
      "maxLength": 1000,
      "examples": [
        "Retroactive correction from bank reconciliation",
        "Extracted from PDF page 3"
      ]
    },
    "source": {
      "type": "string",
      "description": "System or process that made the change",
      "examples": ["manual_correction", "parser_pdf_v2", "normalization_rule"]
    },
    "confidence": {
      "type": "number",
      "description": "Optional: Confidence score (0.0-1.0, affects visual styling)",
      "minimum": 0.0,
      "maximum": 1.0,
      "examples": [0.95, 0.85, 1.0]
    },
    "metadata": {
      "type": "object",
      "description": "Optional: Additional metadata for visualization customization",
      "properties": {
        "color": {
          "type": "string",
          "description": "Custom color for this event (hex, rgb, or CSS color name)",
          "examples": ["#FF5722", "rgb(255, 87, 34)", "red"]
        },
        "icon": {
          "type": "string",
          "description": "Icon identifier for this event (Material Icons, Font Awesome, etc.)",
          "examples": ["edit", "upload", "verified", "delete"]
        },
        "size": {
          "type": "string",
          "description": "Marker size for this event",
          "enum": ["small", "medium", "large"],
          "examples": ["medium", "large"]
        },
        "highlight": {
          "type": "boolean",
          "description": "Whether to highlight this event (e.g., for search results)"
        },
        "group": {
          "type": "string",
          "description": "Group identifier for grouping related events",
          "examples": ["bulk_correction_batch_001", "import_session_xyz"]
        }
      },
      "additionalProperties": true
    },
    "is_retroactive": {
      "type": "boolean",
      "description": "True if valid_time < transaction_time (retroactive correction)",
      "examples": [true, false]
    },
    "is_future": {
      "type": "boolean",
      "description": "True if valid_time > NOW (scheduled change)",
      "examples": [true, false]
    },
    "time_delta": {
      "type": "object",
      "description": "Optional: Time difference between transaction time and valid time (for visualization annotations)",
      "properties": {
        "days": { "type": "integer", "description": "Number of days difference" },
        "label": { "type": "string", "description": "Human-readable label", "examples": ["2 months retroactive", "15 days in future"] }
      }
    }
  },
  "additionalProperties": false,
  "examples": [
    {
      "$comment": "Example 1: Finance - Retroactive merchant correction",
      "event_id": "prov_001",
      "entity_id": "txn_xyz789",
      "entity_type": "transaction",
      "field_name": "merchant",
      "transaction_time": "2025-10-24T10:00:00Z",
      "valid_time": "2025-01-20",
      "action": "override",
      "value": "Amazon Marketplace",
      "previous_value": "AMZN MKTP US*AB123",
      "changed_by": "user_123",
      "reason": "Retroactive correction from bank reconciliation",
      "source": "manual_correction",
      "confidence": 1.0,
      "is_retroactive": true,
      "is_future": false,
      "time_delta": {
        "days": -277,
        "label": "9 months retroactive"
      },
      "metadata": {
        "color": "#FF9800",
        "icon": "edit",
        "size": "medium"
      }
    },
    {
      "$comment": "Example 2: Healthcare - Diagnosis code extraction",
      "event_id": "prov_002",
      "entity_id": "patient_456",
      "entity_type": "patient_record",
      "field_name": "diagnosis_code",
      "transaction_time": "2025-01-10T08:00:00Z",
      "valid_time": "2025-01-10",
      "action": "extracted",
      "value": "E11.9",
      "previous_value": null,
      "changed_by": "parser_ehr_v3",
      "reason": "Extracted from EHR system",
      "source": "parser_ehr_v3",
      "confidence": 0.92,
      "is_retroactive": false,
      "is_future": false,
      "time_delta": {
        "days": 0,
        "label": "current"
      },
      "metadata": {
        "color": "#2196F3",
        "icon": "upload",
        "size": "small"
      }
    },
    {
      "$comment": "Example 3: E-commerce - Future price increase (scheduled)",
      "event_id": "prov_003",
      "entity_id": "prod_42",
      "entity_type": "product",
      "field_name": "price",
      "transaction_time": "2025-10-20T09:00:00Z",
      "valid_time": "2025-11-01",
      "action": "override",
      "value": 29.99,
      "previous_value": 24.99,
      "changed_by": "catalog_manager_789",
      "reason": "Scheduled price increase for holiday season",
      "source": "manual_correction",
      "confidence": 1.0,
      "is_retroactive": false,
      "is_future": true,
      "time_delta": {
        "days": 12,
        "label": "12 days in future"
      },
      "metadata": {
        "color": "#9C27B0",
        "icon": "schedule",
        "size": "medium",
        "highlight": true
      }
    },
    {
      "$comment": "Example 4: Legal - Revert case number correction",
      "event_id": "prov_004",
      "entity_id": "case_2025cv1234",
      "entity_type": "case",
      "field_name": "case_number",
      "transaction_time": "2025-10-25T11:00:00Z",
      "valid_time": "2025-10-25",
      "action": "revert",
      "value": "2025-CV-1234",
      "previous_value": "2025-CV-12345",
      "changed_by": "legal_assistant_456",
      "reason": "Wrong correction - reverting to original",
      "source": "manual_correction",
      "confidence": 1.0,
      "is_retroactive": false,
      "is_future": false,
      "time_delta": {
        "days": 0,
        "label": "current"
      },
      "metadata": {
        "color": "#673AB7",
        "icon": "undo",
        "size": "medium"
      }
    },
    {
      "$comment": "Example 5: Bulk update event (part of batch)",
      "event_id": "prov_005",
      "entity_id": "prod_43",
      "entity_type": "product",
      "field_name": "category",
      "transaction_time": "2025-10-24T16:45:00Z",
      "valid_time": "2025-10-24",
      "action": "bulk_update",
      "value": "Home Appliances",
      "previous_value": "Electronics",
      "changed_by": "catalog_manager_789",
      "reason": "Supplier X catalog error - bulk recategorization",
      "source": "bulk_correction_tool",
      "confidence": 1.0,
      "is_retroactive": false,
      "is_future": false,
      "time_delta": {
        "days": 0,
        "label": "current"
      },
      "metadata": {
        "color": "#4CAF50",
        "icon": "group_work",
        "size": "small",
        "group": "bulk_correction_batch_001"
      }
    },
    {
      "$comment": "Example 6: Rule application (automated normalization)",
      "event_id": "prov_006",
      "entity_id": "txn_xyz790",
      "entity_type": "transaction",
      "field_name": "merchant",
      "transaction_time": "2025-02-20T10:30:00Z",
      "valid_time": "2025-01-20",
      "action": "rule_applied",
      "value": "Amazon",
      "previous_value": "AMZN MKTP US*CD456",
      "changed_by": "normalization_rule_merchant",
      "reason": "Applied normalization rule: merchant_amazon",
      "source": "normalization_engine",
      "confidence": 0.95,
      "is_retroactive": true,
      "is_future": false,
      "time_delta": {
        "days": -31,
        "label": "1 month retroactive"
      },
      "metadata": {
        "color": "#00BCD4",
        "icon": "auto_fix_high",
        "size": "small"
      }
    }
  ],
  "definitions": {
    "TimelineEventArray": {
      "type": "array",
      "description": "Array of timeline events, typically sorted by transaction_time",
      "items": {
        "$ref": "#"
      }
    },
    "TimelineVisualizationConfig": {
      "type": "object",
      "description": "Configuration for timeline visualization",
      "properties": {
        "color_scheme": {
          "type": "object",
          "description": "Color mapping for action types",
          "properties": {
            "extracted": { "type": "string", "examples": ["#2196F3"] },
            "override": { "type": "string", "examples": ["#FF9800"] },
            "revert": { "type": "string", "examples": ["#673AB7"] },
            "delete": { "type": "string", "examples": ["#F44336"] },
            "rule_applied": { "type": "string", "examples": ["#00BCD4"] },
            "ai_suggested": { "type": "string", "examples": ["#8BC34A"] },
            "bulk_update": { "type": "string", "examples": ["#4CAF50"] }
          }
        },
        "icon_mapping": {
          "type": "object",
          "description": "Icon mapping for action types",
          "properties": {
            "extracted": { "type": "string", "examples": ["upload"] },
            "override": { "type": "string", "examples": ["edit"] },
            "revert": { "type": "string", "examples": ["undo"] },
            "delete": { "type": "string", "examples": ["delete"] }
          }
        }
      }
    }
  },
  "notes": [
    "This schema is OUTPUT of TimelineReconstructor.reconstructTimeline() method.",
    "This schema is INPUT to TimelineViewer component (React).",
    "Events are typically sorted by transaction_time ASC for chronological timeline visualization.",
    "Color coding: Blue=extraction, Orange=manual override, Purple=revert, Red=delete, Cyan=rule, Green=AI/bulk.",
    "is_retroactive flag: true if valid_time < transaction_time (user made correction retroactively effective).",
    "is_future flag: true if valid_time > NOW (scheduled change effective in future).",
    "time_delta provides human-readable label for retroactive/future changes ('2 months retroactive', '15 days in future').",
    "metadata.highlight: Used to emphasize specific events (e.g., search results, filtered items).",
    "metadata.group: Groups related events (e.g., bulk corrections from same batch).",
    "For D3.js timeline: Use transaction_time as X-coordinate, valid_time as Y-coordinate (bitemporal view).",
    "For simple timeline: Use transaction_time as X-coordinate only (single timeline).",
    "For table view: Render as sortable/filterable table rows.",
    "Tooltips should show: field_name, value (old → new), changed_by, reason, timestamp.",
    "Event markers: Size based on confidence (small=low, large=high), color based on action type.",
    "Performance: Limit to 1,000 events per timeline (paginate or aggregate older events)."
  ]
}
