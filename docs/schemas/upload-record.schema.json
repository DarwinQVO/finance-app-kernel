{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/DarwinQVO/finance-app-kernel/schemas/upload-record.schema.json",
  "title": "UploadRecord",
  "description": "State machine orchestrator for upload pipeline. Tracks file from upload through parse/normalize stages.",
  "type": "object",
  "properties": {
    "upload_id": {
      "type": "string",
      "pattern": "^UL_[a-zA-Z0-9]+$",
      "description": "Canonical public identifier for this upload"
    },
    "status": {
      "type": "string",
      "enum": [
        "queued_for_parse",
        "parsing",
        "parsed",
        "normalizing",
        "normalized",
        "error"
      ],
      "description": "Current state in the pipeline. Only Coordinator can update this field."
    },
    "version": {
      "type": "integer",
      "minimum": 0,
      "default": 0,
      "description": "Optimistic locking version counter. Incremented on every status update. Used to prevent concurrent modification conflicts (see ADR-0002)."
    },
    "error_message": {
      "type": ["string", "null"],
      "description": "Human-readable error message if status=error, otherwise null"
    },
    "retry_count": {
      "type": "integer",
      "minimum": 0,
      "default": 0,
      "description": "Number of retry attempts for current error. Reset to 0 on successful completion. Used to prevent infinite retry loops (see ADR-0002)."
    },
    "last_retry_at": {
      "type": ["string", "null"],
      "format": "date-time",
      "pattern": ".*Z$",
      "description": "ISO 8601 timestamp (UTC) of last retry attempt. Null if never retried. Format: YYYY-MM-DDTHH:MM:SSZ"
    },
    "max_retries": {
      "type": "integer",
      "minimum": 1,
      "default": 3,
      "description": "Maximum number of retry attempts before marking as permanent failure. Configurable per upload."
    },
    "upload_log_ref": {
      "type": "string",
      "pattern": "^/logs/uploads/UL_[a-zA-Z0-9]+\\.log$",
      "description": "Path to upload log file"
    },
    "parse_log_ref": {
      "type": "string",
      "pattern": "^/logs/parse/UL_[a-zA-Z0-9]+\\.log\\.json$",
      "description": "Path to parse log file. Present only if status ∈ {parsing, parsed, normalizing, normalized, error}"
    },
    "observations_count": {
      "type": "integer",
      "minimum": 0,
      "description": "Number of ObservationTransactions extracted. Present only if status ∈ {parsed, normalizing, normalized, error}"
    },
    "normalizer_log_ref": {
      "type": "string",
      "pattern": "^/logs/normalize/UL_[a-zA-Z0-9]+\\.log\\.json$",
      "description": "Path to normalizer log file. Present only if status ∈ {normalizing, normalized, error}"
    },
    "canonicals_count": {
      "type": "integer",
      "minimum": 0,
      "description": "Number of CanonicalTransactions created. Present only if status = normalized"
    }
  },
  "required": ["upload_id", "status", "version", "retry_count", "max_retries", "upload_log_ref"],
  "additionalProperties": false,
  "examples": [
    {
      "upload_id": "UL_abc123",
      "status": "queued_for_parse",
      "version": 0,
      "error_message": null,
      "retry_count": 0,
      "last_retry_at": null,
      "max_retries": 3,
      "upload_log_ref": "/logs/uploads/UL_abc123.log"
    },
    {
      "upload_id": "UL_xyz789",
      "status": "normalized",
      "version": 4,
      "error_message": null,
      "retry_count": 0,
      "last_retry_at": null,
      "max_retries": 3,
      "upload_log_ref": "/logs/uploads/UL_xyz789.log",
      "parse_log_ref": "/logs/parse/UL_xyz789.log.json",
      "observations_count": 42,
      "normalizer_log_ref": "/logs/normalize/UL_xyz789.log.json",
      "canonicals_count": 42
    },
    {
      "upload_id": "UL_err001",
      "status": "error",
      "version": 2,
      "error_message": "PDF_CORRUPT: Unable to extract text from pages 3-5",
      "retry_count": 2,
      "last_retry_at": "2025-10-22T14:45:00Z",
      "max_retries": 3,
      "upload_log_ref": "/logs/uploads/UL_err001.log",
      "parse_log_ref": "/logs/parse/UL_err001.log.json"
    }
  ]
}
