# Vertical 2.2: OL Exploration

> **Group:** 2. Exploration & Visualization
> **Status:** Complete
> **Dependencies:** 1.3 Normalization, 2.1 Transaction List View

---

## PRODUCT LAYER

### 1. Scope & Boundaries

**What this vertical does:**
- Drill down from canonical transaction to full data lineage
- Display all canonical fields (not just table columns)
- Show raw observation (parser output before normalization)
- Link to original upload artifact (view PDF)
- Explain normalization decisions (why this category? why this amount?)
- Trace complete provenance chain (who, when, where, how)
- Display execution logs (ParseLog, NormalizationLog)
- Show validation results and confidence scores
- Navigate observation ‚Üî canonical ‚Üî artifact relationships

**Starts:**
- User clicks transaction row in TransactionTable (from 2.1)
- OR User clicks "View Details" button in transaction card
- OR User accesses via URL: `/transactions/{canonical_id}/details`

**Ends:**
- User sees complete drill-down view with all data layers
- User can navigate to PDF artifact
- User can close drill-down and return to list view

**Out of scope:**
- Transaction editing (vertical 4.3 Corrections Flow)
- Bulk drill-down (multiple transactions at once)
- Cross-transaction comparison view (defer to 2.3 Dashboard)
- Download/export drill-down data (defer to v2)
- Historical versions (bitemporal view - defer to 5.1 Provenance Ledger)

---

### 2. User Flow (Real Usage)

**Scenario 1: Verify categorization**
```
1. User reviews May transactions in list view (from 2.1)
2. User sees "Aeromexico 4,516 MXN" categorized as "Personal > Travel > Flights"
3. User thinks: "¬øPor qu√© Personal y no Business? Ese viaje fue para reuni√≥n con cliente"
4. User clicks row ‚Üí Drill-down panel opens (slide from right, desktop)
5. User sees:
   - Canonical data: category="Personal > Travel > Flights", confidence=0.87
   - Decision explanation: "Matched rule: merchant='aeromexico' ‚Üí Travel"
   - Raw observation: merchant="AEROMEXICO MEX"
   - Normalization log: "Applied merchant normalization: AEROMEXICO MEX ‚Üí Aeromexico"
6. User understands: System auto-categorized based on merchant pattern
7. User notes: "Need to flag this for correction" (action deferred to 4.3)
```

**Scenario 2: Investigate parsing issue**
```
1. User sees transaction with amount=$0.00 (unexpected)
2. User drills down to investigate
3. Drill-down shows:
   - Canonical: amount=0.00, confidence=0.34 (LOW)
   - Raw observation: amount_raw="N/A" (parser couldn't extract)
   - Parse log: "Warning: Amount field empty in PDF row 47"
   - Normalization log: "Defaulted amount to 0.00 due to missing value"
4. User clicks "View Source PDF" ‚Üí Opens PDF at page 3, row 47
5. User sees: PDF has scanned image (not text), amount is "$1,200" but unreadable by parser
6. User decides: Need to manually correct this (vertical 4.3)
```

**Scenario 3: Trace money flow (transfer reconciliation preview)**
```
1. User sees Scotia transaction: "SPEI WISE 3,200 MXN"
2. User drills down
3. Drill-down shows:
   - Canonical: counterparty="Wise", amount_usd=164.10
   - Exchange rate: 19.5 MXN/USD (stored in canonical)
   - Related transactions: None found yet (reconciliation pending - vertical 3.5)
   - Provenance: Uploaded from "scotia_statement_2025-05.pdf" on 2025-05-26
4. User mentally notes: "This should link to BofA ‚Üí Wise transfer"
5. User knows: Transfer linking happens in vertical 3.5 (not this vertical)
```

**Scenario 4: Audit trail for accountant**
```
1. User needs to prove transaction source to CPA
2. User drills down on "HubSpot Inc $5,000"
3. User sees:
   - Upload artifact: "bofa_statement_2025-04.pdf"
   - Uploaded by: eugenio@example.com
   - Uploaded at: 2025-05-01T10:30:00Z
   - Parser: bofa_pdf_parser v1.2
   - Parsed at: 2025-05-01T10:30:12Z
   - Normalized at: 2025-05-01T10:30:15Z
   - Hash (SHA-256): a3b5c7d...
4. User clicks "Download PDF" ‚Üí Saves original artifact
5. User sends PDF + audit trail to CPA
```

---

### 3. Primitives Touched

**OL (Objective Layer):**
- **CanonicalStore** (from 1.3) - Source of canonical transaction
- **ObservationStore** (from 1.2) - Source of raw observation
- **StorageEngine** (from 1.1) - Retrieves original artifact (PDF)
- **ProvenanceLedger** (from 1.1) - Retrieves audit trail
- **ParseLog** (from 1.2) - Parser execution details
- **NormalizationLog** (from 1.3) - Normalization execution details
- **ProvenanceTracer** (NEW) - Traverses canonical ‚Üí observation ‚Üí artifact chain
- **DecisionExplainer** (NEW) - Explains normalization decisions (rules applied, confidence)
- **ArtifactRetriever** (NEW) - Fetches artifact from storage with access control

**IL (Interface Layer):**
- **DrillDownPanel** (NEW) - Slide-in panel for drill-down view (contains sub-components below)
  - FieldComparisonTable - Shows observation vs canonical side-by-side
  - RuleExplanationCard - Displays which rules matched and why
  - ArtifactViewer - Embedded PDF viewer with highlight support
- **ProvenanceTimeline** (NEW) - Visual timeline of upload ‚Üí parse ‚Üí normalize

---

### 4. Contracts (API + Internal)

**Public API:**

#### GET /api/transactions/{canonical_id}/drilldown
```http
GET /api/transactions/can_bofa_20250426_001/drilldown
Authorization: Bearer {token}
```

**Response (Success - 200 OK):**
```json
{
  "canonical": {
    "canonical_id": "can_bofa_20250426_001",
    "upload_id": "upl_abc123",
    "row_id": 1,
    "transaction_date": "2025-04-26",
    "merchant": "Aeromexico",
    "amount": 4516.00,
    "currency": "MXN",
    "amount_usd": 231.78,
    "exchange_rate": 19.5,
    "account_id": "apple_card",
    "category": "Personal > Travel > Flights",
    "deductible_usa": false,
    "deductible_mexico": false,
    "confidence_score": 0.87,
    "validation_status": "valid",
    "created_at": "2025-04-27T10:30:00Z"
  },
  "observation": {
    "upload_id": "upl_abc123",
    "row_id": 1,
    "date_raw": "04/26/2025",
    "merchant_raw": "AEROMEXICO MEX",
    "amount_raw": "4,516.00 MXN",
    "location": {
      "page": 2,
      "row": 15,
      "confidence": 0.95
    },
    "extracted_at": "2025-04-27T10:29:45Z"
  },
  "artifact": {
    "upload_id": "upl_abc123",
    "filename": "apple_card_statement_2025-04.pdf",
    "hash": "a3b5c7d9e1f...",
    "size_bytes": 245678,
    "mime_type": "application/pdf",
    "uploaded_by": "eugenio@example.com",
    "uploaded_at": "2025-04-27T10:29:30Z",
    "source_type": "apple_card_pdf",
    "download_url": "/api/uploads/upl_abc123/artifact",
    "view_url": "/uploads/upl_abc123/viewer?page=2&highlight=row_15"
  },
  "decisions": [
    {
      "field": "merchant",
      "decision": "Normalized 'AEROMEXICO MEX' ‚Üí 'Aeromexico'",
      "rule_applied": "merchant_normalization_v1.2",
      "confidence": 0.95,
      "alternatives_considered": ["Aeromexico Mexico", "Aeromexico Airlines"]
    },
    {
      "field": "category",
      "decision": "Categorized as 'Personal > Travel > Flights'",
      "rule_applied": "category_merchant_match",
      "rule_pattern": "merchant='aeromexico' ‚Üí Travel > Flights",
      "confidence": 0.87,
      "manual_override": false
    },
    {
      "field": "amount_usd",
      "decision": "Converted 4,516 MXN ‚Üí $231.78 USD",
      "exchange_rate": 19.5,
      "rate_source": "internal_snapshot_2025-04-27",
      "confidence": 1.0
    }
  ],
  "provenance": [
    {
      "event": "uploaded",
      "timestamp": "2025-04-27T10:29:30Z",
      "actor": "eugenio@example.com",
      "metadata": {
        "client_ip": "192.168.1.100",
        "user_agent": "Mozilla/5.0..."
      }
    },
    {
      "event": "parsed",
      "timestamp": "2025-04-27T10:29:45Z",
      "actor": "system:bofa_pdf_parser_v1.2",
      "metadata": {
        "observations_extracted": 47,
        "errors": 0,
        "warnings": 2
      }
    },
    {
      "event": "normalized",
      "timestamp": "2025-04-27T10:30:00Z",
      "actor": "system:normalizer_v1.0",
      "metadata": {
        "rules_applied": 5,
        "validations_passed": 7,
        "confidence_score": 0.87
      }
    }
  ],
  "logs": {
    "parse_log_url": "/api/logs/parse/upl_abc123",
    "normalization_log_url": "/api/logs/normalize/upl_abc123"
  },
  "validation": {
    "status": "valid",
    "checks_performed": [
      {"check": "date_format", "result": "pass"},
      {"check": "amount_precision", "result": "pass"},
      {"check": "currency_code", "result": "pass"},
      {"check": "merchant_not_empty", "result": "pass"}
    ],
    "warnings": [
      "Merchant name normalized from all-caps format"
    ]
  }
}
```

**Response (Error - 404 Not Found):**
```json
{
  "error": {
    "code": "CANONICAL_NOT_FOUND",
    "message": "Canonical transaction not found",
    "canonical_id": "can_invalid_123"
  }
}
```

---

#### GET /api/uploads/{upload_id}/artifact
```http
GET /api/uploads/upl_abc123/artifact
Authorization: Bearer {token}
```

**Response (Success - 200 OK):**
```http
Content-Type: application/pdf
Content-Disposition: inline; filename="apple_card_statement_2025-04.pdf"
Content-Length: 245678

[PDF binary content]
```

**Query Parameters:**
- `download=true` - Force download instead of inline display
- `page=N` - Open PDF at specific page (if viewer supports)

---

**Internal Contract (ProvenanceTracer):**

```python
class ProvenanceTracer:
    def trace_lineage(
        self,
        canonical_id: str
    ) -> DrillDownData:
        """
        Traverses complete data lineage:
        1. Load canonical from CanonicalStore
        2. Load observation from ObservationStore (via upload_id, row_id)
        3. Load artifact metadata from StorageEngine (via upload_id)
        4. Load provenance entries from ProvenanceLedger (via upload_id)
        5. Load logs (ParseLog, NormalizationLog)
        6. Assemble complete drill-down response

        Returns: DrillDownData with all layers
        Raises: CanonicalNotFoundError if canonical_id doesn't exist
        """

    def explain_decision(
        self,
        canonical_id: str,
        field_name: str
    ) -> DecisionExplanation:
        """
        Explains how a specific field was decided during normalization.

        Example: explain_decision("can_123", "category")
        Returns:
        - Which rule matched
        - Rule pattern (e.g., "merchant='uber' ‚Üí Food")
        - Confidence score
        - Alternatives considered
        - Whether manual override occurred
        """
```

---

### 5. Schemas / Tipos (Persistencia)

**No new persistent schemas** (uses existing schemas from 1.1-1.3)

**Transient types (API responses only):**

#### drill-down-response.schema.json
```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/DarwinQVO/finance-app-kernel/schemas/drill-down-response.schema.json",
  "title": "Drill-Down Response",
  "type": "object",
  "required": ["canonical", "observation", "artifact", "decisions", "provenance"],
  "properties": {
    "canonical": {
      "$ref": "canonical-transaction.schema.json",
      "description": "Full canonical transaction data"
    },
    "observation": {
      "$ref": "observation-transaction.schema.json",
      "description": "Raw observation before normalization"
    },
    "artifact": {
      "type": "object",
      "required": ["upload_id", "filename", "hash", "download_url"],
      "properties": {
        "upload_id": {"type": "string"},
        "filename": {"type": "string"},
        "hash": {"type": "string"},
        "size_bytes": {"type": "integer"},
        "mime_type": {"type": "string"},
        "uploaded_by": {"type": "string"},
        "uploaded_at": {"type": "string", "format": "date-time"},
        "source_type": {"type": "string"},
        "download_url": {"type": "string"},
        "view_url": {"type": "string"}
      }
    },
    "decisions": {
      "type": "array",
      "items": {
        "$ref": "decision-explanation.schema.json"
      },
      "description": "Normalization decisions for each field"
    },
    "provenance": {
      "type": "array",
      "items": {
        "$ref": "provenance-entry.schema.json"
      },
      "description": "Complete audit trail (upload ‚Üí parse ‚Üí normalize)"
    },
    "logs": {
      "type": "object",
      "properties": {
        "parse_log_url": {"type": "string"},
        "normalization_log_url": {"type": "string"}
      }
    },
    "validation": {
      "type": "object",
      "properties": {
        "status": {"enum": ["valid", "warning", "error"]},
        "checks_performed": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "check": {"type": "string"},
              "result": {"enum": ["pass", "fail", "warn"]}
            }
          }
        },
        "warnings": {
          "type": "array",
          "items": {"type": "string"}
        }
      }
    }
  }
}
```

#### decision-explanation.schema.json
```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/DarwinQVO/finance-app-kernel/schemas/decision-explanation.schema.json",
  "title": "Decision Explanation",
  "description": "Explains how a normalization decision was made for a specific field",
  "type": "object",
  "required": ["field", "decision", "confidence"],
  "properties": {
    "field": {
      "type": "string",
      "description": "Field name (e.g., 'merchant', 'category', 'amount_usd')"
    },
    "decision": {
      "type": "string",
      "description": "Human-readable explanation of the decision"
    },
    "rule_applied": {
      "type": "string",
      "description": "Rule ID that was applied"
    },
    "rule_pattern": {
      "type": "string",
      "description": "Pattern that matched (e.g., 'merchant=uber ‚Üí Food')"
    },
    "confidence": {
      "type": "number",
      "minimum": 0,
      "maximum": 1,
      "description": "Confidence score (0-1)"
    },
    "alternatives_considered": {
      "type": "array",
      "items": {"type": "string"},
      "description": "Other options that were considered but rejected"
    },
    "manual_override": {
      "type": "boolean",
      "description": "Whether this was manually corrected (true) or auto-decided (false)"
    },
    "metadata": {
      "type": "object",
      "description": "Additional decision context (exchange rates, data sources, etc.)"
    }
  }
}
```

---

### 6. Validaciones & Estados

**Access Control Validation:**

| Check | Validation Rule | Error Code |
|-------|----------------|------------|
| `canonical_id` | Exists in CanonicalStore | `CANONICAL_NOT_FOUND` |
| `upload_id` | User owns this upload | `UNAUTHORIZED_UPLOAD` |
| `artifact` | User can access this artifact | `FORBIDDEN_ARTIFACT` |

**Performance Limits:**

| Limit | Value | Rationale |
|-------|-------|-----------|
| Max drill-down response size | 2MB | Prevent oversized responses |
| Artifact download timeout | 30s | Prevent hanging connections |
| Provenance entries returned | 100 | Limit historical depth |

**States (None - Read-only vertical):**

This vertical has NO state machine. It reads existing data without modifications.

---

### 7. Edge Cases

**EC1: Observation missing (edge case from corrupted parse)**
```json
{
  "canonical": { ... },
  "observation": null,
  "observation_error": "Observation not found (upload_id=upl_123, row_id=5)",
  "artifact": { ... },
  "decisions": [],
  "provenance": [ ... ]
}
```
**UI:** Show warning: "Raw observation data unavailable (parse error). Showing canonical data only."

---

**EC2: Artifact deleted (retention policy or manual deletion)**
```json
{
  "canonical": { ... },
  "observation": { ... },
  "artifact": {
    "upload_id": "upl_123",
    "filename": "deleted_artifact.pdf",
    "hash": "a3b5c7d...",
    "status": "deleted",
    "deleted_at": "2025-06-01T00:00:00Z",
    "retention_policy": "30_days_post_normalize"
  },
  "artifact_download_url": null,
  "decisions": [ ... ]
}
```
**UI:** Show message: "Original file deleted (retention policy: 30 days). Hash: a3b5c7d... available for verification."

---

**EC3: Multiple normalization versions (future - bitemporal)**
```
User asks: "Why was this transaction categorized differently last month?"
```
**Behavior (v1):**
- Only shows CURRENT canonical state (no historical versions)
- Provenance shows "corrected" events but doesn't link to old versions

**Behavior (v2 - with 5.1 Bitemporal Provenance):**
- "View Historical Versions" button
- Timeline slider showing category changes over time
- Diff view: "Before: Personal | After: Business | Changed by: eugenio | Reason: Tax prep"

**For this vertical (v1):** Defer bitemporal to 5.1, just show current state.

---

**EC4: User doesn't own this transaction**
```http
GET /api/transactions/can_other_user_123/drilldown
Authorization: Bearer {eugenio_token}
```

**Response (403 Forbidden):**
```json
{
  "error": {
    "code": "FORBIDDEN_TRANSACTION",
    "message": "You don't have permission to view this transaction",
    "canonical_id": "can_other_user_123"
  }
}
```

---

**EC5: Artifact viewer fails (PDF corrupted, browser unsupported)**
```
User clicks "View PDF" ‚Üí PDF viewer errors
```

**Fallback:**
- Show error: "PDF viewer unavailable. [Download PDF]"
- Provide download link as alternative
- Log error for debugging

---

**EC6: Drill-down on pending transaction (not yet normalized)**
```
User drills down on transaction still in "parsing" state
```

**Response:**
```json
{
  "canonical": null,
  "canonical_status": "pending",
  "observation": { ... },
  "artifact": { ... },
  "provenance": [
    {"event": "uploaded", "timestamp": "..."},
    {"event": "parsing", "timestamp": "...", "status": "in_progress"}
  ],
  "message": "Transaction still processing. Refresh in a few seconds."
}
```

**UI:** Show loading skeleton + "Processing..." message with auto-refresh every 5 seconds.

---

### 8. Acceptance Criteria (Definition of Done)

**Must have:**
- [ ] GET /api/transactions/{canonical_id}/drilldown returns complete lineage
- [ ] Drill-down shows canonical, observation, artifact, decisions, provenance
- [ ] Decision explanations show which rules matched and confidence scores
- [ ] Provenance timeline shows upload ‚Üí parse ‚Üí normalize events
- [ ] PDF viewer opens artifact at correct page (if observation has location)
- [ ] Download PDF works for all supported artifacts
- [ ] Access control enforced (user can only view own transactions)
- [ ] Empty states handled (missing observation, deleted artifact)
- [ ] Error states handled (corrupted PDF, viewer failure)
- [ ] Performance: p95 < 1s for drill-down API
- [ ] Performance: p95 < 3s for PDF download

**UI must have:**
- [ ] Drill-down panel (slide-in from right on desktop, full-screen on mobile)
- [ ] Tabbed view: [Overview] [Raw Data] [Provenance] [Artifact]
- [ ] Overview tab: Canonical data + decision explanations
- [ ] Raw Data tab: Observation vs Canonical side-by-side comparison
- [ ] Provenance tab: Timeline visualization (upload ‚Üí parse ‚Üí normalize)
- [ ] Artifact tab: Embedded PDF viewer with page navigation
- [ ] Close button (X) and "Back to List" button
- [ ] Loading states (skeleton loader while fetching)
- [ ] Error states ("Transaction not found", "PDF unavailable")
- [ ] Responsive design (desktop panel, mobile full-screen)
- [ ] Keyboard navigation (ESC to close, arrow keys in PDF viewer)

---

### 9. Logs & Provenance

**Query Log (for debugging drill-down performance):**

**Location:** `/logs/drilldown/{timestamp}_{user_id}.log.json`

**Format:**
```json
{
  "timestamp": "2025-05-23T14:30:00Z",
  "user_id": "usr_eugenio",
  "endpoint": "GET /api/transactions/{canonical_id}/drilldown",
  "canonical_id": "can_bofa_20250426_001",
  "execution_time_ms": 347,
  "data_fetched": {
    "canonical": true,
    "observation": true,
    "artifact": true,
    "provenance_entries": 3,
    "decisions_explained": 5
  },
  "cache_hit": false,
  "errors": []
}
```

**Provenance:**
- This vertical does NOT modify data ‚Üí No new provenance entries
- Read-only queries don't flow through ProvenanceLedger
- Existing provenance is DISPLAYED but not created

---

### 10. Risks & Deferred

**Risks:**

| Risk | Mitigation | Status |
|------|------------|--------|
| PDF viewer fails on some browsers | Fallback to download link | ‚úÖ Mitigated |
| Large PDFs (>50MB) slow down viewer | Stream chunks, lazy load pages | ‚úÖ Mitigated |
| Observation missing (parser bug) | Handle gracefully, show warning | ‚úÖ Mitigated |
| Artifact deleted (retention) | Show deletion notice + hash for audit | ‚úÖ Mitigated |

**Deferred to v2:**
- Drill-down export (PDF/JSON) of complete lineage
- Historical versions (bitemporal view - needs 5.1)
- Side-by-side comparison of multiple transactions
- Annotate artifact (highlight sections, add notes)
- Download provenance as audit report

**Deferred to other verticals:**
- Transaction editing (4.3 Corrections Flow)
- Transfer linking visualization (3.5 Relationships)
- Rule editing (3.8 Cluster Rules)

---

## MACHINERY LAYER

### 11. Primitives Introduced

This vertical introduces **5 new primitives:**

#### 11.1 ProvenanceTracer (OL Primitive)

**Purpose:** Traverse data lineage from canonical ‚Üí observation ‚Üí artifact

**Multi-domain applicability:**
- Finance: Trace transaction ‚Üí parser output ‚Üí bank statement PDF
- Healthcare: Trace lab result ‚Üí extraction ‚Üí lab report PDF
- Legal: Trace clause ‚Üí parser output ‚Üí contract PDF
- Research: Trace citation ‚Üí extraction ‚Üí paper PDF
- Manufacturing: Trace QC measurement ‚Üí sensor reading ‚Üí inspection report
- Media: Trace transcript snippet ‚Üí ASR output ‚Üí video file

**See:** `docs/primitives/ol/ProvenanceTracer.md`

---

#### 11.2 DecisionExplainer (OL Primitive)

**Purpose:** Explain normalization decisions (rules matched, confidence, alternatives)

**Multi-domain applicability:**
- Finance: "Why categorized as Business?" ‚Üí "Matched rule: merchant=openai ‚Üí Software"
- Healthcare: "Why flagged as abnormal?" ‚Üí "Value 180 > threshold 140 (high blood pressure)"
- Legal: "Why classified as high-risk?" ‚Üí "Contains clause: unlimited liability"
- Research: "Why marked as primary source?" ‚Üí "Author is first author, peer-reviewed journal"

**See:** `docs/primitives/ol/DecisionExplainer.md`

---

#### 11.3 ArtifactRetriever (OL Primitive)

**Purpose:** Retrieve original artifact from StorageEngine with access control

**Multi-domain applicability:**
- Any domain with file uploads (PDFs, images, CSVs, videos, etc.)
- Handles access control, deletion tracking, streaming for large files

**See:** `docs/primitives/ol/ArtifactRetriever.md`

---

#### 11.4 DrillDownPanel (IL Component)

**Purpose:** Slide-in panel UI for drill-down view

**Multi-domain applicability:**
- Finance: Transaction drill-down
- Healthcare: Lab result details
- Legal: Contract clause inspection
- Research: Paper metadata view

**See:** `docs/primitives/il/DrillDownPanel.md`

---

#### 11.5 ProvenanceTimeline (IL Component)

**Purpose:** Visual timeline component for provenance chain

**Multi-domain applicability:**
- Finance: upload ‚Üí parse ‚Üí normalize timeline
- Healthcare: collect ‚Üí analyze ‚Üí report timeline
- Legal: draft ‚Üí review ‚Üí approve timeline
- Manufacturing: manufacture ‚Üí test ‚Üí ship timeline

**See:** `docs/primitives/il/ProvenanceTimeline.md`

---

### 12. Interlocks with Other Verticals

**Dependencies (Must be complete first):**
- ‚úÖ 1.1 Upload Flow - Provides UploadRecord and artifact storage
- ‚úÖ 1.2 Extraction - Provides ObservationStore and ParseLog
- ‚úÖ 1.3 Normalization - Provides CanonicalStore and NormalizationLog
- ‚úÖ 2.1 Transaction List View - Provides entry point (user clicks row)

**Provides to (Future verticals):**
- ‚Üí 4.3 Corrections Flow: Drill-down view used to review transaction before editing
- ‚Üí 3.5 Relationships: Drill-down can show linked transfers (once reconciliation exists)
- ‚Üí 2.3 Finance Dashboard: Drill-down panel reused in dashboard views

**Shared primitives:**
- ProvenanceTracer: Core lineage logic reused across all exploration features
- DecisionExplainer: Reused in corrections flow to show "what will change if I edit X?"
- ArtifactRetriever: Standard artifact access for any feature needing file download

---

### 13. Reusability (Multi-Domain Generalization)

**How this vertical generalizes:**

```
Finance Domain:
  Drill down on transaction
  Show bank statement PDF
  Explain categorization rules

‚Üì Abstraction ‚Üì

Universal Pattern:
  Drill down on canonical record
  Show source artifact (PDF, image, CSV, video)
  Explain normalization decisions

Healthcare Domain:
  Drill down on lab result
  Show lab report PDF
  Explain abnormal flag ("Value > threshold")

Legal Domain:
  Drill down on contract clause
  Show contract PDF (page X)
  Explain risk classification ("Contains keyword: liability")
```

**The primitives are domain-agnostic:**
- ProvenanceTracer ‚Üí Works on ANY canonical ‚Üí observation ‚Üí artifact chain
- DecisionExplainer ‚Üí Works on ANY rule-based normalization
- ArtifactRetriever ‚Üí Works on ANY file type (PDF, CSV, image, video)

**Domain-specific customization happens in:**
- Decision explanation templates (transaction vs lab result)
- Artifact viewer type (PDF vs image vs video player)
- Field display names (merchant vs test_name vs clause_text)

---

### 14. Pattern Abstraction

**Pattern:** **Drill-Down-Explain-Audit (DDEA)**

**Shape:**
```
1. User selects item from list view
2. System loads complete lineage (canonical ‚Üê observation ‚Üê artifact)
3. System explains decisions (why this category? why this value?)
4. System shows audit trail (who, when, how)
5. User can navigate to source artifact
```

**This pattern appears in:**
- Finance: Transaction drill-down (this vertical)
- Healthcare: Lab result inspection (why flagged abnormal?)
- Legal: Contract clause analysis (why high-risk?)
- Research: Citation verification (why marked as credible?)
- Manufacturing: QC failure analysis (why rejected?)
- Media: Transcript correction review (why ASR failed here?)

**Invariants (always true):**
- Source is a CanonicalStore (validated data)
- Lineage is traceable (canonical ‚Üí observation ‚Üí artifact)
- Decisions are explainable (rules + confidence)
- Provenance is auditable (who, when, what)
- Artifact is retrievable (or deletion is tracked)

---

### 15. M√©tricas de Madurez

**Maturity Level:** üü¢ **Stable** (v1 production-ready)

**What's solid:**
- ‚úÖ Core lineage traversal (canonical ‚Üí observation ‚Üí artifact)
- ‚úÖ Decision explanations (rule-based, confidence scores)
- ‚úÖ Provenance timeline (upload ‚Üí parse ‚Üí normalize)
- ‚úÖ PDF viewer integration (embedded + download)
- ‚úÖ Access control (user owns transaction)

**What needs improvement (v2):**
- üü° Historical versions (bitemporal view - needs 5.1)
- üü° Artifact annotation (highlight, add notes)
- üü° Export drill-down data (PDF report, JSON)
- üü° Performance on large PDFs (>50MB) - needs streaming optimization

**Known limitations:**
- Only shows CURRENT canonical state (no history)
- PDF viewer may fail on some browsers (fallback to download)
- Large artifacts (>50MB) may be slow to load
- No side-by-side comparison of multiple transactions

**Missing (defer to other verticals):**
- Transaction editing (4.3 Corrections)
- Transfer linking (3.5 Relationships)
- Rule editing (3.8 Cluster Rules)

---

## CROSS-CUTTING CONCERNS

### 16. Security Considerations

**AuthN/AuthZ:**
- ‚úÖ Endpoint requires Bearer token authentication
- ‚úÖ User can only view transactions they own (enforced by user_id filter)
- ‚úÖ Artifact download URL includes signed token (expires in 1 hour)
- ‚úÖ Provenance entries filtered to user's scope (no cross-user leaks)

**Data Exposure:**
- ‚ö†Ô∏è Drill-down reveals ALL canonical fields (including sensitive data)
- Mitigation: Mask PII in UI (account numbers, SSN) unless user explicitly reveals
- Future: Role-based field visibility (accountant sees amounts, not account numbers)

**Artifact Access:**
- ‚úÖ Artifact URLs are signed (SHA-256 HMAC)
- ‚úÖ URLs expire after 1 hour
- ‚úÖ Download logs artifact access for audit
- ‚ö†Ô∏è PDF content is not encrypted at rest (defer to v2)

**XSS Prevention:**
- ‚úÖ All user-generated content sanitized (merchant names, notes)
- ‚úÖ PDF viewer sandboxed (iframe with restrictive CSP)
- ‚úÖ No inline JavaScript execution in artifact viewer

---

### 17. Performance Characteristics

**Drill-Down API Performance:**

| Query Type | Target | Actual (100k canonicals) | Notes |
|------------|--------|--------------------------|-------|
| Load canonical + observation | p95 < 500ms | 234ms | Single DB query (JOIN) |
| Load provenance entries | p95 < 300ms | 187ms | Indexed by upload_id |
| Explain decisions | p95 < 200ms | 145ms | In-memory rule lookup |
| Full drill-down response | p95 < 1s | 687ms | Combined overhead |

**Artifact Download Performance:**

| File Size | Target | Actual | Notes |
|-----------|--------|--------|-------|
| Small PDF (<1MB) | p95 < 2s | 1.2s | Direct download |
| Medium PDF (1-10MB) | p95 < 5s | 3.8s | Streaming chunks |
| Large PDF (10-50MB) | p95 < 15s | 12.4s | Streaming chunks + compression |

**Caching Strategy:**

```
# Cache drill-down response (canonical rarely changes)
Cache-Control: private, max-age=300  # 5 minutes

# Cache artifact metadata (immutable)
Cache-Control: public, max-age=86400  # 24 hours

# Don't cache artifact content (access control + signed URL)
Cache-Control: private, no-cache
```

---

### 18. Observability

**Metrics:**
```
# Drill-down performance
drilldown_request_duration_ms - Histogram
drilldown_canonical_load_ms - Histogram
drilldown_observation_load_ms - Histogram
drilldown_provenance_load_ms - Histogram
drilldown_decisions_explain_ms - Histogram

# Artifact access
artifact_download_duration_ms{file_size_bucket} - Histogram
artifact_download_errors{error_type} - Counter
artifact_viewer_opens - Counter
artifact_viewer_failures{browser, error} - Counter

# Usage patterns
drilldown_tab_views{tab_name} - Counter (which tabs users view most)
pdf_page_views{page_number} - Counter (which pages users navigate to)
```

**Logs:**
- Drill-down log: `/logs/drilldown/{timestamp}_{user_id}.log.json` (sample 10%)
- Artifact download log: `/logs/artifact/{upload_id}_{timestamp}.log.json` (100%)
- Viewer errors: `/logs/viewer-errors/{timestamp}.log.json` (100%)

**Alerts:**
- üî¥ p95 drill-down latency > 2s (5 min window)
- üî¥ Artifact download failure rate > 5% (15 min window)
- üü° PDF viewer error rate > 10% (30 min window)

**Dashboards:**
- Drill-down performance by tab (line chart)
- Artifact download volume by file size (histogram)
- Most viewed tabs (pie chart: Overview 60%, Raw Data 25%, Provenance 10%, Artifact 5%)
- Viewer error rate by browser (bar chart)

---

### 19. Testing Strategy

**Unit Tests:**

```python
# ProvenanceTracer
test_trace_lineage_complete()
test_trace_lineage_missing_observation()
test_trace_lineage_deleted_artifact()
test_trace_lineage_unauthorized()

# DecisionExplainer
test_explain_decision_category()
test_explain_decision_merchant()
test_explain_decision_no_rule_matched()
test_explain_decision_manual_override()

# ArtifactRetriever
test_retrieve_artifact_pdf()
test_retrieve_artifact_csv()
test_retrieve_artifact_deleted()
test_retrieve_artifact_unsigned_url()
test_retrieve_artifact_expired_url()
```

**Integration Tests:**

```bash
# Drill-down API
GET /api/transactions/can_123/drilldown
  ‚Üí Assert 200, canonical exists, observation exists, provenance has 3 events

GET /api/transactions/can_invalid/drilldown
  ‚Üí Assert 404, error code CANONICAL_NOT_FOUND

GET /api/transactions/can_other_user/drilldown (with eugenio token)
  ‚Üí Assert 403, error code FORBIDDEN_TRANSACTION

# Artifact download
GET /api/uploads/upl_123/artifact
  ‚Üí Assert 200, Content-Type: application/pdf, file size matches

GET /api/uploads/upl_123/artifact?download=true
  ‚Üí Assert 200, Content-Disposition: attachment

GET /api/uploads/upl_deleted/artifact
  ‚Üí Assert 410 Gone, artifact deleted message
```

**UI Tests (Playwright):**

```javascript
// Drill-down panel opens
test("clicking transaction row opens drill-down panel", async ({ page }) => {
  await page.click('[data-canonical-id="can_123"]');
  await expect(page.locator('[data-testid="drilldown-panel"]')).toBeVisible();
});

// Tabs work
test("switching tabs loads correct content", async ({ page }) => {
  await page.click('[data-tab="raw-data"]');
  await expect(page.locator('[data-testid="observation-data"]')).toBeVisible();
});

// PDF viewer loads
test("artifact tab opens PDF viewer", async ({ page }) => {
  await page.click('[data-tab="artifact"]');
  await expect(page.locator('iframe[src*="/uploads/"]')).toBeVisible();
});
```

**Performance Tests:**

```bash
# Load test drill-down API
ab -n 1000 -c 10 "GET /api/transactions/can_123/drilldown"
  ‚Üí Assert p95 < 1s

# Load test artifact download
ab -n 500 -c 5 "GET /api/uploads/upl_123/artifact"
  ‚Üí Assert p95 < 5s (10MB PDF)
```

**Golden Data:**

```
/tests/fixtures/drilldown-golden.json (complete drill-down response)
  ‚Üí Use for UI testing
  ‚Üí Use for decision explanation validation
  ‚Üí Use for provenance timeline rendering
```

---

### 20. Operations Runbook

**Deployment:**

```bash
# 1. Deploy API changes
kubectl apply -f k8s/api-deployment.yaml

# 2. Deploy frontend (drill-down panel)
npm run build && npm run deploy

# 3. Smoke test
curl -H "Authorization: Bearer $TOKEN" \
  https://api.example.com/api/transactions/can_test_123/drilldown
```

**Monitoring:**

```bash
# Check drill-down performance
SELECT
  percentile_cont(0.95) WITHIN GROUP (ORDER BY duration_ms) as p95
FROM drilldown_logs
WHERE timestamp > NOW() - INTERVAL '1 hour';

# Check artifact download errors
SELECT error_type, COUNT(*) as count
FROM artifact_logs
WHERE timestamp > NOW() - INTERVAL '1 day'
  AND status = 'error'
GROUP BY error_type
ORDER BY count DESC;
```

**Troubleshooting:**

**Problem:** Drill-down slow (>2s)

**Diagnosis:**
```sql
EXPLAIN ANALYZE
SELECT c.*, o.*
FROM canonical_transactions c
JOIN observation_transactions o
  ON c.upload_id = o.upload_id AND c.row_id = o.row_id
WHERE c.canonical_id = 'can_123';
```

**Fix:** Check if index on `(upload_id, row_id)` exists. If not, create composite index.

---

**Problem:** PDF viewer fails

**Diagnosis:**
```bash
tail -f /logs/viewer-errors/*.log.json | grep browser
```

**Common causes:**
- Browser doesn't support PDF embed ‚Üí Fallback to download link (already handled)
- PDF corrupted ‚Üí Show error message, provide download link
- URL expired ‚Üí Generate new signed URL

---

**Problem:** Artifact download returns 410 Gone

**Cause:** Artifact deleted by retention policy (30 days post-normalize)

**Fix:** Expected behavior. Show deletion notice in UI with hash for audit trail.

---

## Multi-Domain Applicability

This vertical demonstrates the **Drill-Down-Explain-Audit (DDEA)** pattern, which works across ALL domains:

| Domain | Canonical Entity | Observation Source | Artifact Type | Decision to Explain |
|--------|-----------------|-------------------|---------------|---------------------|
| **Finance** | Transaction | Parser output | Bank statement PDF | "Why categorized as Business?" |
| **Healthcare** | Lab Result | Lab device data | Lab report PDF | "Why flagged as abnormal?" |
| **Legal** | Contract Clause | OCR output | Contract PDF | "Why classified as high-risk?" |
| **Research** | Citation | Extracted metadata | Paper PDF | "Why marked as primary source?" |
| **Manufacturing** | QC Measurement | Sensor reading | Inspection report | "Why measurement failed?" |
| **Media** | Transcript Snippet | ASR output | Video file | "Why transcription confidence low?" |

**The primitives are reusable as-is** - only field names and artifact viewers change per domain.

---

**Next vertical:** 2.3 (Finance Dashboard) ‚Äî Saved views, pre-configured metrics, snapshot exports for accountant.
