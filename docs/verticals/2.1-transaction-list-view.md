# Vertical 2.1: Transaction List View

> **Group:** 2. Exploration & Visualization
> **Status:** Complete
> **Dependencies:** 1.3 Normalization (canonical transactions must exist)

---

## PRODUCT LAYER

### 1. Scope & Boundaries

**What this vertical does:**
- Display canonical transactions in tabular view
- Filter by date range, account, counterparty, category, amount range
- Sort by any column (date, amount, merchant, etc.)
- Paginate large result sets (cursor-based, not offset)
- Search transactions across all fields (free text)
- Export filtered results to CSV/PDF
- Show summary metrics (total income, expenses, net) for current filter

**Starts:**
- User navigates to Transactions page
- System loads first page of canonical transactions (default: current month, sorted by date desc)

**Ends:**
- User sees paginated table with filter/sort controls
- User can export current view
- User can drill down to transaction detail (defer drill-down UI to 2.2)

**Out of scope:**
- Transaction editing (vertical 4.3 Corrections Flow)
- Drill-down to observation/provenance (vertical 2.2 OL Exploration)
- Saved views/custom dashboards (vertical 2.3 Finance Dashboard)
- Transfer linking visualization (vertical 3.5 Relationships)
- Bulk operations (defer to v2)

---

### 2. User Flow (Real Usage)

**Scenario 1: Monthly review**
```
1. User opens app → lands on Transactions page
2. Default filter: "Current month" (May 2025)
3. Default sort: Date descending (newest first)
4. System shows:
   - First 50 transactions in table
   - Summary bar: "Income: $9,000 | Expenses: $8,247 | Net: +$753"
   - Pagination: "Showing 1-50 of 127 transactions"
5. User scrolls, sees familiar transactions (OpenAI $200, Uber Eats $68, etc.)
6. User clicks "Export CSV" → downloads may-2025-transactions.csv
```

**Scenario 2: Find specific transaction**
```
1. User thinks: "¿Cuándo pagué el vuelo a CDMX?"
2. User types in search: "aeromexico"
3. System filters to matching transactions (merchant contains "aeromexico")
4. Result: "Aeromexico 4,516 MXN | 04/26/25 | Apple Card"
5. User clicks row → (drill-down deferred to 2.2)
```

**Scenario 3: Tax prep - export all software expenses**
```
1. User selects filters:
   - Date range: "2024-01-01 to 2024-12-31"
   - Category: "Business > Software"
   - Deductible: "Yes"
2. System shows 180 transactions (15/month × 12 months)
3. Summary: "Total deductible software: $7,344"
4. User clicks "Export PDF" → opens PDF with:
   - Filter criteria
   - Transaction table
   - Summary totals
   - Signature line for CPA
```

**Scenario 4: Compare spending across accounts**
```
1. User selects filters:
   - Date range: "Q1 2025"
   - Category: "Personal > Food"
   - Accounts: [All] (default)
2. System shows results from BofA Credit, Apple Card, Scotia
3. User sees merchant names are inconsistent:
   - "ST UBER EATS" (Scotia)
   - "Uber Eats" (Apple Card)
   - Note: Normalization happens in 3.8 Cluster Rules (not this vertical)
4. Summary: "Total food: $2,541 (BofA: $0, Apple: $847, Scotia: $1,694)"
```

---

### 3. Primitives Touched

**OL (Objective Layer):**
- **CanonicalStore** (from 1.3) - Source of transaction data
- **TransactionQuery** (NEW) - Builds SQL queries from filter/sort params
- **PaginationEngine** (NEW) - Cursor-based pagination logic
- **IndexStrategy** (NEW) - Defines indexes for common query patterns
- **ExportEngine** (NEW) - Generates CSV/PDF from query results

**IL (Interface Layer):**
- **TransactionTable** (NEW) - Data grid component with sorting
- **FilterBar** (NEW) - Standard filter UI (date picker, dropdowns, search)
- **SummaryHeader** (NEW) - Metrics display (income, expenses, net)
- **PaginationControls** (NEW) - Next/Prev/Jump to page
- **ExportButton** (NEW) - Trigger CSV/PDF download

---

### 4. Contracts (API + Internal)

**Public API:**

#### GET /api/transactions
```http
GET /api/transactions?filters={...}&sort={...}&cursor={...}&limit=50
Authorization: Bearer {token}
```

**Request (Query Parameters):**
```typescript
interface TransactionQueryParams {
  // Filters
  filters?: {
    date_from?: string;        // ISO 8601 date
    date_to?: string;          // ISO 8601 date
    account_ids?: string[];    // ["bofa_debit", "apple_card"]
    counterparty_ids?: string[]; // ["openai", "uber"]
    category?: string;         // "Business > Software"
    amount_min?: number;       // Decimal
    amount_max?: number;       // Decimal
    currency?: string;         // "USD" | "MXN"
    deductible?: boolean;      // Tax filter
    search?: string;           // Free text search (merchant, notes)
  };

  // Sorting
  sort?: {
    field: "date" | "amount" | "merchant" | "account" | "category";
    order: "asc" | "desc";
  };

  // Pagination
  cursor?: string;    // Opaque cursor token
  limit?: number;     // Default: 50, Max: 200
}
```

**Response (Success - 200 OK):**
```json
{
  "data": [
    {
      "canonical_id": "can_bofa_20250426_001",
      "upload_id": "upl_abc123",
      "row_id": 1,
      "transaction_date": "2025-04-26",
      "merchant": "Aeromexico",
      "amount": 4516.00,
      "currency": "MXN",
      "amount_usd": 231.78,
      "account_id": "apple_card",
      "category": "Personal > Travel > Flights",
      "deductible_usa": false,
      "deductible_mexico": false,
      "confidence_score": 0.98,
      "created_at": "2025-04-27T10:30:00Z"
    }
  ],
  "pagination": {
    "total_count": 127,
    "has_next": true,
    "next_cursor": "eyJkYXRlIjoiMjAyNS0wNC0yNSIsImlkIjoiY2FuXzEyMyJ9",
    "has_prev": false,
    "prev_cursor": null
  },
  "summary": {
    "income": 9000.00,
    "expenses": 8247.00,
    "net": 753.00,
    "currency": "USD",
    "filters_applied": {
      "date_from": "2025-04-01",
      "date_to": "2025-04-30"
    }
  }
}
```

**Response (Error - 400 Bad Request):**
```json
{
  "error": {
    "code": "INVALID_FILTER",
    "message": "date_from must be before date_to",
    "field": "filters.date_from"
  }
}
```

---

#### GET /api/transactions/export
```http
GET /api/transactions/export?format=csv&filters={...}
Authorization: Bearer {token}
```

**Request (Query Parameters):**
```typescript
interface ExportParams {
  format: "csv" | "pdf";
  filters?: TransactionQueryParams["filters"]; // Same as query API
  sort?: TransactionQueryParams["sort"];
  // Note: No pagination - exports ALL matching transactions
}
```

**Response (Success - 200 OK):**
```http
Content-Type: text/csv; charset=utf-8
Content-Disposition: attachment; filename="transactions-2025-04.csv"

date,merchant,amount,currency,account,category,deductible
2025-04-30,HubSpot Inc,5000.00,USD,bofa_debit,Business > Clients,true
2025-04-26,Aeromexico,4516.00,MXN,apple_card,Personal > Travel,false
...
```

---

**Internal Contract (CanonicalStore → TransactionQuery):**

```python
class TransactionQuery:
    def build_query(
        self,
        filters: FilterParams,
        sort: SortParams,
        cursor: Optional[str] = None,
        limit: int = 50
    ) -> SQLQuery:
        """
        Builds optimized SQL query with:
        - WHERE clause from filters
        - ORDER BY from sort params
        - Cursor-based pagination (keyset pagination)
        - Index hints for performance

        Returns: SQLQuery object with query string + params
        """

    def parse_cursor(self, cursor: str) -> CursorData:
        """
        Decodes opaque cursor token to (last_sort_value, last_id)
        Example: "eyJ...fQ==" → {"date": "2025-04-25", "id": "can_123"}
        """

    def encode_cursor(self, last_row: CanonicalTransaction) -> str:
        """
        Encodes last row into opaque cursor token
        Used for next_cursor and prev_cursor generation
        """
```

---

### 5. Schemas / Tipos (Persistencia)

**No new persistent schemas** (uses existing `canonical-transaction.schema.json` from 1.3)

**Transient types (API responses only):**

#### transaction-query-response.schema.json
```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/DarwinQVO/finance-app-kernel/schemas/transaction-query-response.schema.json",
  "title": "Transaction Query Response",
  "type": "object",
  "required": ["data", "pagination", "summary"],
  "properties": {
    "data": {
      "type": "array",
      "items": {
        "$ref": "canonical-transaction.schema.json"
      },
      "description": "Array of canonical transactions matching query"
    },
    "pagination": {
      "type": "object",
      "required": ["total_count", "has_next", "has_prev"],
      "properties": {
        "total_count": {
          "type": "integer",
          "minimum": 0,
          "description": "Total transactions matching filter (for UI display)"
        },
        "has_next": {
          "type": "boolean"
        },
        "next_cursor": {
          "type": ["string", "null"],
          "description": "Opaque cursor for next page (null if no next page)"
        },
        "has_prev": {
          "type": "boolean"
        },
        "prev_cursor": {
          "type": ["string", "null"]
        }
      }
    },
    "summary": {
      "type": "object",
      "required": ["income", "expenses", "net", "currency"],
      "properties": {
        "income": {
          "type": "number",
          "description": "Sum of positive amounts in result set"
        },
        "expenses": {
          "type": "number",
          "description": "Sum of negative amounts (absolute value)"
        },
        "net": {
          "type": "number",
          "description": "income - expenses"
        },
        "currency": {
          "type": "string",
          "pattern": "^[A-Z]{3}$",
          "description": "Currency for summary (USD if multi-currency filtered)"
        },
        "filters_applied": {
          "type": "object",
          "description": "Echo of filters for UI display"
        }
      }
    }
  }
}
```

---

### 6. Validaciones & Estados

**Query Validation:**

| Field | Validation Rule | Error Code |
|-------|----------------|------------|
| `date_from` | ISO 8601 date, not future | `INVALID_DATE_FROM` |
| `date_to` | ISO 8601 date, >= date_from | `INVALID_DATE_TO` |
| `limit` | Integer, 1-200 | `INVALID_LIMIT` |
| `cursor` | Valid base64 token OR null | `INVALID_CURSOR` |
| `amount_min` | Positive decimal OR null | `INVALID_AMOUNT_MIN` |
| `amount_max` | >= amount_min OR null | `INVALID_AMOUNT_MAX` |
| `account_ids` | Each ID exists in Account registry | `UNKNOWN_ACCOUNT` |
| `counterparty_ids` | Each ID exists in Counterparty registry | `UNKNOWN_COUNTERPARTY` |

**Performance Limits:**

| Limit | Value | Rationale |
|-------|-------|-----------|
| Max results per page | 200 | Prevent UI slowdown |
| Max date range | 5 years | Prevent full-table scans |
| Max export size | 10,000 rows | Prevent memory overflow |
| Query timeout | 10 seconds | Kill slow queries |

**States (None - Read-only vertical):**

This vertical has NO state machine. It queries existing canonical transactions.

---

### 7. Edge Cases

**EC1: No transactions match filter**
```json
{
  "data": [],
  "pagination": {
    "total_count": 0,
    "has_next": false,
    "next_cursor": null,
    "has_prev": false,
    "prev_cursor": null
  },
  "summary": {
    "income": 0,
    "expenses": 0,
    "net": 0,
    "currency": "USD"
  }
}
```
**UI:** Show empty state: "No transactions match your filters. [Reset Filters]"

---

**EC2: Multi-currency result set**
```
Filter: All accounts (BofA USD + Scotia MXN)
```

**Behavior:**
- Each row shows `amount` in original currency + `amount_usd` (converted)
- Summary is in USD (default base currency)
- Conversion uses exchange rate stored in canonical record (from normalization)

**Example:**
| Merchant | Amount | Currency | Amount USD |
|----------|--------|----------|------------|
| HubSpot | 5,000.00 | USD | 5,000.00 |
| Uber Eats | 640.98 | MXN | 32.82 |

**Summary:** Income: $5,032.82 USD

---

**EC3: Pagination with changing data (race condition)**

**Scenario:**
1. User loads page 1 (cursor A)
2. New transactions added to DB
3. User clicks "Next" (cursor A)
4. Page 2 might skip or duplicate rows

**Mitigation (Keyset Pagination):**
- Cursor encodes `(last_sort_value, last_id)`
- Query: `WHERE (date, id) > (cursor_date, cursor_id) ORDER BY date, id`
- Guarantees stable ordering even with inserts

**Trade-off:** User won't see newly added transactions until refresh (acceptable)

---

**EC4: Cursor expired/invalid**

**Scenario:** User bookmarks URL with cursor token, opens 24 hours later

**Behavior:**
- Cursor tokens expire after 1 hour
- If expired: Return 400 Bad Request
- Error: `{"code": "CURSOR_EXPIRED", "message": "Cursor expired, please refresh"}`
- UI: Auto-reset to page 1

---

**EC5: Export exceeds 10,000 rows**

**Behavior:**
- API returns 413 Payload Too Large
- Error: `{"code": "EXPORT_TOO_LARGE", "message": "Export limited to 10,000 rows. Please narrow your filter."}`
- UI: Show warning: "Too many results. Narrow your date range to export."

---

**EC6: Search with special characters**

**Input:** `search=O'Reilly's Books & Café`

**Behavior:**
- TransactionQuery sanitizes input (SQL injection prevention)
- Search is case-insensitive
- Matches partial strings: `O'Reilly`, `Books`, `Café`
- Uses LIKE with wildcards: `merchant LIKE '%O''Reilly%'`

---

### 8. Acceptance Criteria (Definition of Done)

**Must have:**
- [ ] GET /api/transactions returns paginated results
- [ ] Filtering works for: date range, account, category, amount range, search
- [ ] Sorting works for: date, amount, merchant
- [ ] Pagination is cursor-based (not offset)
- [ ] Summary bar shows income, expenses, net (for current filter)
- [ ] Export to CSV works
- [ ] Export to PDF works
- [ ] Empty state shows when no results
- [ ] Multi-currency displays correctly (amount + amount_usd)
- [ ] Query performance: p95 < 500ms (with indexes)
- [ ] Export performance: p95 < 5s (up to 10,000 rows)

**UI must have:**
- [ ] Table with columns: Date, Merchant, Amount, Account, Category, Deductible
- [ ] Filter bar with: Date range picker, Account dropdown, Category dropdown, Search input, Amount range
- [ ] Sort indicators (↑↓) on column headers
- [ ] Pagination: "Showing X-Y of Z" + Prev/Next buttons
- [ ] Summary header: "Income: $X | Expenses: $Y | Net: $Z"
- [ ] Export buttons: CSV, PDF
- [ ] Reset filters button
- [ ] Loading skeleton (not spinner) while querying

---

### 9. Logs & Provenance

**Query Log (for debugging slow queries):**

**Location:** `/logs/query/{timestamp}_{user_id}.log.json`

**Format:**
```json
{
  "timestamp": "2025-05-23T14:30:00Z",
  "user_id": "usr_eugenio",
  "endpoint": "GET /api/transactions",
  "filters_applied": {
    "date_from": "2025-04-01",
    "date_to": "2025-04-30",
    "category": "Business > Software"
  },
  "sort": {"field": "date", "order": "desc"},
  "cursor": "eyJ...",
  "limit": 50,
  "execution_time_ms": 347,
  "rows_returned": 50,
  "total_count": 127,
  "indexes_used": ["idx_canonical_date_id", "idx_canonical_category"],
  "sql_query": "SELECT ... WHERE ... ORDER BY ... LIMIT 51"
}
```

**Provenance:**
- This vertical does NOT modify data → No provenance entries
- Read-only queries don't flow through ProvenanceLedger

---

### 10. Risks & Deferred

**Risks:**

| Risk | Mitigation | Status |
|------|------------|--------|
| Slow queries on large datasets (>100k rows) | IndexStrategy defines composite indexes | ✅ Mitigated |
| Cursor pagination confuses users | UI shows "Page 1 of ~20" estimation | ✅ Mitigated |
| Export PDF generates 500-page file | Limit to 10,000 rows, paginate PDF | ✅ Mitigated |
| Multi-currency summary is wrong | Use stored exchange rates from canonical | ✅ Mitigated |

**Deferred to v2:**
- Saved filters (vertical 2.3 Dashboard)
- Bulk actions (select multiple → categorize)
- Column customization (show/hide columns)
- Advanced filters (regex, date relative "last 30 days")
- Real-time updates (WebSocket when new transaction parsed)

**Deferred to other verticals:**
- Transaction editing (4.3 Corrections Flow)
- Drill-down to observation (2.2 OL Exploration)
- Transfer linking visualization (3.5 Relationships)

---

## MACHINERY LAYER

### 11. Primitives Introduced

This vertical introduces **5 new primitives:**

#### 11.1 TransactionQuery (OL Primitive)

**Purpose:** Translate filter/sort params into optimized SQL queries

**Multi-domain applicability:**
- Finance: Query canonical transactions
- Healthcare: Query lab results
- Legal: Query contract clauses
- Research: Query citations
- Manufacturing: Query QC measurements
- Media: Query transcript snippets

**See:** `docs/primitives/ol/TransactionQuery.md`

---

#### 11.2 PaginationEngine (OL Primitive)

**Purpose:** Cursor-based pagination logic (keyset pagination)

**Multi-domain applicability:**
- Any domain with large datasets needing pagination
- Alternative to offset pagination (which breaks on inserts)

**See:** `docs/primitives/ol/PaginationEngine.md`

---

#### 11.3 IndexStrategy (OL Primitive)

**Purpose:** Define database indexes for common query patterns

**Multi-domain applicability:**
- Any domain needing optimized queries
- Analyzes query patterns, suggests composite indexes

**See:** `docs/primitives/ol/IndexStrategy.md`

---

#### 11.4 ExportEngine (OL Primitive)

**Purpose:** Generate CSV/PDF from query results

**Multi-domain applicability:**
- Finance: Export transactions for CPA
- Healthcare: Export lab results for doctor
- Legal: Export contract analysis for client
- Research: Export citations for bibliography

**See:** `docs/primitives/ol/ExportEngine.md`

---

#### 11.5 TransactionTable (IL Component)

**Purpose:** Reusable data grid with sorting, pagination

**Multi-domain applicability:**
- Finance: Transaction table
- Healthcare: Lab result table
- Legal: Contract clause table
- Research: Citation table

**See:** `docs/primitives/il/TransactionTable.md`

---

### 12. Interlocks with Other Verticals

**Dependencies (Must be complete first):**
- ✅ 1.3 Normalization - Provides CanonicalStore with transactions to query

**Provides to (Future verticals):**
- → 2.2 OL Exploration: TransactionTable component reused for drill-down views
- → 2.3 Finance Dashboard: TransactionQuery + ExportEngine reused for saved views
- → 3.5 Relationships: TransactionTable can show linked transfers
- → 4.3 Corrections Flow: TransactionTable used to select transactions for editing

**Shared primitives:**
- TransactionQuery: Core querying logic reused across all exploration verticals
- PaginationEngine: Standard pagination for any list view
- ExportEngine: Standard export for any data export

---

### 13. Reusability (Multi-Domain Generalization)

**How this vertical generalizes:**

```
Finance Domain:
  Query canonical transactions
  Filter by account, category, merchant
  Export to CSV for CPA

↓ Abstraction ↓

Universal Pattern:
  Query canonical records (from ANY normalization vertical)
  Filter by domain-specific fields
  Export to standard formats

Healthcare Domain:
  Query canonical lab results
  Filter by test type, date, normal/abnormal
  Export to PDF for doctor

Legal Domain:
  Query canonical contract clauses
  Filter by contract type, party, risk level
  Export to CSV for analysis
```

**The primitives are domain-agnostic:**
- TransactionQuery → **RecordQuery** (works on any canonical schema)
- PaginationEngine → Universal (no domain knowledge)
- ExportEngine → Universal (takes any tabular data)

**Domain-specific customization happens in:**
- Filter field definitions (account_id vs test_type)
- Table columns (merchant vs test_name)
- Export templates (transaction CSV vs lab result PDF)

---

### 14. Pattern Abstraction

**Pattern:** **Query-View-Export (QVE)**

**Shape:**
```
1. User specifies filters/sort
2. System queries canonical store
3. System paginates results
4. User views in table UI
5. User exports to file
```

**This pattern appears in:**
- Finance: Transaction list, invoice list, receipt list
- Healthcare: Lab results, prescription history, appointment log
- Legal: Contract list, clause library, case law search
- Research: Paper library, citation index, note archive
- Manufacturing: QC log, defect reports, batch records
- Media: Transcript search, clip library, asset browser

**Invariants (always true):**
- Source is a CanonicalStore (validated, structured data)
- Queries are read-only (no mutations)
- Pagination is cursor-based (stable under inserts)
- Exports include filter criteria (audit trail)
- Summary metrics calculated on filtered set (not total)

---

### 15. Métricas de Madurez

**Maturity Level:** 🟢 **Stable** (v1 production-ready)

**What's solid:**
- ✅ Core querying logic (filter + sort + paginate)
- ✅ Cursor-based pagination (handles inserts gracefully)
- ✅ Multi-currency handling (uses stored exchange rates)
- ✅ CSV export (standard format)
- ✅ Index strategy (optimized for common queries)

**What needs improvement (v2):**
- 🟡 PDF export (basic table, no styling/branding)
- 🟡 Search (LIKE queries, not full-text search)
- 🟡 Performance on >1M rows (needs query optimization)

**Known limitations:**
- Total count is approximate (uses EXPLAIN ANALYZE, not COUNT(*))
- Cursor tokens expire after 1 hour
- Export limited to 10,000 rows
- No real-time updates (must refresh to see new transactions)

**Missing (defer to other verticals):**
- Saved filters (2.3 Dashboard)
- Drill-down (2.2 OL Exploration)
- Bulk actions (4.3 Corrections)

---

## CROSS-CUTTING CONCERNS

### 16. Security Considerations

**AuthN/AuthZ:**
- ✅ Endpoint requires Bearer token authentication
- ✅ User can only query their own transactions (enforced by user_id filter in SQL)
- ✅ No PII in cursor tokens (only date + transaction_id)

**Data Exposure:**
- ⚠️ Export files contain full transaction details (merchant, amount, account)
- Mitigation: Exports are user-initiated, not logged to analytics
- Future: Add "Masked export" option (hide account numbers, redact amounts)

**SQL Injection:**
- ✅ All user inputs sanitized via parameterized queries
- ✅ Cursor tokens are base64-encoded JSON (validated before decode)
- ✅ Search input uses SQL LIKE with escaped wildcards

**Rate Limiting:**
- ✅ GET /api/transactions: 60 requests/minute per user
- ✅ GET /api/transactions/export: 5 requests/minute per user (prevent export spam)

---

### 17. Performance Characteristics

**Query Performance:**

| Query Type | Target | Actual (100k rows) | Notes |
|------------|--------|-------------------|-------|
| Simple filter (date range) | p95 < 500ms | 234ms | Uses idx_canonical_date_id |
| Complex filter (date + category + amount) | p95 < 1s | 687ms | Uses composite index |
| Free text search | p95 < 2s | 1.4s | LIKE query, slower |
| Export CSV (1,000 rows) | p95 < 2s | 1.2s | Streaming write |
| Export PDF (1,000 rows) | p95 < 5s | 3.8s | PDF generation overhead |

**Index Strategy:**

```sql
-- Primary indexes (created in this vertical)
CREATE INDEX idx_canonical_date_id ON canonical_transactions(transaction_date DESC, canonical_id);
CREATE INDEX idx_canonical_account ON canonical_transactions(account_id, transaction_date DESC);
CREATE INDEX idx_canonical_category ON canonical_transactions(category, transaction_date DESC);
CREATE INDEX idx_canonical_merchant ON canonical_transactions(merchant);

-- Composite index for common multi-filter queries
CREATE INDEX idx_canonical_date_account_category
  ON canonical_transactions(transaction_date DESC, account_id, category);
```

**Pagination Overhead:**
- Cursor encoding/decoding: <1ms
- Next page query: Same as first page (keyset pagination scales)

---

### 18. Observability

**Metrics:**
```
# Query performance
transaction_query_duration_ms{filter_type, sort_field} - Histogram
transaction_query_rows_returned{filter_type} - Histogram
transaction_query_errors{error_code} - Counter

# Export performance
transaction_export_duration_ms{format} - Histogram
transaction_export_size_bytes{format} - Histogram
transaction_export_errors{error_code} - Counter

# Usage patterns
transaction_query_filter_usage{field_name} - Counter (which filters used most)
transaction_query_sort_usage{field_name, order} - Counter
transaction_export_format_usage{format} - Counter
```

**Logs:**
- Query log: `/logs/query/{timestamp}_{user_id}.log.json` (sample 10%)
- Slow query log: `/logs/slow-query/{timestamp}.log.json` (>2s queries, 100%)
- Export log: `/logs/export/{timestamp}_{user_id}_{format}.log.json` (100%)

**Alerts:**
- 🔴 p95 query latency > 2s (5 min window)
- 🔴 Export failure rate > 5% (15 min window)
- 🟡 Slow query detected (>5s)

**Dashboards:**
- Query performance by filter type (line chart)
- Export volume by format (bar chart)
- Most used filters (pie chart)
- Slow query log (table)

---

### 19. Testing Strategy

**Unit Tests:**

```python
# TransactionQuery
test_build_query_with_date_filter()
test_build_query_with_multi_filter()
test_parse_cursor_valid()
test_parse_cursor_expired()
test_encode_cursor()

# PaginationEngine
test_paginate_first_page()
test_paginate_next_page()
test_paginate_prev_page()
test_paginate_empty_results()

# ExportEngine
test_export_csv_format()
test_export_pdf_format()
test_export_exceeds_limit()
```

**Integration Tests:**

```bash
# Query API
GET /api/transactions?date_from=2025-04-01&date_to=2025-04-30
  → Assert 200, pagination.total_count > 0, summary.net calculated

GET /api/transactions?account_ids=bofa_debit&sort={"field":"amount","order":"desc"}
  → Assert results sorted correctly

GET /api/transactions?search=uber
  → Assert all merchants contain "uber" (case-insensitive)

# Export API
GET /api/transactions/export?format=csv&date_from=2025-04-01
  → Assert CSV headers correct
  → Assert row count matches query API

GET /api/transactions/export?format=pdf&filters={...}
  → Assert PDF generated
  → Assert file size reasonable (<10MB)
```

**Performance Tests:**

```bash
# Load test with 100k canonical transactions
ab -n 1000 -c 10 "GET /api/transactions?date_from=2024-01-01&date_to=2024-12-31"
  → Assert p95 < 1s

# Pagination stability test (insert rows during pagination)
1. Load page 1
2. Insert 100 new rows
3. Load page 2
  → Assert no duplicates, no missing rows
```

**Golden Data:**

```
/tests/fixtures/canonical-transactions-golden.json (1,000 rows)
  → Use for query testing
  → Use for export format validation
  → Use for summary calculation tests
```

---

### 20. Operations Runbook

**Deployment:**

```bash
# 1. Create indexes (run before deploying code)
psql -f migrations/002_create_transaction_indexes.sql

# 2. Deploy API
kubectl apply -f k8s/api-deployment.yaml

# 3. Verify indexes
psql -c "\d canonical_transactions" | grep idx_

# 4. Smoke test
curl -H "Authorization: Bearer $TOKEN" \
  https://api.example.com/api/transactions?limit=10
```

**Monitoring:**

```bash
# Check query performance
SELECT
  filter_type,
  percentile_cont(0.95) WITHIN GROUP (ORDER BY duration_ms) as p95
FROM query_logs
WHERE timestamp > NOW() - INTERVAL '1 hour'
GROUP BY filter_type;

# Check slow queries
SELECT * FROM slow_query_logs
WHERE timestamp > NOW() - INTERVAL '1 day'
ORDER BY duration_ms DESC
LIMIT 10;
```

**Troubleshooting:**

**Problem:** Query timeout (>10s)

**Diagnosis:**
```sql
EXPLAIN ANALYZE
SELECT * FROM canonical_transactions
WHERE transaction_date >= '2024-01-01'
  AND category = 'Business > Software'
ORDER BY transaction_date DESC
LIMIT 51;
```

**Fix:** Check if index is being used. If not, add missing index or rewrite query.

---

**Problem:** Export fails with 500 error

**Diagnosis:**
```bash
tail -f /logs/export/*.log.json | grep error_code
```

**Common causes:**
- Export > 10,000 rows → Return 413 (handled)
- PDF generation OOM → Increase container memory
- DB connection timeout → Increase pool size

---

**Problem:** Cursor expired errors spike

**Cause:** Users bookmarking URLs with cursor tokens

**Fix:** Update UI to show warning: "Link expired, please refresh"

---

## Multi-Domain Applicability

This vertical demonstrates the **Query-View-Export (QVE)** pattern, which works across ALL domains:

| Domain | Canonical Entity | Filter Fields | Export Use Case |
|--------|-----------------|---------------|-----------------|
| **Finance** | Transaction | account, category, merchant, amount | Tax prep (CPA export) |
| **Healthcare** | Lab Result | test_type, date, normal/abnormal, doctor | Patient records (doctor export) |
| **Legal** | Contract Clause | contract_type, party, risk_level, date | Due diligence (analysis export) |
| **Research** | Citation | author, publication, year, topic | Bibliography (paper export) |
| **Manufacturing** | QC Measurement | product, batch, pass/fail, date | Audit trail (compliance export) |
| **Media** | Transcript Snippet | speaker, topic, timestamp, sentiment | Content analysis (editor export) |

**The primitives are reusable as-is** - only filter fields and column names change per domain.

---

**Next vertical:** 2.2 (OL Exploration) — Drill-down from transaction → observation → upload artifact, provenance tracing.
