# Vertical 3.5: Relationships (Transaction-to-Transaction Linking)

> **Literate Programming:** Product layer (what users see), Machinery layer (primitives that power it), Cross-cutting concerns (security, performance, testing).

---

## Product Layer (Sections 1-10)

### 1. What is Relationships?

**Problem:**
Transactions don't exist in isolation - they're often related:
- **Transfers:** Moving money between your own accounts (BofA Checking → Wise USD)
- **FX Conversions:** Currency exchanges with different amounts (Wise USD $100 → Wise MXN $1,850)
- **Splits:** Single expense split across multiple accounts
- **Reimbursements:** Expense paid personally, later reimbursed by employer

Without relationship tracking:
- ❌ Duplicate counting in analytics (transfer shows as both expense and income)
- ❌ Lost FX conversion tracking (can't see original amount or exchange rate)
- ❌ Manual reconciliation effort (user must mentally link related transactions)
- ❌ Incorrect balances and reports

**Solution:**
Vertical 3.5 provides **transaction-to-transaction relationship tracking**:
- ✅ Auto-detect transfers (same amount, opposite accounts, ±3 days)
- ✅ Track FX conversions with exchange rates
- ✅ Link paired transactions with confidence scoring
- ✅ Exclude transfers from analytics (prevent double-counting)
- ✅ Manual link creation for edge cases

**Example:**
```
Transfer flow:
  BofA Checking  →  Wise USD  →  Wise MXN  →  Scotia MXN

Transactions:
  1. BofA Checking:  -$1,000  (2025-10-15, "Transfer to Wise")
  2. Wise USD:       +$1,000  (2025-10-15, "Deposit from BofA")
  3. Wise USD:       -$1,000  (2025-10-16, "Convert to MXN")
  4. Wise MXN:      +$18,500  (2025-10-16, "Converted from USD")  [rate: 18.5]
  5. Wise MXN:      -$18,500  (2025-10-17, "Transfer to Scotia")
  6. Scotia MXN:    +$18,500  (2025-10-17, "Deposit from Wise")

Relationships:
  - txn_1 ↔ txn_2 (transfer, confidence: 0.95)
  - txn_3 ↔ txn_4 (fx_conversion, rate: 18.5, confidence: 0.98)
  - txn_5 ↔ txn_6 (transfer, confidence: 0.95)
```

**Multi-Domain Applicability:**
This pattern applies universally wherever related records must be linked:

**Finance (this vertical):**
- Transfer detection between accounts
- FX conversion tracking
- Split expense linking

**Healthcare:**
- Claim ↔ Payment linking (insurance claim → reimbursement)
- Referral relationships (primary care → specialist visit)
- Prescription refills (original Rx → refill instances)

**Legal:**
- Case relationships (parent case → child cases)
- Document version tracking (original brief → amended brief)
- Billing ↔ Payment reconciliation

**Research:**
- Citation networks (paper ↔ cited papers)
- Dataset lineage (source dataset → derived dataset)
- Experiment chains (pilot study → full study)

**E-commerce:**
- Order ↔ Return linking
- Refund ↔ Original payment
- Split shipments (order → multiple shipments)

**Pattern:** **Paired Record Linking + Confidence Scoring**

---

### 2. User Workflow: Transfer Detection

**Scenario:** User uploads BofA statement showing transfer to Wise, then uploads Wise statement.

**Steps:**

1. **Upload BofA statement** (2025-10-15):
   ```
   Date       | Account        | Amount    | Description
   2025-10-15 | BofA Checking  | -$1,000   | Transfer to Wise
   ```
   - System creates `txn_001` (canonical transaction)
   - **No relationships yet** (only one side of transfer)

2. **Upload Wise statement** (same day):
   ```
   Date       | Account   | Amount   | Description
   2025-10-15 | Wise USD  | +$1,000  | Deposit from BofA
   ```
   - System creates `txn_002`
   - **TransferDetector runs automatically**
   - Detects potential link:
     - ✅ Same amount ($1,000)
     - ✅ Opposite signs (- vs +)
     - ✅ Different accounts (BofA vs Wise)
     - ✅ Same user
     - ✅ Close dates (same day)
     - **Confidence: 0.95** (very high)

3. **User sees suggestion**:
   ```
   ┌─────────────────────────────────────────────────────────┐
   │ 🔗 Transfer Detected                                    │
   ├─────────────────────────────────────────────────────────┤
   │                                                         │
   │ From: BofA Checking  -$1,000  (2025-10-15)             │
   │ To:   Wise USD       +$1,000  (2025-10-15)             │
   │                                                         │
   │ Confidence: 95%                                         │
   │                                                         │
   │ [Link as Transfer]  [Dismiss]                          │
   └─────────────────────────────────────────────────────────┘
   ```

4. **User clicks "Link as Transfer"**:
   - System creates relationship record:
     ```json
     {
       "relationship_id": "rel_001",
       "txn_1_id": "txn_001",
       "txn_2_id": "txn_002",
       "type": "transfer",
       "confidence": 0.95,
       "detection_method": "auto",
       "linked_at": "2025-10-15T14:30:00Z"
     }
     ```
   - Both transactions now show "🔗 Linked Transfer" badge
   - Analytics exclude these from income/expense totals

**Edge Cases:**
- **Different amounts** (fees): BofA -$1,000 vs Wise +$998 (Wise fee $2) → Lower confidence (0.80), suggest with warning
- **Different dates** (processing delay): BofA 10/15 vs Wise 10/18 → Still detect if ≤7 days
- **Multiple candidates**: If 3 transactions match criteria → Show all suggestions, user picks correct one
- **Already linked**: Don't suggest if either transaction already in relationship

---

### 3. User Workflow: FX Conversion Tracking

**Scenario:** User converts USD to MXN in Wise.

**Steps:**

1. **Upload Wise statement** (2025-10-16):
   ```
   Date       | Account   | Amount     | Description
   2025-10-16 | Wise USD  | -$1,000    | Convert to MXN
   2025-10-16 | Wise MXN  | +$18,500   | Converted from USD
   ```
   - System creates `txn_003` (USD) and `txn_004` (MXN)
   - **TransferDetector with FX mode** runs
   - Detects FX conversion:
     - ✅ Different currencies (USD vs MXN)
     - ✅ Same date
     - ✅ Same account institution (Wise)
     - ✅ Opposite signs
     - **Exchange rate calculated:** 18,500 / 1,000 = 18.5
     - **Confidence: 0.98** (very high, same institution + same date)

2. **User sees suggestion**:
   ```
   ┌─────────────────────────────────────────────────────────┐
   │ 💱 FX Conversion Detected                               │
   ├─────────────────────────────────────────────────────────┤
   │                                                         │
   │ From: Wise USD  -$1,000                                │
   │ To:   Wise MXN  +$18,500                               │
   │                                                         │
   │ Exchange Rate: 18.5 MXN/USD                            │
   │ Confidence: 98%                                         │
   │                                                         │
   │ [Link as FX Conversion]  [Dismiss]                     │
   └─────────────────────────────────────────────────────────┘
   ```

3. **User clicks "Link as FX Conversion"**:
   - System creates relationship with FX details:
     ```json
     {
       "relationship_id": "rel_002",
       "txn_1_id": "txn_003",
       "txn_2_id": "txn_004",
       "type": "fx_conversion",
       "fx_details": {
         "from_currency": "USD",
         "to_currency": "MXN",
         "from_amount": 1000.00,
         "to_amount": 18500.00,
         "exchange_rate": 18.5,
         "rate_source": "calculated"
       },
       "confidence": 0.98,
       "detection_method": "auto",
       "linked_at": "2025-10-16T09:15:00Z"
     }
     ```

4. **Transaction detail shows conversion**:
   ```
   ┌─────────────────────────────────────────────────────────┐
   │ Transaction Detail: txn_003                             │
   ├─────────────────────────────────────────────────────────┤
   │                                                         │
   │ Date:     2025-10-16                                    │
   │ Account:  Wise USD                                      │
   │ Amount:   -$1,000.00                                    │
   │ Desc:     Convert to MXN                                │
   │                                                         │
   │ 💱 FX Conversion (18.5 MXN/USD)                         │
   │ ↓ Converted to: $18,500 MXN (txn_004)                  │
   │                                                         │
   └─────────────────────────────────────────────────────────┘
   ```

**Benefits:**
- ✅ Historical FX rates preserved (even if Wise doesn't provide rate in statement)
- ✅ Multi-currency reporting (can show expenses in base currency)
- ✅ FX gain/loss tracking (compare actual rate to market rate)

---

### 4. User Workflow: Manual Link Creation

**Scenario:** User needs to manually link two transactions that auto-detection missed.

**Example:** Personal expense reimbursed by employer with different amounts (employer rounds up).

**Steps:**

1. **User opens transaction detail** (txn_005: Personal Card -$47.32 for client dinner)

2. **Clicks "Link to Transaction" button**

3. **Dialog opens:**
   ```
   ┌─────────────────────────────────────────────────────────┐
   │ Link Transaction                                        │
   ├─────────────────────────────────────────────────────────┤
   │                                                         │
   │ Current Transaction:                                    │
   │ Personal Card  -$47.32  (2025-10-10)                   │
   │ "Client dinner - expense report"                        │
   │                                                         │
   │ Link to:                                                │
   │ ┌─────────────────────────────────────────────────┐    │
   │ │ Search transactions...                          │    │
   │ └─────────────────────────────────────────────────┘    │
   │                                                         │
   │ Relationship Type:                                      │
   │ ◉ Reimbursement                                         │
   │ ○ Transfer                                              │
   │ ○ FX Conversion                                         │
   │ ○ Split                                                 │
   │ ○ Other                                                 │
   │                                                         │
   │ Notes (optional):                                       │
   │ ┌─────────────────────────────────────────────────┐    │
   │ │ Employer rounds reimbursements to nearest $5    │    │
   │ └─────────────────────────────────────────────────┘    │
   │                                                         │
   │           [Cancel]  [Create Link]                       │
   └─────────────────────────────────────────────────────────┘
   ```

4. **User searches for reimbursement** (types "expense report"):
   ```
   ┌─────────────────────────────────────────────────────────┐
   │ Search Results:                                         │
   ├─────────────────────────────────────────────────────────┤
   │ ✓ Business Checking  +$50.00  (2025-10-20)             │
   │   "Expense reimbursement Oct"                           │
   │                                                         │
   │   Work Visa  +$250.00  (2025-10-18)                    │
   │   "Travel expense reimbursement"                        │
   └─────────────────────────────────────────────────────────┘
   ```

5. **User selects first result, clicks "Create Link"**:
   - System creates relationship:
     ```json
     {
       "relationship_id": "rel_003",
       "txn_1_id": "txn_005",
       "txn_2_id": "txn_006",
       "type": "reimbursement",
       "confidence": null,
       "detection_method": "manual",
       "notes": "Employer rounds reimbursements to nearest $5",
       "linked_at": "2025-10-21T16:00:00Z",
       "linked_by": "user_darwin"
     }
     ```

6. **Both transactions show link:**
   - txn_005 (expense): "🔗 Reimbursed by txn_006"
   - txn_006 (income): "🔗 Reimburses txn_005"

**Manual Link Use Cases:**
- Reimbursements with different amounts
- Split expenses across multiple cards
- Delayed transfers (>7 days)
- Corrections/adjustments linked to original transaction

---

### 5. User Workflow: Unlink Transactions

**Scenario:** User accidentally linked wrong transactions or wants to remove auto-detected link.

**Steps:**

1. **User opens transaction detail** showing linked relationship

2. **Clicks "Unlink" button** in relationship card:
   ```
   ┌─────────────────────────────────────────────────────────┐
   │ Transaction Detail: txn_001                             │
   ├─────────────────────────────────────────────────────────┤
   │                                                         │
   │ Date:     2025-10-15                                    │
   │ Account:  BofA Checking                                 │
   │ Amount:   -$1,000.00                                    │
   │                                                         │
   │ 🔗 Transfer Relationship                                │
   │ ┌───────────────────────────────────────────────┐      │
   │ │ ↓ Wise USD  +$1,000.00  (2025-10-15)          │      │
   │ │   Confidence: 95% (auto-detected)              │      │
   │ │                                 [Unlink]       │      │
   │ └───────────────────────────────────────────────┘      │
   └─────────────────────────────────────────────────────────┘
   ```

3. **Confirmation dialog:**
   ```
   ┌─────────────────────────────────────────────────────────┐
   │ Unlink Transfer?                                        │
   ├─────────────────────────────────────────────────────────┤
   │                                                         │
   │ This will remove the transfer relationship between:     │
   │                                                         │
   │ • BofA Checking  -$1,000  (2025-10-15)                 │
   │ • Wise USD       +$1,000  (2025-10-15)                 │
   │                                                         │
   │ Both transactions will be counted separately in         │
   │ analytics again.                                        │
   │                                                         │
   │        [Cancel]  [Unlink Transactions]                  │
   └─────────────────────────────────────────────────────────┘
   ```

4. **User confirms**:
   - System **soft deletes** relationship record:
     ```json
     {
       "relationship_id": "rel_001",
       "deleted_at": "2025-10-22T10:00:00Z",
       "deleted_by": "user_darwin"
     }
     ```
   - Relationship removed from both transactions
   - Analytics now count both transactions separately

**Audit Trail:**
- All link/unlink operations logged in provenance
- Can view history: "Who linked? When? Why unlinked?"
- Supports compliance/audit requirements

---

### 6. Analytics Integration: Exclude Transfers

**Problem:** Without transfer exclusion, analytics double-count money movement.

**Example Without Exclusion:**
```
BofA Checking → Wise USD transfer of $1,000

Expenses:  $1,000  (BofA withdrawal)
Income:    $1,000  (Wise deposit)
Net:       $0      ✅ Correct by coincidence

Monthly Expense Total: $5,000  ❌ WRONG (includes $1,000 transfer)
Monthly Income Total:  $3,000  ❌ WRONG (includes $1,000 transfer)
```

**Solution: Filter by Relationship Type**

**API Query:**
```http
GET /api/transactions?
  date_from=2025-10-01&
  date_to=2025-10-31&
  exclude_transfers=true
```

**Backend Logic:**
```python
def get_transactions(exclude_transfers: bool = False):
    query = """
        SELECT t.*
        FROM canonical_transactions t
        LEFT JOIN relationships r ON (
            t.txn_id = r.txn_1_id OR t.txn_id = r.txn_2_id
        )
        WHERE t.user_id = :user_id
          AND t.date BETWEEN :date_from AND :date_to
    """

    if exclude_transfers:
        query += """
          AND (
              r.relationship_id IS NULL
              OR r.type NOT IN ('transfer', 'fx_conversion')
          )
        """

    return db.execute(query, params)
```

**Result:**
```
Monthly Expense Total: $4,000  ✅ Correct (excludes transfer)
Monthly Income Total:  $2,000  ✅ Correct (excludes transfer)
```

**Dashboard Default:**
All finance dashboards default to `exclude_transfers=true` to prevent double-counting.

**User Control:**
- ✅ "Include Transfers" toggle in dashboard settings
- ✅ Separate "Transfers" report to analyze money movement
- ✅ FX conversion report to track currency exchanges

---

### 7. Edge Cases Handled

**7.1 Split Transactions**

**Scenario:** Dinner bill split across two cards.

**Data:**
```
Personal Card:  -$60  (2025-10-15, "Dinner with client")
Work Visa:      -$40  (2025-10-15, "Dinner with client")
```

**Solution:**
- User manually links both as "split" type
- Relationship stores parent concept:
  ```json
  {
    "relationship_id": "rel_004",
    "type": "split",
    "txn_ids": ["txn_007", "txn_008"],
    "total_amount": 100.00,
    "notes": "Split dinner bill 60/40"
  }
  ```

**7.2 Partial Transfers**

**Scenario:** Transfer $1,000 from BofA but only $998 arrives in Wise (fee).

**Detection:**
- Amount differs: -$1,000 vs +$998
- **Confidence: 0.80** (lower due to mismatch)
- Suggestion shows warning:
  ```
  ⚠️ Amount Mismatch ($2 difference)
  From: BofA  -$1,000
  To:   Wise  +$998

  This may be due to transfer fees.
  ```

**User Actions:**
- **Option 1:** Link anyway (most common)
- **Option 2:** Create separate fee transaction (advanced users)

**7.3 Delayed Transfers**

**Scenario:** BofA transfer on 10/15, Wise deposit on 10/19 (4-day delay).

**Detection:**
- Date diff: 4 days (within 7-day window)
- **Confidence: 0.85** (lower due to delay)
- Still auto-suggested

**7.4 Multiple Candidates**

**Scenario:** Three $100 transactions on same day.

**Detection:**
- Finds all matches
- Shows list of candidates:
  ```
  🔗 Potential Transfers Found

  BofA Checking  -$100  (2025-10-15)

  Could be linked to:
  ☐ Wise USD       +$100  (2025-10-15)
  ☐ Chase Savings  +$100  (2025-10-15)
  ☐ Venmo         +$100  (2025-10-15)

  [Link Selected] [Dismiss]
  ```

**7.5 Chain Transfers**

**Scenario:** BofA → Wise USD → Wise MXN → Scotia.

**Solution:**
- Create relationships pairwise:
  - rel_001: BofA ↔ Wise USD (transfer)
  - rel_002: Wise USD ↔ Wise MXN (fx_conversion)
  - rel_003: Wise MXN ↔ Scotia (transfer)

- UI shows chain:
  ```
  Transfer Chain:
  BofA → Wise USD → Wise MXN → Scotia
  ```

**7.6 Already Linked**

**Scenario:** Transaction already in relationship, user tries to link again.

**Validation:**
```python
def validate_link(txn_id: str) -> None:
    existing = db.query("""
        SELECT * FROM relationships
        WHERE (txn_1_id = :txn_id OR txn_2_id = :txn_id)
          AND deleted_at IS NULL
    """, txn_id=txn_id)

    if existing:
        raise AlreadyLinkedException(
            f"Transaction {txn_id} already linked in relationship {existing.relationship_id}"
        )
```

**Error Message:**
```
❌ Cannot Link Transaction

This transaction is already linked:
• Existing: Transfer to Wise USD (rel_001)

Unlink the existing relationship first.
```

---

### 8. Confidence Scoring

**How Confidence is Calculated:**

```python
def calculate_transfer_confidence(txn_1: Transaction, txn_2: Transaction) -> float:
    """Calculate confidence score for transfer detection (0.0 to 1.0)"""

    score = 0.0

    # Amount match (40% weight)
    amount_diff = abs(abs(txn_1.amount) - abs(txn_2.amount))
    amount_ratio = amount_diff / abs(txn_1.amount)

    if amount_ratio == 0:
        score += 0.40  # Perfect match
    elif amount_ratio <= 0.02:  # Within 2%
        score += 0.35
    elif amount_ratio <= 0.05:  # Within 5%
        score += 0.25
    else:
        score += 0.10  # Weak match

    # Date proximity (30% weight)
    date_diff = abs((txn_1.date - txn_2.date).days)

    if date_diff == 0:
        score += 0.30  # Same day
    elif date_diff <= 1:
        score += 0.25  # Next day
    elif date_diff <= 3:
        score += 0.20  # Within 3 days
    elif date_diff <= 7:
        score += 0.10  # Within week
    else:
        score += 0.0   # Too far apart

    # Opposite signs (20% weight)
    if (txn_1.amount > 0 and txn_2.amount < 0) or \
       (txn_1.amount < 0 and txn_2.amount > 0):
        score += 0.20

    # Different accounts, same user (10% weight)
    if txn_1.account_id != txn_2.account_id and txn_1.user_id == txn_2.user_id:
        score += 0.10

    return min(score, 1.0)  # Cap at 1.0
```

**Confidence Thresholds:**

| Score | Behavior | Example |
|-------|----------|---------|
| **≥0.90** | Auto-suggest with high confidence | Same amount, same day, opposite signs |
| **0.70-0.89** | Auto-suggest with medium confidence | 2% amount diff, 1-day delay |
| **0.50-0.69** | Show in "Possible Matches" list | 5% amount diff, 3-day delay |
| **<0.50** | Don't suggest (manual link only) | Different amounts, 10-day delay |

**User Override:**
- Users can link any two transactions manually (even with 0% confidence)
- Manual links stored with `confidence: null`, `detection_method: "manual"`

---

### 9. Relationship Types Supported

**9.1 Transfer**
- **Definition:** Money moved between user's own accounts
- **Characteristics:** Same amount, opposite signs, different accounts
- **Example:** BofA Checking -$1,000 → Wise USD +$1,000
- **Analytics Impact:** Excluded from income/expense totals

**9.2 FX Conversion**
- **Definition:** Currency exchange with different amounts
- **Characteristics:** Different currencies, opposite signs, exchange rate calculated
- **Example:** Wise USD -$1,000 → Wise MXN +$18,500 (rate: 18.5)
- **Analytics Impact:** Excluded from totals, FX gain/loss tracked
- **Extra Data:** Exchange rate, rate source (calculated, manual, market)

**9.3 Reimbursement**
- **Definition:** Expense paid personally, later reimbursed
- **Characteristics:** Different amounts allowed, different dates allowed
- **Example:** Personal Card -$47.32 → Business Checking +$50.00
- **Analytics Impact:** Expense remains expense, income remains income (not excluded)
- **UI:** Shows "Reimbursed by" badge

**9.4 Split**
- **Definition:** Single transaction split across multiple accounts/cards
- **Characteristics:** Multiple transactions, sum to total amount
- **Example:** Dinner split: Personal -$60 + Work -$40 = -$100 total
- **Analytics Impact:** Can group as single expense or keep separate (user choice)
- **Extra Data:** Total amount, split ratio

**9.5 Correction**
- **Definition:** Adjustment or reversal of original transaction
- **Characteristics:** Opposite amount, often same account
- **Example:** Original charge -$100 → Refund +$100
- **Analytics Impact:** Can net to zero or track separately

**9.6 Other**
- **Definition:** Custom relationship type for edge cases
- **User Input:** Requires notes field to explain relationship
- **Example:** "This is a disputed charge linked to resolution"

---

### 10. Success Metrics

**Metric 1: Auto-Detection Accuracy**
- **Goal:** ≥90% precision (suggested links are correct)
- **Goal:** ≥80% recall (detect most actual transfers)
- **Measure:** User accept rate on auto-suggestions

**Metric 2: Manual Link Volume**
- **Goal:** <10% of transfers require manual linking
- **Measure:** manual_links / total_links ratio

**Metric 3: Analytics Correctness**
- **Goal:** 100% of dashboards exclude transfers by default
- **Measure:** No user reports of double-counting

**Metric 4: User Adoption**
- **Goal:** ≥70% of eligible transaction pairs are linked within 7 days
- **Measure:** linked_pairs / detected_pairs ratio

**Metric 5: Performance**
- **Goal:** <200ms p95 for transfer detection on upload
- **Goal:** <100ms p95 for relationship queries
- **Measure:** Server-side latency monitoring

---

## Machinery Layer (Sections 11-15)

### 11. Primitives Used

**This vertical introduces 4 new OL primitives:**

**11.1 RelationshipStore**
- **Purpose:** CRUD operations for transaction relationships
- **Key Methods:**
  - `create(txn_1_id, txn_2_id, type, confidence, detection_method, notes)` → Relationship
  - `get(relationship_id)` → Relationship
  - `find_by_transaction(txn_id)` → List[Relationship]
  - `unlink(relationship_id, user_id)` → void (soft delete)
  - `search(user_id, type, min_confidence)` → List[Relationship]

- **Storage:** PostgreSQL table `relationships`
  ```sql
  CREATE TABLE relationships (
      relationship_id TEXT PRIMARY KEY,
      user_id TEXT NOT NULL,
      txn_1_id TEXT NOT NULL,
      txn_2_id TEXT NOT NULL,
      type TEXT NOT NULL, -- transfer, fx_conversion, reimbursement, split, correction, other
      confidence DECIMAL(3,2), -- 0.00 to 1.00, NULL for manual links
      detection_method TEXT NOT NULL, -- auto, manual
      fx_details JSONB, -- Exchange rate data for fx_conversion type
      notes TEXT,
      linked_at TIMESTAMPTZ NOT NULL,
      linked_by TEXT, -- user_id for manual links
      deleted_at TIMESTAMPTZ,
      deleted_by TEXT,
      FOREIGN KEY (user_id) REFERENCES users(user_id),
      FOREIGN KEY (txn_1_id) REFERENCES canonical_transactions(txn_id),
      FOREIGN KEY (txn_2_id) REFERENCES canonical_transactions(txn_id),
      CHECK (txn_1_id != txn_2_id)
  );

  CREATE INDEX idx_relationships_txn_1 ON relationships(txn_1_id) WHERE deleted_at IS NULL;
  CREATE INDEX idx_relationships_txn_2 ON relationships(txn_2_id) WHERE deleted_at IS NULL;
  CREATE INDEX idx_relationships_user ON relationships(user_id, type) WHERE deleted_at IS NULL;
  ```

**11.2 TransferDetector**
- **Purpose:** Auto-detect transfer pairs based on matching criteria
- **Key Methods:**
  - `detect_on_upload(txn_id)` → List[Candidate] (run after normalization)
  - `detect_batch(user_id, date_from, date_to)` → List[Candidate] (bulk analysis)
  - `calculate_confidence(txn_1, txn_2)` → float (scoring algorithm)

- **Algorithm:**
  ```python
  def detect_on_upload(txn_id: str) -> List[Candidate]:
      txn = get_transaction(txn_id)

      # Find candidates: opposite amount, same user, recent dates
      candidates = db.query("""
          SELECT * FROM canonical_transactions
          WHERE user_id = :user_id
            AND txn_id != :txn_id
            AND ABS(ABS(amount) - ABS(:amount)) <= :amount * 0.05  -- Within 5%
            AND SIGN(amount) != SIGN(:amount)  -- Opposite signs
            AND account_id != :account_id  -- Different accounts
            AND ABS(date - :date) <= 7  -- Within 7 days
            AND txn_id NOT IN (
                SELECT txn_1_id FROM relationships WHERE deleted_at IS NULL
                UNION
                SELECT txn_2_id FROM relationships WHERE deleted_at IS NULL
            )
          ORDER BY ABS(date - :date), ABS(ABS(amount) - ABS(:amount))
          LIMIT 10
      """, user_id=txn.user_id, txn_id=txn_id, amount=txn.amount,
           account_id=txn.account_id, date=txn.date)

      # Calculate confidence for each candidate
      results = []
      for candidate in candidates:
          confidence = calculate_confidence(txn, candidate)
          if confidence >= 0.50:  # Threshold
              results.append(Candidate(
                  txn_id=candidate.txn_id,
                  confidence=confidence,
                  type="fx_conversion" if txn.currency != candidate.currency else "transfer"
              ))

      return sorted(results, key=lambda x: x.confidence, reverse=True)
  ```

**11.3 FXConverter**
- **Purpose:** Calculate exchange rates and track FX conversions
- **Key Methods:**
  - `calculate_rate(from_amount, from_currency, to_amount, to_currency)` → Decimal
  - `get_market_rate(date, from_currency, to_currency)` → Decimal (external API)
  - `calculate_fx_gain_loss(relationship_id)` → Decimal

- **Exchange Rate Calculation:**
  ```python
  def calculate_rate(from_amount: Decimal, from_currency: str,
                     to_amount: Decimal, to_currency: str) -> Decimal:
      """
      Calculate exchange rate from transaction amounts.

      Example:
        from: $1,000 USD
        to:   $18,500 MXN
        rate: 18,500 / 1,000 = 18.5 MXN/USD
      """
      if from_amount == 0:
          raise ValueError("From amount cannot be zero")

      rate = abs(to_amount) / abs(from_amount)
      return rate.quantize(Decimal('0.0001'))  # 4 decimal places
  ```

- **FX Gain/Loss:**
  ```python
  def calculate_fx_gain_loss(relationship: Relationship) -> Decimal:
      """
      Compare actual rate to market rate to calculate gain/loss.

      Example:
        Actual rate:  18.5 MXN/USD (from transaction)
        Market rate:  18.3 MXN/USD (from API on date)
        From amount:  $1,000 USD

        Expected:     1,000 * 18.3 = 18,300 MXN
        Actual:       18,500 MXN
        Gain:         +200 MXN ($10.93 USD)
      """
      fx = relationship.fx_details
      market_rate = get_market_rate(
          relationship.date,
          fx.from_currency,
          fx.to_currency
      )

      expected = abs(fx.from_amount) * market_rate
      actual = abs(fx.to_amount)
      gain_loss = actual - expected

      return gain_loss
  ```

**11.4 RelationshipMatcher**
- **Purpose:** Fuzzy matching for paired transactions with configurable thresholds
- **Key Methods:**
  - `match(txn_1_id, txn_2_id, match_config)` → MatchResult
  - `bulk_match(user_id, date_range, match_config)` → List[MatchResult]

- **Configuration:**
  ```python
  @dataclass
  class MatchConfig:
      amount_tolerance_pct: float = 0.05  # 5%
      date_window_days: int = 7
      min_confidence: float = 0.50
      require_opposite_signs: bool = True
      require_different_accounts: bool = True
  ```

**11.5 Reused Primitives from Previous Verticals:**
- **ProvenanceLedger** (1.1): Log all link/unlink operations
- **CanonicalStore** (1.3): Query transactions for matching
- **AccountStore** (3.1): Validate account ownership
- **CounterpartyStore** (3.2): Not directly used, but relationships can link transactions with same counterparty

---

### 12. IL Components Used

**This vertical introduces 3 new IL components:**

**12.1 RelationshipPanel**
- **Purpose:** Display linked transactions in transaction detail view
- **Location:** Embedded in transaction detail page
- **Features:**
  - Show relationship type with icon (🔗 transfer, 💱 FX, 💰 reimburse)
  - Display linked transaction summary (account, amount, date)
  - Show confidence score for auto-detected links
  - "Unlink" button for manual removal
  - Click linked transaction to navigate to its detail

**12.2 TransferLinkDialog**
- **Purpose:** Manual link creation dialog
- **Trigger:** "Link to Transaction" button in transaction detail
- **Features:**
  - Search for transactions to link
  - Filter by date range, account, amount
  - Select relationship type (dropdown)
  - Optional notes field
  - Preview link before creation
  - Validation: prevent duplicate links, same-transaction links

**12.3 FXConversionCard**
- **Purpose:** Display FX conversion details
- **Location:** Embedded in RelationshipPanel when type = fx_conversion
- **Features:**
  - Show exchange rate
  - Display from/to currencies and amounts
  - Compare to market rate (if available)
  - Show FX gain/loss calculation
  - Link to FX conversion report

**12.4 Reused IL Components:**
- **TransactionTable** (2.1): Reused in search dialog
- **DrillDownPanel** (2.2): Extended to show relationships

---

### 13. State Management

**Relationship Lifecycle:**

```
┌─────────────────────────────────────────────────────────────┐
│                    Relationship States                      │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. [Suggested] ──────────────────────────────────────┐    │
│       ↓                                                │    │
│       User accepts                                     │    │
│       ↓                                                │    │
│  2. [Active] ──────────────────────────────────────────┼──→ │
│       ↓                                                │    │
│       User unlinks                                     │    │
│       ↓                                                │    │
│  3. [Deleted] (soft delete, deleted_at != NULL)       │    │
│                                                        │    │
│  Alternative: User dismisses suggestion ───────────────┘    │
│  (no record created)                                        │
└─────────────────────────────────────────────────────────────┘
```

**State Transitions:**

| From State | Action | To State | Side Effects |
|------------|--------|----------|--------------|
| **None** | Auto-detection finds match | **Suggested** | Show UI notification |
| **Suggested** | User accepts | **Active** | Create relationship record, update both txn views |
| **Suggested** | User dismisses | **None** | Log dismissal (prevent re-suggesting) |
| **Active** | User unlinks | **Deleted** | Soft delete (deleted_at), update both txn views |

**Transaction View States:**

Each transaction can be in one of:
- **Unlinked:** No relationships
- **Linked:** Has 1+ active relationships
- **Suggested Link:** Has 1+ pending suggestions

**UI Indicators:**
```
Unlinked:          [Transaction Detail]  (no badge)

Linked:            [Transaction Detail]  🔗 Transfer

Suggested:         [Transaction Detail]  🔔 Link Suggested
```

---

### 14. Validation Rules

**14.1 Create Relationship Validation:**

```python
def validate_create_relationship(
    txn_1_id: str,
    txn_2_id: str,
    user_id: str,
    relationship_type: str
) -> None:
    """Validate relationship creation"""

    # Rule 1: Cannot link transaction to itself
    if txn_1_id == txn_2_id:
        raise ValidationError("Cannot link transaction to itself")

    # Rule 2: Both transactions must exist
    txn_1 = get_transaction(txn_1_id)
    txn_2 = get_transaction(txn_2_id)
    if not txn_1 or not txn_2:
        raise NotFoundError("One or both transactions not found")

    # Rule 3: User must own both transactions
    if txn_1.user_id != user_id or txn_2.user_id != user_id:
        raise AuthorizationError("You can only link your own transactions")

    # Rule 4: Transactions cannot already be linked
    existing = find_relationship(txn_1_id, txn_2_id)
    if existing and not existing.deleted_at:
        raise AlreadyLinkedError(
            f"Transactions already linked in relationship {existing.relationship_id}"
        )

    # Rule 5: Type must be valid
    valid_types = ["transfer", "fx_conversion", "reimbursement", "split", "correction", "other"]
    if relationship_type not in valid_types:
        raise ValidationError(f"Invalid relationship type: {relationship_type}")

    # Rule 6: FX conversion requires different currencies
    if relationship_type == "fx_conversion":
        if txn_1.currency == txn_2.currency:
            raise ValidationError("FX conversion requires different currencies")

    # Rule 7: Transfer should have same currency (warning, not error)
    if relationship_type == "transfer":
        if txn_1.currency != txn_2.currency:
            # Allow but log warning
            logger.warning(f"Transfer between different currencies: {txn_1.currency} vs {txn_2.currency}")
```

**14.2 Unlink Validation:**

```python
def validate_unlink(relationship_id: str, user_id: str) -> None:
    """Validate relationship deletion"""

    # Rule 1: Relationship must exist
    rel = get_relationship(relationship_id)
    if not rel:
        raise NotFoundError(f"Relationship {relationship_id} not found")

    # Rule 2: User must own the relationship
    if rel.user_id != user_id:
        raise AuthorizationError("You can only unlink your own relationships")

    # Rule 3: Relationship must not already be deleted
    if rel.deleted_at:
        raise ValidationError("Relationship already deleted")
```

**14.3 Confidence Score Validation:**

```python
def validate_confidence(confidence: Optional[float], detection_method: str) -> None:
    """Validate confidence score"""

    # Rule 1: Auto-detected must have confidence
    if detection_method == "auto" and confidence is None:
        raise ValidationError("Auto-detected relationships require confidence score")

    # Rule 2: Manual links must have NULL confidence
    if detection_method == "manual" and confidence is not None:
        raise ValidationError("Manual relationships cannot have confidence score")

    # Rule 3: Confidence must be 0.0 to 1.0
    if confidence is not None:
        if not (0.0 <= confidence <= 1.0):
            raise ValidationError(f"Confidence must be between 0.0 and 1.0, got {confidence}")
```

---

### 15. Data Flow

**Flow 1: Auto-Detection on Upload**

```
┌─────────────────────────────────────────────────────────────┐
│                   Auto-Detection Flow                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. User uploads statement                                  │
│      ↓                                                      │
│  2. Parser extracts observations                            │
│      ↓                                                      │
│  3. Normalizer creates canonical transactions               │
│      ↓                                                      │
│  4. TransferDetector.detect_on_upload(txn_id)               │
│      ├─ Query recent unlinked transactions                  │
│      ├─ Filter by amount, date, account criteria            │
│      ├─ Calculate confidence for each candidate             │
│      └─ Return candidates with confidence ≥ 0.50            │
│      ↓                                                      │
│  5. If candidates found:                                    │
│      ├─ Store suggestion in temp table OR                   │
│      └─ Show immediate UI notification                      │
│      ↓                                                      │
│  6. User reviews suggestion                                 │
│      ├─ Accept → Create relationship (Active)               │
│      ├─ Dismiss → Log dismissal (prevent re-suggest)        │
│      └─ Ignore → Remains suggested                          │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**Flow 2: Manual Link Creation**

```
┌─────────────────────────────────────────────────────────────┐
│                   Manual Link Flow                          │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. User opens transaction detail (txn_1)                   │
│      ↓                                                      │
│  2. Clicks "Link to Transaction" button                     │
│      ↓                                                      │
│  3. TransferLinkDialog opens                                │
│      ├─ Search input                                        │
│      ├─ Relationship type selector                          │
│      └─ Notes field                                         │
│      ↓                                                      │
│  4. User searches for transaction (txn_2)                   │
│      ├─ Frontend: TransactionQuery.search(text)             │
│      └─ Backend: Query canonical_transactions               │
│      ↓                                                      │
│  5. User selects transaction from results                   │
│      ↓                                                      │
│  6. User selects relationship type                          │
│      ↓                                                      │
│  7. Frontend: Validate before submit                        │
│      ├─ Check not same transaction                          │
│      ├─ Check not already linked                            │
│      └─ Check user owns both                                │
│      ↓                                                      │
│  8. User clicks "Create Link"                               │
│      ↓                                                      │
│  9. Backend: RelationshipStore.create()                     │
│      ├─ Server-side validation                              │
│      ├─ Insert relationship record                          │
│      ├─ Log to ProvenanceLedger                             │
│      └─ Return relationship_id                              │
│      ↓                                                      │
│ 10. Frontend: Update both transaction views                 │
│      ├─ Refresh txn_1 detail (show link)                    │
│      └─ Invalidate txn_2 cache                              │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**Flow 3: FX Conversion with Rate Calculation**

```
┌─────────────────────────────────────────────────────────────┐
│                  FX Conversion Flow                         │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. TransferDetector finds candidate                        │
│      ├─ txn_1.currency = "USD"                              │
│      ├─ txn_2.currency = "MXN"                              │
│      └─ Classify as fx_conversion                           │
│      ↓                                                      │
│  2. FXConverter.calculate_rate()                            │
│      ├─ from_amount = 1000.00 USD                           │
│      ├─ to_amount = 18500.00 MXN                            │
│      └─ rate = 18500 / 1000 = 18.5                          │
│      ↓                                                      │
│  3. (Optional) Get market rate                              │
│      ├─ FXConverter.get_market_rate(date, "USD", "MXN")     │
│      └─ market_rate = 18.3 (from external API)              │
│      ↓                                                      │
│  4. Calculate FX gain/loss                                  │
│      ├─ expected = 1000 * 18.3 = 18300 MXN                  │
│      ├─ actual = 18500 MXN                                  │
│      └─ gain = +200 MXN                                     │
│      ↓                                                      │
│  5. Create relationship with fx_details                     │
│      {                                                      │
│        "type": "fx_conversion",                             │
│        "fx_details": {                                      │
│          "from_currency": "USD",                            │
│          "to_currency": "MXN",                              │
│          "from_amount": 1000.00,                            │
│          "to_amount": 18500.00,                             │
│          "exchange_rate": 18.5,                             │
│          "rate_source": "calculated",                       │
│          "market_rate": 18.3,                               │
│          "fx_gain_loss": 200.00                             │
│        }                                                    │
│      }                                                      │
│      ↓                                                      │
│  6. UI displays FXConversionCard                            │
│      ├─ Show exchange rate                                  │
│      ├─ Compare to market rate                              │
│      └─ Highlight gain/loss                                 │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

**Flow 4: Analytics Exclusion**

```
┌─────────────────────────────────────────────────────────────┐
│              Analytics Exclusion Flow                       │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  1. User opens finance dashboard                            │
│      ↓                                                      │
│  2. Frontend: DashboardEngine.get_metrics()                 │
│      ├─ Parameters: date_range, exclude_transfers=true      │
│      └─ API: GET /api/transactions?exclude_transfers=true   │
│      ↓                                                      │
│  3. Backend: Build query with exclusion                     │
│      SELECT t.*, SUM(amount) as total                       │
│      FROM canonical_transactions t                          │
│      LEFT JOIN relationships r ON (                         │
│        t.txn_id = r.txn_1_id OR t.txn_id = r.txn_2_id       │
│      )                                                      │
│      WHERE t.user_id = :user_id                             │
│        AND t.date BETWEEN :from AND :to                     │
│        AND (                                                │
│          r.relationship_id IS NULL                          │
│          OR r.type NOT IN ('transfer', 'fx_conversion')     │
│          OR r.deleted_at IS NOT NULL                        │
│        )                                                    │
│      GROUP BY ...                                           │
│      ↓                                                      │
│  4. Return metrics without transfers                        │
│      ├─ Total income: $5,000 (excludes transfers)           │
│      ├─ Total expenses: $3,000 (excludes transfers)         │
│      └─ Net: +$2,000                                        │
│      ↓                                                      │
│  5. Separate "Transfers" widget                             │
│      ├─ Query: WHERE r.type IN ('transfer', 'fx_conversion')│
│      ├─ Show transfer volume                                │
│      └─ Link to transfers report                            │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## Cross-Cutting Concerns (Sections 16-20)

### 16. Security & Privacy

**16.1 Authorization**

**Rule:** Users can only link their own transactions.

```python
@require_auth
def create_relationship(txn_1_id: str, txn_2_id: str, user_id: str):
    # Validate both transactions belong to user
    txn_1 = db.get_transaction(txn_1_id)
    txn_2 = db.get_transaction(txn_2_id)

    if txn_1.user_id != user_id or txn_2.user_id != user_id:
        raise Forbidden("Cannot link transactions you don't own")

    # Proceed with creation...
```

**16.2 Audit Trail**

**All link/unlink operations logged:**

```python
def create_relationship(...):
    rel = RelationshipStore.create(...)

    # Log to provenance ledger
    ProvenanceLedger.append({
        "event_type": "relationship_created",
        "relationship_id": rel.relationship_id,
        "txn_1_id": rel.txn_1_id,
        "txn_2_id": rel.txn_2_id,
        "type": rel.type,
        "detection_method": rel.detection_method,
        "confidence": rel.confidence,
        "user_id": user_id,
        "timestamp": now()
    })
```

**16.3 PII Handling**

- Transaction descriptions may contain PII (merchant names, notes)
- Relationships don't duplicate data, only link IDs
- Access control enforced at transaction level (inherited by relationships)

**16.4 SQL Injection Prevention**

```python
# ✅ CORRECT: Parameterized queries
db.execute("""
    SELECT * FROM relationships
    WHERE user_id = :user_id AND type = :type
""", user_id=user_id, type=rel_type)

# ❌ WRONG: String concatenation
db.execute(f"SELECT * FROM relationships WHERE user_id = '{user_id}'")
```

---

### 17. Performance & Scalability

**17.1 Query Optimization**

**Problem:** Finding transfer candidates is expensive (full table scan).

**Solution 1: Indexed Queries**

```sql
-- Index on (user_id, date, amount) for fast candidate search
CREATE INDEX idx_transfers_lookup ON canonical_transactions(
    user_id, date, amount
) WHERE deleted_at IS NULL;

-- Index on relationship lookups
CREATE INDEX idx_relationships_txn_1 ON relationships(txn_1_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_relationships_txn_2 ON relationships(txn_2_id) WHERE deleted_at IS NULL;
```

**Solution 2: Limit Search Window**

```python
# Only search recent transactions (last 30 days)
candidates = db.query("""
    SELECT * FROM canonical_transactions
    WHERE user_id = :user_id
      AND date >= :txn_date - INTERVAL '30 days'
      AND date <= :txn_date + INTERVAL '30 days'
      ...
""")
```

**17.2 Background Processing**

**Auto-detection runs asynchronously:**

```python
# After normalization completes
async def on_normalization_complete(txn_id: str):
    # Enqueue background job
    queue.enqueue(
        "detect_transfers",
        txn_id=txn_id,
        priority="low"
    )
```

**User doesn't wait for detection:**
- Normalization completes → user sees transaction immediately
- Detection runs in background → notification appears later

**17.3 Caching**

**Cache relationship lookups:**

```python
@cache(ttl=300)  # 5 minutes
def find_relationships_for_transaction(txn_id: str) -> List[Relationship]:
    return db.query("""
        SELECT * FROM relationships
        WHERE (txn_1_id = :txn_id OR txn_2_id = :txn_id)
          AND deleted_at IS NULL
    """, txn_id=txn_id)
```

**Cache invalidation:**
- Invalidate on link creation
- Invalidate on unlink operation

**17.4 Performance Targets**

| Operation | Target Latency (p95) |
|-----------|----------------------|
| Auto-detect on upload | <200ms |
| Manual link creation | <150ms |
| Unlink operation | <100ms |
| Relationship query | <50ms |
| Analytics with exclusion | <300ms |

**17.5 Database Scaling**

**Expected volume:**
- 1,000 transactions/user/year
- 20% transfer rate → 200 relationships/user/year
- 10,000 users → 2M relationships total

**Partitioning strategy:**
- Partition `relationships` table by `user_id` (user-level isolation)
- Archive old relationships (>2 years) to cold storage

---

### 18. Observability & Monitoring

**18.1 Metrics**

**Auto-Detection Metrics:**
```
transfer_detection_duration_ms (histogram)
transfer_detection_candidates_found (histogram)
transfer_detection_suggestions_shown (counter)
transfer_detection_accept_rate (gauge)
transfer_detection_dismiss_rate (gauge)
```

**Manual Link Metrics:**
```
manual_link_created (counter, label: type)
manual_link_search_duration_ms (histogram)
manual_link_validation_errors (counter, label: error_type)
```

**Relationship Metrics:**
```
relationships_total (gauge, label: type)
relationships_created_today (counter)
relationships_deleted_today (counter)
relationship_query_duration_ms (histogram)
```

**18.2 Structured Logs**

**Link Creation:**
```json
{
  "event": "relationship_created",
  "relationship_id": "rel_001",
  "txn_1_id": "txn_001",
  "txn_2_id": "txn_002",
  "type": "transfer",
  "detection_method": "auto",
  "confidence": 0.95,
  "user_id": "user_darwin",
  "timestamp": "2025-10-15T14:30:00Z"
}
```

**Unlink Operation:**
```json
{
  "event": "relationship_deleted",
  "relationship_id": "rel_001",
  "deleted_by": "user_darwin",
  "reason": "user_initiated",
  "timestamp": "2025-10-22T10:00:00Z"
}
```

**18.3 Dashboards**

**Dashboard 1: Transfer Detection Health**
- Candidate detection rate (per upload)
- Suggestion accept rate
- Average confidence score
- P95 detection latency

**Dashboard 2: User Adoption**
- % transactions linked
- Manual vs auto link ratio
- Most common relationship types

**Dashboard 3: Performance**
- Query latency by operation
- Cache hit rate
- Background job queue depth

**18.4 Alerts**

| Alert | Condition | Severity |
|-------|-----------|----------|
| Low Accept Rate | <50% suggestions accepted for 24h | Warning |
| High Latency | P95 detection latency >500ms | Warning |
| Validation Errors | >10 validation errors/hour | Critical |
| Background Queue | Queue depth >1000 jobs | Critical |

---

### 19. Testing Strategy

**19.1 Unit Tests**

**Test: Confidence Calculation**
```python
def test_calculate_transfer_confidence():
    txn_1 = Transaction(amount=-1000.00, date="2025-10-15", account_id="acc_bofa")
    txn_2 = Transaction(amount=+1000.00, date="2025-10-15", account_id="acc_wise")

    confidence = TransferDetector.calculate_confidence(txn_1, txn_2)

    assert confidence == 1.0  # Perfect match

def test_calculate_confidence_with_fee():
    txn_1 = Transaction(amount=-1000.00, date="2025-10-15", account_id="acc_bofa")
    txn_2 = Transaction(amount=+998.00, date="2025-10-15", account_id="acc_wise")  # $2 fee

    confidence = TransferDetector.calculate_confidence(txn_1, txn_2)

    assert 0.85 <= confidence <= 0.95  # High but not perfect

def test_calculate_confidence_delayed():
    txn_1 = Transaction(amount=-1000.00, date="2025-10-15", account_id="acc_bofa")
    txn_2 = Transaction(amount=+1000.00, date="2025-10-19", account_id="acc_wise")  # 4-day delay

    confidence = TransferDetector.calculate_confidence(txn_1, txn_2)

    assert 0.80 <= confidence <= 0.90  # Lower due to delay
```

**Test: FX Rate Calculation**
```python
def test_calculate_fx_rate():
    rate = FXConverter.calculate_rate(
        from_amount=1000.00,
        from_currency="USD",
        to_amount=18500.00,
        to_currency="MXN"
    )

    assert rate == Decimal("18.5000")

def test_calculate_fx_gain_loss():
    relationship = Relationship(
        fx_details={
            "from_amount": 1000.00,
            "to_amount": 18500.00,
            "from_currency": "USD",
            "to_currency": "MXN"
        }
    )

    # Mock market rate API
    with mock.patch('FXConverter.get_market_rate', return_value=18.3):
        gain_loss = FXConverter.calculate_fx_gain_loss(relationship)

    assert gain_loss == Decimal("200.00")  # 18500 - (1000 * 18.3)
```

**19.2 Integration Tests**

**Test: End-to-End Transfer Detection**
```python
def test_auto_detect_transfer_on_upload():
    # Setup: Create first transaction
    txn_1 = create_transaction(user_id="user_test", account_id="acc_bofa", amount=-1000.00, date="2025-10-15")

    # Upload second transaction
    txn_2 = create_transaction(user_id="user_test", account_id="acc_wise", amount=+1000.00, date="2025-10-15")

    # Auto-detection should run
    candidates = TransferDetector.detect_on_upload(txn_2.txn_id)

    assert len(candidates) == 1
    assert candidates[0].txn_id == txn_1.txn_id
    assert candidates[0].confidence >= 0.90

    # User accepts suggestion
    rel = RelationshipStore.create(
        txn_1_id=txn_1.txn_id,
        txn_2_id=txn_2.txn_id,
        type="transfer",
        confidence=candidates[0].confidence,
        detection_method="auto"
    )

    # Verify relationship created
    assert rel.type == "transfer"
    assert rel.confidence >= 0.90

    # Verify both transactions show link
    txn_1_rels = RelationshipStore.find_by_transaction(txn_1.txn_id)
    txn_2_rels = RelationshipStore.find_by_transaction(txn_2.txn_id)
    assert len(txn_1_rels) == 1
    assert len(txn_2_rels) == 1
    assert txn_1_rels[0].relationship_id == rel.relationship_id
```

**Test: Manual Link Creation**
```python
def test_manual_link_creation():
    # Setup: Two unrelated transactions
    txn_1 = create_transaction(user_id="user_test", amount=-47.32)
    txn_2 = create_transaction(user_id="user_test", amount=+50.00)

    # User manually links as reimbursement
    rel = RelationshipStore.create(
        txn_1_id=txn_1.txn_id,
        txn_2_id=txn_2.txn_id,
        type="reimbursement",
        confidence=None,  # Manual link
        detection_method="manual",
        notes="Employer rounds to $5"
    )

    # Verify manual link
    assert rel.type == "reimbursement"
    assert rel.confidence is None
    assert rel.detection_method == "manual"
    assert rel.notes == "Employer rounds to $5"
```

**19.3 Edge Case Tests**

**Test: Multiple Candidates**
```python
def test_multiple_transfer_candidates():
    # Setup: Three $100 transactions on same day
    txn_1 = create_transaction(account_id="acc_bofa", amount=-100.00, date="2025-10-15")
    txn_2 = create_transaction(account_id="acc_wise", amount=+100.00, date="2025-10-15")
    txn_3 = create_transaction(account_id="acc_chase", amount=+100.00, date="2025-10-15")
    txn_4 = create_transaction(account_id="acc_venmo", amount=+100.00, date="2025-10-15")

    # Detect candidates for txn_1
    candidates = TransferDetector.detect_on_upload(txn_1.txn_id)

    # Should find all three as candidates
    assert len(candidates) == 3
    assert {c.txn_id for c in candidates} == {txn_2.txn_id, txn_3.txn_id, txn_4.txn_id}
```

**Test: Already Linked**
```python
def test_prevent_duplicate_link():
    txn_1 = create_transaction(amount=-1000.00)
    txn_2 = create_transaction(amount=+1000.00)

    # Create first link
    rel_1 = RelationshipStore.create(txn_1.txn_id, txn_2.txn_id, "transfer")

    # Attempt to create duplicate
    with pytest.raises(AlreadyLinkedError):
        RelationshipStore.create(txn_1.txn_id, txn_2.txn_id, "transfer")
```

**19.4 Multi-Domain Tests**

**Healthcare: Claim-Payment Linking**
```python
def test_healthcare_claim_payment_linking():
    # Insurance claim submission
    claim = create_transaction(
        amount=-500.00,  # Claim submitted
        category="healthcare",
        description="Doctor visit claim"
    )

    # Insurance reimbursement (60 days later)
    payment = create_transaction(
        amount=+450.00,  # 90% reimbursement
        date=claim.date + timedelta(days=60),
        description="Insurance reimbursement"
    )

    # Manual link (amounts differ, large delay)
    rel = RelationshipStore.create(
        txn_1_id=claim.txn_id,
        txn_2_id=payment.txn_id,
        type="reimbursement",
        confidence=None,
        detection_method="manual"
    )

    assert rel.type == "reimbursement"
```

---

### 20. Deployment & Operations

**20.1 Database Migration**

**Migration: Create relationships table**

```sql
-- migrations/202510_create_relationships.sql

BEGIN;

CREATE TABLE relationships (
    relationship_id TEXT PRIMARY KEY DEFAULT ('rel_' || gen_random_uuid()::text),
    user_id TEXT NOT NULL,
    txn_1_id TEXT NOT NULL,
    txn_2_id TEXT NOT NULL,
    type TEXT NOT NULL CHECK (type IN ('transfer', 'fx_conversion', 'reimbursement', 'split', 'correction', 'other')),
    confidence DECIMAL(3,2) CHECK (confidence IS NULL OR (confidence >= 0 AND confidence <= 1)),
    detection_method TEXT NOT NULL CHECK (detection_method IN ('auto', 'manual')),
    fx_details JSONB,
    notes TEXT,
    linked_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
    linked_by TEXT,
    deleted_at TIMESTAMPTZ,
    deleted_by TEXT,
    FOREIGN KEY (user_id) REFERENCES users(user_id),
    FOREIGN KEY (txn_1_id) REFERENCES canonical_transactions(txn_id),
    FOREIGN KEY (txn_2_id) REFERENCES canonical_transactions(txn_id),
    FOREIGN KEY (linked_by) REFERENCES users(user_id),
    FOREIGN KEY (deleted_by) REFERENCES users(user_id),
    CHECK (txn_1_id != txn_2_id),
    CHECK ((detection_method = 'auto' AND confidence IS NOT NULL) OR (detection_method = 'manual' AND confidence IS NULL))
);

-- Indexes for fast lookups
CREATE INDEX idx_relationships_txn_1 ON relationships(txn_1_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_relationships_txn_2 ON relationships(txn_2_id) WHERE deleted_at IS NULL;
CREATE INDEX idx_relationships_user ON relationships(user_id, type) WHERE deleted_at IS NULL;
CREATE INDEX idx_relationships_confidence ON relationships(confidence DESC) WHERE deleted_at IS NULL AND detection_method = 'auto';

-- Index for analytics exclusion query
CREATE INDEX idx_relationships_analytics ON relationships(txn_1_id, txn_2_id, type) WHERE deleted_at IS NULL;

COMMIT;
```

**20.2 Background Job Configuration**

**Worker: Transfer Detection**

```yaml
# workers/transfer_detection.yml
name: transfer_detection
queue: background
concurrency: 5
max_retries: 3
timeout: 30s

jobs:
  - name: detect_on_upload
    handler: TransferDetector.detect_on_upload
    priority: low

  - name: detect_batch
    handler: TransferDetector.detect_batch
    schedule: "0 2 * * *"  # Daily at 2 AM
    priority: low
```

**20.3 Feature Flags**

```python
# Enable/disable auto-detection
FEATURE_AUTO_TRANSFER_DETECTION = env.bool("FEATURE_AUTO_TRANSFER_DETECTION", default=True)

# Confidence threshold
TRANSFER_CONFIDENCE_THRESHOLD = env.float("TRANSFER_CONFIDENCE_THRESHOLD", default=0.50)

# Enable FX conversion tracking
FEATURE_FX_CONVERSION = env.bool("FEATURE_FX_CONVERSION", default=True)
```

**20.4 Rollout Strategy**

**Phase 1: Dark Launch (Week 1)**
- Deploy relationship table and primitives
- Run auto-detection in background (don't show suggestions)
- Monitor metrics: detection rate, confidence distribution

**Phase 2: Beta Launch (Week 2-3)**
- Enable suggestions for 10% of users
- Collect accept/dismiss rates
- Gather user feedback

**Phase 3: Full Launch (Week 4)**
- Enable for all users
- Monitor performance and error rates
- Iterate based on feedback

**20.5 Monitoring Checklist**

Pre-launch:
- ✅ Database migration successful
- ✅ Indexes created
- ✅ Background workers running
- ✅ Metrics dashboard deployed
- ✅ Alerts configured

Post-launch:
- ✅ Monitor accept rate (target: ≥70%)
- ✅ Monitor false positive rate (target: <10%)
- ✅ Monitor query performance (target: p95 <200ms)
- ✅ Monitor background job queue (target: <100 pending)

**20.6 Rollback Plan**

If critical issues arise:

1. **Disable auto-detection:**
   ```python
   # Set feature flag
   FEATURE_AUTO_TRANSFER_DETECTION = False
   ```

2. **Keep manual linking enabled:**
   - Users can still manually link transactions
   - Existing relationships remain intact

3. **Fix and re-deploy:**
   - Auto-detection re-enabled after fix
   - Re-process recent transactions if needed

---

## Summary

**Vertical 3.5 Relationships** provides **transaction-to-transaction linking** for finance applications:

**Key Features:**
- ✅ Auto-detect transfers (same amount, opposite accounts, ±3 days)
- ✅ FX conversion tracking with exchange rates
- ✅ Manual link creation for edge cases
- ✅ Confidence scoring (0.0 to 1.0)
- ✅ Analytics exclusion (prevent double-counting)
- ✅ Relationship types: transfer, fx_conversion, reimbursement, split, correction, other

**Primitives Delivered:**
- **RelationshipStore** (OL) - CRUD for transaction relationships
- **TransferDetector** (OL) - Auto-detect transfer pairs
- **FXConverter** (OL) - Calculate exchange rates and FX gain/loss
- **RelationshipMatcher** (OL) - Fuzzy matching with configurable thresholds
- **RelationshipPanel** (IL) - Display linked transactions in detail view
- **TransferLinkDialog** (IL) - Manual link creation UI
- **FXConversionCard** (IL) - FX conversion details display

**Multi-Domain Pattern: Paired Record Linking + Confidence Scoring**

This pattern applies universally:
- **Finance:** Transfer detection, FX conversion
- **Healthcare:** Claim ↔ Payment, Referral ↔ Visit
- **Legal:** Case relationships, Document versions
- **Research:** Citation networks, Dataset lineage
- **E-commerce:** Order ↔ Return, Refund ↔ Payment

**Performance Targets:**
- Auto-detect: <200ms p95
- Manual link: <150ms p95
- Relationship query: <50ms p95
- Analytics exclusion: <300ms p95

**Next Vertical:** 3.6 Unit (currency/date normalization)
