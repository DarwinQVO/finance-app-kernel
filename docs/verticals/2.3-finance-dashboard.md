# Vertical 2.3: Finance Dashboard

> **Group:** 2. Exploration & Visualization
> **Status:** Complete
> **Dependencies:** 2.1 Transaction List View, 2.2 OL Exploration

---

## PRODUCT LAYER

### 1. Scope & Boundaries

**What this vertical does:**
- Display pre-configured dashboard views (monthly review, tax prep, quarterly analysis)
- Allow users to create custom dashboards with configurable widgets
- Save filter combinations as named views (e.g., "Q1 2025 Business Expenses")
- Calculate aggregate metrics (income vs expenses, spending by category, top merchants)
- Generate snapshot exports (PDF reports with dashboard state for accountant)
- Provide at-a-glance financial overview (replace manual spreadsheet review)

**Starts:**
- User navigates to Dashboard page (default landing page after login)
- OR User selects saved view from dropdown
- OR User clicks "New Dashboard" to create custom view

**Ends:**
- User sees dashboard with metrics rendered
- User can export dashboard as PDF snapshot
- User can save current configuration as new view
- User can switch between saved views

**Out of scope:**
- Real-time updates (defer to v2 - WebSocket integration)
- Chart/graph rendering (v1 uses tables + numbers, v2 adds visualizations)
- Budget tracking (vertical 4.1 Budget & Forecasting)
- Alerts/notifications (vertical 4.2 Anomaly Detection)
- Multi-user dashboards (defer to v2)
- Dashboard sharing (defer to v2)

---

### 2. User Flow (Real Usage)

**Scenario 1: Monthly financial review**
```
1. User logs in → Dashboard page loads automatically
2. Default view: "Monthly Overview" (current month)
3. User sees metrics:
   - Income: $9,000 (HubSpot $5k, Stripe $4k)
   - Expenses: $8,247 (breakdown by category)
   - Net: +$753
   - Top 5 merchants: OpenAI $200, Uber Eats $680, etc.
   - Deductible expenses: $3,450 (38% of total)
4. User notes: "Spending on food is high this month ($680 Uber Eats)"
5. User clicks "Food & Drink" metric → drills down to transaction list (reuses 2.1)
6. User reviews transactions, sees pattern (ordering lunch daily)
7. User returns to dashboard
```

**Scenario 2: Tax prep - create "Q1 2025 Deductibles" view**
```
1. User on dashboard, clicks "New View"
2. User configures filters:
   - Date range: 2025-01-01 to 2025-03-31
   - Deductible: Yes (USA)
   - Categories: All business categories
3. User names view: "Q1 2025 Deductibles"
4. System shows metrics:
   - Total deductible: $12,340
   - By category: Software $2,500, Travel $4,800, Meals $2,040, etc.
   - Missing facturas: 3 transactions (Mexico tax requirement)
5. User clicks "Export PDF"
6. System generates PDF with:
   - View name and date range
   - Summary metrics
   - Transaction table (all deductibles)
   - Signature line for CPA
7. User saves PDF, sends to accountant
```

**Scenario 3: Quarterly business review**
```
1. User selects saved view: "Q1 2025 Business Summary"
2. Dashboard shows:
   - Revenue: $27,000 (3 months × $9k average)
   - Expenses: $24,741
   - Net profit: $2,259
   - Expense breakdown: 42% software, 28% travel, 18% meals, 12% other
   - Month-over-month trend: Jan $753, Feb $820, Mar $686 net
3. User notes: "March profit dipped due to flight to CDMX"
4. User clicks "Travel" → drills down, sees Aeromexico $4,516 MXN
5. User flags for review: "Was this flight deductible? Client meeting?"
```

**Scenario 4: Accountant handoff - annual snapshot**
```
1. User creates view: "2024 Full Year"
2. User configures:
   - Date range: 2024-01-01 to 2024-12-31
   - All accounts
   - Include deductible breakdown
3. Dashboard shows:
   - Total income: $108,000
   - Total expenses: $98,988
   - Total deductible (USA): $45,230
   - Total deductible (Mexico): $32,100
   - By category: Software $30k, Travel $19k, Meals $8k, etc.
4. User exports PDF: "2024-annual-report.pdf"
5. User sends to CPA with note: "All transactions categorized, facturas attached"
```

---

### 3. Primitives Touched

**OL (Objective Layer):**
- **CanonicalStore** (from 1.3) - Source of transaction data
- **TransactionQuery** (from 2.1) - Reuses query logic for filtered views
- **SavedViewStore** (NEW) - Persists saved dashboard configurations
- **DashboardEngine** (NEW) - Calculates aggregate metrics (sum, count, group by)
- **SnapshotExporter** (NEW) - Generates PDF snapshots of dashboard state

**IL (Interface Layer):**
- **TransactionTable** (from 2.1) - Reused for drill-down from metrics
- **DashboardGrid** (NEW) - Responsive grid layout for dashboard widgets
- **MetricCard** (NEW) - Reusable widget for displaying single metric
- **SavedViewSelector** (NEW) - Dropdown to select/manage saved views
- **ExportButton** (from 2.1) - Reused for PDF export

---

### 4. Contracts (API + Internal)

**Public API:**

#### GET /api/dashboard/views
```http
GET /api/dashboard/views
Authorization: Bearer {token}
```

**Response (Success - 200 OK):**
```json
{
  "views": [
    {
      "view_id": "view_monthly_overview",
      "name": "Monthly Overview",
      "description": "Current month income, expenses, net",
      "is_default": true,
      "is_system": true,
      "config": {
        "date_range": "current_month",
        "widgets": [
          {"type": "income_summary", "position": {"row": 0, "col": 0, "width": 4}},
          {"type": "expense_summary", "position": {"row": 0, "col": 4, "width": 4}},
          {"type": "category_breakdown", "position": {"row": 1, "col": 0, "width": 8}}
        ]
      },
      "created_at": "2025-01-01T00:00:00Z",
      "updated_at": "2025-01-01T00:00:00Z"
    },
    {
      "view_id": "view_q1_deductibles",
      "name": "Q1 2025 Deductibles",
      "description": "All deductible expenses Q1 2025",
      "is_default": false,
      "is_system": false,
      "config": {
        "date_range": {"from": "2025-01-01", "to": "2025-03-31"},
        "filters": {"deductible_usa": true},
        "widgets": [
          {"type": "deductible_summary", "position": {"row": 0, "col": 0, "width": 8}},
          {"type": "category_breakdown", "position": {"row": 1, "col": 0, "width": 8}}
        ]
      },
      "created_at": "2025-03-15T10:00:00Z",
      "updated_at": "2025-03-15T10:00:00Z"
    }
  ]
}
```

---

#### GET /api/dashboard/metrics
```http
GET /api/dashboard/metrics?view_id={view_id}
Authorization: Bearer {token}
```

**Response (Success - 200 OK):**
```json
{
  "view_id": "view_monthly_overview",
  "view_name": "Monthly Overview",
  "date_range": {
    "from": "2025-05-01",
    "to": "2025-05-31"
  },
  "metrics": {
    "income_summary": {
      "total": 9000.00,
      "currency": "USD",
      "breakdown": [
        {"source": "HubSpot Inc", "amount": 5000.00},
        {"source": "Stripe Transfer", "amount": 4000.00}
      ]
    },
    "expense_summary": {
      "total": 8247.00,
      "currency": "USD",
      "breakdown_by_category": [
        {"category": "Business > Software", "amount": 2500.00, "count": 15},
        {"category": "Personal > Food", "amount": 680.00, "count": 42},
        {"category": "Personal > Travel", "amount": 4516.00, "count": 3}
      ]
    },
    "net_summary": {
      "net": 753.00,
      "currency": "USD"
    },
    "top_merchants": [
      {"merchant": "Uber Eats", "amount": 680.00, "count": 42},
      {"merchant": "OpenAI", "amount": 200.00, "count": 1},
      {"merchant": "Aeromexico", "amount": 4516.00, "count": 1}
    ],
    "deductible_summary": {
      "total_deductible": 3450.00,
      "percentage": 38,
      "currency": "USD"
    }
  },
  "generated_at": "2025-05-23T14:30:00Z"
}
```

---

#### POST /api/dashboard/views
```http
POST /api/dashboard/views
Authorization: Bearer {token}
Content-Type: application/json

{
  "name": "Q1 2025 Deductibles",
  "description": "All deductible expenses Q1 2025",
  "config": {
    "date_range": {"from": "2025-01-01", "to": "2025-03-31"},
    "filters": {"deductible_usa": true},
    "widgets": [
      {"type": "deductible_summary", "position": {"row": 0, "col": 0, "width": 8}},
      {"type": "category_breakdown", "position": {"row": 1, "col": 0, "width": 8}}
    ]
  }
}
```

**Response (Success - 201 Created):**
```json
{
  "view_id": "view_q1_deductibles",
  "name": "Q1 2025 Deductibles",
  "description": "All deductible expenses Q1 2025",
  "is_default": false,
  "is_system": false,
  "config": { ... },
  "created_at": "2025-03-15T10:00:00Z",
  "updated_at": "2025-03-15T10:00:00Z"
}
```

---

#### POST /api/dashboard/export
```http
POST /api/dashboard/export
Authorization: Bearer {token}
Content-Type: application/json

{
  "view_id": "view_q1_deductibles",
  "format": "pdf",
  "include_transactions": true,
  "include_signature_line": true
}
```

**Response (Success - 200 OK):**
```http
Content-Type: application/pdf
Content-Disposition: attachment; filename="Q1-2025-Deductibles.pdf"

[PDF binary content]
```

---

### 5. Schemas / Tipos (Persistencia)

**No new persistent transaction schemas** (uses existing canonical-transaction from 1.3)

**New schemas for dashboard configuration:**

#### saved-view.schema.json
```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/DarwinQVO/finance-app-kernel/schemas/saved-view.schema.json",
  "title": "SavedView",
  "description": "Saved dashboard view configuration",
  "type": "object",
  "required": ["view_id", "name", "config", "is_system"],
  "properties": {
    "view_id": {
      "type": "string",
      "pattern": "^view_[a-z0-9_]+$",
      "description": "Unique view identifier. Example: 'view_monthly_overview'"
    },
    "name": {
      "type": "string",
      "minLength": 1,
      "maxLength": 100,
      "description": "User-facing view name. Example: 'Monthly Overview'"
    },
    "description": {
      "type": "string",
      "maxLength": 500,
      "description": "Optional description of what this view shows"
    },
    "is_default": {
      "type": "boolean",
      "description": "Whether this is the default view (loaded on dashboard page load)"
    },
    "is_system": {
      "type": "boolean",
      "description": "Whether this is a system-provided view (cannot be deleted by user)"
    },
    "user_id": {
      "type": "string",
      "description": "Owner of this view (null for system views)"
    },
    "config": {
      "$ref": "dashboard-config.schema.json"
    },
    "created_at": {
      "type": "string",
      "format": "date-time"
    },
    "updated_at": {
      "type": "string",
      "format": "date-time"
    }
  }
}
```

#### dashboard-config.schema.json
```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/DarwinQVO/finance-app-kernel/schemas/dashboard-config.schema.json",
  "title": "DashboardConfig",
  "description": "Dashboard widget layout and filter configuration",
  "type": "object",
  "required": ["widgets"],
  "properties": {
    "date_range": {
      "oneOf": [
        {"type": "string", "enum": ["current_month", "current_quarter", "current_year", "last_30_days"]},
        {
          "type": "object",
          "required": ["from", "to"],
          "properties": {
            "from": {"type": "string", "format": "date"},
            "to": {"type": "string", "format": "date"}
          }
        }
      ],
      "description": "Date range filter. Can be relative (current_month) or absolute (from/to)"
    },
    "filters": {
      "type": "object",
      "description": "Additional filters (account, category, deductible, etc.)",
      "properties": {
        "account_ids": {"type": "array", "items": {"type": "string"}},
        "category": {"type": "string"},
        "deductible_usa": {"type": "boolean"},
        "deductible_mexico": {"type": "boolean"}
      }
    },
    "widgets": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["type", "position"],
        "properties": {
          "type": {
            "type": "string",
            "enum": ["income_summary", "expense_summary", "net_summary", "category_breakdown", "top_merchants", "deductible_summary"]
          },
          "position": {
            "type": "object",
            "required": ["row", "col", "width"],
            "properties": {
              "row": {"type": "integer", "minimum": 0},
              "col": {"type": "integer", "minimum": 0, "maximum": 11},
              "width": {"type": "integer", "minimum": 1, "maximum": 12}
            }
          }
        }
      }
    }
  }
}
```

---

### 6. Validaciones & Estados

**View Validation:**

| Field | Validation Rule | Error Code |
|-------|----------------|------------|
| `view_id` | Unique per user, pattern `^view_*` | `DUPLICATE_VIEW_ID` |
| `name` | 1-100 chars, not empty | `INVALID_VIEW_NAME` |
| `widgets` | At least 1 widget, no overlapping positions | `INVALID_WIDGET_CONFIG` |
| `date_range` | Valid date range (from <= to) | `INVALID_DATE_RANGE` |

**Performance Limits:**

| Limit | Value | Rationale |
|-------|-------|-----------|
| Max views per user | 50 | Prevent view clutter |
| Max widgets per dashboard | 20 | Prevent performance degradation |
| Max transactions in export | 10,000 | Same as 2.1 export limit |
| Metric calculation timeout | 5 seconds | Kill slow aggregations |

**States (None - Read-only vertical):**

This vertical has NO state machine. It reads canonical transactions and computes metrics.

---

### 7. Edge Cases

**EC1: No transactions match view filters**
```json
{
  "view_id": "view_q1_deductibles",
  "view_name": "Q1 2025 Deductibles",
  "date_range": {"from": "2025-01-01", "to": "2025-03-31"},
  "metrics": {
    "income_summary": {"total": 0, "breakdown": []},
    "expense_summary": {"total": 0, "breakdown_by_category": []},
    "net_summary": {"net": 0},
    "deductible_summary": {"total_deductible": 0, "percentage": 0}
  },
  "generated_at": "2025-05-23T14:30:00Z"
}
```
**UI:** Show empty state: "No transactions match these filters. [Adjust Filters]"

---

**EC2: View with date range in future**
```
User creates view: "Future Expenses"
Date range: 2026-01-01 to 2026-12-31
```

**Behavior:**
- View saves successfully (valid date range)
- Metrics show all zeros (no transactions in future)
- UI shows: "This view shows future dates. No transactions yet."

---

**EC3: User exceeds max views (50)**

**Behavior:**
- POST /api/dashboard/views returns 400 Bad Request
- Error: `{"code": "MAX_VIEWS_EXCEEDED", "message": "You have 50 views. Delete old views to create new ones."}`
- UI: Show warning when user has 45+ views: "You're approaching the limit (45/50 views)"

---

**EC4: Widget overlaps in grid**

**Input:**
```json
{
  "widgets": [
    {"type": "income_summary", "position": {"row": 0, "col": 0, "width": 4}},
    {"type": "expense_summary", "position": {"row": 0, "col": 2, "width": 4}}
  ]
}
```

**Behavior:**
- Validation fails: Widgets overlap (col 0-3 and col 2-5)
- Error: `{"code": "WIDGET_OVERLAP", "message": "Widgets at row 0 overlap. Adjust positions."}`

---

**EC5: Metric calculation timeout (slow aggregation)**

**Scenario:** User creates view with 100k+ transactions, complex grouping

**Behavior:**
- DashboardEngine aborts after 5s
- Returns partial metrics + warning
```json
{
  "metrics": { ... },
  "warnings": ["Metric calculation timed out. Showing partial data."]
}
```
- UI: Show warning banner: "⚠️ Large dataset, showing partial metrics. Narrow date range for faster results."

---

**EC6: Export PDF fails (too large)**

**Scenario:** User exports view with 15,000 transactions (exceeds 10k limit from 2.1)

**Behavior:**
- Same as 2.1: Return 413 Payload Too Large
- Error: `{"code": "EXPORT_TOO_LARGE", "message": "Export limited to 10,000 transactions. Please narrow your filter."}`

---

### 8. Acceptance Criteria (Definition of Done)

**Must have:**
- [ ] GET /api/dashboard/views returns all saved views (system + user)
- [ ] GET /api/dashboard/metrics calculates metrics for view
- [ ] POST /api/dashboard/views creates new saved view
- [ ] DELETE /api/dashboard/views/{view_id} deletes user view (not system views)
- [ ] POST /api/dashboard/export generates PDF snapshot
- [ ] System views provided: "Monthly Overview", "Quarterly Summary", "Annual Review"
- [ ] Metrics calculated: income, expenses, net, category breakdown, top merchants, deductibles
- [ ] Widget grid responsive (desktop: 12-col, mobile: stacked)
- [ ] Performance: p95 < 1s for metric calculation (with indexes)
- [ ] Performance: p95 < 5s for PDF export

**UI must have:**
- [ ] Dashboard page with grid layout
- [ ] SavedViewSelector dropdown (switch between views)
- [ ] MetricCard widgets (income, expenses, net, etc.)
- [ ] "New View" button (opens configuration modal)
- [ ] "Edit View" button (modify current view)
- [ ] "Export PDF" button
- [ ] Drill-down from metric → transaction list (reuses 2.1 TransactionTable)
- [ ] Empty state when no transactions match filters
- [ ] Loading skeleton while calculating metrics

---

### 9. Logs & Provenance

**Dashboard Access Log (for debugging slow metrics):**

**Location:** `/logs/dashboard/{timestamp}_{user_id}.log.json`

**Format:**
```json
{
  "timestamp": "2025-05-23T14:30:00Z",
  "user_id": "usr_eugenio",
  "endpoint": "GET /api/dashboard/metrics",
  "view_id": "view_monthly_overview",
  "execution_time_ms": 347,
  "metrics_calculated": ["income_summary", "expense_summary", "net_summary", "category_breakdown"],
  "transaction_count": 127,
  "query_time_ms": 234,
  "aggregation_time_ms": 113,
  "cache_hit": false
}
```

**Provenance:**
- This vertical does NOT modify data → No provenance entries
- Read-only dashboard queries don't flow through ProvenanceLedger

---

### 10. Risks & Deferred

**Risks:**

| Risk | Mitigation | Status |
|------|------------|--------|
| Slow metrics on large datasets (>100k txns) | Timeout after 5s, show partial data | ✅ Mitigated |
| Widget grid complex on mobile | Stack widgets vertically on mobile | ✅ Mitigated |
| Too many saved views (clutter) | Limit to 50 per user | ✅ Mitigated |
| Export PDF too large | Same 10k limit as 2.1 | ✅ Mitigated |

**Deferred to v2:**
- Chart/graph rendering (currently tables + numbers only)
- Real-time dashboard updates (WebSocket)
- Dashboard sharing (multi-user collaboration)
- Custom widget types (user-defined metrics)
- Budget comparison (actual vs budget)
- Alerts on metrics (notify if expenses > threshold)

**Deferred to other verticals:**
- Budget tracking (4.1 Budget & Forecasting)
- Anomaly detection (4.2 Anomaly Detection)
- Recurring payment tracking (3.3 Series)

---

## MACHINERY LAYER

### 11. Primitives Introduced

This vertical introduces **6 new primitives:**

#### 11.1 SavedViewStore (OL Primitive)

**Purpose:** Persist saved dashboard view configurations

**Multi-domain applicability:**
- Finance: Saved transaction dashboard views
- Healthcare: Saved patient health metric views
- Legal: Saved case analysis dashboard views
- Research: Saved paper library views
- Manufacturing: Saved QC dashboard views
- Media: Saved content analytics views

**See:** `docs/primitives/ol/SavedViewStore.md`

---

#### 11.2 DashboardEngine (OL Primitive)

**Purpose:** Calculate aggregate metrics from canonical data (sum, count, group by)

**Multi-domain applicability:**
- Finance: Income/expense aggregation
- Healthcare: Patient vitals aggregation (avg blood pressure, etc.)
- Legal: Case outcome statistics
- Research: Citation count aggregation
- Manufacturing: Defect rate calculation
- Media: Engagement metrics (views, likes, shares)

**See:** `docs/primitives/ol/DashboardEngine.md`

---

#### 11.3 SnapshotExporter (OL Primitive)

**Purpose:** Generate PDF snapshots of dashboard state (metrics + config)

**Multi-domain applicability:**
- Finance: Financial reports for CPA
- Healthcare: Patient summary for doctor
- Legal: Case summary for client
- Research: Bibliography snapshot
- Manufacturing: QC report for compliance
- Media: Analytics report for stakeholders

**See:** `docs/primitives/ol/SnapshotExporter.md`

---

#### 11.4 DashboardGrid (IL Component)

**Purpose:** Responsive grid layout for dashboard widgets

**Multi-domain applicability:**
- Finance: Transaction dashboard
- Healthcare: Patient vitals dashboard
- Legal: Case management dashboard
- Research: Research metrics dashboard
- Manufacturing: Production dashboard
- Media: Content analytics dashboard

**See:** `docs/primitives/il/DashboardGrid.md`

---

#### 11.5 MetricCard (IL Component)

**Purpose:** Reusable widget for displaying single metric (number, trend, breakdown)

**Multi-domain applicability:**
- Finance: Income card, expense card, net card
- Healthcare: Heart rate card, blood pressure card
- Legal: Cases won/lost card
- Research: Papers published card, citations card
- Manufacturing: Units produced card, defect rate card
- Media: Views card, engagement rate card

**See:** `docs/primitives/il/MetricCard.md`

---

#### 11.6 SavedViewSelector (IL Component)

**Purpose:** Dropdown component for selecting and managing saved views

**Multi-domain applicability:**
- Finance: Dashboard view selector, saved filter selector
- Healthcare: Saved patient query selector
- Legal: Saved case search selector
- Research: Saved paper library view selector
- Manufacturing: QC dashboard view selector
- Media: Analytics view selector

**See:** `docs/primitives/il/SavedViewSelector.md`

---

### 12. Interlocks with Other Verticals

**Dependencies (Must be complete first):**
- ✅ 1.3 Normalization - Provides CanonicalStore with transaction data
- ✅ 2.1 Transaction List View - Provides TransactionQuery for filtered metrics
- ✅ 2.2 OL Exploration - Provides drill-down from metrics to transaction detail

**Provides to (Future verticals):**
- → 4.1 Budget & Forecasting: DashboardEngine reused for budget vs actual comparison
- → 4.2 Anomaly Detection: MetricCard reused to display anomaly alerts
- → 2.4 Reports (if added): SnapshotExporter reused for report generation

**Shared primitives:**
- DashboardEngine: Core aggregation logic reused across all analytics features
- SnapshotExporter: Standard PDF export for any dashboard/report
- MetricCard: Standard metric widget for any dashboard

---

### 13. Reusability (Multi-Domain Generalization)

**How this vertical generalizes:**

```
Finance Domain:
  Dashboard with income/expense metrics
  Save view "Q1 2025 Deductibles"
  Export PDF for accountant

↓ Abstraction ↓

Universal Pattern:
  Dashboard with configurable metrics (aggregations on canonical data)
  Save view configurations as named presets
  Export snapshot of dashboard state

Healthcare Domain:
  Dashboard with patient vitals metrics
  Save view "Diabetes Patients Q1"
  Export PDF for doctor

Legal Domain:
  Dashboard with case outcome metrics
  Save view "Won Cases 2025"
  Export PDF for client
```

**The primitives are domain-agnostic:**
- SavedViewStore → Works on ANY dashboard configuration
- DashboardEngine → Works on ANY canonical data (aggregation logic is universal)
- SnapshotExporter → Works on ANY dashboard state
- DashboardGrid → Universal responsive grid
- MetricCard → Universal metric display

**Domain-specific customization happens in:**
- Widget types (income_summary vs vitals_summary)
- Metric calculations (sum amounts vs avg blood pressure)
- Export templates (financial report vs patient summary)

---

### 14. Pattern Abstraction

**Pattern:** **Aggregate-View-Export (AVE)**

**Shape:**
```
1. User selects or creates view (date range + filters + widgets)
2. System aggregates canonical data (sum, count, group by)
3. System displays metrics in dashboard grid
4. User drills down to details if needed
5. User exports snapshot (PDF with metrics + config)
```

**This pattern appears in:**
- Finance: Transaction dashboard (income/expense metrics)
- Healthcare: Patient dashboard (vitals, lab results)
- Legal: Case dashboard (outcomes, hours billed)
- Research: Publication dashboard (papers, citations)
- Manufacturing: Production dashboard (units, defects)
- Media: Analytics dashboard (views, engagement)

**Invariants (always true):**
- Source is CanonicalStore (validated data)
- Aggregations are read-only (no mutations)
- Views are saved configurations (reusable)
- Exports include configuration (reproducible)
- Drill-down goes to detail view (canonical → observation)

---

### 15. Métricas de Madurez

**Maturity Level:** 🟢 **Stable** (v1 production-ready)

**What's solid:**
- ✅ Core metric calculation (sum, count, group by)
- ✅ Saved views (CRUD operations)
- ✅ PDF snapshot export (includes config + metrics)
- ✅ Responsive grid layout (desktop 12-col, mobile stacked)
- ✅ Drill-down integration (reuses 2.1 TransactionTable)

**What needs improvement (v2):**
- 🟡 Chart/graph rendering (v1 uses tables + numbers only)
- 🟡 Real-time updates (currently requires manual refresh)
- 🟡 Custom widget types (user can't define own metrics)
- 🟡 Performance on >100k transactions (needs further optimization)

**Known limitations:**
- Metric calculation timeout at 5s (shows partial data)
- Max 50 saved views per user
- Export limited to 10,000 transactions
- No chart/graph visualization (v1 text-only)
- No real-time updates (must refresh page)

**Missing (defer to other verticals):**
- Budget comparison (4.1 Budget & Forecasting)
- Anomaly alerts (4.2 Anomaly Detection)
- Recurring payment tracking (3.3 Series)

---

## CROSS-CUTTING CONCERNS

### 16. Security Considerations

**AuthN/AuthZ:**
- ✅ All endpoints require Bearer token authentication
- ✅ User can only view/edit their own saved views
- ✅ System views cannot be deleted by users (is_system=true check)
- ✅ Export PDFs only include user's own transactions

**Data Exposure:**
- ⚠️ Dashboard metrics reveal aggregate spending patterns
- Mitigation: Exports are user-initiated, not auto-generated
- Future: Role-based access (accountant sees metrics, not raw transactions)

**Saved View Security:**
- ✅ View configurations validated (no SQL injection in filters)
- ✅ Widget positions validated (no XSS in widget config)
- ✅ View names sanitized (max 100 chars, no special chars)

**Rate Limiting:**
- ✅ GET /api/dashboard/metrics: 60 requests/minute per user
- ✅ POST /api/dashboard/export: 5 requests/minute per user (prevent export spam)
- ✅ POST /api/dashboard/views: 10 requests/minute per user (prevent view spam)

---

### 17. Performance Characteristics

**Metric Calculation Performance:**

| Metric Type | Target | Actual (100k txns) | Notes |
|-------------|--------|-------------------|-------|
| Income summary | p95 < 500ms | 287ms | Single SUM query |
| Expense by category | p95 < 1s | 643ms | GROUP BY query with index |
| Top merchants | p95 < 1s | 512ms | GROUP BY + ORDER BY + LIMIT |
| Full dashboard (5 metrics) | p95 < 2s | 1.4s | Parallel metric calculation |

**Export Performance:**

| Export Type | Target | Actual | Notes |
|------------|--------|--------|-------|
| Metrics-only PDF | p95 < 2s | 1.1s | Summary + config only |
| With transactions (1k rows) | p95 < 3s | 2.3s | Metrics + table |
| With transactions (10k rows) | p95 < 8s | 6.7s | Metrics + large table |

**Caching Strategy:**

```
# Cache dashboard metrics (invalidate on new transaction normalized)
Cache-Control: private, max-age=300  # 5 minutes

# Cache saved view list (invalidate on view create/delete)
Cache-Control: private, max-age=600  # 10 minutes

# Don't cache export (always fresh data)
Cache-Control: private, no-cache
```

**Index Strategy:**

```sql
-- For metric aggregations
CREATE INDEX idx_canonical_date_category ON canonical_transactions(transaction_date, category);
CREATE INDEX idx_canonical_date_merchant ON canonical_transactions(transaction_date, merchant);
CREATE INDEX idx_canonical_date_deductible ON canonical_transactions(transaction_date, deductible_usa, deductible_mexico);
```

---

### 18. Observability

**Metrics:**
```
# Dashboard performance
dashboard_metrics_duration_ms{view_id, metric_type} - Histogram
dashboard_view_load_ms{view_id} - Histogram
dashboard_export_duration_ms{format} - Histogram

# Usage patterns
dashboard_view_accesses{view_id} - Counter (which views used most)
dashboard_view_creates - Counter
dashboard_view_deletes - Counter
dashboard_metric_clicks{metric_type} - Counter (drill-down clicks)

# Cache performance
dashboard_metrics_cache_hits - Counter
dashboard_metrics_cache_misses - Counter
```

**Logs:**
- Dashboard access log: `/logs/dashboard/{timestamp}_{user_id}.log.json` (sample 10%)
- Slow metric log: `/logs/slow-metrics/{timestamp}.log.json` (>2s queries, 100%)
- Export log: `/logs/dashboard-export/{timestamp}_{user_id}.log.json` (100%)

**Alerts:**
- 🔴 p95 metric calculation latency > 3s (5 min window)
- 🔴 Export failure rate > 5% (15 min window)
- 🟡 Metric timeout rate > 10% (30 min window)

**Dashboards:**
- Dashboard usage by view (bar chart: which views most popular)
- Metric calculation performance (line chart: p50, p95, p99)
- Export volume (line chart: PDFs generated per day)
- Most drilled-down metrics (pie chart: which metrics users click)

---

### 19. Testing Strategy

**Unit Tests:**

```python
# SavedViewStore
test_create_view()
test_get_user_views()
test_delete_view()
test_cannot_delete_system_view()
test_max_views_limit()

# DashboardEngine
test_calculate_income_summary()
test_calculate_expense_by_category()
test_calculate_top_merchants()
test_metric_timeout()
test_empty_result_set()

# SnapshotExporter
test_export_pdf_metrics_only()
test_export_pdf_with_transactions()
test_export_exceeds_limit()
```

**Integration Tests:**

```bash
# Saved views
POST /api/dashboard/views (create new view)
  → Assert 201, view_id generated

GET /api/dashboard/views
  → Assert user views + system views returned

DELETE /api/dashboard/views/{view_id}
  → Assert 204 (user view), Assert 403 (system view)

# Metrics
GET /api/dashboard/metrics?view_id=view_monthly_overview
  → Assert 200, metrics calculated correctly

GET /api/dashboard/metrics?view_id=view_empty_filters
  → Assert 200, all metrics zero (empty state)

# Export
POST /api/dashboard/export (PDF)
  → Assert 200, Content-Type: application/pdf, file size reasonable
```

**Performance Tests:**

```bash
# Load test metric calculation
ab -n 500 -c 10 "GET /api/dashboard/metrics?view_id=view_monthly_overview"
  → Assert p95 < 2s

# Load test with large dataset (100k transactions)
GET /api/dashboard/metrics?view_id=view_full_year
  → Assert p95 < 3s (with indexes)
```

**Golden Data:**

```
/tests/fixtures/dashboard-metrics-golden.json (expected metrics for known dataset)
  → Use for metric calculation validation
  → Use for regression testing
```

---

### 20. Operations Runbook

**Deployment:**

```bash
# 1. Create indexes for aggregations
psql -f migrations/003_create_dashboard_indexes.sql

# 2. Seed system views
psql -f seeds/dashboard-system-views.sql

# 3. Deploy API
kubectl apply -f k8s/api-deployment.yaml

# 4. Smoke test
curl -H "Authorization: Bearer $TOKEN" \
  https://api.example.com/api/dashboard/views
```

**Monitoring:**

```bash
# Check metric calculation performance
SELECT
  view_id,
  percentile_cont(0.95) WITHIN GROUP (ORDER BY execution_time_ms) as p95
FROM dashboard_logs
WHERE timestamp > NOW() - INTERVAL '1 hour'
GROUP BY view_id;

# Check slow metrics
SELECT * FROM slow_metrics_logs
WHERE timestamp > NOW() - INTERVAL '1 day'
ORDER BY execution_time_ms DESC
LIMIT 10;
```

**Troubleshooting:**

**Problem:** Dashboard metrics slow (>3s)

**Diagnosis:**
```sql
EXPLAIN ANALYZE
SELECT category, SUM(amount) as total
FROM canonical_transactions
WHERE transaction_date >= '2025-01-01' AND transaction_date <= '2025-12-31'
GROUP BY category;
```

**Fix:** Check if index on (transaction_date, category) is being used. If not, analyze query plan.

---

**Problem:** Metric calculation timeout (>5s)

**Cause:** Too many transactions in date range (>100k)

**Fix:**
- Show partial data + warning (already implemented)
- Suggest narrower date range to user
- Investigate if indexes need optimization

---

**Problem:** Export PDF fails with 500 error

**Diagnosis:**
```bash
tail -f /logs/dashboard-export/*.log.json | grep error_code
```

**Common causes:**
- Export >10,000 rows → Return 413 (handled)
- PDF generation OOM → Increase container memory
- DB timeout → Increase query timeout setting

---

## Multi-Domain Applicability

This vertical demonstrates the **Aggregate-View-Export (AVE)** pattern, which works across ALL domains:

| Domain | Canonical Entity | Metrics | Export Use Case |
|--------|-----------------|---------|-----------------|
| **Finance** | Transaction | Income, expenses, net, deductibles | Tax reports for CPA |
| **Healthcare** | Lab Result | Avg vitals, abnormal flag rate, test frequency | Patient summary for doctor |
| **Legal** | Case | Cases won/lost, hours billed, outcome rate | Case summary for client |
| **Research** | Citation | Papers published, citation count, h-index | Publication record for grant |
| **Manufacturing** | QC Measurement | Units produced, defect rate, pass/fail ratio | Compliance report for auditor |
| **Media** | Transcript Snippet | Total views, avg engagement, top clips | Analytics report for stakeholders |

**The primitives are reusable as-is** - only metric types and widget configurations change per domain.

---

**Next vertical:** 3.1 (Account Registry) — Closed registry of user's financial accounts with metadata.
