# Vertical 3.4: Tax Categorization (Regulatory Classification)

> **Type:** Regulatory Classification System
> **Pattern:** Multi-Jurisdiction + Taxonomy Hierarchy + Compliance Tagging
> **Last Updated:** 2025-10-24

---

## 📋 Overview

The **Tax Categorization** vertical provides a **regulatory classification system** for tagging transactions with tax-relevant categories and deduction eligibility. While demonstrated in finance domain (USA + Mexico tax law), the underlying primitives are domain-agnostic and apply to ANY regulatory compliance classification.

**Key Characteristics:**
- **Multi-Jurisdiction:** Support multiple regulatory frameworks simultaneously (USA tax law, Mexico tax law)
- **Hierarchical Taxonomy:** Categories organized in parent-child trees (Schedule C, SAT)
- **Compliance Levels:** Deduction rates (100%, 50%, 0%) = eligibility percentages
- **Document Tracking:** Factura linkage (regulatory artifact attachment)
- **Auto-Classification:** Rule-based category suggestion + ML-based prediction

**Finance Domain Examples:**
- USA: Classify transactions into Schedule C categories (Advertising, Office Expenses, Travel)
- Mexico: Classify transactions into SAT categories (Gastos de Gestión, Publicidad)
- Deduction rates: 100% deductible, 50% deductible (meals), 0% deductible (personal)
- Factura: Link Mexican tax receipt (RFC, UUID) to transaction

**Multi-Domain Applicability:**
- Healthcare: CPT codes, ICD-10 diagnosis codes, Medicare reimbursement eligibility
- Legal: Case law categories, jurisdiction-specific filing types, fee schedules
- Research: Grant expense categories, NSF/NIH compliance classifications, allowable costs

---

## Product Layer (Sections 1-10)

### 1. Scope & Boundaries

**In Scope:**
- Multi-jurisdiction tax category assignment (USA + Mexico demonstrated)
- Hierarchical taxonomy support (parent-child categories)
- Deduction rate tagging (100%, 50%, 0%)
- Factura (regulatory document) attachment and tracking
- Auto-classification via rules + ML
- Category-based filtering and reporting
- Bulk categorization
- Historical category changes (audit trail)

**Out of Scope:**
- Tax calculation (covered in future vertical 4.x Tax Engine)
- Tax form generation (Form 1040 Schedule C, SAT forms)
- Multi-currency exchange rate handling (covered in 3.6 Unit)
- Payment of taxes (separate workflow)
- Tax advice or legal guidance

**Boundaries:**
- Categories are user-customizable (can add custom categories within jurisdiction)
- Deduction rates are jurisdiction-specific (USA rules ≠ Mexico rules)
- One transaction can have multiple categories (if split)
- Factura is optional for Mexico transactions (not all have RFC)

---

### 2. User Flow (Real Usage)

**Scenario 1: User tags transaction with USA Schedule C category**

User: "This Uber ride was for a client meeting - it's a business travel expense"

System:
1. User views transaction in Transaction List (2.1)
2. Clicks transaction to open detail drawer
3. Tax section shows:
   - Jurisdiction: USA (auto-detected from account)
   - Category: [Not categorized yet]
   - Deduction Rate: N/A
4. User clicks "Categorize" button
5. TaxCategorySelector dropdown appears with Schedule C categories
6. User searches "travel"
7. Matches:
   - "Car and Truck Expenses" (Schedule C Line 9)
   - "Travel" (Schedule C Line 24a)
8. User selects "Travel - Client meeting"
9. System:
   - Applies category `tax_cat_usa_schedule_c_travel`
   - Sets deduction_rate = 1.0 (100% deductible)
   - Updates transaction.tax_classification
   - Logs change to audit trail
10. User sees badge "✅ 100% Deductible (Travel)"

**Scenario 2: User links Factura to Mexico transaction**

User: "I need to link the Factura (tax receipt) for this Mexican expense"

System:
1. User views transaction: "Comida - $500 MXN"
2. Jurisdiction: Mexico (auto-detected from account currency MXN)
3. User clicks "Attach Factura"
4. FacturaUploadDialog appears
5. User uploads XML file (CFDI 4.0 format)
6. System parses Factura:
   - RFC: ABC123456XYZ
   - UUID: 12345678-1234-1234-1234-123456789012
   - Importe: $500.00 MXN
   - Fecha: 2024-11-01
7. System validates:
   - Amount matches transaction? $500 MXN ✅
   - Date within ±7 days? ✅
   - RFC valid format? ✅
8. Creates FacturaRecord:
   ```json
   {
     "factura_id": "factura_abc123456xyz_1",
     "transaction_id": "txn_67890",
     "rfc": "ABC123456XYZ",
     "uuid": "12345678-1234-1234-1234-123456789012",
     "amount": 500.00,
     "currency": "MXN",
     "issued_date": "2024-11-01",
     "xml_file_id": "file_artifact_123",
     "status": "valid"
   }
   ```
9. Transaction now shows "📄 Factura attached"
10. User can download XML or PDF at any time

**Scenario 3: System auto-suggests category based on merchant**

Background: User has categorized 10 Uber transactions as "Travel"

System:
1. New Uber transaction normalized (from 1.3)
2. TaxCategoryClassifier.auto_classify() runs
3. Checks rule-based matches:
   - Merchant name contains "Uber"? ✅
   - Historical pattern: Uber → Travel (confidence: 0.95, count: 10)
4. Suggests category: "Travel (Schedule C Line 24a)"
5. User sees notification: "💡 Suggested: Travel (based on 10 similar transactions)"
6. User can:
   - Accept suggestion (1 click)
   - Edit suggestion (pick different category)
   - Reject (leave uncategorized)
7. If accepted, applies category + deduction_rate automatically

**Scenario 4: User creates custom category for Mexico SAT**

User: "I need a custom category for 'Gastos de Publicidad en Redes Sociales'"

System:
1. User opens TaxCategoryManager
2. Selects jurisdiction: Mexico (SAT)
3. Clicks "Create Custom Category"
4. Fills form:
   - Name: "Gastos de Publicidad en Redes Sociales"
   - Parent Category: "Gastos de Gestión" (SAT top-level)
   - SAT Code: 84111506 (optional - official SAT product/service code)
   - Deduction Rate: 100%
   - Description: "Social media advertising expenses"
5. System validates:
   - Name unique within jurisdiction? ✅
   - Parent exists? ✅
   - Deduction rate valid (0-100%)? ✅
6. Creates custom category with ID `tax_cat_mx_sat_custom_social_ads`
7. User can now assign transactions to this category
8. Category appears in TaxCategorySelector under "Gastos de Gestión > Custom"

---

### 3. Primitives Touched

**Objective Layer (OL):**
- `TaxCategoryStore` - CRUD for tax categories (system + custom) (NEW - this vertical)
- `TaxonomyEngine` - Loads and navigates hierarchical category trees (NEW - this vertical)
- `TaxCategoryClassifier` - Auto-suggests categories based on rules + ML (NEW - this vertical)
- `FacturaStore` - CRUD for Factura records (Mexico) (NEW - this vertical)
- `FacturaValidator` - Validates CFDI XML format, RFC, UUID (NEW - this vertical)
- `TransactionStore` - Update transaction with tax_classification (from 1.3)
- `CounterpartyStore` - Reference merchant for classification (from 3.2)

**Interaction Layer (IL):**
- `TaxCategorySelector` - Dropdown for selecting tax category with search and hierarchy (NEW - this vertical)
- `TaxCategoryManager` - Full UI for managing custom categories (NEW - this vertical)
- `FacturaUploadDialog` - Upload and link Factura XML to transaction (NEW - this vertical)
- `TransactionList` - View transactions with tax category badges (from 2.1)
- `DrillDownPanel` - View tax classification in transaction detail (from 2.2)

**Schemas:**
- `tax-category.schema.json` - Tax category definition (NEW - this vertical)
- `tax-classification.schema.json` - Transaction tax classification (NEW - this vertical)
- `factura-record.schema.json` - Mexican Factura (CFDI) record (NEW - this vertical)

---

### 4. Contracts (API + Internal)

**REST API:**

```http
# Get Tax Categories for Jurisdiction
GET /api/tax-categories?jurisdiction=usa_federal
Authorization: Bearer {token}

Response 200:
{
  "categories": [
    {
      "category_id": "tax_cat_usa_schedule_c_advertising",
      "name": "Advertising",
      "jurisdiction": "usa_federal",
      "taxonomy": "schedule_c",
      "code": "line_8",
      "parent_id": null,
      "deduction_rate": 1.0,
      "is_system": true,
      "description": "Advertising and marketing expenses (Schedule C Line 8)"
    },
    {
      "category_id": "tax_cat_usa_schedule_c_office",
      "name": "Office Expenses",
      "jurisdiction": "usa_federal",
      "taxonomy": "schedule_c",
      "code": "line_18",
      "parent_id": null,
      "deduction_rate": 1.0,
      "is_system": true
    },
    {
      "category_id": "tax_cat_usa_schedule_c_meals",
      "name": "Meals (Business)",
      "jurisdiction": "usa_federal",
      "taxonomy": "schedule_c",
      "code": "line_24b",
      "parent_id": null,
      "deduction_rate": 0.5,
      "is_system": true,
      "description": "Business meals (50% deductible per IRS rules)"
    }
  ],
  "total": 25
}
```

```http
# Classify Transaction
PATCH /api/transactions/{transaction_id}/classify
Authorization: Bearer {token}
Content-Type: application/json

{
  "category_id": "tax_cat_usa_schedule_c_travel",
  "notes": "Client meeting in SF",
  "classification_method": "manual"  // or "auto_suggested", "auto_applied"
}

Response 200:
{
  "transaction_id": "txn_12345",
  "tax_classification": {
    "category_id": "tax_cat_usa_schedule_c_travel",
    "category_name": "Travel",
    "jurisdiction": "usa_federal",
    "deduction_rate": 1.0,
    "classified_at": "2024-11-01T10:30:00Z",
    "classified_by": "user",
    "classification_method": "manual",
    "notes": "Client meeting in SF"
  }
}
```

```http
# Upload Factura (Mexico)
POST /api/facturas
Authorization: Bearer {token}
Content-Type: multipart/form-data

file: factura.xml
transaction_id: txn_67890

Response 201:
{
  "factura_id": "factura_abc123456xyz_1",
  "transaction_id": "txn_67890",
  "rfc": "ABC123456XYZ",
  "uuid": "12345678-1234-1234-1234-123456789012",
  "amount": 500.00,
  "currency": "MXN",
  "issued_date": "2024-11-01",
  "xml_file_id": "file_artifact_123",
  "pdf_file_id": null,
  "status": "valid",
  "validation_errors": [],
  "created_at": "2024-11-01T10:00:00Z"
}

Response 400 (Invalid Factura):
{
  "error": "FACTURA_VALIDATION_FAILED",
  "message": "Factura XML validation failed",
  "validation_errors": [
    "RFC format invalid: must be 12 or 13 characters",
    "UUID not found in SAT database"
  ]
}
```

```http
# Auto-Suggest Category
POST /api/transactions/{transaction_id}/suggest-category
Authorization: Bearer {token}

Response 200:
{
  "suggestions": [
    {
      "category_id": "tax_cat_usa_schedule_c_travel",
      "category_name": "Travel",
      "confidence": 0.95,
      "reason": "Based on 10 similar Uber transactions",
      "deduction_rate": 1.0
    },
    {
      "category_id": "tax_cat_usa_schedule_c_car_truck",
      "category_name": "Car and Truck Expenses",
      "confidence": 0.65,
      "reason": "Merchant is transportation-related",
      "deduction_rate": 1.0
    }
  ]
}
```

**Internal OL API:**

```python
class TaxCategoryStore:
    def create_custom(self, user_id: str, jurisdiction: str, name: str,
                      parent_id: Optional[str], deduction_rate: Decimal,
                      sat_code: Optional[str] = None) -> TaxCategory:
        """
        Creates custom tax category for user.

        Raises:
            DuplicateCategoryNameError: If name exists in jurisdiction
            InvalidJurisdictionError: If jurisdiction not supported
            InvalidParentError: If parent_id doesn't exist
            InvalidDeductionRateError: If rate not in [0.0, 1.0]
        """

    def get_hierarchy(self, jurisdiction: str, parent_id: Optional[str] = None) -> List[TaxCategory]:
        """Returns category tree for jurisdiction (depth-first traversal)."""

    def search(self, jurisdiction: str, query: str) -> List[TaxCategory]:
        """Full-text search across category names and descriptions."""

class TaxCategoryClassifier:
    def auto_classify(self, transaction: Transaction) -> Optional[CategorySuggestion]:
        """
        Auto-suggests tax category based on:
        1. Merchant historical pattern (user has categorized this merchant before)
        2. Counterparty name matching (e.g., "Uber" → Travel)
        3. Amount pattern (e.g., $5-$30 → Meals)
        4. ML model prediction (trained on user's categorization history)

        Returns:
            CategorySuggestion with confidence score [0.0, 1.0]
            None if no confident match (threshold: 0.70)
        """

    def bulk_classify(self, transactions: List[Transaction]) -> Dict[str, CategorySuggestion]:
        """Batch classification for performance."""

class FacturaStore:
    def create(self, user_id: str, transaction_id: str, xml_content: bytes) -> FacturaRecord:
        """
        Parses CFDI XML, validates, and creates Factura record.

        Raises:
            FacturaParseError: If XML malformed
            FacturaValidationError: If RFC/UUID/amount invalid
            TransactionMismatchError: If amounts don't match
        """

    def validate_uuid(self, uuid: str) -> bool:
        """Validates UUID format and optionally checks SAT database (external API)."""

class FacturaValidator:
    def validate_xml(self, xml_content: bytes) -> ValidationResult:
        """
        Validates CFDI 4.0 XML format.

        Checks:
        - XML schema compliance
        - RFC format (12-13 alphanumeric)
        - UUID format (UUID v4)
        - Amount > 0
        - Date not in future
        - Signature (sello digital) valid
        """
```

---

### 5. Schemas / Tipos (Persistencia)

**TaxCategory Schema:**

```json
{
  "category_id": "tax_cat_usa_schedule_c_travel",
  "user_id": null,
  "name": "Travel",
  "jurisdiction": "usa_federal",
  "taxonomy": "schedule_c",
  "code": "line_24a",
  "parent_id": null,
  "deduction_rate": 1.0,
  "is_system": true,
  "description": "Travel expenses for business (Schedule C Line 24a)",
  "created_at": "2024-01-01T00:00:00Z"
}
```

**TaxClassification Schema (embedded in Transaction):**

```json
{
  "transaction_id": "txn_12345",
  "tax_classification": {
    "category_id": "tax_cat_usa_schedule_c_travel",
    "category_name": "Travel",
    "jurisdiction": "usa_federal",
    "deduction_rate": 1.0,
    "classified_at": "2024-11-01T10:30:00Z",
    "classified_by": "user_123",
    "classification_method": "manual",
    "notes": "Client meeting in SF",
    "confidence": null
  }
}
```

**FacturaRecord Schema:**

```json
{
  "factura_id": "factura_abc123456xyz_1",
  "user_id": "user_123",
  "transaction_id": "txn_67890",
  "rfc": "ABC123456XYZ",
  "uuid": "12345678-1234-1234-1234-123456789012",
  "amount": 500.00,
  "currency": "MXN",
  "issued_date": "2024-11-01",
  "xml_file_id": "file_artifact_123",
  "pdf_file_id": null,
  "status": "valid",
  "validation_errors": [],
  "created_at": "2024-11-01T10:00:00Z"
}
```

**Jurisdictions:**
- `usa_federal` - USA federal tax (Schedule C)
- `usa_state_{state_code}` - USA state-specific (e.g., `usa_state_ca`)
- `mexico_federal` - Mexico federal tax (SAT)

**Deduction Rates:**
- `1.0` = 100% deductible
- `0.5` = 50% deductible (e.g., business meals in USA)
- `0.0` = 0% deductible (non-deductible / personal)

---

### 6. Validaciones & Estados

**Create Custom Category Validations:**
- Name: 1-200 chars, unique within jurisdiction (case-insensitive)
- Jurisdiction: Must be supported (usa_federal, mexico_federal, etc.)
- Parent ID: Must exist if provided, must be in same jurisdiction
- Deduction rate: [0.0, 1.0]
- SAT code: Optional, 8 digits (for Mexico)

**Classification Validations:**
- Category must exist and match transaction jurisdiction
- User can only use custom categories they created (or system categories)
- Cannot classify same transaction twice with same category (idempotent)
- Notes: Max 500 chars

**Factura Validations:**
- XML format: CFDI 3.3 or 4.0 (SAT standard)
- RFC: 12-13 alphanumeric (person) or 12 alphanumeric (company)
- UUID: Valid UUIDv4 format
- Amount: Must match transaction amount (tolerance ±$1 MXN)
- Date: Must be within ±7 days of transaction date
- One factura per transaction (1:1 mapping)

**State Machine (Factura):**
```
┌──────────┐
│ uploaded │──validate──▶│ valid │
└──────────┘             └───────┘
     │
     │ validation fails
     │
     ▼
│ invalid │──user corrects──▶│ revalidating │──▶│ valid │
└─────────┘                   └──────────────┘    └───────┘
```

---

### 7. Edge Cases

**EC1: Transaction in multiple categories (split)**
- Problem: Dinner with client ($100) - 50% business meal ($50), 50% personal ($50)
- **Solution:** Allow multiple tax_classification entries per transaction with amount splits
- Each classification has `allocated_amount` field
- Sum of allocated_amounts must equal transaction.amount

**EC2: Jurisdiction mismatch**
- Problem: USA account, but expense in Mexico (cross-border)
- **Solution:** Jurisdiction derived from account.country, but user can override
- Show warning: "Account is USA-based, but you selected Mexico category"

**EC3: Deduction rate changes retroactively**
- Problem: IRS changes business meals from 50% to 100% deductible
- **Solution:** TaxCategory.deduction_rate is point-in-time
- Historical classifications use rate at time of classification (stored in tax_classification.deduction_rate)
- System can bulk-update for new rules (user confirms)

**EC4: Factura amount doesn't match transaction**
- Problem: Factura shows $520 MXN, transaction shows $500 MXN
- **Solution:**
  - If variance < 5%, accept with warning
  - If variance >= 5%, require user confirmation (force link)
  - Log variance in factura_record.validation_errors

**EC5: Multiple Facturas for single transaction**
- Problem: Single purchase split across 2 Facturas (different RFC providers)
- **Solution:** Allow multiple factura_records per transaction (1:N)
- Each factura has `allocated_amount`
- Sum must equal transaction.amount

**EC6: Factura uploaded before transaction exists**
- Problem: User scans Factura, but hasn't uploaded bank statement yet
- **Solution:** Create orphan FacturaRecord with transaction_id=null
- When transaction appears, auto-match based on amount + date (±7 days) + RFC
- User confirms link

**EC7: Custom category deleted but transactions still use it**
- Problem: User deletes custom category, but 50 transactions reference it
- **Solution:** Soft delete only (is_active=false)
- Category hidden from UI but preserved in historical classifications
- User must re-categorize transactions before hard delete allowed

---

### 8. Acceptance Criteria (Definition of Done)

**Tax Category Management:**
- [ ] User can view system tax categories for USA (Schedule C) and Mexico (SAT)
- [ ] User can create custom categories within jurisdiction
- [ ] User can search categories by name/description
- [ ] User can view category hierarchy (parent-child tree)
- [ ] System enforces unique names per jurisdiction (case-insensitive)
- [ ] System validates deduction rate [0.0, 1.0]

**Transaction Classification:**
- [ ] User can manually assign tax category to transaction
- [ ] User can see suggested categories with confidence scores
- [ ] User can accept/reject suggestions
- [ ] User can add classification notes
- [ ] System stores classification history (audit trail)
- [ ] User can bulk-classify transactions (select multiple, apply category)
- [ ] User can filter transactions by tax category
- [ ] User can export transactions with tax classifications (CSV)

**Factura Management (Mexico):**
- [ ] User can upload Factura XML (CFDI 3.3/4.0)
- [ ] System parses and validates RFC, UUID, amount, date
- [ ] System links Factura to transaction (1:1 or 1:N)
- [ ] User can view Factura details (RFC, UUID, amount, date)
- [ ] User can download original XML
- [ ] System detects missing Facturas (Mexico transactions without Factura)
- [ ] User can see warning for transactions over $2000 MXN without Factura

**Auto-Classification:**
- [ ] System suggests categories based on merchant history (confidence ≥ 0.70)
- [ ] System suggests categories based on counterparty name matching
- [ ] User can train classifier by accepting/rejecting suggestions
- [ ] System bulk-suggests for uncategorized transactions

**Multi-Domain:**
- [ ] Pattern applies to Healthcare (CPT/ICD-10 codes, reimbursement eligibility)
- [ ] Pattern applies to Legal (case categories, jurisdiction-specific classifications)
- [ ] Pattern applies to Research (grant expense categories, compliance requirements)

---

### 9. Logs & Provenance

**Structured Logs:**

```json
{
  "event": "transaction_classified",
  "transaction_id": "txn_12345",
  "category_id": "tax_cat_usa_schedule_c_travel",
  "jurisdiction": "usa_federal",
  "deduction_rate": 1.0,
  "classification_method": "manual",
  "confidence": null,
  "user_id": "user_123",
  "timestamp": "2024-11-01T10:30:00Z"
}
```

```json
{
  "event": "category_suggestion_accepted",
  "transaction_id": "txn_67890",
  "suggested_category_id": "tax_cat_usa_schedule_c_meals",
  "confidence": 0.85,
  "user_id": "user_123",
  "timestamp": "2024-11-01T10:35:00Z"
}
```

```json
{
  "event": "factura_uploaded",
  "factura_id": "factura_abc123456xyz_1",
  "transaction_id": "txn_67890",
  "rfc": "ABC123456XYZ",
  "amount": 500.00,
  "validation_status": "valid",
  "user_id": "user_123",
  "timestamp": "2024-11-01T10:00:00Z"
}
```

**Provenance Chain:**
```
Transaction Normalized (1.3)
  ↓
TaxCategoryClassifier.auto_classify() (3.4)
  ↓
Suggestion Presented to User (IL)
  ↓
User Accepts/Rejects (IL)
  ↓
Classification Applied (OL)
  ↓
Audit Trail Updated (ProvenanceLedger)
```

---

### 10. Risks & Deferred

**Risks:**
- **R1: Tax law complexity** - Tax rules change annually, hard to keep current
  - **Mitigation:** System categories versioned, allow custom categories for new rules
- **R2: Multi-jurisdiction conflicts** - Same transaction, different rules (USA vs Mexico)
  - **Mitigation:** User chooses primary jurisdiction, can add secondary classification
- **R3: SAT validation dependency** - Factura UUID validation requires external SAT API
  - **Mitigation:** Validate format offline, optionally validate with SAT (async)

**Deferred:**
- **D1: Tax calculation** - Actual tax computation moved to 4.x Tax Engine
- **D2: Form generation** - Schedule C PDF, SAT forms moved to 4.x Tax Forms
- **D3: ML model training** - Initial version uses rule-based, ML enhancement in v2
- **D4: State-specific rules** - USA state tax categories deferred to v2

---

## Machinery Layer (Sections 11-15)

### 11. Primitives Introduced

**Objective Layer (OL) - 5 new primitives:**

1. **TaxCategoryStore** - CRUD for tax categories (system + custom)
   - File: `docs/primitives/ol/TaxCategoryStore.md`
   - Methods: create_custom, get, get_hierarchy, search, archive
   - Responsibilities: Category persistence, hierarchy navigation, uniqueness validation

2. **TaxonomyEngine** - Loads and navigates hierarchical category trees
   - File: `docs/primitives/ol/TaxonomyEngine.md`
   - Methods: load_taxonomy, get_children, get_path, search_tree
   - Responsibilities: Tree traversal, depth-first/breadth-first search

3. **TaxCategoryClassifier** - Auto-suggests categories (rules + ML)
   - File: `docs/primitives/ol/TaxCategoryClassifier.md`
   - Methods: auto_classify, bulk_classify, train_from_history
   - Responsibilities: Pattern matching, confidence scoring, suggestion generation

4. **FacturaStore** - CRUD for Mexican Factura records
   - File: `docs/primitives/ol/FacturaStore.md`
   - Methods: create, get, link_to_transaction, auto_match
   - Responsibilities: CFDI XML parsing, Factura persistence, transaction linking

5. **FacturaValidator** - Validates CFDI XML format
   - File: `docs/primitives/ol/FacturaValidator.md`
   - Methods: validate_xml, validate_rfc, validate_uuid, validate_amount
   - Responsibilities: Schema validation, SAT compliance, field validation

**Interaction Layer (IL) - 3 new components:**

6. **TaxCategorySelector** - Dropdown for selecting tax category
   - File: `docs/primitives/il/TaxCategorySelector.md`
   - Features: Hierarchical display, search, jurisdiction filter, deduction rate badge
   - Responsibilities: Category selection, suggestion display

7. **TaxCategoryManager** - Full UI for managing custom categories
   - File: `docs/primitives/il/TaxCategoryManager.md`
   - Features: Tree view, create/edit custom categories, system vs user categories
   - Responsibilities: Category CRUD UI, hierarchy visualization

8. **FacturaUploadDialog** - Upload and link Factura XML
   - File: `docs/primitives/il/FacturaUploadDialog.md`
   - Features: Drag-drop XML, parse validation, transaction linking, download
   - Responsibilities: Factura upload UI, validation feedback

**Schemas - 3 new:**

9. **tax-category.schema.json** - Tax category definition
10. **tax-classification.schema.json** - Transaction tax classification (embedded)
11. **factura-record.schema.json** - Mexican Factura (CFDI) record

---

### 12. Interlocks with Other Verticals

**Depends On:**
- **1.3 Normalization** - Transactions must be normalized before classification
- **3.2 Counterparty Registry** - Merchant name used for auto-classification
- **2.1 Transaction List** - Classification UI embedded in transaction detail

**Used By:**
- **4.2 Forecast** - Tax deduction projections based on historical classifications
- **2.3 Finance Dashboard** - Tax summary widget (total deductions by category)
- **Future: 4.x Tax Engine** - Tax calculation uses classifications

**Data Flow:**
```
Transaction Normalized (1.3)
  ↓
TaxCategoryClassifier checks merchant (3.2)
  ↓
Suggests category (3.4)
  ↓
User accepts via TaxCategorySelector (IL)
  ↓
Classification stored in Transaction
  ↓
Dashboard shows tax summary (2.3)
```

---

### 13. Reusability (Multi-Domain Generalization)

**Pattern: Regulatory Classification + Compliance Tagging**

This pattern applies to **any domain with regulatory compliance requirements**:

**Finance:**
- Taxonomy: USA Schedule C, Mexico SAT
- Compliance Level: Deduction rate (100%, 50%, 0%)
- Regulatory Document: Factura (CFDI)
- Use Case: Tax deduction tracking

**Healthcare:**
- Taxonomy: CPT codes (procedures), ICD-10 codes (diagnoses)
- Compliance Level: Medicare reimbursement eligibility (100%, 80%, 0%)
- Regulatory Document: CMS-1500 claim form, EOB (Explanation of Benefits)
- Use Case: Insurance claim categorization

**Legal:**
- Taxonomy: Case law categories, filing types by jurisdiction
- Compliance Level: Court fee schedules by jurisdiction
- Regulatory Document: Court filings, motions, briefs
- Use Case: Legal expense categorization for client billing

**Research:**
- Taxonomy: NSF/NIH expense categories, grant-specific allowable costs
- Compliance Level: Cost share requirement (100% reimbursable, 50% cost-share, 0% unallowable)
- Regulatory Document: Budget justification, grant agreement
- Use Case: Grant expense compliance tracking

**Manufacturing:**
- Taxonomy: OSHA safety categories, EPA environmental compliance categories
- Compliance Level: Compliance status (fully compliant, partially compliant, non-compliant)
- Regulatory Document: Safety inspection report, environmental permit
- Use Case: Compliance expense tracking

**Key Abstraction:**
```python
class RegulatoryClassifier:
    """
    Universal pattern for regulatory classification.

    Generic enough to apply across:
    - Finance: Tax categories, deduction rates, Facturas
    - Healthcare: Procedure codes, reimbursement eligibility, claim forms
    - Legal: Case categories, fee schedules, court filings
    - Research: Grant categories, cost-share requirements, budget docs
    """
    taxonomy: Taxonomy  # Hierarchical category tree
    jurisdiction: str   # Regulatory framework (usa_federal, hipaa, etc.)
    compliance_level: float  # Eligibility percentage [0.0, 1.0]
    regulatory_document: Optional[Document]  # Supporting artifact
```

---

### 14. Pattern Abstraction

**Pattern Name:** Regulatory Classification + Compliance Tagging

**Problem Statement:**
Users need to classify transactions/events according to regulatory frameworks (tax law, healthcare compliance, legal requirements) to determine eligibility, compliance status, and required documentation.

**Solution Architecture:**

1. **Multi-Jurisdiction Support** - Handle multiple regulatory frameworks simultaneously
2. **Hierarchical Taxonomy** - Organize categories in parent-child trees
3. **Compliance Levels** - Tag with eligibility percentages (deduction rate, reimbursement rate)
4. **Regulatory Documents** - Link supporting artifacts (Factura, claim form, court filing)
5. **Auto-Classification** - Rule-based + ML suggestions based on historical patterns

**Components:**
- **TaxonomyEngine** - Navigate hierarchical category trees
- **Classifier** - Auto-suggest categories based on entity attributes
- **DocumentStore** - Persist regulatory artifacts
- **Validator** - Validate regulatory document compliance

**When to Use:**
- ✅ Need to categorize entities according to regulatory rules
- ✅ Multiple jurisdictions with different taxonomies
- ✅ Compliance levels vary (not binary)
- ✅ Supporting documentation required for audit
- ❌ Simple tagging (use basic categorization instead)
- ❌ No regulatory requirement (use free-form tags)

---

### 15. Métricas de Madurez

**Coverage Metrics:**
- % of transactions classified (target: >90%)
- % of Mexico transactions with Factura (target: >80% for >$2000 MXN)
- % of classifications using auto-suggest (target: >60%)

**Quality Metrics:**
- Auto-classification accuracy (user acceptance rate, target: >70%)
- Factura validation success rate (target: >95%)
- Custom category usage (indicates system categories insufficient)

**Performance Metrics:**
- Category search latency (target: <100ms p95)
- Auto-classify latency (target: <200ms p95)
- Factura XML parse + validate (target: <500ms p95)

**User Engagement:**
- % users with at least 1 custom category (target: >30%)
- Avg classifications per user per month (target: >50)
- % users who accept auto-suggestions (target: >60%)

---

## Cross-Cutting Concerns (Sections 16-20)

### 16. Security Considerations

**Authentication & Authorization:**
- All operations require valid bearer token
- Users can only classify their own transactions
- Custom categories are user-scoped (user_id foreign key)
- System categories are read-only (is_system=true)

**Input Validation:**
- Category name: Pattern validation, length limits (prevent XSS)
- Deduction rate: Range [0.0, 1.0]
- SAT code: 8 digits (if Mexico)
- Factura XML: Size limit (<5MB), schema validation (prevent XML bomb)

**SQL Injection Prevention:**
- Use parameterized queries for all database operations
- Example: `SELECT * FROM tax_categories WHERE user_id = ? AND name ILIKE ?`

**Trust Construction Elements:**
- **Ownership verification:** All classifications checked against user_id
- **Audit trail:** All classification changes logged with user_id + timestamp
- **Factura validation:** RFC format, UUID format, amount matching (prevent fraud)
- **XML validation:** CFDI schema compliance (prevent malicious XML)
- **Rate limiting:** Classify: 100 per minute, Factura upload: 10 per minute

**Data Privacy:**
- Category notes may contain sensitive info (e.g., "client meeting with ABC Corp")
- Do not log category notes in external systems
- Redact PII in error messages

---

### 17. Performance Characteristics

**Target Latencies (p95):**
- `GET /api/tax-categories` (list): <100ms
- `PATCH /api/transactions/{id}/classify` (classify): <200ms
- `POST /api/facturas` (upload): <500ms (XML parse + validate)
- `POST /api/transactions/{id}/suggest-category` (auto-classify): <200ms

**Scalability:**
- Categories per jurisdiction: 100 system + unlimited custom
- Classifications per transaction: 1 (typical), 10 (max for splits)
- Facturas per transaction: 1 (typical), 5 (max for split invoices)

**Database Indexes:**
```sql
-- Tax categories
CREATE INDEX idx_tax_categories_jurisdiction ON tax_categories(jurisdiction, is_active);
CREATE INDEX idx_tax_categories_user ON tax_categories(user_id, jurisdiction);
CREATE INDEX idx_tax_categories_name ON tax_categories(user_id, jurisdiction, LOWER(name));

-- Transaction classifications (embedded in transactions table)
CREATE INDEX idx_transactions_tax_category ON transactions(tax_classification->>'category_id');
CREATE INDEX idx_transactions_jurisdiction ON transactions(tax_classification->>'jurisdiction');

-- Facturas
CREATE INDEX idx_facturas_transaction ON facturas(transaction_id);
CREATE INDEX idx_facturas_rfc ON facturas(rfc);
CREATE INDEX idx_facturas_uuid ON facturas(uuid);
```

**Caching Strategy:**
- Cache system categories per jurisdiction (TTL: 24 hours, rarely change)
- Cache user's custom categories (TTL: 5 minutes, invalidate on create/update)
- Cache taxonomy tree (TTL: 1 hour)

**Background Jobs:**
- **Hourly:** Auto-classify uncategorized transactions (batch 1000 at a time)
- **Daily:** Detect missing Facturas for Mexico transactions >$2000 MXN
- **Weekly:** Retrain ML classifier from user's classification history

---

### 18. Observability

**Metrics:**
```
tax_categories.created.count (counter, labels: user_id, jurisdiction)
transactions.classified.count (counter, labels: category_id, method)
suggestions.accepted.count (counter, labels: category_id)
suggestions.rejected.count (counter, labels: category_id)
facturas.uploaded.count (counter, labels: status)
classify.latency (histogram, labels: method)
auto_classify.accuracy (gauge)
```

**Structured Logs:**
- All classification operations (create, update, delete)
- All suggestion accept/reject events
- All Factura uploads and validation results
- Auto-classification decisions (confidence, reason)

**Dashboards:**
- Classification coverage % (trend over time)
- Top 10 categories by usage
- Auto-classification acceptance rate (target: >70%)
- Factura upload success rate (target: >95%)
- Custom category creation rate

**Alerts:**
- Auto-classification accuracy drops below 60% (investigate model drift)
- Factura validation failure rate >10% (investigate SAT API issues)
- Classification latency >500ms (investigate database performance)

**Tracing:**
- Trace auto-classification flow: transaction → merchant lookup → pattern match → suggestion
- Include transaction_id, merchant_name, confidence_score, decision in trace

---

### 19. Testing Strategy

**Unit Tests:**

```python
# TaxCategoryStore tests
def test_create_custom_category():
    category = store.create_custom(
        user_id="user_123",
        jurisdiction="usa_federal",
        name="Custom Software",
        parent_id="tax_cat_usa_schedule_c_office",
        deduction_rate=Decimal("1.0")
    )
    assert category.category_id.startswith("tax_cat_")
    assert category.is_system == False

def test_duplicate_category_name():
    store.create_custom(user_id="user_123", jurisdiction="usa_federal", name="Custom", ...)
    with pytest.raises(DuplicateCategoryNameError):
        store.create_custom(user_id="user_123", jurisdiction="usa_federal", name="custom", ...)

# TaxCategoryClassifier tests
def test_auto_classify_by_merchant_pattern():
    # User has classified 10 Uber transactions as "Travel"
    suggestion = classifier.auto_classify(uber_transaction)
    assert suggestion.category_id == "tax_cat_usa_schedule_c_travel"
    assert suggestion.confidence >= 0.90

def test_auto_classify_no_match():
    # New merchant, no historical pattern
    suggestion = classifier.auto_classify(new_merchant_transaction)
    assert suggestion is None  # Confidence below threshold

# FacturaValidator tests
def test_validate_xml_valid():
    result = validator.validate_xml(valid_cfdi_xml)
    assert result.is_valid == True
    assert len(result.errors) == 0

def test_validate_rfc_invalid():
    result = validator.validate_rfc("INVALID")
    assert result.is_valid == False
    assert "RFC format invalid" in result.errors[0]
```

**Integration Tests:**

```python
def test_end_to_end_classification():
    # 1. Create transaction
    transaction = create_transaction(amount=-50.00, merchant="Uber")

    # 2. Auto-classify
    suggestion = client.post(f"/api/transactions/{transaction.id}/suggest-category")
    assert suggestion["suggestions"][0]["category_id"] == "tax_cat_usa_schedule_c_travel"

    # 3. Accept suggestion
    response = client.patch(f"/api/transactions/{transaction.id}/classify", json={
        "category_id": "tax_cat_usa_schedule_c_travel",
        "classification_method": "auto_suggested"
    })
    assert response.status_code == 200
    assert response.json()["tax_classification"]["deduction_rate"] == 1.0

def test_factura_upload_and_link():
    # 1. Upload Factura
    response = client.post("/api/facturas", files={"file": open("factura.xml", "rb")}, data={"transaction_id": "txn_123"})
    assert response.status_code == 201
    factura_id = response.json()["factura_id"]

    # 2. Verify link
    transaction = client.get("/api/transactions/txn_123")
    assert transaction.json()["factura_id"] == factura_id
```

**Multi-Domain Tests:**
- Finance: Classify transaction with Schedule C category
- Healthcare: Classify medical claim with CPT code
- Legal: Classify court filing with jurisdiction category
- Research: Classify grant expense with NSF category

---

### 20. Operations Runbook

**Deployment:**

1. **Database Migrations:**
```sql
-- Create tax_categories table
CREATE TABLE tax_categories (
    category_id VARCHAR(100) PRIMARY KEY,
    user_id UUID,  -- null for system categories
    name VARCHAR(200) NOT NULL,
    jurisdiction VARCHAR(50) NOT NULL,
    taxonomy VARCHAR(50) NOT NULL,
    code VARCHAR(50),  -- e.g., "line_8", "84111506"
    parent_id VARCHAR(100),
    deduction_rate DECIMAL(3,2) NOT NULL CHECK (deduction_rate >= 0 AND deduction_rate <= 1),
    is_system BOOLEAN DEFAULT FALSE,
    description TEXT,
    created_at TIMESTAMP DEFAULT NOW(),
    UNIQUE(user_id, jurisdiction, LOWER(name)),
    FOREIGN KEY (parent_id) REFERENCES tax_categories(category_id)
);

-- Create facturas table
CREATE TABLE facturas (
    factura_id VARCHAR(100) PRIMARY KEY,
    user_id UUID NOT NULL,
    transaction_id VARCHAR(100),
    rfc VARCHAR(13) NOT NULL,
    uuid UUID NOT NULL,
    amount DECIMAL(12,2) NOT NULL,
    currency VARCHAR(3) NOT NULL,
    issued_date DATE NOT NULL,
    xml_file_id VARCHAR(100) NOT NULL,
    pdf_file_id VARCHAR(100),
    status VARCHAR(20) NOT NULL,  -- "valid", "invalid"
    validation_errors JSONB,
    created_at TIMESTAMP DEFAULT NOW(),
    FOREIGN KEY (user_id) REFERENCES users(user_id),
    FOREIGN KEY (transaction_id) REFERENCES transactions(transaction_id),
    FOREIGN KEY (xml_file_id) REFERENCES file_artifacts(artifact_id)
);

-- Add tax_classification to transactions table (JSONB column)
ALTER TABLE transactions ADD COLUMN tax_classification JSONB;
```

2. **Seed System Categories:**
```bash
# Load USA Schedule C categories
python /app/scripts/seed_tax_categories.py --jurisdiction=usa_federal --file=schedule_c_categories.json

# Load Mexico SAT categories
python /app/scripts/seed_tax_categories.py --jurisdiction=mexico_federal --file=sat_categories.json
```

**Monitoring:**

- **Health Check:** `GET /api/health/tax-categories` - Returns OK if TaxCategoryStore can query
- **Metric Alerts:**
  - Auto-classification accuracy < 60% → investigate model drift
  - Factura validation failure rate > 10% → check SAT API
  - Classification latency > 500ms → database performance issue

**Common Issues:**

**Issue 1: Auto-classification not working**
- **Symptom:** No suggestions appearing for transactions
- **Debug:**
  1. Check if user has classification history (need at least 5 for pattern matching)
  2. Verify merchant name matches historical patterns
  3. Check confidence threshold (default: 0.70)
- **Fix:** Lower threshold temporarily or train on more data

**Issue 2: Factura validation failing**
- **Symptom:** All Factura uploads rejected with "UUID invalid"
- **Debug:**
  1. Check SAT API connectivity (external dependency)
  2. Verify XML schema version (CFDI 3.3 vs 4.0)
  3. Check RFC format (12-13 chars)
- **Fix:** Validate format offline, skip SAT UUID check if API down

**Issue 3: Category hierarchy broken**
- **Symptom:** Parent categories not showing children
- **Debug:**
  1. Check parent_id references valid category
  2. Verify jurisdiction matches parent
  3. Check for circular references
- **Fix:** Run `VACUUM ANALYZE tax_categories`, rebuild hierarchy cache

**Incident Response:**

```bash
# Query uncategorized transactions
SELECT transaction_id, merchant_name, amount
FROM transactions
WHERE tax_classification IS NULL AND account_id LIKE 'acc_usa_%'
ORDER BY date DESC
LIMIT 100;

# Force classify transaction
curl -X PATCH /api/transactions/{id}/classify \
  -H "Authorization: Bearer TOKEN" \
  -d '{"category_id": "tax_cat_usa_schedule_c_travel", "classification_method": "manual"}'

# Validate Factura manually
python /app/scripts/validate_factura.py --factura-id={factura_id}

# Bulk re-classify based on merchant
python /app/scripts/bulk_classify.py --merchant="Uber" --category="tax_cat_usa_schedule_c_travel"
```

---

## 🎯 Summary

Vertical 3.4 delivers a **regulatory classification system** with:

✅ **5 OL Primitives** (TaxCategoryStore, TaxonomyEngine, TaxCategoryClassifier, FacturaStore, FacturaValidator)
✅ **3 IL Components** (TaxCategorySelector, TaxCategoryManager, FacturaUploadDialog)
✅ **3 Schemas** (tax-category, tax-classification, factura-record)
✅ **20 Complete Sections** (Product, Machinery, Cross-Cutting)
✅ **Multi-Domain Pattern** (Finance → Tax, Healthcare → CPT/ICD-10, Legal → Case categories, Research → Grant compliance)

**Finance Instantiation:**
- USA: Schedule C categories, 100%/50%/0% deduction rates
- Mexico: SAT categories, Factura (CFDI) tracking
- Auto-classification based on merchant patterns

**Universal Pattern: Regulatory Classification**
- Multi-jurisdiction support (regulatory frameworks)
- Hierarchical taxonomy navigation
- Compliance level tagging (eligibility percentages)
- Regulatory document linking (artifacts)

**Next:** 3.5 Relationships (transaction linking, transfers, FX conversion)
