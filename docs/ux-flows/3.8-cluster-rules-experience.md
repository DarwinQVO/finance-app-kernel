# UX Flow: Cluster Rules Experience (3.8)

> **Vertical:** 3.8 Cluster Rules (Merchant Normalization & Transaction Clustering)
> **Last Updated:** 2025-10-24

---

## Overview

This document describes the complete user experience for creating normalization rules, reviewing cluster suggestions, and managing text standardization across merchants, providers, institutions, and other entities.

**Target Users:**
- Finance users normalizing merchant names
- Healthcare admins standardizing provider names
- Legal teams normalizing case/party names
- Researchers deduplicating author/institution names

---

## User Journey 1: Auto-Normalize Merchant Name Using Existing Rule

**Scenario:** Transaction ingested with raw merchant name, system auto-normalizes using user's rule

### Flow

```
1. System ingests transaction
   Raw merchant: "UBER EATS PENDING"
   User: Darwin

2. MerchantNormalizer.normalize() executes
   - Load Darwin's rules (priority order)
   - Match: rule_uber_all (pattern: "UBER.*", replacement: "Uber", priority: 90)
   - Apply normalization

3. Transaction stored with normalized merchant
   {
     "transaction_id": "txn_12345",
     "raw_merchant": "UBER EATS PENDING",
     "normalized_merchant": "Uber",
     "normalization_rule_id": "rule_uber_all"
   }

4. User views transaction in TransactionList
   - Merchant column shows: "Uber"
   - Tooltip on hover: "Normalized from 'UBER EATS PENDING' using rule 'UBER.*'"

5. User clicks transaction to view detail
   - DrillDownPanel shows:
     • Merchant: "Uber" (badge: "Normalized")
     • Original: "UBER EATS PENDING"
     • Rule: "UBER.* → Uber (Priority 90)"
     • Confidence: 100%
```

### Wireframe: Normalized Transaction Detail

```
┌─────────────────────────────────────────────────────────────────┐
│ Transaction Details                                  [×] Close   │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│ Amount: -$15.67                                                  │
│ Date: 2025-10-24                                                 │
│                                                                   │
│ Merchant: Uber  [✓ Normalized]                                  │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ Original: "UBER EATS PENDING"                                │ │
│ │ Normalized by rule: "UBER.*" → "Uber"                       │ │
│ │ Match type: Regex                                            │ │
│ │ Confidence: 100%                                             │ │
│ │ Applied: 2025-10-24 10:05:00                                 │ │
│ │                                                              │ │
│ │ [View Rule] [Edit Normalization]                            │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                                   │
│ Category: Food & Dining                                          │
│ Notes: Lunch delivery                                            │
└─────────────────────────────────────────────────────────────────┘
```

---

## User Journey 2: Create New Normalization Rule

**Scenario:** User has 47 Uber transactions with different raw names, wants to normalize all to "Uber"

### Flow

```
1. User views transaction list
   - Sees: "UBER EATS PENDING", "UBER *RIDE", "Uber Technologies"
   - Realizes these should be grouped

2. User opens MerchantRulesManager
   - Clicks "Create Rule" button
   - RuleEditorDialog appears

3. User fills form
   - Rule Type: Selects "Regex"
   - Pattern: Enters "UBER.*"
   - Replacement: Enters "Uber"
   - Priority: Adjusts slider to 90 (default for regex)

4. User clicks "Test Rule"
   - System calls POST /api/normalization-rules/test
   - Returns: 47 transactions match
   - Preview shows:
     • "UBER EATS PENDING" → "Uber" (15 txns)
     • "UBER *RIDE" → "Uber" (23 txns)
     • "Uber Technologies" → "Uber" (9 txns)

5. User reviews preview
   - Confirms all matches look correct
   - Clicks "Save Rule"

6. System creates rule
   - POST /api/normalization-rules
   - Returns: rule_id "rule_uber_all_1"

7. System batch-normalizes 47 transactions
   - POST /api/normalization/batch
   - Updates all transactions with normalized_merchant="Uber"

8. User sees success notification
   "✅ Rule created. Normalized 47 transactions to 'Uber'"

9. User returns to transaction list
   - All Uber transactions now show "Uber" (consolidated)
```

### Wireframes

#### Step 3: Rule Creation Form

```
┌───────────────────────────────────────────────────────────┐
│ Create Normalization Rule                  [×]            │
├───────────────────────────────────────────────────────────┤
│                                                             │
│ Rule Type: ● Exact  ○ Regex  ○ Fuzzy  ○ Soundex           │
│ Selected: Regex                                            │
│                                                             │
│ Pattern *                                                   │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ UBER.*                                               │   │
│ └─────────────────────────────────────────────────────┘   │
│ ℹ️ Use .* for wildcard (matches "UBER EATS", "UBER RIDE")│
│                                                             │
│ Replacement *                                               │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ Uber                                                 │   │
│ └─────────────────────────────────────────────────────┘   │
│ This will be the normalized name                          │
│                                                             │
│ Priority (0-100) *                                          │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ 0────────────●──────────────────────────────── 100   │   │
│ │                    90                                │   │
│ └─────────────────────────────────────────────────────┘   │
│ Higher priority = executed first                          │
│                                                             │
│             [Test Rule]  [Cancel]  [Save Rule]             │
└───────────────────────────────────────────────────────────┘
```

#### Step 4: Test Preview

```
┌───────────────────────────────────────────────────────────┐
│ Test Results: "UBER.*" → "Uber"               [×]         │
├───────────────────────────────────────────────────────────┤
│                                                             │
│ ✅ 47 transactions will be normalized                      │
│                                                             │
│ Sample Matches:                                            │
│                                                             │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ "UBER EATS PENDING" → "Uber"            ✅          │   │
│ │ Match: Regex | Confidence: 100%                     │   │
│ │ Transactions: 15                                    │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ "UBER *RIDE" → "Uber"                   ✅          │   │
│ │ Match: Regex | Confidence: 100%                     │   │
│ │ Transactions: 23                                    │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ "Uber Technologies" → "Uber"            ✅          │   │
│ │ Match: Regex | Confidence: 100%                     │   │
│ │ Transactions: 9                                     │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│ [Show All 47]                                              │
│                                                             │
│                    [Adjust Pattern]  [Cancel]  [Save]      │
└───────────────────────────────────────────────────────────┘
```

---

## User Journey 3: Review and Merge Cluster Suggestions

**Scenario:** System detects similar merchant names nightly, suggests cluster merge

### Flow

```
1. Nightly job runs ClusteringEngine.create_clusters()
   - Scans all merchant names for user
   - Finds similar variants:
     • "AMAZON.COM" (23 txns)
     • "AMZN MKTP US" (45 txns)
     • "AMAZON PRIME" (12 txns)
   - Creates cluster with similarity 0.85

2. User logs in, sees notification
   "💡 4 new cluster suggestions available"

3. User opens ClusterViewer
   - Sees grid of pending clusters
   - Amazon cluster shows:
     • Canonical: "Amazon"
     • Variants: 3
     • Transactions: 80
     • Similarity: 0.85

4. User clicks "View" on Amazon cluster
   - Detail view shows:
     • Similarity heatmap
     • Per-variant similarity to "Amazon"
     • Transaction counts

5. User reviews cluster
   - Sees all variants make sense
   - Notices no outliers
   - Decides to accept

6. User clicks "Accept Merge"
   - Confirmation dialog shows:
     • 3 rules will be created
     • 80 transactions will be normalized
   - User confirms

7. System creates rules
   - Rule 1: "AMAZON.COM" → "Amazon" (exact, priority 80)
   - Rule 2: "AMZN MKTP US" → "Amazon" (exact, priority 80)
   - Rule 3: "AMAZON PRIME" → "Amazon" (exact, priority 80)

8. System batch-normalizes 80 transactions
   - Updates all to normalized_merchant="Amazon"

9. User sees success notification
   "✅ Cluster merged. Created 3 rules, normalized 80 transactions"

10. Cluster status updated to "accepted"
```

### Wireframes

#### Step 3: Cluster Overview

```
┌─────────────────────────────────────────────────────────────────┐
│ Merchant Clusters                        Min Similarity: [0.70▼] │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│ Sort: [Similarity ▼]  Status: [Pending ▼]                       │
│                                                                   │
│ ┌────────────────────────┐  ┌────────────────────────┐          │
│ │ Amazon                  │  │ Walmart                │          │
│ │ 📊 Similarity: 0.85     │  │ 📊 Similarity: 0.88    │          │
│ │ 💰 80 transactions      │  │ 💰 34 transactions     │          │
│ │                         │  │                        │          │
│ │ 3 variants:             │  │ 2 variants:            │          │
│ │ • AMAZON.COM (23)       │  │ • WALMART (20)         │          │
│ │ • AMZN MKTP US (45)     │  │ • WAL-MART (14)        │          │
│ │ • AMAZON PRIME (12)     │  │                        │          │
│ │                         │  │ [View] [Accept] [×]    │          │
│ │ [View] [Accept] [×]     │  └────────────────────────┘          │
│ └────────────────────────┘                                        │
│                                                                   │
│ Total: 4 clusters │ Pending: 4 │ Total transactions: 168         │
└─────────────────────────────────────────────────────────────────┘
```

#### Step 4: Cluster Detail

```
┌─────────────────────────────────────────────────────────────────┐
│ Cluster: Amazon                            [×] Close             │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│ Canonical Name: Amazon                                           │
│ Overall Similarity: 0.85 (Good)                                  │
│ Total Transactions: 80                                           │
│ Status: Pending Review                                           │
│                                                                   │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ Variants & Similarity Scores                                 │ │
│ ├─────────────────────────────────────────────────────────────┤ │
│ │                                                              │ │
│ │ ✅ AMAZON.COM (23 txns)                                      │ │
│ │    Similarity to "Amazon": 0.92 ████████████████████░░       │ │
│ │                                                              │ │
│ │ ✅ AMZN MKTP US (45 txns)                                    │ │
│ │    Similarity to "Amazon": 0.78 ███████████████░░░░░         │ │
│ │                                                              │ │
│ │ ✅ AMAZON PRIME (12 txns)                                    │ │
│ │    Similarity to "Amazon": 0.85 ████████████████░░░░         │ │
│ │                                                              │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                                   │
│ 💡 All variants have good similarity (>0.70). Safe to merge.    │
│                                                                   │
│                    [Reject Cluster] [Accept Merge]               │
└─────────────────────────────────────────────────────────────────┘
```

---

## User Journey 4: Test Rule Before Applying

**Scenario:** User wants to create fuzzy rule for McDonald's but unsure of threshold

### Flow

```
1. User opens RuleEditorDialog
   - Clicks "Create Rule"

2. User selects fuzzy rule type
   - Rule Type: Fuzzy
   - Pattern: "McDonald's"
   - Replacement: "McDonald's"
   - Similarity Threshold: 0.80 (default)

3. User clicks "Test Rule" (without saving)
   - System calls POST /api/normalization-rules/test
   - Scans all merchant names for matches

4. System returns matches
   - "MCDONALDS #1234" → 0.87 similarity ✅
   - "MCDONALD'S" → 0.95 similarity ✅
   - "MC DONALDS" → 0.82 similarity ✅
   - "McDONALD S" → 0.78 similarity ❌ (below 0.80)

5. User reviews results
   - Sees "McDONALD S" excluded (0.78 < 0.80)
   - Wants to include it

6. User adjusts threshold to 0.75
   - Updates slider
   - Clicks "Test Rule" again

7. System returns new matches
   - Now includes "McDONALD S" (0.78 > 0.75)
   - Total: 4 variants, 23 transactions

8. User satisfied with matches
   - Clicks "Save Rule"
   - System creates rule with threshold 0.75

9. System batch-normalizes 23 transactions
   - All McDonald's variants → "McDonald's"
```

### Wireframe: Fuzzy Rule Testing

```
┌───────────────────────────────────────────────────────────┐
│ Create Fuzzy Rule: McDonald's              [×]            │
├───────────────────────────────────────────────────────────┤
│                                                             │
│ Rule Type: ○ Exact  ○ Regex  ● Fuzzy  ○ Soundex           │
│                                                             │
│ Pattern: "McDonald's"                                      │
│ Replacement: "McDonald's"                                  │
│                                                             │
│ Similarity Threshold (0.70-1.0)                            │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ 0.70───────●──────────────────────────────── 1.0    │   │
│ │           0.75                                       │   │
│ └─────────────────────────────────────────────────────┘   │
│ Lower = more matches (less strict)                        │
│                                                             │
│ 💡 Test Results (4 variants, 23 transactions):            │
│ ┌─────────────────────────────────────────────────────┐   │
│ │ "MCDONALD'S" → 0.95 ✅                              │   │
│ │ "MCDONALDS #1234" → 0.87 ✅                         │   │
│ │ "MC DONALDS" → 0.82 ✅                              │   │
│ │ "McDONALD S" → 0.78 ✅ (now included!)             │   │
│ └─────────────────────────────────────────────────────┘   │
│                                                             │
│             [Test Again]  [Cancel]  [Save Rule]            │
└───────────────────────────────────────────────────────────┘
```

---

## User Journey 5: Batch Normalize Historical Transactions

**Scenario:** User creates new rule, wants to apply to past transactions

### Flow

```
1. User creates new rule
   - Pattern: "STARBUCKS.*"
   - Replacement: "Starbucks"
   - Type: Regex
   - Priority: 90

2. Rule saved successfully
   - System applies to new transactions automatically
   - But 156 historical transactions still have raw names

3. User sees notification
   "💡 156 historical transactions match this rule. Apply now?"

4. User clicks "Apply to Historical"
   - Confirmation dialog shows:
     • 156 transactions will be updated
     • This may overwrite manual edits
   - User confirms

5. System batch-normalizes
   - POST /api/normalization/batch
   - Processes 156 transactions
   - Updates normalized_merchant="Starbucks"

6. User sees progress indicator
   "⏳ Normalizing 156 transactions..."

7. System completes
   - Success notification: "✅ Normalized 156 transactions to 'Starbucks'"

8. User views transaction list
   - All Starbucks transactions now consolidated
```

### Wireframe: Batch Apply Confirmation

```
┌───────────────────────────────────────────────────────────┐
│ Apply Rule to Historical Transactions?     [×]            │
├───────────────────────────────────────────────────────────┤
│                                                             │
│ Rule: "STARBUCKS.*" → "Starbucks"                         │
│                                                             │
│ This rule will be applied to 156 historical transactions:  │
│                                                             │
│ • "STARBUCKS #1234" (45 transactions)                     │
│ • "STARBUCKS COFFEE" (67 transactions)                    │
│ • "STARBUCKS STORE" (44 transactions)                     │
│                                                             │
│ ⚠️ Warning:                                                │
│ • This may overwrite any manual merchant edits            │
│ • Changes cannot be undone (disable rule to revert)       │
│                                                             │
│ [ ] Skip transactions with manual edits                    │
│                                                             │
│                         [Cancel]  [Apply to All]           │
└───────────────────────────────────────────────────────────┘
```

---

## User Journey 6: Handle Conflicting Rules

**Scenario:** User has multiple rules that could match same text, needs priority ordering

### Flow

```
1. User has existing rules:
   - Rule A: "UBER.*" → "Uber" (priority 90, regex)
   - Rule B: "UBER EATS" → "Uber Eats" (priority 95, exact)

2. Transaction ingested: "UBER EATS"
   - MerchantNormalizer loads rules (priority order)
   - Rule B matches first (exact match, priority 95)
   - Rule A also matches but not executed (lower priority)

3. Transaction normalized to "Uber Eats" (Rule B wins)

4. User views MerchantRulesManager
   - Sees both rules listed
   - Rule B shown first (priority 95)
   - Rule A shown second (priority 90)

5. User realizes conflict
   - Wants all Uber variants normalized to "Uber" (not "Uber Eats")
   - Needs to adjust priorities

6. User edits Rule B
   - Lowers priority to 85 (below Rule A)
   - Or deletes Rule B entirely

7. System re-normalizes affected transactions
   - Now "UBER EATS" matches Rule A first
   - Normalized to "Uber"

8. User sees updated transaction list
   - All Uber variants now show "Uber"
```

### Wireframe: Rule Priority Management

```
┌─────────────────────────────────────────────────────────────────┐
│ Normalization Rules                      [+ Create Rule] [Test] │
├─────────────────────────────────────────────────────────────────┤
│                                                                   │
│ Sort: [Priority ▼]                                               │
│                                                                   │
│ ⚠️ Conflict detected: Multiple rules match "UBER EATS"          │
│                                                                   │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ Priority 95 │ EXACT │ ✅ Enabled         [Edit] [Delete] [⋮]│ │
│ │ Pattern: "UBER EATS"                                        │ │
│ │ Replacement: "Uber Eats"                                    │ │
│ │ Matches: 15 transactions                                    │ │
│ │ ⚠️ This rule conflicts with "UBER.*" below                 │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                                   │
│ ┌─────────────────────────────────────────────────────────────┐ │
│ │ Priority 90 │ REGEX │ ✅ Enabled         [Edit] [Delete] [⋮]│ │
│ │ Pattern: "UBER.*"                                           │ │
│ │ Replacement: "Uber"                                         │ │
│ │ Matches: 47 transactions                                    │ │
│ │ ℹ️ Lower priority, executed after exact match              │ │
│ └─────────────────────────────────────────────────────────────┘ │
│                                                                   │
│ 💡 Tip: Higher priority rules execute first. Exact matches      │
│ typically have priority 95, regex 90, fuzzy 85.                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Multi-Domain Examples

### Healthcare: Provider Name Normalization

**User Journey:** Hospital admin normalizes provider names

```
1. Admin sees providers:
   - "ST MARY'S HOSP"
   - "ST MARY'S HOSPITAL"
   - "ST MARYS MEDICAL CENTER"

2. Admin creates regex rule:
   - Pattern: "ST MARY'S.*"
   - Replacement: "St. Mary's Hospital"
   - Priority: 90

3. System clusters similar providers
   - Suggests merge for 3 variants

4. Admin accepts cluster
   - Creates normalization rules
   - Updates 234 patient records
```

### Legal: Case Name Normalization

**User Journey:** Law firm normalizes case names

```
1. Lawyer sees cases:
   - "DOE V. SMITH"
   - "Doe v. Smith"
   - "DOE VS SMITH"

2. Lawyer creates regex rules:
   - Pattern: "(\\w+) V\\. (\\w+)" → "\\1 v. \\2"
   - Pattern: "(\\w+) VS (\\w+)" → "\\1 v. \\2"

3. System normalizes all case names to "Doe v. Smith"
```

### Research: Author Name Deduplication

**User Journey:** Researcher deduplicates author names

```
1. Researcher sees citations:
   - "J. Smith"
   - "John Smith"
   - "Smith, J."
   - "Smith, John"

2. System clusters similar names
   - Suggests merge for 4 variants

3. Researcher accepts cluster
   - Canonical: "John Smith"
   - Creates fuzzy rules for variants
```

---

## Summary

**Cluster Rules Experience** provides:
- ✅ Auto-normalization using existing rules
- ✅ Rule creation with real-time testing
- ✅ Cluster suggestions for bulk normalization
- ✅ Fuzzy matching with adjustable thresholds
- ✅ Batch processing for historical data
- ✅ Priority-based conflict resolution
- ✅ Multi-domain support (finance, healthcare, legal, research)

**Universal Pattern:**
Applicable to any domain requiring text standardization and entity deduplication with user-defined rules and AI-assisted clustering.
