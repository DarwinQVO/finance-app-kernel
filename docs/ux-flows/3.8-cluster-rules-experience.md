# UX Flow: Cluster Rules Experience (3.8)

> **Vertical:** 3.8 Cluster Rules (Merchant Normalization & Transaction Clustering)
> **Last Updated:** 2025-10-24

---

## Overview

This document describes the complete user experience for creating normalization rules, reviewing cluster suggestions, and managing text standardization across merchants, providers, institutions, and other entities.

**Target Users:**
- Finance users normalizing merchant names
- Healthcare admins standardizing provider names
- Legal teams normalizing case/party names
- Researchers deduplicating author/institution names

---

## User Journey 1: Auto-Normalize Merchant Name Using Existing Rule

**Scenario:** Transaction ingested with raw merchant name, system auto-normalizes using user's rule

### Flow

```
1. System ingests transaction
   Raw merchant: "UBER EATS PENDING"
   User: Darwin

2. MerchantNormalizer.normalize() executes
   - Load Darwin's rules (priority order)
   - Match: rule_uber_all (pattern: "UBER.*", replacement: "Uber", priority: 90)
   - Apply normalization

3. Transaction stored with normalized merchant
   {
     "transaction_id": "txn_12345",
     "raw_merchant": "UBER EATS PENDING",
     "normalized_merchant": "Uber",
     "normalization_rule_id": "rule_uber_all"
   }

4. User views transaction in TransactionList
   - Merchant column shows: "Uber"
   - Tooltip on hover: "Normalized from 'UBER EATS PENDING' using rule 'UBER.*'"

5. User clicks transaction to view detail
   - DrillDownPanel shows:
     â€¢ Merchant: "Uber" (badge: "Normalized")
     â€¢ Original: "UBER EATS PENDING"
     â€¢ Rule: "UBER.* â†’ Uber (Priority 90)"
     â€¢ Confidence: 100%
```

### Wireframe: Normalized Transaction Detail

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Transaction Details                                  [Ã—] Close   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚ Amount: -$15.67                                                  â”‚
â”‚ Date: 2025-10-24                                                 â”‚
â”‚                                                                   â”‚
â”‚ Merchant: Uber  [âœ“ Normalized]                                  â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Original: "UBER EATS PENDING"                                â”‚ â”‚
â”‚ â”‚ Normalized by rule: "UBER.*" â†’ "Uber"                       â”‚ â”‚
â”‚ â”‚ Match type: Regex                                            â”‚ â”‚
â”‚ â”‚ Confidence: 100%                                             â”‚ â”‚
â”‚ â”‚ Applied: 2025-10-24 10:05:00                                 â”‚ â”‚
â”‚ â”‚                                                              â”‚ â”‚
â”‚ â”‚ [View Rule] [Edit Normalization]                            â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚ Category: Food & Dining                                          â”‚
â”‚ Notes: Lunch delivery                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## User Journey 2: Create New Normalization Rule

**Scenario:** User has 47 Uber transactions with different raw names, wants to normalize all to "Uber"

### Flow

```
1. User views transaction list
   - Sees: "UBER EATS PENDING", "UBER *RIDE", "Uber Technologies"
   - Realizes these should be grouped

2. User opens MerchantRulesManager
   - Clicks "Create Rule" button
   - RuleEditorDialog appears

3. User fills form
   - Rule Type: Selects "Regex"
   - Pattern: Enters "UBER.*"
   - Replacement: Enters "Uber"
   - Priority: Adjusts slider to 90 (default for regex)

4. User clicks "Test Rule"
   - System calls POST /api/normalization-rules/test
   - Returns: 47 transactions match
   - Preview shows:
     â€¢ "UBER EATS PENDING" â†’ "Uber" (15 txns)
     â€¢ "UBER *RIDE" â†’ "Uber" (23 txns)
     â€¢ "Uber Technologies" â†’ "Uber" (9 txns)

5. User reviews preview
   - Confirms all matches look correct
   - Clicks "Save Rule"

6. System creates rule
   - POST /api/normalization-rules
   - Returns: rule_id "rule_uber_all_1"

7. System batch-normalizes 47 transactions
   - POST /api/normalization/batch
   - Updates all transactions with normalized_merchant="Uber"

8. User sees success notification
   "âœ… Rule created. Normalized 47 transactions to 'Uber'"

9. User returns to transaction list
   - All Uber transactions now show "Uber" (consolidated)
```

### Wireframes

#### Step 3: Rule Creation Form

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Create Normalization Rule                  [Ã—]            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ Rule Type: â— Exact  â—‹ Regex  â—‹ Fuzzy  â—‹ Soundex           â”‚
â”‚ Selected: Regex                                            â”‚
â”‚                                                             â”‚
â”‚ Pattern *                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ UBER.*                                               â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ â„¹ï¸ Use .* for wildcard (matches "UBER EATS", "UBER RIDE")â”‚
â”‚                                                             â”‚
â”‚ Replacement *                                               â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Uber                                                 â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ This will be the normalized name                          â”‚
â”‚                                                             â”‚
â”‚ Priority (0-100) *                                          â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ 0â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 100   â”‚   â”‚
â”‚ â”‚                    90                                â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ Higher priority = executed first                          â”‚
â”‚                                                             â”‚
â”‚             [Test Rule]  [Cancel]  [Save Rule]             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Step 4: Test Preview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Test Results: "UBER.*" â†’ "Uber"               [Ã—]         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ âœ… 47 transactions will be normalized                      â”‚
â”‚                                                             â”‚
â”‚ Sample Matches:                                            â”‚
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ "UBER EATS PENDING" â†’ "Uber"            âœ…          â”‚   â”‚
â”‚ â”‚ Match: Regex | Confidence: 100%                     â”‚   â”‚
â”‚ â”‚ Transactions: 15                                    â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ "UBER *RIDE" â†’ "Uber"                   âœ…          â”‚   â”‚
â”‚ â”‚ Match: Regex | Confidence: 100%                     â”‚   â”‚
â”‚ â”‚ Transactions: 23                                    â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ "Uber Technologies" â†’ "Uber"            âœ…          â”‚   â”‚
â”‚ â”‚ Match: Regex | Confidence: 100%                     â”‚   â”‚
â”‚ â”‚ Transactions: 9                                     â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚ [Show All 47]                                              â”‚
â”‚                                                             â”‚
â”‚                    [Adjust Pattern]  [Cancel]  [Save]      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## User Journey 3: Review and Merge Cluster Suggestions

**Scenario:** System detects similar merchant names nightly, suggests cluster merge

### Flow

```
1. Nightly job runs ClusteringEngine.create_clusters()
   - Scans all merchant names for user
   - Finds similar variants:
     â€¢ "AMAZON.COM" (23 txns)
     â€¢ "AMZN MKTP US" (45 txns)
     â€¢ "AMAZON PRIME" (12 txns)
   - Creates cluster with similarity 0.85

2. User logs in, sees notification
   "ğŸ’¡ 4 new cluster suggestions available"

3. User opens ClusterViewer
   - Sees grid of pending clusters
   - Amazon cluster shows:
     â€¢ Canonical: "Amazon"
     â€¢ Variants: 3
     â€¢ Transactions: 80
     â€¢ Similarity: 0.85

4. User clicks "View" on Amazon cluster
   - Detail view shows:
     â€¢ Similarity heatmap
     â€¢ Per-variant similarity to "Amazon"
     â€¢ Transaction counts

5. User reviews cluster
   - Sees all variants make sense
   - Notices no outliers
   - Decides to accept

6. User clicks "Accept Merge"
   - Confirmation dialog shows:
     â€¢ 3 rules will be created
     â€¢ 80 transactions will be normalized
   - User confirms

7. System creates rules
   - Rule 1: "AMAZON.COM" â†’ "Amazon" (exact, priority 80)
   - Rule 2: "AMZN MKTP US" â†’ "Amazon" (exact, priority 80)
   - Rule 3: "AMAZON PRIME" â†’ "Amazon" (exact, priority 80)

8. System batch-normalizes 80 transactions
   - Updates all to normalized_merchant="Amazon"

9. User sees success notification
   "âœ… Cluster merged. Created 3 rules, normalized 80 transactions"

10. Cluster status updated to "accepted"
```

### Wireframes

#### Step 3: Cluster Overview

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Merchant Clusters                        Min Similarity: [0.70â–¼] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚ Sort: [Similarity â–¼]  Status: [Pending â–¼]                       â”‚
â”‚                                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚ â”‚ Amazon                  â”‚  â”‚ Walmart                â”‚          â”‚
â”‚ â”‚ ğŸ“Š Similarity: 0.85     â”‚  â”‚ ğŸ“Š Similarity: 0.88    â”‚          â”‚
â”‚ â”‚ ğŸ’° 80 transactions      â”‚  â”‚ ğŸ’° 34 transactions     â”‚          â”‚
â”‚ â”‚                         â”‚  â”‚                        â”‚          â”‚
â”‚ â”‚ 3 variants:             â”‚  â”‚ 2 variants:            â”‚          â”‚
â”‚ â”‚ â€¢ AMAZON.COM (23)       â”‚  â”‚ â€¢ WALMART (20)         â”‚          â”‚
â”‚ â”‚ â€¢ AMZN MKTP US (45)     â”‚  â”‚ â€¢ WAL-MART (14)        â”‚          â”‚
â”‚ â”‚ â€¢ AMAZON PRIME (12)     â”‚  â”‚                        â”‚          â”‚
â”‚ â”‚                         â”‚  â”‚ [View] [Accept] [Ã—]    â”‚          â”‚
â”‚ â”‚ [View] [Accept] [Ã—]     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                        â”‚
â”‚                                                                   â”‚
â”‚ Total: 4 clusters â”‚ Pending: 4 â”‚ Total transactions: 168         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### Step 4: Cluster Detail

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Cluster: Amazon                            [Ã—] Close             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚ Canonical Name: Amazon                                           â”‚
â”‚ Overall Similarity: 0.85 (Good)                                  â”‚
â”‚ Total Transactions: 80                                           â”‚
â”‚ Status: Pending Review                                           â”‚
â”‚                                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Variants & Similarity Scores                                 â”‚ â”‚
â”‚ â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ â”‚
â”‚ â”‚                                                              â”‚ â”‚
â”‚ â”‚ âœ… AMAZON.COM (23 txns)                                      â”‚ â”‚
â”‚ â”‚    Similarity to "Amazon": 0.92 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘       â”‚ â”‚
â”‚ â”‚                                                              â”‚ â”‚
â”‚ â”‚ âœ… AMZN MKTP US (45 txns)                                    â”‚ â”‚
â”‚ â”‚    Similarity to "Amazon": 0.78 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘â–‘         â”‚ â”‚
â”‚ â”‚                                                              â”‚ â”‚
â”‚ â”‚ âœ… AMAZON PRIME (12 txns)                                    â”‚ â”‚
â”‚ â”‚    Similarity to "Amazon": 0.85 â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–‘â–‘â–‘â–‘         â”‚ â”‚
â”‚ â”‚                                                              â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚ ğŸ’¡ All variants have good similarity (>0.70). Safe to merge.    â”‚
â”‚                                                                   â”‚
â”‚                    [Reject Cluster] [Accept Merge]               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## User Journey 4: Test Rule Before Applying

**Scenario:** User wants to create fuzzy rule for McDonald's but unsure of threshold

### Flow

```
1. User opens RuleEditorDialog
   - Clicks "Create Rule"

2. User selects fuzzy rule type
   - Rule Type: Fuzzy
   - Pattern: "McDonald's"
   - Replacement: "McDonald's"
   - Similarity Threshold: 0.80 (default)

3. User clicks "Test Rule" (without saving)
   - System calls POST /api/normalization-rules/test
   - Scans all merchant names for matches

4. System returns matches
   - "MCDONALDS #1234" â†’ 0.87 similarity âœ…
   - "MCDONALD'S" â†’ 0.95 similarity âœ…
   - "MC DONALDS" â†’ 0.82 similarity âœ…
   - "McDONALD S" â†’ 0.78 similarity âŒ (below 0.80)

5. User reviews results
   - Sees "McDONALD S" excluded (0.78 < 0.80)
   - Wants to include it

6. User adjusts threshold to 0.75
   - Updates slider
   - Clicks "Test Rule" again

7. System returns new matches
   - Now includes "McDONALD S" (0.78 > 0.75)
   - Total: 4 variants, 23 transactions

8. User satisfied with matches
   - Clicks "Save Rule"
   - System creates rule with threshold 0.75

9. System batch-normalizes 23 transactions
   - All McDonald's variants â†’ "McDonald's"
```

### Wireframe: Fuzzy Rule Testing

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Create Fuzzy Rule: McDonald's              [Ã—]            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ Rule Type: â—‹ Exact  â—‹ Regex  â— Fuzzy  â—‹ Soundex           â”‚
â”‚                                                             â”‚
â”‚ Pattern: "McDonald's"                                      â”‚
â”‚ Replacement: "McDonald's"                                  â”‚
â”‚                                                             â”‚
â”‚ Similarity Threshold (0.70-1.0)                            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ 0.70â”€â”€â”€â”€â”€â”€â”€â—â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ 1.0    â”‚   â”‚
â”‚ â”‚           0.75                                       â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚ Lower = more matches (less strict)                        â”‚
â”‚                                                             â”‚
â”‚ ğŸ’¡ Test Results (4 variants, 23 transactions):            â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ "MCDONALD'S" â†’ 0.95 âœ…                              â”‚   â”‚
â”‚ â”‚ "MCDONALDS #1234" â†’ 0.87 âœ…                         â”‚   â”‚
â”‚ â”‚ "MC DONALDS" â†’ 0.82 âœ…                              â”‚   â”‚
â”‚ â”‚ "McDONALD S" â†’ 0.78 âœ… (now included!)             â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                             â”‚
â”‚             [Test Again]  [Cancel]  [Save Rule]            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## User Journey 5: Batch Normalize Historical Transactions

**Scenario:** User creates new rule, wants to apply to past transactions

### Flow

```
1. User creates new rule
   - Pattern: "STARBUCKS.*"
   - Replacement: "Starbucks"
   - Type: Regex
   - Priority: 90

2. Rule saved successfully
   - System applies to new transactions automatically
   - But 156 historical transactions still have raw names

3. User sees notification
   "ğŸ’¡ 156 historical transactions match this rule. Apply now?"

4. User clicks "Apply to Historical"
   - Confirmation dialog shows:
     â€¢ 156 transactions will be updated
     â€¢ This may overwrite manual edits
   - User confirms

5. System batch-normalizes
   - POST /api/normalization/batch
   - Processes 156 transactions
   - Updates normalized_merchant="Starbucks"

6. User sees progress indicator
   "â³ Normalizing 156 transactions..."

7. System completes
   - Success notification: "âœ… Normalized 156 transactions to 'Starbucks'"

8. User views transaction list
   - All Starbucks transactions now consolidated
```

### Wireframe: Batch Apply Confirmation

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Apply Rule to Historical Transactions?     [Ã—]            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚ Rule: "STARBUCKS.*" â†’ "Starbucks"                         â”‚
â”‚                                                             â”‚
â”‚ This rule will be applied to 156 historical transactions:  â”‚
â”‚                                                             â”‚
â”‚ â€¢ "STARBUCKS #1234" (45 transactions)                     â”‚
â”‚ â€¢ "STARBUCKS COFFEE" (67 transactions)                    â”‚
â”‚ â€¢ "STARBUCKS STORE" (44 transactions)                     â”‚
â”‚                                                             â”‚
â”‚ âš ï¸ Warning:                                                â”‚
â”‚ â€¢ This may overwrite any manual merchant edits            â”‚
â”‚ â€¢ Changes cannot be undone (disable rule to revert)       â”‚
â”‚                                                             â”‚
â”‚ [ ] Skip transactions with manual edits                    â”‚
â”‚                                                             â”‚
â”‚                         [Cancel]  [Apply to All]           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## User Journey 6: Handle Conflicting Rules

**Scenario:** User has multiple rules that could match same text, needs priority ordering

### Flow

```
1. User has existing rules:
   - Rule A: "UBER.*" â†’ "Uber" (priority 90, regex)
   - Rule B: "UBER EATS" â†’ "Uber Eats" (priority 95, exact)

2. Transaction ingested: "UBER EATS"
   - MerchantNormalizer loads rules (priority order)
   - Rule B matches first (exact match, priority 95)
   - Rule A also matches but not executed (lower priority)

3. Transaction normalized to "Uber Eats" (Rule B wins)

4. User views MerchantRulesManager
   - Sees both rules listed
   - Rule B shown first (priority 95)
   - Rule A shown second (priority 90)

5. User realizes conflict
   - Wants all Uber variants normalized to "Uber" (not "Uber Eats")
   - Needs to adjust priorities

6. User edits Rule B
   - Lowers priority to 85 (below Rule A)
   - Or deletes Rule B entirely

7. System re-normalizes affected transactions
   - Now "UBER EATS" matches Rule A first
   - Normalized to "Uber"

8. User sees updated transaction list
   - All Uber variants now show "Uber"
```

### Wireframe: Rule Priority Management

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Normalization Rules                      [+ Create Rule] [Test] â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚ Sort: [Priority â–¼]                                               â”‚
â”‚                                                                   â”‚
â”‚ âš ï¸ Conflict detected: Multiple rules match "UBER EATS"          â”‚
â”‚                                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Priority 95 â”‚ EXACT â”‚ âœ… Enabled         [Edit] [Delete] [â‹®]â”‚ â”‚
â”‚ â”‚ Pattern: "UBER EATS"                                        â”‚ â”‚
â”‚ â”‚ Replacement: "Uber Eats"                                    â”‚ â”‚
â”‚ â”‚ Matches: 15 transactions                                    â”‚ â”‚
â”‚ â”‚ âš ï¸ This rule conflicts with "UBER.*" below                 â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ Priority 90 â”‚ REGEX â”‚ âœ… Enabled         [Edit] [Delete] [â‹®]â”‚ â”‚
â”‚ â”‚ Pattern: "UBER.*"                                           â”‚ â”‚
â”‚ â”‚ Replacement: "Uber"                                         â”‚ â”‚
â”‚ â”‚ Matches: 47 transactions                                    â”‚ â”‚
â”‚ â”‚ â„¹ï¸ Lower priority, executed after exact match              â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                   â”‚
â”‚ ğŸ’¡ Tip: Higher priority rules execute first. Exact matches      â”‚
â”‚ typically have priority 95, regex 90, fuzzy 85.                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Multi-Domain Examples

### Healthcare: Provider Name Normalization

**User Journey:** Hospital admin normalizes provider names

```
1. Admin sees providers:
   - "ST MARY'S HOSP"
   - "ST MARY'S HOSPITAL"
   - "ST MARYS MEDICAL CENTER"

2. Admin creates regex rule:
   - Pattern: "ST MARY'S.*"
   - Replacement: "St. Mary's Hospital"
   - Priority: 90

3. System clusters similar providers
   - Suggests merge for 3 variants

4. Admin accepts cluster
   - Creates normalization rules
   - Updates 234 patient records
```

### Legal: Case Name Normalization

**User Journey:** Law firm normalizes case names

```
1. Lawyer sees cases:
   - "DOE V. SMITH"
   - "Doe v. Smith"
   - "DOE VS SMITH"

2. Lawyer creates regex rules:
   - Pattern: "(\\w+) V\\. (\\w+)" â†’ "\\1 v. \\2"
   - Pattern: "(\\w+) VS (\\w+)" â†’ "\\1 v. \\2"

3. System normalizes all case names to "Doe v. Smith"
```

### Research: Author Name Deduplication

**User Journey:** Researcher deduplicates author names

```
1. Researcher sees citations:
   - "J. Smith"
   - "John Smith"
   - "Smith, J."
   - "Smith, John"

2. System clusters similar names
   - Suggests merge for 4 variants

3. Researcher accepts cluster
   - Canonical: "John Smith"
   - Creates fuzzy rules for variants
```

---

## Summary

**Cluster Rules Experience** provides:
- âœ… Auto-normalization using existing rules
- âœ… Rule creation with real-time testing
- âœ… Cluster suggestions for bulk normalization
- âœ… Fuzzy matching with adjustable thresholds
- âœ… Batch processing for historical data
- âœ… Priority-based conflict resolution
- âœ… Multi-domain support (finance, healthcare, legal, research)

**Universal Pattern:**
Applicable to any domain requiring text standardization and entity deduplication with user-defined rules and AI-assisted clustering.
