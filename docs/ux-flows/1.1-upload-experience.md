# UX Flow: Upload Experience (Vertical 1.1)

**Version**: 1.0
**Last Updated**: 2025-10-22

---

## Screen: Upload Page

### Wireframe (Desktop)

```
┌─────────────────────────────────────────────────────────────┐
│ Finance App                                    [@user] [⚙]  │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  Upload Bank Statement                                       │
│  ──────────────────────                                      │
│                                                              │
│  Source Type                                                 │
│  ┌────────────────────────────────────────────────┐         │
│  │ Bank of America PDF Statement           [▼]   │         │
│  └────────────────────────────────────────────────┘         │
│                                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │  📄 Drag & drop PDF here or click to browse        │   │
│  │                                                      │   │
│  │             [Choose File]                           │   │
│  │                                                      │   │
│  │  Accepted: PDF files up to 50MB                     │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│                                                              │
│  Recent Uploads                                              │
│  ──────────────                                              │
│  ┌──────────────────────────────────────────────────────┐   │
│  │ statement_jan_2024.pdf    [✓ Parsed]    10:32 AM    │   │
│  │ statement_dec_2023.pdf    [✅ Complete]  Yesterday   │   │
│  │ large_file.pdf            [❌ Error]     10:15 AM    │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                              │
│  [< Previous] Page 1 of 3 [Next >]                           │
│                                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## User Journey 1: Successful Upload

### Steps

**1. User lands on upload page**
```
State: idle
Components visible:
- RegistrySelect (source type)
- FileUpload (drag & drop area)
- UploadList (recent uploads)
```

**2. User selects source type**
```
Action: Click dropdown
→ Shows: "Bank of America PDF Statement"
→ User clicks option
→ sourceType = "bofa_pdf"
```

**3. User drags PDF over upload area**
```
State: dragover
Visual change:
- Border highlights (green dashed → solid green)
- Background tint (light blue)
- Text changes: "Drop file to upload"
```

**4. User drops file**
```
Event: onDrop
→ Component validates file
  - Check MIME type: application/pdf ✓
  - Check size: 2.4MB < 50MB ✓
→ onFileSelect(file) called
```

**5. Frontend uploads file to backend**
```
POST /uploads
  Content-Type: multipart/form-data
  file: <binary>
  source_type: "bofa_pdf"

Response (201 Created):
  {
    "upload_id": "UL_abc123",
    "status": "queued_for_parse",
    "upload_log_ref": "/logs/uploads/UL_abc123.log"
  }
```

**6. UI updates**
```
- Toast notification: "✓ File uploaded successfully"
- New row added to UploadList:
  statement_feb_2024.pdf    [🕒 Queued]    now

- FileUpload resets to idle state
```

**7. Backend processes file (background)**
```
T+0s:   status = "queued_for_parse"
T+2s:   Coordinator → "parsing"
T+5s:   Parser completes → Coordinator → "parsed"
T+6s:   Coordinator → "normalizing"
T+8s:   Normalizer completes → Coordinator → "normalized"
```

**8. UI polls for updates (every 5s)**
```
GET /uploads/UL_abc123

T+0s:  { status: "queued_for_parse" }
       UI shows: [🕒 Queued]

T+5s:  { status: "parsing" }
       UI shows: [⏳ Parsing...]

T+10s: { status: "parsed", observations_count: 42 }
       UI shows: [✓ Parsed]

T+15s: { status: "normalized", canonicals_count: 42 }
       UI shows: [✅ Complete]
       Poll stops
```

**Final state**:
```
┌──────────────────────────────────────────────────────────┐
│ statement_feb_2024.pdf    [✅ Complete]    10:35 AM     │
│ statement_jan_2024.pdf    [✓ Parsed]      10:32 AM     │
└──────────────────────────────────────────────────────────┘
```

---

## User Journey 2: Duplicate Upload

### Steps

**1-4. Same as Journey 1**

**5. Backend detects duplicate**
```
POST /uploads
  file: statement_jan_2024.pdf (hash: sha256:abc123...)

Backend:
→ Calculate hash
→ Check FileArtifact table
→ Hash exists! (uploaded 3 hours ago)
→ Return 409 Conflict

Response (409):
  {
    "error": "duplicate",
    "upload_id": "UL_existing",
    "file_hash": "sha256:abc123...",
    "upload_log_ref": "/logs/uploads/UL_existing.log"
  }
```

**6. UI shows duplicate dialog**
```
┌──────────────────────────────────────────┐
│  Duplicate File Detected                │
│                                          │
│  This file was already uploaded:         │
│  statement_jan_2024.pdf                  │
│  Uploaded: 3 hours ago                   │
│  Status: ✅ Complete                     │
│                                          │
│  [View Existing Upload]  [Cancel]       │
└──────────────────────────────────────────┘
```

**7. User clicks "View Existing Upload"**
```
→ Navigate to /uploads/UL_existing
→ Shows full upload detail page
```

**Alternative**: User clicks "Cancel"
```
→ Dialog closes
→ FileUpload resets to idle
→ No new record created
```

---

## User Journey 3: Upload Error (File Too Large)

### Steps

**1. User selects 75MB PDF file**
```
Action: Click "Choose File" → selects large_file.pdf (75MB)
```

**2. Client-side validation fails**
```
FileUpload component:
→ Check file size: 75MB > 50MB ❌
→ onError({
    code: "FILE_TOO_LARGE",
    message: "File exceeds 50MB limit"
  })
```

**3. UI shows error**
```
┌──────────────────────────────────────────────────────────┐
│  ❌ File too large                                       │
│                                                          │
│  File: large_file.pdf (75MB)                            │
│  Maximum allowed: 50MB                                   │
│                                                          │
│             [Try Again]                                  │
│                                                          │
│  Accepted: PDF files up to 50MB                          │
└──────────────────────────────────────────────────────────┘
```

**4. User clicks "Try Again"**
```
→ Error clears
→ Component resets to idle
→ User can select different file
```

---

## User Journey 4: Backend Parsing Error

### Steps

**1-5. User uploads corrupted PDF**

**6. Backend starts parsing**
```
T+0s:  status = "queued_for_parse"
T+2s:  Coordinator → "parsing"
       Parser worker starts

T+10s: Parser fails (PDF corrupt, can't extract text)
       → parse.failed event
       → Coordinator → "error"
       → error_message = "PDF_CORRUPT: Unable to extract text"
```

**7. UI polls and shows error**
```
GET /uploads/UL_abc123
{
  "upload_id": "UL_abc123",
  "status": "error",
  "error_message": "PDF_CORRUPT: Unable to extract text",
  "parse_log_ref": "/logs/parse/UL_abc123.log.json"
}

UI updates UploadList:
┌──────────────────────────────────────────────────────────┐
│ corrupted.pdf    [❌ Error: PDF corrupt]    10:40 AM    │
└──────────────────────────────────────────────────────────┘
```

**8. User clicks on row**
```
→ Opens detail modal:

┌──────────────────────────────────────────────────────────┐
│  Upload Details: corrupted.pdf                           │
│  ────────────────────────────────────────────────────────│
│                                                          │
│  Status: ❌ Error                                        │
│  Error: PDF_CORRUPT: Unable to extract text             │
│                                                          │
│  Timeline:                                               │
│  10:38 AM - Uploaded                                     │
│  10:38 AM - Queued for parsing                           │
│  10:39 AM - Parsing started                              │
│  10:40 AM - Parsing failed                               │
│                                                          │
│  Logs:                                                   │
│  - Upload log: /logs/uploads/UL_abc123.log              │
│  - Parse log: /logs/parse/UL_abc123.log.json            │
│                                                          │
│  [Retry]  [Download Original]  [Delete]                 │
└──────────────────────────────────────────────────────────┘
```

**9. User clicks "Retry"** (Future feature)
```
→ POST /uploads/UL_abc123/retry
→ Backend resets status to "queued_for_parse"
→ Parser re-runs
```

---

## Responsive Design

### Mobile (< 768px)

```
┌─────────────────────────┐
│ [≡] Finance    [@] [⚙] │
├─────────────────────────┤
│                         │
│ Upload Statement        │
│ ────────────            │
│                         │
│ Source Type             │
│ ┌─────────────────────┐ │
│ │ BoFA PDF       [▼] │ │
│ └─────────────────────┘ │
│                         │
│ ┌─────────────────────┐ │
│ │  📄 Tap to         │ │
│ │    browse          │ │
│ │                     │ │
│ │  [Choose File]     │ │
│ │                     │ │
│ │  PDF up to 50MB    │ │
│ └─────────────────────┘ │
│                         │
│ Recent Uploads          │
│ ────────────            │
│ ┌─────────────────────┐ │
│ │ statement_jan.pdf  │ │
│ │ [✅ Complete]      │ │
│ │ 10:32 AM           │ │
│ ├─────────────────────┤ │
│ │ large_file.pdf     │ │
│ │ [❌ Error]         │ │
│ │ 10:15 AM           │ │
│ └─────────────────────┘ │
│                         │
│ [Load More]             │
│                         │
└─────────────────────────┘
```

**Changes from desktop**:
- Hamburger menu (≡) instead of full nav
- Single column layout
- Drag & drop replaced with "Tap to browse" (iOS doesn't support drag & drop well)
- Upload list items stacked vertically
- Pagination replaced with "Load More" button

---

## Loading States

### During Upload (File Transfer)

```
┌──────────────────────────────────────────────────────────┐
│  Uploading statement_feb_2024.pdf...                     │
│                                                          │
│  [████████████████░░░░░░░░░░] 65%                       │
│                                                          │
│  2.4MB / 3.7MB                                           │
└──────────────────────────────────────────────────────────┘
```

### During Processing (Backend)

```
UploadList row animates:
┌──────────────────────────────────────────────────────────┐
│ statement_feb_2024.pdf    [⏳ Parsing...] ⟳   10:35 AM   │
└──────────────────────────────────────────────────────────┘
                                 ↑
                           Spinner icon animates
```

---

## Empty States

### No Uploads Yet

```
┌──────────────────────────────────────────────────────────┐
│                                                          │
│                    📄                                    │
│                                                          │
│           No uploads yet                                 │
│                                                          │
│  Upload your first bank statement to get started         │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

### Filtered (No Results)

```
┌──────────────────────────────────────────────────────────┐
│  Filter: Status = Error                                  │
│                                                          │
│                    🔍                                    │
│                                                          │
│           No uploads match your filters                  │
│                                                          │
│  [Reset Filters]                                         │
│                                                          │
└──────────────────────────────────────────────────────────┘
```

---

## Notifications / Toasts

### Success
```
┌─────────────────────────────────┐
│ ✓ File uploaded successfully    │
└─────────────────────────────────┘
  ↑ Green background, auto-dismiss 3s
```

### Error
```
┌─────────────────────────────────┐
│ ✗ Upload failed: File too large │
└─────────────────────────────────┘
  ↑ Red background, stays until dismissed
```

### Processing Complete
```
┌──────────────────────────────────────┐
│ ✓ statement_feb_2024.pdf processed   │
│   42 transactions found              │
└──────────────────────────────────────┘
  ↑ Green background, auto-dismiss 5s
```

---

## Accessibility Features

### Keyboard Navigation

```
Tab order:
1. Source type dropdown
2. File upload area (activatable with Enter/Space)
3. Recent uploads list (arrow keys to navigate rows)
4. Pagination controls

Escape key: Close modals
Enter key: Activate focused element
```

### Screen Reader Announcements

```
On file select:
"File selected: statement_feb_2024.pdf, 2.4 megabytes"

On upload success:
"Upload successful. File is queued for processing."

On status change:
"statement_feb_2024.pdf status changed to Parsing"
"statement_feb_2024.pdf status changed to Complete. 42 transactions found."

On error:
"Upload failed. File too large. Maximum size is 50 megabytes."
```

---

## Decision Points

### 1. Polling vs WebSocket for Status Updates

**Current (v1)**: Polling every 5s
- **Pros**: Simple, works everywhere
- **Cons**: Latency, unnecessary requests

**Future (v2)**: WebSocket
- **Pros**: Real-time, efficient
- **Cons**: More complex, requires WS server

**Decision**: Start with polling, migrate to WebSocket in v2 if needed

---

### 2. Progress Bar During Upload

**Current (v1)**: Show progress bar for files > 5MB
- **Pros**: User feedback, prevents anxiety
- **Cons**: Requires chunked upload implementation

**Implementation**:
```javascript
xhr.upload.onprogress = (e) => {
  if (e.lengthComputable) {
    const percent = (e.loaded / e.total) * 100
    updateProgressBar(percent)
  }
}
```

---

### 3. Duplicate Dialog vs Inline Error

**Current (v1)**: Modal dialog with "View Existing" link
- **Pros**: Clear, actionable
- **Cons**: Interrupts flow

**Alternative**: Toast notification
- **Pros**: Less intrusive
- **Cons**: Harder to provide link to existing upload

**Decision**: Use modal (more informative)

---

## Performance Targets

| Metric | Target | Notes |
|--------|--------|-------|
| Time to interactive | < 2s | First paint + JS loaded |
| Upload latency (10MB) | < 3s | Network dependent |
| Poll interval | 5s | Balance between freshness and load |
| List render (100 items) | < 100ms | Virtualization if needed |

---

**Status**: Complete
**Next**: Implement components using this UX spec
