# UX Flow 3.2: Counterparty Registry Experience

> **Vertical:** 3.2 Counterparty Registry (closed registry of merchants, people, and institutions)
> **Dependencies:** 2.1 Transaction List View (counterparty filter), 2.2 OL Exploration (transaction edit uses counterparty selector), 3.1 Account Registry (pattern reference)
> **User Story:** As a user, I want to manage counterparties (merchants, people, institutions) so I can normalize transaction descriptions, merge duplicates, and track spending patterns accurately.

---

## User Journeys

### Journey 1: Auto-Creation During Transaction Normalization

**Context:** User uploads a bank statement CSV. System encounters "UBER EATS *1234 NYC" in transaction description. Normalization engine auto-creates a counterparty record.

**Steps:**

1. **Entry point:** User uploads CSV via Import Transactions flow
   - File: `chase_2025-05.csv` (127 transactions)
   - System begins parsing transactions
   - Progress indicator: "Processing 127 transactions..."

2. **System encounters raw merchant description:**
   - Raw description: "UBER EATS *1234 NYC 05/23"
   - System checks counterparty registry for existing match
   - No exact match found for "UBER EATS *1234 NYC 05/23"
   - Normalization engine extracts canonical name: "Uber Eats"

3. **Fuzzy matching engine runs:**
   - System searches for similar counterparties:
     - "Uber" → 0.67 similarity (below threshold)
     - "Uber Technologies" → 0.52 similarity (below threshold)
     - "Eats" → 0.23 similarity (below threshold)
   - No fuzzy matches above 0.80 confidence threshold
   - Decision: CREATE NEW COUNTERPARTY

4. **Auto-creation notification appears (real-time):**
   ```
   ┌────────────────────────────────────────────────────────┐
   │ Import Progress                                   [×]  │
   ├────────────────────────────────────────────────────────┤
   │ Processing: 42 of 127 transactions                     │
   │ [████████████░░░░░░░░░░░░] 33%                         │
   │                                                        │
   │ Recent activity:                                       │
   │ ✅ Transaction #41 processed                           │
   │ 🆕 New counterparty created: Uber Eats                 │
   │    (from "UBER EATS *1234 NYC")                        │
   │ ✅ Transaction #42 linked to: Uber Eats                │
   │                                                        │
   │ [Pause] [View Counterparties]                          │
   └────────────────────────────────────────────────────────┘
   ```

5. **System creates counterparty record:**
   ```json
   {
     "id": "cp_7j3k9m2n",
     "canonical_name": "Uber Eats",
     "type": "merchant",
     "aliases": ["UBER EATS *1234 NYC"],
     "created_at": "2025-05-23T14:32:11Z",
     "created_by": "auto_normalization",
     "transaction_count": 1,
     "confidence_score": 0.95
   }
   ```

6. **Subsequent similar transaction processed:**
   - Next transaction: "UBER EATS *5678 BOS 05/24"
   - System extracts: "Uber Eats"
   - Fuzzy match finds: "Uber Eats" → 1.00 similarity (exact match)
   - Decision: LINK TO EXISTING COUNTERPARTY
   - New alias added: "UBER EATS *5678 BOS"

7. **Import completes, summary shows:**
   ```
   ┌────────────────────────────────────────────────────────┐
   │ Import Complete                                   [×]  │
   ├────────────────────────────────────────────────────────┤
   │ ✅ 127 transactions imported                           │
   │                                                        │
   │ Counterparty Summary:                                  │
   │ • 42 new counterparties created                        │
   │ • 85 transactions linked to existing counterparties    │
   │                                                        │
   │ Top new counterparties:                                │
   │ 🆕 Uber Eats (12 transactions)                         │
   │ 🆕 Starbucks (8 transactions)                          │
   │ 🆕 Amazon (7 transactions)                             │
   │                                                        │
   │ ⚠️  3 potential duplicates detected                    │
   │ [Review Duplicates]                                    │
   │                                                        │
   │ [View All Counterparties] [Done]                       │
   └────────────────────────────────────────────────────────┘
   ```

8. **User navigates to Counterparty Registry:**
   - URL: `/settings/counterparties`
   - User sees "Uber Eats" in list with 12 transactions
   - Canonical name: "Uber Eats"
   - Aliases: 12 variations (all UBER EATS * patterns)

**Outcome:** System automatically normalized merchant names during import, creating structured counterparty records with aliases. User can review and refine later.

**Duration:** ~30 seconds (background processing during import)

---

### Journey 2: Fuzzy Match Suggestion (0.80-0.90 Confidence)

**Context:** User imports a new transaction with description "UBER *5678 SAN FRANCISCO". System finds existing "Uber Eats" counterparty with 0.85 similarity score (below auto-link threshold of 0.90, above ignore threshold of 0.80).

**Steps:**

1. **Entry point:** User adding transaction manually
   - URL: `/transactions/new`
   - User enters: Amount: $18.45, Description: "UBER *5678 SAN FRANCISCO"
   - User clicks "Save Transaction"

2. **System runs normalization:**
   - Extracts canonical name: "Uber"
   - Fuzzy match engine searches:
     - "Uber Eats" → 0.85 similarity (SUGGESTION THRESHOLD)
     - "Uber Technologies" → 0.72 similarity (below threshold)
   - Decision: SUGGEST MATCH (don't auto-link)

3. **Match suggestion dialog appears:**
   ```
   ┌────────────────────────────────────────────────────────┐
   │ Potential Match Found                             [×]  │
   ├────────────────────────────────────────────────────────┤
   │ We found a similar counterparty that might match       │
   │ this transaction.                                      │
   │                                                        │
   │ Your transaction:                                      │
   │ "UBER *5678 SAN FRANCISCO"                             │
   │                                                        │
   │ Potential match:                                       │
   │ ┌──────────────────────────────────────────────────┐   │
   │ │ Uber Eats                                        │   │
   │ │ Merchant • 12 transactions                       │   │
   │ │                                                  │   │
   │ │ Known aliases (12):                              │   │
   │ │ • UBER EATS *1234 NYC                            │   │
   │ │ • UBER EATS *5678 BOS                            │   │
   │ │ • UBER EATS *9012 LA                             │   │
   │ │ ... and 9 more                                   │   │
   │ │                                                  │   │
   │ │ Confidence: 85% ███████████░░░░░                 │   │
   │ └──────────────────────────────────────────────────┘   │
   │                                                        │
   │ Is this the same counterparty?                         │
   │                                                        │
   │ [No, Create New] [Yes, Link to Uber Eats]              │
   │                                                        │
   │ ☐ Remember this decision for similar transactions     │
   └────────────────────────────────────────────────────────┘
   ```

4. **User reviews suggestion:**
   - User reads: "Uber Eats" with 12 existing aliases
   - User thinks: "Uber Eats is for food delivery. This 'UBER *5678' might be rideshare."
   - User notes: "SAN FRANCISCO" location differs from existing NYC/BOS/LA patterns

5. **User decides: Not a match**
   - Clicks "No, Create New"
   - System creates new counterparty: "Uber"
   - Dialog closes
   - Success toast: "✅ Transaction saved with new counterparty: Uber"

6. **User verification:**
   - User navigates to `/settings/counterparties`
   - User sees TWO separate counterparties:
     ```
     MERCHANTS (43)
     ┌──────────────────────────────────────────────────┐
     │ Uber                                             │
     │ Merchant • 1 transaction                         │
     │ Aliases: UBER *5678 SAN FRANCISCO                │
     │                                                  │
     │ [Edit] [Merge]                                   │
     └──────────────────────────────────────────────────┘

     ┌──────────────────────────────────────────────────┐
     │ Uber Eats                                        │
     │ Merchant • 12 transactions                       │
     │ Aliases: UBER EATS *1234 NYC, +11 more           │
     │                                                  │
     │ [Edit] [Merge]                                   │
     └──────────────────────────────────────────────────┘
     ```

7. **User later realizes mistake:**
   - After 5 more "UBER *" transactions (all rideshare)
   - User decides: "These should stay separate. Good decision."

**Alternative Path: User accepts suggestion**

5b. **User decides: Yes, it's a match**
   - Clicks "Yes, Link to Uber Eats"
   - Checks: "☑ Remember this decision for similar transactions"
   - System adds "UBER *5678 SAN FRANCISCO" to Uber Eats aliases
   - Creates linking rule: "UBER *" patterns → Uber Eats (confidence boost +0.10)

6b. **Future "UBER *" transactions auto-link:**
   - Next transaction: "UBER *9999 CHICAGO"
   - Base similarity: 0.82
   - Learned rule boost: +0.10 → 0.92 (above auto-link threshold)
   - Auto-links to Uber Eats without prompt

**Outcome:** System suggested a potential match but didn't auto-link due to medium confidence. User made informed decision. System learns from user's choice.

**Duration:** ~1 minute (manual review + decision)

---

### Journey 3: User Merges 3 Duplicates

**Context:** User has three counterparty records that represent the same entity: "OpenAI", "OpenAI Inc", and "OPENAI*". User wants to merge them into a single canonical counterparty.

**Steps:**

1. **Entry point:** User on Counterparties page
   - URL: `/settings/counterparties`
   - User scrolls through merchants list
   - User notices three similar entries:
     ```
     MERCHANTS (87)

     ┌──────────────────────────────────────────────────┐
     │ OpenAI                                           │
     │ Merchant • 3 transactions                        │
     │ Aliases: openai.com, api.openai.com              │
     │ [Edit] [Merge]                                   │
     └──────────────────────────────────────────────────┘

     ┌──────────────────────────────────────────────────┐
     │ OpenAI Inc                                       │
     │ Merchant • 5 transactions                        │
     │ Aliases: OPENAI INC, OpenAI Inc.                 │
     │ [Edit] [Merge]                                   │
     └──────────────────────────────────────────────────┘

     ┌──────────────────────────────────────────────────┐
     │ OPENAI*                                          │
     │ Merchant • 2 transactions                        │
     │ Aliases: OPENAI*USD                              │
     │ [Edit] [Merge]                                   │
     └──────────────────────────────────────────────────┘
     ```

2. **User clicks "Merge" on first counterparty:**
   - Card enters selection mode
   - Checkbox appears on card
   - Merge toolbar slides up from bottom:
     ```
     ┌────────────────────────────────────────────────────────┐
     │                                                        │
     │ [Bottom toolbar slides up]                             │
     │                                                        │
     │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
     │ 1 selected                                             │
     │                                                        │
     │ [Cancel] [Select All Similar] [Continue to Merge →]   │
     │                 (grayed out until 2+ selected)         │
     └────────────────────────────────────────────────────────┘
     ```

3. **User selects additional counterparties:**
   - User clicks checkbox on "OpenAI Inc" card
   - User clicks checkbox on "OPENAI*" card
   - Cards highlight with blue border
   - Toolbar updates:
     ```
     ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
     3 selected • 10 total transactions

     [Cancel] [Continue to Merge →]
                   (now enabled)
     ```

4. **User clicks "Continue to Merge →":**
   - Merge preview dialog opens:
     ```
     ┌────────────────────────────────────────────────────────┐
     │ Merge Counterparties                              [×]  │
     ├────────────────────────────────────────────────────────┤
     │ You're about to merge 3 counterparties into one.       │
     │                                                        │
     │ Select primary counterparty (will keep this name):     │
     │                                                        │
     │ ⦿ OpenAI                       3 transactions          │
     │ ○ OpenAI Inc                   5 transactions          │
     │ ○ OPENAI*                      2 transactions          │
     │                                                        │
     │ ───────────────────────────────────────────────────    │
     │                                                        │
     │ Merge targets (will be absorbed):                      │
     │ • OpenAI Inc (5 transactions)                          │
     │ • OPENAI* (2 transactions)                             │
     │                                                        │
     │ After merge:                                           │
     │ ┌──────────────────────────────────────────────────┐   │
     │ │ Canonical name: OpenAI                           │   │
     │ │ Type: Merchant                                   │   │
     │ │ Total transactions: 10                           │   │
     │ │ Total aliases: 5                                 │   │
     │ │   • openai.com                                   │   │
     │ │   • api.openai.com                               │   │
     │ │   • OPENAI INC                                   │   │
     │ │   • OpenAI Inc.                                  │   │
     │ │   • OPENAI*USD                                   │   │
     │ └──────────────────────────────────────────────────┘   │
     │                                                        │
     │ [← Back] [Preview Transactions] [Merge Counterparties] │
     └────────────────────────────────────────────────────────┘
     ```

5. **User reviews merge preview:**
   - User sees: Primary = "OpenAI" (3 txns)
   - User thinks: "Wait, 'OpenAI Inc' has more transactions (5). Maybe that should be primary?"
   - User clicks: ○ OpenAI Inc

6. **Primary selection changes:**
   ```
   Select primary counterparty:

   ○ OpenAI                       3 transactions
   ⦿ OpenAI Inc                   5 transactions  ← Now selected
   ○ OPENAI*                      2 transactions

   After merge:
   ┌──────────────────────────────────────────────────┐
   │ Canonical name: OpenAI Inc                       │  ← Updated
   │ Type: Merchant                                   │
   │ Total transactions: 10                           │
   │ ...
   └──────────────────────────────────────────────────┘
   ```

7. **User clicks "Preview Transactions":**
   - Transaction preview panel opens:
     ```
     ┌────────────────────────────────────────────────────────┐
     │ Affected Transactions (10)                        [×]  │
     ├────────────────────────────────────────────────────────┤
     │ All transactions will be reassigned to:                │
     │ "OpenAI Inc"                                           │
     │                                                        │
     │ ┌──────────────────────────────────────────────────┐   │
     │ │ 2025-05-23  $20.00  OpenAI → OpenAI Inc          │   │
     │ │ Description: api.openai.com                      │   │
     │ └──────────────────────────────────────────────────┘   │
     │                                                        │
     │ ┌──────────────────────────────────────────────────┐   │
     │ │ 2025-05-15  $20.00  OpenAI → OpenAI Inc          │   │
     │ │ Description: openai.com                          │   │
     │ └──────────────────────────────────────────────────┘   │
     │                                                        │
     │ ┌──────────────────────────────────────────────────┐   │
     │ │ 2025-05-08  $25.00  OPENAI* → OpenAI Inc         │   │
     │ │ Description: OPENAI*USD                          │   │
     │ └──────────────────────────────────────────────────┘   │
     │                                                        │
     │ ... 7 more transactions                                │
     │                                                        │
     │ [Close]                                                │
     └────────────────────────────────────────────────────────┘
     ```

8. **User confirms merge:**
   - Clicks "Merge Counterparties" in main dialog
   - Confirmation warning appears:
     ```
     ┌────────────────────────────────────────────────────────┐
     │ ⚠️  Confirm Merge                                 [×]  │
     ├────────────────────────────────────────────────────────┤
     │ This action cannot be undone.                          │
     │                                                        │
     │ You're merging:                                        │
     │ • OpenAI (3 txns) → OpenAI Inc                         │
     │ • OPENAI* (2 txns) → OpenAI Inc                        │
     │                                                        │
     │ Total: 10 transactions will be updated                 │
     │                                                        │
     │ Type "MERGE" to confirm:                               │
     │ [____________________]                                 │
     │                                                        │
     │ [Cancel]                       [Confirm Merge]         │
     │                                    (disabled)          │
     └────────────────────────────────────────────────────────┘
     ```

9. **User types "MERGE" confirmation:**
   - Field updates: [MERGE_______________]
   - "Confirm Merge" button enables
   - User clicks "Confirm Merge"

10. **Merge processing begins:**
    ```
    ┌────────────────────────────────────────────────────────┐
    │ Merging Counterparties...                              │
    ├────────────────────────────────────────────────────────┤
    │ Step 1: Updating transactions                          │
    │ [█████████████████████░░░] 85% (9 of 10)               │
    │                                                        │
    │ Step 2: Merging aliases                                │
    │ [Pending...]                                           │
    │                                                        │
    │ Step 3: Updating counterparty record                   │
    │ [Pending...]                                           │
    │                                                        │
    │ Please wait...                                         │
    └────────────────────────────────────────────────────────┘
    ```

11. **Merge completes successfully:**
    - All steps complete (1.2 seconds total)
    - Dialog closes with fade-out (200ms)
    - Success toast appears:
      ```
      ┌────────────────────────────────────────────────────┐
      │ ✅ 3 counterparties merged into "OpenAI Inc"       │
      │ 10 transactions updated                            │
      └────────────────────────────────────────────────────┘
      ```

12. **Counterparty list updates:**
    ```
    MERCHANTS (85)  ← Count decreased from 87 to 85

    ┌──────────────────────────────────────────────────┐
    │ OpenAI Inc                                       │ ← Merged result
    │ Merchant • 10 transactions                       │
    │ Aliases: openai.com, api.openai.com, +3 more     │
    │                                                  │
    │ [Edit] [Merge]                                   │
    └──────────────────────────────────────────────────┘
    ```
    - "OpenAI" card: REMOVED
    - "OPENAI*" card: REMOVED
    - "OpenAI Inc" card: UPDATED (10 txns, 5 aliases)

**Outcome:** User successfully merged three duplicate counterparties into one canonical record. All transactions reassigned. Aliases consolidated.

**Duration:** ~2 minutes

---

### Journey 4: User Edits Canonical Name and Assigns Type

**Context:** User has a counterparty "AMZN MKT" (auto-created from bank statement) with 47 transactions. User wants to rename it to "Amazon" and confirm it's a merchant (not a person or institution).

**Steps:**

1. **Entry point:** User on Counterparties page
   - URL: `/settings/counterparties`
   - User searches: "AMZN"
   - Search results:
     ```
     Search counterparties... [AMZN_______________] ×
     Showing 1 of 85 counterparties
     ├────────────────────────────────────────────────────┤

     MERCHANTS (1)
     ┌──────────────────────────────────────────────────┐
     │ AMZN MKT                                         │
     │ Merchant • 47 transactions                       │
     │ Aliases: AMZN MKTP US, AMAZON MKTPLACE, +8 more  │
     │ Created: Auto (2025-03-12)                       │
     │                                                  │
     │ [Edit] [Merge]                                   │
     └──────────────────────────────────────────────────┘
     ```

2. **User clicks "Edit" button:**
   - Edit Counterparty modal opens:
     ```
     ┌────────────────────────────────────────────────────────┐
     │ Edit Counterparty                                 [×]  │
     ├────────────────────────────────────────────────────────┤
     │ Canonical Name *                                       │
     │ [AMZN MKT____________________________________]         │
     │                                                        │
     │ Type *                                                 │
     │ [Merchant ▼]                                           │
     │                                                        │
     │ Notes (optional)                                       │
     │ [____________________________________________]         │
     │ [____________________________________________]         │
     │                                                        │
     │ Aliases (10)                                           │
     │ ┌──────────────────────────────────────────────────┐   │
     │ │ • AMZN MKTP US                          [Remove] │   │
     │ │ • AMAZON MKTPLACE                       [Remove] │   │
     │ │ • AMZN MKT                              [Remove] │   │
     │ │ • AMAZON.COM                            [Remove] │   │
     │ │ • AMZN MKTP US*A1B2C3                   [Remove] │   │
     │ │ ... 5 more aliases                               │   │
     │ └──────────────────────────────────────────────────┘   │
     │ [+ Add Alias]                                          │
     │                                                        │
     │ Transaction Statistics                                 │
     │ • 47 transactions                                      │
     │ • Date range: 2025-03-12 to 2025-05-23                 │
     │ • Total volume: $2,847.32                              │
     │                                                        │
     │ [Cancel]                          [Save Changes]       │
     └────────────────────────────────────────────────────────┘
     ```

3. **User edits canonical name:**
   - Selects all text: Cmd+A
   - Types: "Amazon"
   - Field updates: [Amazon_____________________________]
   - User notes: "Much cleaner. This is the official brand name."

4. **User reviews type:**
   - Current type: "Merchant" (auto-assigned during import)
   - User clicks dropdown to verify options:
     ```
     ┌──────────────────────────┐
     │ Merchant ✓               │
     │ Person                   │
     │ Institution              │
     │ Internal Transfer        │
     │ Government               │
     │ Unknown                  │
     └──────────────────────────┘
     ```
   - User confirms: "Merchant is correct. Amazon is an online retailer."
   - User clicks "Merchant" again to close dropdown (no change)

5. **User decides to add a note:**
   - Clicks into Notes field
   - Types: "Online retailer - includes AWS, Prime, and marketplace purchases"
   - Field shows:
     ```
     Notes (optional)
     [Online retailer - includes AWS, Prime, and_____]
     [marketplace purchases_________________________]
     ```

6. **User reviews aliases:**
   - User sees 10 aliases (5 visible, 5 collapsed)
   - User clicks "... 5 more aliases" to expand:
     ```
     Aliases (10)
     ┌──────────────────────────────────────────────────┐
     │ • AMZN MKTP US                          [Remove] │
     │ • AMAZON MKTPLACE                       [Remove] │
     │ • AMZN MKT                              [Remove] │
     │ • AMAZON.COM                            [Remove] │
     │ • AMZN MKTP US*A1B2C3                   [Remove] │
     │ • AMZN DIGITAL                          [Remove] │
     │ • AMAZON PRIME                          [Remove] │
     │ • AWS                                   [Remove] │
     │ • AMZN MKTP US*D4E5F6                   [Remove] │
     │ • AMAZON WEB SERVICES                   [Remove] │
     └──────────────────────────────────────────────────┘
     ```
   - User thinks: "AWS and AMAZON WEB SERVICES are here. Good - those are Amazon purchases."
   - User decides: No changes needed to aliases

7. **User adds one more alias manually:**
   - Clicks "[+ Add Alias]"
   - New alias field appears:
     ```
     ┌──────────────────────────────────────────────────┐
     │ • AMZN MKTP US                          [Remove] │
     │ ...
     │ • AMAZON WEB SERVICES                   [Remove] │
     │                                                  │
     │ [amazon.com________________________] [Add]       │ ← New field
     │ [Cancel]                                         │
     └──────────────────────────────────────────────────┘
     ```
   - Types: "amazon.com"
   - Clicks "Add"
   - New alias appears in list: "• amazon.com [Remove]"
   - Success micro-feedback: Field briefly flashes green (200ms)

8. **User saves changes:**
   - Clicks "Save Changes" button
   - Modal closes (200ms fade)
   - Success toast:
     ```
     ┌────────────────────────────────────────────────────┐
     │ ✅ Counterparty "Amazon" updated                   │
     │ 47 transactions now reference this updated name    │
     └────────────────────────────────────────────────────┘
     ```

9. **Counterparty list refreshes:**
   ```
   Search counterparties... [AMZN_______________] ×
   Showing 1 of 85 counterparties
   ├────────────────────────────────────────────────────┤

   MERCHANTS (1)
   ┌──────────────────────────────────────────────────┐
   │ Amazon                                   ← Updated│
   │ Merchant • 47 transactions                       │
   │ Aliases: AMZN MKTP US, AMAZON.COM, +9 more       │
   │ Note: Online retailer - includes AWS...          │
   │                                                  │
   │ [Edit] [Merge]                                   │
   └──────────────────────────────────────────────────┘
   ```

10. **User verifies changes in transaction list:**
    - Navigates to `/transactions`
    - Filters by counterparty: "Amazon"
    - Sees 47 transactions all showing "Amazon" (not "AMZN MKT")
    - User confirms: "Perfect. All transactions updated automatically."

**Outcome:** User successfully renamed counterparty from auto-generated name to canonical brand name. Added note for context. All existing transactions automatically reflect the new name.

**Duration:** ~2 minutes

---

### Journey 5: User Selects Counterparty in Transaction Edit Dropdown

**Context:** User editing a transaction and needs to assign it to a counterparty. They have 85 counterparties (merchants, people, institutions). User wants to assign transaction to "Starbucks".

**Steps:**

1. **Entry point:** User editing transaction
   - URL: `/transactions/edit/txn_8k2m5n9p`
   - Transaction edit modal open:
     ```
     ┌────────────────────────────────────────────────────────┐
     │ Edit Transaction                                  [×]  │
     ├────────────────────────────────────────────────────────┤
     │ Date                                                   │
     │ [2025-05-23 ▼]                                         │
     │                                                        │
     │ Amount *                                               │
     │ [$8.47_______________________________________]         │
     │                                                        │
     │ Account *                                              │
     │ [Chase Credit Card ▼]                                  │
     │                                                        │
     │ Counterparty *                                         │
     │ [Select counterparty ▼]                ← Not selected │
     │                                                        │
     │ Category                                               │
     │ [Food & Drink ▼]                                       │
     │                                                        │
     │ Description                                            │
     │ [Morning coffee_________________________________]      │
     │                                                        │
     │ [Cancel]                          [Save Transaction]   │
     └────────────────────────────────────────────────────────┘
     ```

2. **User clicks "Counterparty" dropdown:**
   - Dropdown expands with grouped counterparties:
     ```
     ┌────────────────────────────────────────────────────────┐
     │ Counterparty *                                         │
     │ [Select counterparty ▼] ← clicked                      │
     │  ↓                                                     │
     │  ┌──────────────────────────────────────────────────┐  │
     │  │ Search counterparties... [___________________]   │  │
     │  ├──────────────────────────────────────────────────┤  │
     │  │ MERCHANTS (67)                                   │  │
     │  │   Amazon                              47 txns    │  │
     │  │   Apple                               23 txns    │  │
     │  │   Costco                              18 txns    │  │
     │  │   OpenAI Inc                          10 txns    │  │
     │  │   Starbucks                            8 txns    │  │
     │  │   Uber Eats                           12 txns    │  │
     │  │   Whole Foods                         15 txns    │  │
     │  │   ... 60 more                                    │  │
     │  │                                                  │  │
     │  │ PEOPLE (12)                                      │  │
     │  │   Alice Johnson (friend)               5 txns    │  │
     │  │   Bob Martinez (landlord)             12 txns    │  │
     │  │   ... 10 more                                    │  │
     │  │                                                  │  │
     │  │ INSTITUTIONS (6)                                 │  │
     │  │   Bank of America                      2 txns    │  │
     │  │   Chase                                1 txn     │  │
     │  │   ... 4 more                                     │  │
     │  ├──────────────────────────────────────────────────┤  │
     │  │ + Create New Counterparty                        │  │
     │  └──────────────────────────────────────────────────┘  │
     └────────────────────────────────────────────────────────┘
     ```

3. **User observes dropdown structure:**
   - Counterparties grouped by type: MERCHANTS, PEOPLE, INSTITUTIONS
   - Sorted by transaction count (descending) within each group
   - Transaction count shown for each counterparty
   - Search field at top for filtering
   - 67 merchants in list (user thinks: "Too many to scroll")

4. **User searches for "Starbucks":**
   - Types "star" in search field
   - Dropdown filters in real-time (200ms debounce):
     ```
     ┌──────────────────────────────────────────────────┐
     │ Search counterparties... [star_______________]   │
     ├──────────────────────────────────────────────────┤
     │ MERCHANTS (1)                                    │
     │   Starbucks                            8 txns    │ ← Matched
     ├──────────────────────────────────────────────────┤
     │ + Create "star" as new counterparty              │
     └──────────────────────────────────────────────────┘
     ```
   - User sees: Only "Starbucks" matches
   - User notes: "Quick action to create new counterparty if needed"

5. **User selects "Starbucks":**
   - Clicks on "Starbucks" row
   - Dropdown closes (100ms)
   - Counterparty field updates:
     ```
     Counterparty *
     [Starbucks ▼]                          ← Selected
     ```
   - Transaction count next to name: "(9 transactions)" updates to reflect this will be 9th

6. **User saves transaction:**
   - Clicks "Save Transaction"
   - Modal closes
   - Success toast: "✅ Transaction updated"

7. **User verifies in transaction list:**
   - Transaction now shows: "Starbucks" in counterparty column
   - User clicks "Starbucks" link in transaction row
   - Counterparty detail page opens: `/settings/counterparties/cp_starbucks`
   - Shows all 9 Starbucks transactions (including newly saved one)

**Alternative Path: User creates new counterparty from dropdown**

4b. **User searches for non-existent counterparty:**
   - Types "Dunkin" in search field
   - No matches found:
     ```
     ┌──────────────────────────────────────────────────┐
     │ Search counterparties... [Dunkin_____________]   │
     ├──────────────────────────────────────────────────┤
     │ No counterparties match "Dunkin"                 │
     │                                                  │
     │ + Create "Dunkin" as new counterparty            │
     └──────────────────────────────────────────────────┘
     ```

5b. **User clicks "+ Create 'Dunkin' as new counterparty":**
   - Quick create modal opens (overlay on transaction edit):
     ```
     ┌────────────────────────────────────────────────────────┐
     │ Create Counterparty (Quick)                       [×]  │
     ├────────────────────────────────────────────────────────┤
     │ Canonical Name *                                       │
     │ [Dunkin_____________________________________]  ← Pre-filled
     │                                                        │
     │ Type *                                                 │
     │ [Merchant ▼]                                           │
     │                                                        │
     │ ⓘ Creating counterparty from transaction edit.        │
     │   Advanced options available in Settings >             │
     │   Counterparties.                                      │
     │                                                        │
     │ [Cancel]                   [Create & Select]           │
     └────────────────────────────────────────────────────────┘
     ```

6b. **User creates counterparty:**
   - Name pre-filled: "Dunkin"
   - Type defaults to: "Merchant"
   - Clicks "Create & Select"
   - Modal closes
   - Transaction edit updates:
     ```
     Counterparty *
     [Dunkin ▼]                             ← Auto-selected
     ✅ New counterparty created
     ```

7b. **User continues editing transaction:**
   - Saves transaction with newly created counterparty
   - New counterparty appears in registry with 1 transaction

**Outcome:** User efficiently selected counterparty using search within dropdown. Alternative path shows seamless creation workflow without losing transaction context.

**Duration:** ~30 seconds (direct selection) or ~1 minute (with creation)

---

## Wireframes

### Wireframe 1: Counterparty List View (Grouped by Type) - Desktop

```
┌────────────────────────────────────────────────────────────────────────┐
│ ☰ Finance App                                                     👤   │
├────────────────────────────────────────────────────────────────────────┤
│ Settings > Counterparties                                              │
│                                                                        │
│ Counterparties (85)                             [+ New Counterparty]   │
├────────────────────────────────────────────────────────────────────────┤
│ Search counterparties... [________________________] [Filter ▼]        │
│                                                      [Sort: A-Z ▼]     │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│ MERCHANTS (67)                                                         │
│ ┌──────────────────────────────────────────────────────────────────┐  │
│ │ Amazon                                                           │  │
│ │ Merchant • 47 transactions                                       │  │
│ │ Aliases: AMZN MKTP US, AMAZON.COM, +9 more                       │  │
│ │ Note: Online retailer - includes AWS, Prime, and marketplace...  │  │
│ │                                                                  │  │
│ │ [Edit] [Merge]                                                   │  │
│ └──────────────────────────────────────────────────────────────────┘  │
│                                                                        │
│ ┌──────────────────────────────────────────────────────────────────┐  │
│ │ Apple                                                            │  │
│ │ Merchant • 23 transactions                                       │  │
│ │ Aliases: APPLE.COM, APPLE INC, +3 more                           │  │
│ │                                                                  │  │
│ │ [Edit] [Merge]                                                   │  │
│ └──────────────────────────────────────────────────────────────────┘  │
│                                                                        │
│ ┌──────────────────────────────────────────────────────────────────┐  │
│ │ Costco                                                           │  │
│ │ Merchant • 18 transactions                                       │  │
│ │ Aliases: COSTCO WHSE, COSTCO WHOLESALE, +2 more                  │  │
│ │                                                                  │  │
│ │ [Edit] [Merge]                                                   │  │
│ └──────────────────────────────────────────────────────────────────┘  │
│                                                                        │
│ PEOPLE (12)                                                            │
│ ┌──────────────────────────────────────────────────────────────────┐  │
│ │ Bob Martinez                                                     │  │
│ │ Person • 12 transactions                                         │  │
│ │ Aliases: Bob M., Robert Martinez                                 │  │
│ │ Note: Landlord - monthly rent payments                           │  │
│ │                                                                  │  │
│ │ [Edit] [Merge]                                                   │  │
│ └──────────────────────────────────────────────────────────────────┘  │
│                                                                        │
│ ┌──────────────────────────────────────────────────────────────────┐  │
│ │ Alice Johnson                                                    │  │
│ │ Person • 5 transactions                                          │  │
│ │ Aliases: Alice J., A. Johnson                                    │  │
│ │ Note: Friend - split payments for dinners                        │  │
│ │                                                                  │  │
│ │ [Edit] [Merge]                                                   │  │
│ └──────────────────────────────────────────────────────────────────┘  │
│                                                                        │
│ INSTITUTIONS (6)                                                       │
│ ┌──────────────────────────────────────────────────────────────────┐  │
│ │ Bank of America                                                  │  │
│ │ Institution • 2 transactions                                     │  │
│ │ Aliases: BofA, BANK OF AMERICA NA                                │  │
│ │                                                                  │  │
│ │ [Edit] [Merge]                                                   │  │
│ └──────────────────────────────────────────────────────────────────┘  │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘

Sort dropdown options:
┌────────────────────────┐
│ A-Z (name) ✓           │
│ Transaction count      │
│ Recently added         │
│ Recently updated       │
└────────────────────────┘

Filter dropdown:
┌────────────────────────┐
│ Type                   │
├────────────────────────┤
│ ☑ All Types            │
│ ☐ Merchants only       │
│ ☐ People only          │
│ ☐ Institutions only    │
├────────────────────────┤
│ Activity               │
├────────────────────────┤
│ ☑ All                  │
│ ☐ Active (>5 txns)     │
│ ☐ Inactive (<5 txns)   │
│ ☐ Zero transactions    │
└────────────────────────┘
```

---

### Wireframe 2: Search Results (Matching Canonical Name + Aliases)

```
┌────────────────────────────────────────────────────────────────────────┐
│ Counterparties (85)                             [+ New Counterparty]   │
├────────────────────────────────────────────────────────────────────────┤
│ Search counterparties... [uber____________________] ×                  │
│ Showing 2 of 85 counterparties                                         │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│ MERCHANTS (2)                                                          │
│ ┌──────────────────────────────────────────────────────────────────┐  │
│ │ Uber Eats                                                        │  │
│ │ Merchant • 12 transactions                                       │  │
│ │ Aliases: UBER EATS *1234 NYC, UBER EATS *5678 BOS, +10 more      │  │
│ │          ^^^^                    ^^^^                            │  │
│ │          (matched portions highlighted)                          │  │
│ │                                                                  │  │
│ │ [Edit] [Merge]                                                   │  │
│ └──────────────────────────────────────────────────────────────────┘  │
│                                                                        │
│ ┌──────────────────────────────────────────────────────────────────┐  │
│ │ Uber                                                             │  │
│ │ Merchant • 5 transactions                                        │  │
│ │ Aliases: UBER *5678 SAN FRANCISCO, UBER *9999 CHICAGO, +3 more   │  │
│ │          ^^^^                         ^^^^                       │  │
│ │                                                                  │  │
│ │ [Edit] [Merge]                                                   │  │
│ └──────────────────────────────────────────────────────────────────┘  │
│                                                                        │
│ ───────────────────────────────────────────────────────────────────   │
│ ⚠️  These counterparties look similar                                 │
│ Uber vs Uber Eats • Similarity: 85%                                   │
│                                                                        │
│ [Merge These Counterparties] [Dismiss]                                │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘

Search behavior:
- Searches canonical name (e.g., "Uber Eats")
- Searches all aliases (e.g., "UBER EATS *1234 NYC")
- Highlights matched portions in results
- Shows duplicate suggestions if similarity >0.80
```

---

### Wireframe 3: Duplicate Suggestions Panel (Similarity Scores)

```
┌────────────────────────────────────────────────────────────────────────┐
│ Settings > Counterparties                                              │
│                                                                        │
│ Counterparties (85)                             [+ New Counterparty]   │
├────────────────────────────────────────────────────────────────────────┤
│ Search counterparties... [________________________]                    │
│                                                                        │
│ ⚠️  Potential Duplicates Detected (3 groups)          [Dismiss All]    │
│ ┌──────────────────────────────────────────────────────────────────┐  │
│ │ Group 1: OpenAI duplicates                                       │  │
│ │ ┌────────────────────────────────────────────────────────────┐   │  │
│ │ │ OpenAI                           3 txns                     │   │  │
│ │ │ OpenAI Inc                       5 txns   92% similar       │   │  │
│ │ │ OPENAI*                          2 txns   87% similar       │   │  │
│ │ └────────────────────────────────────────────────────────────┘   │  │
│ │                                                                  │  │
│ │ [Merge These 3 Counterparties] [Not Duplicates]                 │  │
│ └──────────────────────────────────────────────────────────────────┘  │
│                                                                        │
│ ┌──────────────────────────────────────────────────────────────────┐  │
│ │ Group 2: Starbucks duplicates                                    │  │
│ │ ┌────────────────────────────────────────────────────────────┐   │  │
│ │ │ Starbucks                        8 txns                     │   │  │
│ │ │ STARBUCKS COFFEE                 3 txns   95% similar       │   │  │
│ │ └────────────────────────────────────────────────────────────┘   │  │
│ │                                                                  │  │
│ │ [Merge These 2 Counterparties] [Not Duplicates]                 │  │
│ └──────────────────────────────────────────────────────────────────┘  │
│                                                                        │
│ ┌──────────────────────────────────────────────────────────────────┐  │
│ │ Group 3: Amazon duplicates                                       │  │
│ │ ┌────────────────────────────────────────────────────────────┐   │  │
│ │ │ Amazon                          47 txns                     │   │  │
│ │ │ Amazon Prime                    12 txns   83% similar       │   │  │
│ │ └────────────────────────────────────────────────────────────┘   │  │
│ │                                                                  │  │
│ │ [Merge These 2 Counterparties] [Not Duplicates]                 │  │
│ └──────────────────────────────────────────────────────────────────┘  │
│                                                                        │
│ ───────────────────────────────────────────────────────────────────   │
│                                                                        │
│ MERCHANTS (67)                                                         │
│ [Rest of counterparty list...]                                        │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘

Similarity calculation:
- Levenshtein distance for string similarity
- Alias overlap analysis
- Transaction pattern comparison
- Threshold: >80% = duplicate suggestion
```

---

### Wireframe 4: Multi-Select for Bulk Merge (Checkboxes + Merge Button)

```
┌────────────────────────────────────────────────────────────────────────┐
│ Settings > Counterparties                                              │
│                                                                        │
│ Counterparties (85)                             [+ New Counterparty]   │
├────────────────────────────────────────────────────────────────────────┤
│ Search counterparties... [________________________]                    │
├────────────────────────────────────────────────────────────────────────┤
│                                                                        │
│ MERCHANTS (67)                                                         │
│ ☑ ┌──────────────────────────────────────────────────────────────┐   │
│   │ OpenAI                                                       │   │
│   │ Merchant • 3 transactions                                    │   │
│   │ Aliases: openai.com, api.openai.com                          │   │
│   │                                                              │   │
│   │ [Edit] [Merge] ← Clicked to enter selection mode            │   │
│   └──────────────────────────────────────────────────────────────┘   │
│   ↑ Checkbox appears, card highlighted                                │
│                                                                        │
│ ☑ ┌──────────────────────────────────────────────────────────────┐   │
│   │ OpenAI Inc                                                   │   │
│   │ Merchant • 5 transactions                                    │   │
│   │ Aliases: OPENAI INC, OpenAI Inc.                             │   │
│   │                                                              │   │
│   │ [Edit] [Merge]                                               │   │
│   └──────────────────────────────────────────────────────────────┘   │
│                                                                        │
│ ☑ ┌──────────────────────────────────────────────────────────────┐   │
│   │ OPENAI*                                                      │   │
│   │ Merchant • 2 transactions                                    │   │
│   │ Aliases: OPENAI*USD                                          │   │
│   │                                                              │   │
│   │ [Edit] [Merge]                                               │   │
│   └──────────────────────────────────────────────────────────────┘   │
│                                                                        │
│ ☐ ┌──────────────────────────────────────────────────────────────┐   │
│   │ Starbucks                                                    │   │
│   │ Merchant • 8 transactions                                    │   │
│   │ Aliases: STARBUCKS #1234, STARBUCKS COFFEE                   │   │
│   │                                                              │   │
│   │ [Edit] [Merge]                                               │   │
│   └──────────────────────────────────────────────────────────────┘   │
│                                                                        │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
  ↓
  [Bottom toolbar slides up when 1+ selected]
  ┌────────────────────────────────────────────────────────────────────┐
  │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
  │                                                                    │
  │ 3 selected • 10 total transactions                                 │
  │                                                                    │
  │ [Cancel] [Select All Similar] [Continue to Merge →]               │
  │                                     (enabled when 2+ selected)     │
  └────────────────────────────────────────────────────────────────────┘

"Select All Similar" button logic:
- Uses fuzzy matching to find counterparties >0.80 similar to first selection
- Auto-checks all similar counterparties
- Shows confirmation: "5 similar counterparties selected"
```

---

### Wireframe 5: Edit Counterparty Modal (Canonical Name, Type, Notes, Aliases)

```
┌────────────────────────────────────────────────────────────────────────┐
│                                                                        │
│                   ┌──────────────────────────────────────┐             │
│                   │ Edit Counterparty                × │             │
│                   ├──────────────────────────────────────┤             │
│                   │ Canonical Name *                     │             │
│                   │ [Amazon______________________________]│             │
│                   │                                      │             │
│                   │ Type *                               │             │
│                   │ [Merchant ▼]                         │             │
│                   │                                      │             │
│                   │ Notes (optional)                     │             │
│                   │ [Online retailer - includes AWS,___] │             │
│                   │ [Prime, and marketplace purchases__] │             │
│                   │                                      │             │
│                   │ Aliases (11)                         │             │
│                   │ ┌────────────────────────────────┐   │             │
│                   │ │ • AMZN MKTP US      [Remove]   │   │             │
│                   │ │ • AMAZON MKTPLACE   [Remove]   │   │             │
│                   │ │ • AMZN MKT          [Remove]   │   │             │
│                   │ │ • AMAZON.COM        [Remove]   │   │             │
│                   │ │ • AMZN MKTP US*A1B2C3 [Remove] │   │             │
│                   │ │ • AMZN DIGITAL      [Remove]   │   │             │
│                   │ │ • AMAZON PRIME      [Remove]   │   │             │
│                   │ │ • AWS               [Remove]   │   │             │
│                   │ │ • AMZN MKTP US*D4E5F6 [Remove] │   │             │
│                   │ │ • AMAZON WEB SERVICES [Remove] │   │             │
│                   │ │ • amazon.com        [Remove]   │   │             │
│                   │ └────────────────────────────────┘   │             │
│                   │ [+ Add Alias]                        │             │
│                   │                                      │             │
│                   │ Transaction Statistics               │             │
│                   │ • 47 transactions                    │             │
│                   │ • Date range: 2025-03-12 to 2025-05-23│            │
│                   │ • Total volume: $2,847.32            │             │
│                   │ • Avg transaction: $60.58            │             │
│                   │                                      │             │
│                   │ Metadata                             │             │
│                   │ • Created: 2025-03-12 (auto)         │             │
│                   │ • Last updated: 2025-05-23 (manual)  │             │
│                   │                                      │             │
│                   │ [Delete Counterparty]  [Cancel]      │             │
│                   │                      [Save Changes]  │             │
│                   └──────────────────────────────────────┘             │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘

Type dropdown (when clicked):
┌──────────────────────────┐
│ Merchant ✓               │
│ Person                   │
│ Institution              │
│ Internal Transfer        │
│ Government               │
│ Unknown                  │
└──────────────────────────┘

Add alias flow:
┌────────────────────────────────────┐
│ Aliases (11)                       │
│ ┌────────────────────────────────┐ │
│ │ • AMAZON.COM        [Remove]   │ │
│ │ • amazon.com        [Remove]   │ │
│ │                                │ │
│ │ [new alias_______________] [Add]│ ← New field appears
│ │ [Cancel]                       │ │
│ └────────────────────────────────┘ │
└────────────────────────────────────┘
```

---

### Wireframe 6: Merge Preview Dialog (Primary + Merge Targets, Transaction Counts)

```
┌────────────────────────────────────────────────────────────────────────┐
│                                                                        │
│                   ┌──────────────────────────────────────┐             │
│                   │ Merge Counterparties             × │             │
│                   ├──────────────────────────────────────┤             │
│                   │ You're about to merge 3              │             │
│                   │ counterparties into one.             │             │
│                   │                                      │             │
│                   │ Select primary counterparty:         │             │
│                   │ (will keep this name and type)       │             │
│                   │                                      │             │
│                   │ ○ OpenAI              3 txns         │             │
│                   │ ⦿ OpenAI Inc          5 txns         │ ← Selected  │
│                   │ ○ OPENAI*             2 txns         │             │
│                   │                                      │             │
│                   │ ──────────────────────────────────── │             │
│                   │                                      │             │
│                   │ Merge targets (will be absorbed):    │             │
│                   │ • OpenAI (3 transactions)            │             │
│                   │ • OPENAI* (2 transactions)           │             │
│                   │                                      │             │
│                   │ After merge:                         │             │
│                   │ ┌────────────────────────────────┐   │             │
│                   │ │ Canonical name: OpenAI Inc     │   │             │
│                   │ │ Type: Merchant                 │   │             │
│                   │ │ Total transactions: 10         │   │             │
│                   │ │ Total aliases: 5               │   │             │
│                   │ │                                │   │             │
│                   │ │ Aliases from all sources:      │   │             │
│                   │ │ • openai.com                   │   │ ← From OpenAI
│                   │ │ • api.openai.com               │   │ ← From OpenAI
│                   │ │ • OPENAI INC                   │   │ ← From OpenAI Inc
│                   │ │ • OpenAI Inc.                  │   │ ← From OpenAI Inc
│                   │ │ • OPENAI*USD                   │   │ ← From OPENAI*
│                   │ └────────────────────────────────┘   │             │
│                   │                                      │             │
│                   │ Impact:                              │             │
│                   │ • 10 transactions will be updated    │             │
│                   │ • 2 counterparty records deleted     │             │
│                   │ • All aliases preserved              │             │
│                   │                                      │             │
│                   │ [← Back] [Preview Transactions]      │             │
│                   │                 [Merge Counterparties]│            │
│                   └──────────────────────────────────────┘             │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘

Primary selection logic:
- Default: Counterparty with most transactions
- User can override by clicking radio button
- Primary's canonical name, type, and notes preserved
- All aliases from all counterparties merged
```

---

### Wireframe 7: Merge Confirmation (Irreversible Warning, Progress Bar)

```
Step 1: Confirmation with typed "MERGE"
┌────────────────────────────────────────────────────────────────────────┐
│                                                                        │
│                   ┌──────────────────────────────────────┐             │
│                   │ ⚠️  Confirm Merge                × │             │
│                   ├──────────────────────────────────────┤             │
│                   │ This action cannot be undone.        │             │
│                   │                                      │             │
│                   │ You're merging:                      │             │
│                   │ • OpenAI (3 txns) → OpenAI Inc      │             │
│                   │ • OPENAI* (2 txns) → OpenAI Inc     │             │
│                   │                                      │             │
│                   │ Total: 10 transactions will be       │             │
│                   │ updated                              │             │
│                   │                                      │             │
│                   │ Type "MERGE" to confirm:             │             │
│                   │ [MERGE___________________________]   │             │
│                   │                                      │             │
│                   │ [Cancel]           [Confirm Merge]   │             │
│                   │                         (enabled)    │             │
│                   └──────────────────────────────────────┘             │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘

Step 2: Processing with progress bar
┌────────────────────────────────────────────────────────────────────────┐
│                                                                        │
│                   ┌──────────────────────────────────────┐             │
│                   │ Merging Counterparties...            │             │
│                   ├──────────────────────────────────────┤             │
│                   │ Step 1: Updating transactions        │             │
│                   │ [█████████████████████░░░] 85%       │             │
│                   │ (9 of 10 transactions)               │             │
│                   │                                      │             │
│                   │ Step 2: Merging aliases              │             │
│                   │ [Pending...]                         │             │
│                   │                                      │             │
│                   │ Step 3: Updating counterparty record │             │
│                   │ [Pending...]                         │             │
│                   │                                      │             │
│                   │ Step 4: Cleaning up old records      │             │
│                   │ [Pending...]                         │             │
│                   │                                      │             │
│                   │ Estimated: 2 seconds remaining       │             │
│                   │                                      │             │
│                   │ Please wait...                       │             │
│                   └──────────────────────────────────────┘             │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘

Step 3: All steps complete
┌────────────────────────────────────────────────────────────────────────┐
│                                                                        │
│                   ┌──────────────────────────────────────┐             │
│                   │ Merging Counterparties...            │             │
│                   ├──────────────────────────────────────┤             │
│                   │ Step 1: Updating transactions ✅     │             │
│                   │ [████████████████████████] 100%      │             │
│                   │                                      │             │
│                   │ Step 2: Merging aliases ✅           │             │
│                   │ [████████████████████████] 100%      │             │
│                   │                                      │             │
│                   │ Step 3: Updating counterparty ✅     │             │
│                   │ [████████████████████████] 100%      │             │
│                   │                                      │             │
│                   │ Step 4: Cleaning up records ✅       │             │
│                   │ [████████████████████████] 100%      │             │
│                   │                                      │             │
│                   │ Merge complete!                      │             │
│                   └──────────────────────────────────────┘             │
│                   (Closes automatically in 1 second)                   │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘

Success toast (appears after modal closes):
┌────────────────────────────────────────────────────────┐
│ ✅ 3 counterparties merged into "OpenAI Inc"           │
│ 10 transactions updated                                │
└────────────────────────────────────────────────────────┘
```

---

### Wireframe 8: Counterparty Selector Dropdown (Collapsed) - In Transaction Edit

```
┌────────────────────────────────────────────────────────────────────────┐
│                                                                        │
│                   ┌──────────────────────────────────────┐             │
│                   │ Edit Transaction                 × │             │
│                   ├──────────────────────────────────────┤             │
│                   │ Date                                 │             │
│                   │ [2025-05-23 ▼]                       │             │
│                   │                                      │             │
│                   │ Amount *                             │             │
│                   │ [$8.47_______________________________]│            │
│                   │                                      │             │
│                   │ Account *                            │             │
│                   │ [Chase Credit Card ▼]                │             │
│                   │                                      │             │
│                   │ Counterparty *                       │             │
│                   │ [Starbucks ▼]           ← Selected   │             │
│                   │ (9 transactions)                     │             │
│                   │                                      │             │
│                   │ Category                             │             │
│                   │ [Food & Drink ▼]                     │             │
│                   │                                      │             │
│                   │ Description                          │             │
│                   │ [Morning coffee______________________]│            │
│                   │                                      │             │
│                   │ Notes                                │             │
│                   │ [____________________________________]│            │
│                   │                                      │             │
│                   │ [Cancel]          [Save Transaction] │             │
│                   └──────────────────────────────────────┘             │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘
```

---

### Wireframe 9: Counterparty Selector Dropdown (Expanded with Search + Grouping)

```
┌────────────────────────────────────────────────────────────────────────┐
│                                                                        │
│                   ┌──────────────────────────────────────┐             │
│                   │ Edit Transaction                 × │             │
│                   ├──────────────────────────────────────┤             │
│                   │ Date                                 │             │
│                   │ [2025-05-23 ▼]                       │             │
│                   │                                      │             │
│                   │ Amount *                             │             │
│                   │ [$8.47_______________________________]│            │
│                   │                                      │             │
│                   │ Account *                            │             │
│                   │ [Chase Credit Card ▼]                │             │
│                   │                                      │             │
│                   │ Counterparty *                       │             │
│                   │ [Select counterparty ▼] ← clicked    │             │
│                   │  ↓                                   │             │
│                   │  ┌────────────────────────────────┐  │             │
│                   │  │ Search... [star______________] │  │             │
│                   │  ├────────────────────────────────┤  │             │
│                   │  │ MERCHANTS (1)                  │  │             │
│                   │  │   Starbucks          8 txns    │  │ ← Matched   │
│                   │  │                                │  │             │
│                   │  │ No matches in People           │  │             │
│                   │  │ No matches in Institutions     │  │             │
│                   │  ├────────────────────────────────┤  │             │
│                   │  │ + Create "star" as new         │  │             │
│                   │  │   counterparty                 │  │             │
│                   │  └────────────────────────────────┘  │             │
│                   │                                      │             │
│                   │ Category                             │             │
│                   │ [Food & Drink ▼]                     │             │
│                   │                                      │             │
│                   └──────────────────────────────────────┘             │
│                                                                        │
└────────────────────────────────────────────────────────────────────────┘

Full dropdown (no search term):
┌────────────────────────────────────┐
│ Search... [___________________]    │
├────────────────────────────────────┤
│ MERCHANTS (67)                     │
│   Amazon                  47 txns  │
│   Apple                   23 txns  │
│   Costco                  18 txns  │
│   OpenAI Inc              10 txns  │
│   Starbucks                8 txns  │
│   Uber Eats               12 txns  │
│   Whole Foods             15 txns  │
│   ... 60 more                      │
│                                    │
│ PEOPLE (12)                        │
│   Alice Johnson            5 txns  │
│   Bob Martinez            12 txns  │
│   ... 10 more                      │
│                                    │
│ INSTITUTIONS (6)                   │
│   Bank of America          2 txns  │
│   Chase                    1 txn   │
│   ... 4 more                       │
├────────────────────────────────────┤
│ + Create New Counterparty          │
└────────────────────────────────────┘

Keyboard navigation:
- Type to search (auto-focus)
- ↓/↑ to navigate results
- Enter to select
- Esc to close
```

---

### Wireframe 10: Auto-Creation Notification ("New counterparty created: Uber Eats")

```
During import (real-time notification):
┌────────────────────────────────────────────────────────────────────────┐
│ Import Progress                                                   [×]  │
├────────────────────────────────────────────────────────────────────────┤
│ Processing: 42 of 127 transactions                                     │
│ [████████████░░░░░░░░░░░░] 33%                                         │
│                                                                        │
│ Recent activity:                                                       │
│ ┌──────────────────────────────────────────────────────────────────┐   │
│ │ ✅ Transaction #41 processed                                     │   │
│ │ 🆕 New counterparty created: Uber Eats                           │   │
│ │    Source: "UBER EATS *1234 NYC 05/23"                           │   │
│ │    Type: Merchant (auto-detected)                                │   │
│ │ ✅ Transaction #42 linked to: Uber Eats                          │   │
│ └──────────────────────────────────────────────────────────────────┘   │
│                                                                        │
│ Auto-created counterparties this session:                              │
│ • Uber Eats (12 transactions)                                          │
│ • Starbucks (8 transactions)                                           │
│ • Amazon (7 transactions)                                              │
│ • Costco (5 transactions)                                              │
│ ... 38 more                                                            │
│                                                                        │
│ [Pause] [View Counterparties]                                          │
└────────────────────────────────────────────────────────────────────────┘

Single transaction save (inline notification):
┌────────────────────────────────────────────────────────────────────────┐
│ Edit Transaction                                                  [×]  │
├────────────────────────────────────────────────────────────────────────┤
│ Amount: $18.45                                                         │
│ Description: "UBER *5678 SAN FRANCISCO"                                │
│                                                                        │
│ [Save Transaction] ← Clicked                                           │
└────────────────────────────────────────────────────────────────────────┘
         ↓
Toast notification:
┌────────────────────────────────────────────────────────────────────────┐
│ ✅ Transaction saved                                                   │
│ 🆕 New counterparty created: Uber                                      │
│                                                                        │
│ [View Counterparty] [Dismiss]                                          │
└────────────────────────────────────────────────────────────────────────┘

Post-import summary:
┌────────────────────────────────────────────────────────────────────────┐
│ Import Complete                                                   [×]  │
├────────────────────────────────────────────────────────────────────────┤
│ ✅ 127 transactions imported                                           │
│                                                                        │
│ Counterparty Summary:                                                  │
│ • 42 new counterparties created automatically                          │
│ • 85 transactions linked to existing counterparties                    │
│                                                                        │
│ Top new counterparties:                                                │
│ ┌──────────────────────────────────────────────────────────────────┐   │
│ │ 🆕 Uber Eats                                   12 transactions   │   │
│ │    Aliases: UBER EATS *1234 NYC, +11 more                        │   │
│ └──────────────────────────────────────────────────────────────────┘   │
│ ┌──────────────────────────────────────────────────────────────────┐   │
│ │ 🆕 Starbucks                                    8 transactions   │   │
│ │    Aliases: STARBUCKS #1234, STARBUCKS COFFEE, +6 more           │   │
│ └──────────────────────────────────────────────────────────────────┘   │
│ ┌──────────────────────────────────────────────────────────────────┐   │
│ │ 🆕 Amazon                                       7 transactions   │   │
│ │    Aliases: AMZN MKTP US, AMAZON MKTPLACE, +5 more               │   │
│ └──────────────────────────────────────────────────────────────────┘   │
│                                                                        │
│ ⚠️  3 potential duplicates detected                                    │
│ [Review Duplicates]                                                    │
│                                                                        │
│ [View All Counterparties] [Done]                                       │
└────────────────────────────────────────────────────────────────────────┘
```

---

## Interaction Details

### Fuzzy Matching Confidence Levels

**Auto-Link (>0.90 confidence):**
```javascript
// Exact or near-exact match
similarity = calculateSimilarity("UBER EATS *5678", "UBER EATS *1234");
// Result: 0.95 → AUTO-LINK

System behavior:
- No user prompt
- Automatically link to existing counterparty
- Add new description as alias
- Log auto-link decision for audit
```

**Suggest Match (0.80-0.90 confidence):**
```javascript
// Similar but not identical
similarity = calculateSimilarity("UBER *5678 SF", "UBER EATS *1234 NYC");
// Result: 0.85 → SUGGEST

System behavior:
- Show match suggestion dialog
- Present confidence score: "85% similar"
- Show existing aliases for context
- User decides: Link or Create New
- Learn from user decision (boost/penalty)
```

**Create New (<0.80 confidence):**
```javascript
// Too different to suggest
similarity = calculateSimilarity("DUNKIN DONUTS", "STARBUCKS");
// Result: 0.12 → CREATE NEW

System behavior:
- Create new counterparty automatically
- No user prompt (confidence too low)
- Extract canonical name from description
- Auto-assign type based on patterns
```

**Similarity Calculation Algorithm:**
```javascript
function calculateSimilarity(str1, str2) {
  // Step 1: Normalize strings
  const norm1 = normalizeDescription(str1);
  const norm2 = normalizeDescription(str2);

  // Step 2: Calculate Levenshtein distance
  const levenshtein = levenshteinDistance(norm1, norm2);

  // Step 3: Calculate token overlap
  const tokenOverlap = jaccardSimilarity(
    tokenize(norm1),
    tokenize(norm2)
  );

  // Step 4: Weighted average
  const similarity = (levenshtein * 0.6) + (tokenOverlap * 0.4);

  return similarity;
}

function normalizeDescription(str) {
  return str
    .toLowerCase()
    .replace(/[*#]/g, '') // Remove special chars
    .replace(/\d+/g, '') // Remove numbers
    .replace(/\s+/g, ' ') // Normalize whitespace
    .trim();
}
```

---

### Merge Operation (Batch Update Transactions, Show Progress)

**Merge Process (Step-by-Step):**

1. **User selects primary counterparty:**
   - Default: Counterparty with most transactions
   - User can override selection
   - Primary's canonical name and type preserved

2. **Validate merge targets:**
   ```javascript
   function validateMerge(primary, targets) {
     // Check 1: No circular merges
     if (targets.includes(primary.id)) {
       throw new Error("Cannot merge counterparty into itself");
     }

     // Check 2: All same type (optional warning)
     const types = [primary.type, ...targets.map(t => t.type)];
     if (new Set(types).size > 1) {
       warn("Merging different types (Merchant + Person)");
     }

     // Check 3: No duplicate aliases
     const allAliases = [
       ...primary.aliases,
       ...targets.flatMap(t => t.aliases)
     ];
     const uniqueAliases = [...new Set(allAliases)];

     return {
       valid: true,
       totalTransactions: primary.txnCount + targets.reduce((sum, t) => sum + t.txnCount, 0),
       uniqueAliases
     };
   }
   ```

3. **Execute merge (background job if >100 transactions):**
   ```javascript
   async function executeMerge(primary, targets) {
     const totalTxns = getTotalTransactionCount([primary, ...targets]);

     // Small merge: Execute synchronously
     if (totalTxns < 100) {
       return await mergeSynchronous(primary, targets);
     }

     // Large merge: Background job
     const jobId = await queueMergeJob(primary, targets);
     return {
       jobId,
       status: 'processing',
       estimatedTime: totalTxns * 0.05 // 50ms per transaction
     };
   }

   async function mergeSynchronous(primary, targets) {
     // Step 1: Update all transactions (batch)
     const txnIds = await getTransactionIds(targets);
     await batchUpdateTransactions(txnIds, {
       counterparty_id: primary.id
     });

     // Step 2: Merge aliases
     const newAliases = targets.flatMap(t => t.aliases);
     await addAliasesToCounterparty(primary.id, newAliases);

     // Step 3: Update counterparty record
     await updateCounterparty(primary.id, {
       transaction_count: primary.txnCount + txnIds.length,
       updated_at: new Date()
     });

     // Step 4: Delete merged counterparties
     await deleteCounterparties(targets.map(t => t.id));

     return {
       status: 'complete',
       updatedTxns: txnIds.length,
       newAliasCount: newAliases.length
     };
   }
   ```

4. **Show progress (for large merges):**
   ```javascript
   function showMergeProgress(jobId) {
     const progressInterval = setInterval(async () => {
       const status = await checkJobStatus(jobId);

       updateProgressUI({
         step1: status.transactions_updated / status.total_transactions,
         step2: status.aliases_merged ? 1.0 : 0.0,
         step3: status.record_updated ? 1.0 : 0.0,
         step4: status.cleanup_complete ? 1.0 : 0.0
       });

       if (status.complete) {
         clearInterval(progressInterval);
         showSuccessMessage(status);
       }
     }, 500); // Check every 500ms
   }
   ```

**Progress Indicator States:**

```
State 1: Updating transactions (0-70% of time)
┌──────────────────────────────────────┐
│ Step 1: Updating transactions        │
│ [█████████████░░░░░░░] 65%           │
│ (650 of 1,000 transactions)          │
└──────────────────────────────────────┘

State 2: Merging aliases (70-85% of time)
┌──────────────────────────────────────┐
│ Step 1: Updating transactions ✅     │
│ [████████████████████████] 100%      │
│                                      │
│ Step 2: Merging aliases              │
│ [████████░░░░░░░░░░░] 40%            │
│ (12 of 30 aliases)                   │
└──────────────────────────────────────┘

State 3: Updating record (85-95% of time)
┌──────────────────────────────────────┐
│ Step 1: Updating transactions ✅     │
│ Step 2: Merging aliases ✅           │
│ Step 3: Updating counterparty...     │
│ [██████████████████░░] 80%           │
└──────────────────────────────────────┘

State 4: Cleanup (95-100% of time)
┌──────────────────────────────────────┐
│ Step 1: Updating transactions ✅     │
│ Step 2: Merging aliases ✅           │
│ Step 3: Updating counterparty ✅     │
│ Step 4: Cleaning up records...       │
│ [████████████████████░] 90%          │
└──────────────────────────────────────┘
```

---

### Search Behavior (Searches Canonical Name and Aliases)

**Search Algorithm:**

```javascript
function searchCounterparties(query, counterparties) {
  const normalizedQuery = query.toLowerCase().trim();

  return counterparties.filter(cp => {
    // Search canonical name
    if (cp.canonical_name.toLowerCase().includes(normalizedQuery)) {
      return true;
    }

    // Search aliases
    const aliasMatch = cp.aliases.some(alias =>
      alias.toLowerCase().includes(normalizedQuery)
    );
    if (aliasMatch) return true;

    // Search notes
    if (cp.notes && cp.notes.toLowerCase().includes(normalizedQuery)) {
      return true;
    }

    return false;
  });
}
```

**Search Highlighting:**

```javascript
function highlightMatches(text, query) {
  const regex = new RegExp(`(${escapeRegex(query)})`, 'gi');
  return text.replace(regex, '<mark>$1</mark>');
}

// Example:
highlightMatches("UBER EATS *1234 NYC", "uber");
// Result: "<mark>UBER</mark> EATS *1234 NYC"
```

**Real-Time Search (Debounced):**

```javascript
const searchInput = document.getElementById('counterparty-search');
const debounceDelay = 200; // 200ms

let searchTimeout;
searchInput.addEventListener('input', (e) => {
  clearTimeout(searchTimeout);

  searchTimeout = setTimeout(() => {
    const query = e.target.value;
    const results = searchCounterparties(query, allCounterparties);
    renderSearchResults(results);
  }, debounceDelay);
});
```

---

### Keyboard Shortcuts

**Counterparty List Page:**
- `N` → Open "New Counterparty" modal (when not in input field)
- `Cmd/Ctrl + F` → Focus search box
- `ESC` → Clear search (if search active), or navigate back
- `↓` / `↑` → Navigate between counterparty cards (when search focused)
- `Enter` → Open edit modal for focused counterparty
- `/` → Focus search box (alternative to Cmd/Ctrl+F)
- `M` → Enter merge mode (multi-select)

**Edit Counterparty Modal:**
- `Tab` → Move to next field
- `Shift + Tab` → Move to previous field
- `ESC` → Close modal (if no unsaved changes)
- `Cmd/Ctrl + Enter` → Save counterparty (from any field)
- `Cmd/Ctrl + S` → Save counterparty (alternative)

**Counterparty Selector Dropdown (in transaction edit):**
- `↓` / `↑` → Navigate options
- `Enter` → Select highlighted counterparty
- `ESC` → Close dropdown without selecting
- `Type to search` → Filter counterparties in real-time
- `Tab` → Close dropdown and move to next field

**Merge Mode:**
- `Cmd/Ctrl + A` → Select all counterparties
- `Cmd/Ctrl + D` → Deselect all
- `Space` → Toggle selection on focused card
- `ESC` → Exit merge mode
- `M` → Continue to merge (when 2+ selected)

---

## Edge Cases

### Edge Case 1: Fuzzy Match Ambiguity (2 Similar Counterparties with Close Scores)

**Scenario:** System finds two existing counterparties with similar confidence scores for a new transaction description.

**User Action:** Importing transaction with description "AMZN PRIME VIDEO".

**System Behavior:**

```
1. Normalization extracts: "Amazon Prime Video"

2. Fuzzy matching finds TWO potential matches:
   - "Amazon" → 0.83 similarity
   - "Amazon Prime" → 0.82 similarity

3. Both above suggestion threshold (0.80), scores very close

4. Ambiguous match dialog appears:
┌────────────────────────────────────────────────────────┐
│ Multiple Potential Matches Found                 [×]  │
├────────────────────────────────────────────────────────┤
│ Your transaction:                                      │
│ "AMZN PRIME VIDEO"                                     │
│                                                        │
│ We found 2 similar counterparties:                     │
│                                                        │
│ ┌──────────────────────────────────────────────────┐   │
│ │ 1. Amazon                                        │   │
│ │    Merchant • 47 transactions                    │   │
│ │    Aliases: AMZN MKTP US, AMAZON.COM, +9 more    │   │
│ │    Confidence: 83% ████████████░░░░░             │   │
│ │                                                  │   │
│ │    [Select This]                                 │   │
│ └──────────────────────────────────────────────────┘   │
│                                                        │
│ ┌──────────────────────────────────────────────────┐   │
│ │ 2. Amazon Prime                                  │   │
│ │    Merchant • 12 transactions                    │   │
│ │    Aliases: AMAZON PRIME, PRIME VIDEO, +2 more   │   │
│ │    Confidence: 82% ███████████░░░░░              │   │
│ │                                                  │   │
│ │    [Select This]                                 │   │
│ └──────────────────────────────────────────────────┘   │
│                                                        │
│ Or create new counterparty:                            │
│ [Create "Amazon Prime Video"]                          │
│                                                        │
│ [Cancel]                                               │
└────────────────────────────────────────────────────────┘

5. User reviews both options:
   - User thinks: "'Amazon Prime' seems more specific for Prime Video"
   - User clicks [Select This] on "Amazon Prime"

6. System links transaction to "Amazon Prime"
   - Adds "AMZN PRIME VIDEO" to aliases
   - Success toast: "✅ Transaction linked to Amazon Prime"

Alternative: User creates new counterparty
- Clicks [Create "Amazon Prime Video"]
- New counterparty created with canonical name: "Amazon Prime Video"
- Type: Merchant
- First alias: "AMZN PRIME VIDEO"
```

**System Logic for Ambiguous Matches:**

```javascript
function handleAmbiguousMatches(matches, threshold = 0.05) {
  // Sort by confidence (descending)
  matches.sort((a, b) => b.confidence - a.confidence);

  const topMatch = matches[0];
  const secondMatch = matches[1];

  // Check if top two matches are within threshold
  if (Math.abs(topMatch.confidence - secondMatch.confidence) < threshold) {
    // Too close to auto-decide
    return {
      action: 'SHOW_AMBIGUOUS_DIALOG',
      matches: matches.slice(0, 3) // Show top 3
    };
  }

  // Clear winner
  if (topMatch.confidence >= 0.90) {
    return { action: 'AUTO_LINK', match: topMatch };
  } else if (topMatch.confidence >= 0.80) {
    return { action: 'SUGGEST', match: topMatch };
  } else {
    return { action: 'CREATE_NEW' };
  }
}
```

---

### Edge Case 2: Merge with 1000+ Transactions (Show Progress, Batch Processing)

**Scenario:** User merges two high-volume counterparties: "Amazon" (847 txns) + "Amazon Marketplace" (312 txns) = 1,159 total transactions.

**User Action:** Selects both counterparties and clicks "Merge".

**System Behavior:**

```
1. User selects counterparties for merge:
   ☑ Amazon (847 transactions)
   ☑ Amazon Marketplace (312 transactions)

2. User clicks "Continue to Merge"

3. System detects high transaction count (>500)

4. Enhanced warning dialog:
┌────────────────────────────────────────────────────────┐
│ ⚠️  Large Merge Detected                         [×]  │
├────────────────────────────────────────────────────────┤
│ You're merging 2 counterparties with 1,159 total      │
│ transactions.                                          │
│                                                        │
│ Due to the large volume, this merge will:             │
│ • Run as a background job                             │
│ • Take approximately 1-2 minutes                       │
│ • Send you a notification when complete               │
│                                                        │
│ You can continue using the app while this processes.  │
│                                                        │
│ Merge summary:                                         │
│ • Amazon (847 txns) + Amazon Marketplace (312 txns)   │
│ • Total: 1,159 transactions to update                 │
│ • Primary: Amazon                                     │
│                                                        │
│ Type "MERGE" to confirm:                               │
│ [____________________]                                 │
│                                                        │
│ [Cancel]                       [Confirm Large Merge]   │
│                                    (disabled)          │
└────────────────────────────────────────────────────────┘

5. User types "MERGE" and clicks "Confirm Large Merge"

6. Job queued, initial progress dialog:
┌────────────────────────────────────────────────────────┐
│ Merge Started                                     [×]  │
├────────────────────────────────────────────────────────┤
│ Your merge is processing in the background.            │
│                                                        │
│ Job ID: #MRG-2025-05-23-7K3M                           │
│ Status: Queued                                         │
│                                                        │
│ We'll notify you when it's complete. You can close    │
│ this dialog and continue working.                      │
│                                                        │
│ [View Progress] [Close]                                │
└────────────────────────────────────────────────────────┘

7. User clicks [View Progress]:
┌────────────────────────────────────────────────────────┐
│ Merge Progress - Job #MRG-2025-05-23-7K3M         [×]  │
├────────────────────────────────────────────────────────┤
│ Step 1: Updating transactions                          │
│ [████████████░░░░░░░░░░░] 52%                          │
│ (603 of 1,159 transactions)                            │
│                                                        │
│ Processing in batches of 50...                         │
│ Current batch: 13 of 24                                │
│                                                        │
│ Estimated time remaining: 47 seconds                   │
│                                                        │
│ Step 2: Merging aliases [Pending]                      │
│ Step 3: Updating counterparty [Pending]                │
│ Step 4: Cleanup [Pending]                              │
│                                                        │
│ [Close] (can close and check back later)               │
└────────────────────────────────────────────────────────┘

8. System processes in batches:
   - Batch 1: txns 1-50 (complete)
   - Batch 2: txns 51-100 (complete)
   - ...
   - Batch 13: txns 601-650 (processing)
   - Batch 14-24: pending

9. Progress updates every 2 seconds (WebSocket):
   52% → 56% → 61% → 65% → ...

10. All steps complete:
┌────────────────────────────────────────────────────────┐
│ Merge Complete - Job #MRG-2025-05-23-7K3M        [×]  │
├────────────────────────────────────────────────────────┤
│ ✅ Merge completed successfully!                       │
│                                                        │
│ Step 1: Updating transactions ✅                       │
│ [████████████████████████] 100%                        │
│ (1,159 of 1,159 transactions)                          │
│                                                        │
│ Step 2: Merging aliases ✅                             │
│ (14 aliases merged)                                    │
│                                                        │
│ Step 3: Updating counterparty ✅                       │
│ (Amazon updated)                                       │
│                                                        │
│ Step 4: Cleanup ✅                                     │
│ (Amazon Marketplace deleted)                           │
│                                                        │
│ Total time: 1 minute 23 seconds                        │
│                                                        │
│ [View Merged Counterparty] [Close]                     │
└────────────────────────────────────────────────────────┘

11. Browser notification (if user navigated away):
┌────────────────────────────────┐
│ Finance App                    │
├────────────────────────────────┤
│ ✅ Merge Complete              │
│                                │
│ Amazon + Amazon Marketplace    │
│ merged successfully.           │
│                                │
│ 1,159 transactions updated     │
└────────────────────────────────┘
```

**Batch Processing Implementation:**

```javascript
async function executeLargeMerge(primary, targets, batchSize = 50) {
  const allTxnIds = await getTransactionIds(targets);
  const totalBatches = Math.ceil(allTxnIds.length / batchSize);

  let processedCount = 0;

  // Process in batches
  for (let i = 0; i < totalBatches; i++) {
    const batch = allTxnIds.slice(i * batchSize, (i + 1) * batchSize);

    // Update batch
    await batchUpdateTransactions(batch, {
      counterparty_id: primary.id
    });

    processedCount += batch.length;

    // Update progress
    await updateJobProgress(jobId, {
      step: 1,
      progress: processedCount / allTxnIds.length,
      processed: processedCount,
      total: allTxnIds.length,
      currentBatch: i + 1,
      totalBatches
    });

    // Small delay to prevent DB overload
    await sleep(100);
  }

  // Continue with steps 2-4...
}
```

---

### Edge Case 3: User Tries to Rename to Existing Canonical Name

**Scenario:** User editing "Starbucks Coffee" tries to rename it to "Starbucks" (which already exists).

**User Action:** Changes canonical name in edit modal.

**System Behavior:**

```
1. User opens edit modal for "Starbucks Coffee":
┌──────────────────────────────────────┐
│ Edit Counterparty                × │
├──────────────────────────────────────┤
│ Canonical Name *                     │
│ [Starbucks Coffee________________]   │
│                                      │
│ Type *                               │
│ [Merchant ▼]                         │
│                                      │
│ [Cancel]              [Save Changes] │
└──────────────────────────────────────┘

2. User edits name:
   - Selects all: Cmd+A
   - Types: "Starbucks"
   - Field updates: [Starbucks_______]

3. User clicks "Save Changes"

4. Client-side validation runs (before API call):
┌──────────────────────────────────────┐
│ Canonical Name *                     │
│ [Starbucks_______________________]   │
│ ❌ Name "Starbucks" already exists   │
│                                      │
│ Existing counterparty:               │
│ • Starbucks (8 transactions)         │
│                                      │
│ Did you mean to merge instead?       │
│ [Merge with Starbucks]               │
│                                      │
│ Or choose different name:            │
│ • Starbucks Coffee (keep current)    │
│ • Starbucks Downtown                 │
│ • Starbucks Reserve                  │
│                                      │
│ [Use Suggestion]                     │
└──────────────────────────────────────┘

5. User has 3 options:

Option A: User clicks [Merge with Starbucks]
→ Edit modal closes
→ Merge preview dialog opens with:
   - Primary: Starbucks (8 txns)
   - Target: Starbucks Coffee (3 txns)
   - User continues merge flow

Option B: User clicks suggestion "Starbucks Coffee"
→ Field reverts: [Starbucks Coffee_______]
→ No changes saved
→ User can try different edit

Option C: User types unique name
→ Changes to: [Starbucks Reserve__________]
→ No error (name is unique)
→ "Save Changes" button enabled
→ User saves successfully
```

**Validation Logic:**

```javascript
function validateCounterpartyName(newName, currentCounterpartyId, allCounterparties) {
  const normalized = newName.toLowerCase().trim();

  // Check for exact duplicate (case-insensitive)
  const duplicate = allCounterparties.find(cp =>
    cp.id !== currentCounterpartyId &&
    cp.canonical_name.toLowerCase() === normalized
  );

  if (duplicate) {
    return {
      valid: false,
      error: 'NAME_EXISTS',
      duplicate: duplicate,
      suggestions: [
        currentCounterpartyId ? getCurrentName(currentCounterpartyId) : null,
        `${newName} Downtown`,
        `${newName} Reserve`,
        `${newName} #2`
      ].filter(Boolean)
    };
  }

  // Check for very similar names (>0.90 similarity)
  const similar = allCounterparties.find(cp =>
    cp.id !== currentCounterpartyId &&
    calculateSimilarity(cp.canonical_name, newName) > 0.90
  );

  if (similar) {
    return {
      valid: true, // Allow but warn
      warning: 'SIMILAR_NAME_EXISTS',
      similar: similar,
      confidence: calculateSimilarity(similar.canonical_name, newName)
    };
  }

  return { valid: true };
}
```

---

### Edge Case 4: Circular Merge Attempts (A merged into B, B merged into A)

**Scenario:** User previously merged "OpenAI" into "OpenAI Inc". Now user tries to merge "OpenAI Inc" into a newly created "OpenAI".

**System Behavior:**

```
1. Merge history exists:
   - 2025-05-10: "OpenAI" merged into "OpenAI Inc"
   - "OpenAI" counterparty deleted
   - 3 transactions moved to "OpenAI Inc"

2. User manually creates new "OpenAI" (2025-05-23):
   - New counterparty ID: cp_new_openai
   - 0 transactions

3. User selects for merge:
   ☑ OpenAI Inc (10 transactions)
   ☑ OpenAI (0 transactions)

4. User clicks "Continue to Merge"

5. System detects potential circular merge:
┌────────────────────────────────────────────────────────┐
│ ⚠️  Potential Circular Merge Detected            [×]  │
├────────────────────────────────────────────────────────┤
│ We detected that "OpenAI" was previously merged into   │
│ "OpenAI Inc" on 2025-05-10.                            │
│                                                        │
│ Merge history:                                         │
│ ┌──────────────────────────────────────────────────┐   │
│ │ 2025-05-10: OpenAI → OpenAI Inc                  │   │
│ │ (3 transactions moved)                           │   │
│ └──────────────────────────────────────────────────┘   │
│                                                        │
│ Current merge:                                         │
│ • OpenAI Inc (10 txns) → OpenAI (0 txns)              │
│                                                        │
│ This appears to be reversing a previous merge.         │
│                                                        │
│ Are you sure you want to continue?                     │
│                                                        │
│ ⚠️  This will:                                         │
│ • Move 10 transactions from OpenAI Inc → OpenAI       │
│ • Delete OpenAI Inc                                   │
│ • Lose OpenAI Inc's merge history                     │
│                                                        │
│ [Cancel] [Review Merge History] [Continue Anyway]      │
└────────────────────────────────────────────────────────┘

6. User clicks [Review Merge History]:
┌────────────────────────────────────────────────────────┐
│ Merge History - OpenAI Inc                        [×]  │
├────────────────────────────────────────────────────────┤
│ This counterparty has participated in 1 merge:         │
│                                                        │
│ ┌──────────────────────────────────────────────────┐   │
│ │ 2025-05-10 14:23:11                              │   │
│ │ Merged: OpenAI → OpenAI Inc                      │   │
│ │                                                  │   │
│ │ • 3 transactions moved                           │   │
│ │ • 2 aliases absorbed                             │   │
│ │ • Merged by: user@example.com                    │   │
│ │                                                  │   │
│ │ Absorbed counterparties:                         │   │
│ │ - OpenAI (cp_7j3k9m2n)                           │   │
│ └──────────────────────────────────────────────────┘   │
│                                                        │
│ [Close]                                                │
└────────────────────────────────────────────────────────┘

7. User decides to cancel:
   - Clicks [Cancel]
   - Merge dialog closes
   - No merge executed

Alternative: User continues anyway
   - Clicks [Continue Anyway]
   - Requires typing "REVERSE MERGE" (not just "MERGE")
   - System executes merge with audit trail:
     ```json
     {
       "merge_id": "mrg_8k2m5n9p",
       "type": "reverse_merge",
       "primary": "OpenAI (cp_new_openai)",
       "targets": ["OpenAI Inc (cp_7j3k9m2n)"],
       "warning_acknowledged": true,
       "previous_merge_detected": "mrg_5j2k9m2n"
     }
     ```
```

**Circular Merge Detection Logic:**

```javascript
function detectCircularMerge(primary, targets, mergeHistory) {
  for (const target of targets) {
    // Check if target was previously merged INTO primary
    const previousMerge = mergeHistory.find(m =>
      m.targets.includes(primary.id) &&
      m.primary === target.id
    );

    if (previousMerge) {
      return {
        detected: true,
        type: 'reverse_merge',
        previousMerge: previousMerge,
        warning: 'Reversing previous merge'
      };
    }

    // Check if primary was previously merged INTO target
    const oppositeMerge = mergeHistory.find(m =>
      m.targets.includes(target.id) &&
      m.primary === primary.id
    );

    if (oppositeMerge) {
      return {
        detected: true,
        type: 'already_merged',
        previousMerge: oppositeMerge,
        warning: 'Already merged in opposite direction'
      };
    }
  }

  return { detected: false };
}
```

---

## Performance Expectations

| Action | Target | Notes |
|--------|--------|-------|
| Load counterparty list (≤100 counterparties) | p95 < 400ms | Fetch from DB, render cards with grouping |
| Load counterparty list (500 counterparties) | p95 < 800ms | With virtual scrolling, lazy load aliases |
| Create counterparty | p95 < 200ms | DB insert + cache invalidation |
| Edit counterparty | p95 < 200ms | DB update + alias re-indexing |
| Merge counterparties (<100 txns) | p95 < 500ms | Synchronous batch update |
| Merge counterparties (100-500 txns) | p95 < 2s | Synchronous with progress indicator |
| Merge counterparties (500+ txns) | Background job | Async processing, WebSocket progress updates |
| Merge counterparties (5000+ txns) | Background job | Batched updates, email notification on completion |
| Search filter (keystroke) | < 50ms | Client-side filtering with 200ms debounce |
| Fuzzy match calculation | < 100ms | Per transaction during import |
| Counterparty dropdown open | < 100ms | Cached counterparty list, grouped rendering |
| Auto-creation during import | < 50ms | Per transaction, batched DB inserts |

---

## Accessibility Compliance

### WCAG 2.2 Level AA Requirements

**Screen Reader Compatibility:**

```
Counterparty card announcement:
"Counterparty card. Amazon. Merchant. 47 transactions.
Aliases: AMZN MKTP US, AMAZON.COM, plus 9 more.
Note: Online retailer - includes AWS, Prime, and marketplace purchases.
Edit button. Merge button."

Fuzzy match suggestion:
"Alert dialog. Potential match found. We found a similar counterparty
that might match this transaction. Your transaction: UBER *5678 SAN FRANCISCO.
Potential match: Uber Eats. Merchant. 12 transactions. Confidence: 85%.
Button: Yes, Link to Uber Eats. Button: No, Create New."

Merge preview:
"Dialog. Merge Counterparties. You're about to merge 3 counterparties
into one. Select primary: OpenAI, 3 transactions. OpenAI Inc, 5 transactions,
selected. OPENAI*, 2 transactions..."

Success notification:
"Alert. 3 counterparties merged into OpenAI Inc. 10 transactions updated."
```

**Keyboard Navigation:**

```
Tab order on Counterparty List:
1. Search field
2. Filter dropdown
3. Sort dropdown
4. "New Counterparty" button
5. First counterparty card (focus outline)
6. Edit button on first card
7. Merge button on first card
8. Second counterparty card
9. Edit button on second card
...

Modal tab order (Edit Counterparty):
1. Canonical Name field (auto-focused)
2. Type dropdown
3. Notes field
4. First alias Remove button
5. Second alias Remove button
...
N. Add Alias button
N+1. Delete Counterparty button
N+2. Cancel button
N+3. Save Changes button
Tab from last → cycles to first
```

**Color Contrast:**

```
Text on white background:
- Primary text (#1a1a1a): 15.8:1 ✅ (AAA)
- Secondary text (#666666): 5.7:1 ✅ (AA)
- Disabled text (#999999): 3.5:1 ⚠️ (AA Large only)

Confidence indicators:
- High (>0.90): Green #00aa00 / white: 4.8:1 ✅
- Medium (0.80-0.90): Yellow #cc9900 / black: 6.2:1 ✅
- Low (<0.80): Red #cc0000 / white: 9.1:1 ✅

Progress bars:
- Active segment: Blue #0066cc / white: 8.2:1 ✅
- Pending segment: Gray #e0e0e0 / border #999999: 3.2:1 ⚠️

Type badges:
- Merchant: Blue #0066cc / white: 8.2:1 ✅
- Person: Purple #6600cc / white: 9.5:1 ✅
- Institution: Orange #cc6600 / white: 6.8:1 ✅
```

**Focus Indicators:**

```
Default focus (keyboard):
border: 2px solid #0066cc;
outline: 2px solid #0066cc;
outline-offset: 2px;
box-shadow: 0 0 0 3px rgba(0, 102, 204, 0.2);
(Contrast ratio: 8.2:1 ✅)

Merge mode (multi-select):
Selected cards:
border: 3px solid #0066cc;
background: rgba(0, 102, 204, 0.05);

High contrast mode:
border: 3px solid CanvasText;
outline: 3px solid Highlight;
```

**ARIA Labels:**

```html
<!-- Counterparty card -->
<div
  role="article"
  aria-label="Amazon counterparty card"
>
  <h3>Amazon</h3>
  <p aria-label="Type">Merchant</p>
  <p aria-label="Transaction count">47 transactions</p>
  <p aria-label="Aliases">AMZN MKTP US, AMAZON.COM, +9 more</p>

  <button
    aria-label="Edit Amazon counterparty"
  >
    Edit
  </button>

  <button
    aria-label="Merge Amazon with other counterparties"
  >
    Merge
  </button>
</div>

<!-- Fuzzy match suggestion -->
<dialog
  role="alertdialog"
  aria-labelledby="match-title"
  aria-describedby="match-description"
  aria-modal="true"
>
  <h2 id="match-title">Potential Match Found</h2>
  <p id="match-description">
    We found a similar counterparty that might match this transaction.
  </p>

  <div role="region" aria-label="Match details">
    <p>Your transaction: UBER *5678 SAN FRANCISCO</p>

    <div aria-label="Suggested match: Uber Eats">
      <h3>Uber Eats</h3>
      <p>Merchant • 12 transactions</p>
      <meter
        value="0.85"
        min="0"
        max="1"
        aria-label="Confidence: 85%"
      >
        85%
      </meter>
    </div>
  </div>
</dialog>

<!-- Merge progress -->
<div
  role="progressbar"
  aria-valuenow="65"
  aria-valuemin="0"
  aria-valuemax="100"
  aria-label="Updating transactions: 65% complete"
>
  <div style="width: 65%"></div>
</div>
```

---

## Decision Points

### When to auto-link vs suggest vs create new?

**Auto-Link (>0.90 confidence):**
- Exact canonical name match (case-insensitive)
- Very similar aliases (e.g., "UBER EATS *1234" vs "UBER EATS *5678")
- Same merchant with different transaction IDs
- User has previously linked similar patterns

**Suggest Match (0.80-0.90 confidence):**
- Similar but not identical names (e.g., "UBER" vs "UBER EATS")
- Common abbreviations (e.g., "AMZN" vs "AMAZON")
- Different locations of same brand (e.g., "STARBUCKS #1234" vs "STARBUCKS #5678")
- User should decide based on context

**Create New (<0.80 confidence):**
- Completely different names
- Low string similarity
- No overlapping tokens
- No user history of linking similar patterns

**Learning from User Decisions:**

```javascript
function learnFromUserDecision(transaction, suggestedMatch, userChoice) {
  if (userChoice === 'LINK') {
    // User accepted suggestion → boost confidence for similar patterns
    addLinkingRule({
      pattern: extractPattern(transaction.description),
      counterparty: suggestedMatch.id,
      confidenceBoost: 0.10,
      source: 'user_feedback'
    });
  } else if (userChoice === 'CREATE_NEW') {
    // User rejected suggestion → penalize this pattern
    addAvoidanceRule({
      pattern: extractPattern(transaction.description),
      avoidCounterparty: suggestedMatch.id,
      confidencePenalty: -0.15,
      source: 'user_feedback'
    });
  }
}
```

---

### When to group by type vs alphabetically?

**Group by Type (default):**
- User has counterparties of multiple types (Merchants, People, Institutions)
- Helps differentiate spending categories (businesses vs individuals)
- Aligns with user mental model of transactions

**Sort Alphabetically (within groups):**
- Default sort within each type group
- Easy scanning for specific counterparty name
- Predictable ordering

**Alternative Sorting Options:**

```
Sort dropdown options:
┌────────────────────────┐
│ A-Z (name) ✓           │ ← Default
│ Transaction count      │ ← Most active first
│ Recently added         │ ← Newest first
│ Recently updated       │ ← Recently edited first
│ Total volume           │ ← Highest spending first
└────────────────────────┘
```

**Implementation:**

```javascript
function sortCounterparties(counterparties, sortBy = 'name') {
  // First group by type
  const grouped = groupBy(counterparties, 'type');

  // Then sort within each group
  const sortFn = {
    'name': (a, b) => a.canonical_name.localeCompare(b.canonical_name),
    'transaction_count': (a, b) => b.transaction_count - a.transaction_count,
    'recently_added': (a, b) => new Date(b.created_at) - new Date(a.created_at),
    'recently_updated': (a, b) => new Date(b.updated_at) - new Date(a.updated_at),
    'total_volume': (a, b) => b.total_volume - a.total_volume
  }[sortBy];

  return Object.entries(grouped).map(([type, cps]) => ({
    type,
    counterparties: cps.sort(sortFn)
  }));
}
```

---

### When to show duplicate suggestions automatically?

**Show Duplicate Suggestions:**
- New counterparties created in last 7 days
- Similarity score >0.80
- At least 2 counterparties in group
- User hasn't dismissed suggestion for this group

**Don't Show:**
- User manually created both counterparties (intentional)
- User previously clicked "Not Duplicates"
- Similarity based only on common words ("Inc", "LLC", "The")
- Counterparties of different types (Merchant vs Person)

**Dismissal Tracking:**

```javascript
function trackDuplicateDismissal(counterpartyIds, reason) {
  storeDismissal({
    counterparties: counterpartyIds,
    dismissed_at: new Date(),
    reason: reason, // 'not_duplicates' or 'will_merge_later'
    expires_at: reason === 'will_merge_later'
      ? addDays(new Date(), 30) // Show again in 30 days
      : null // Never show again
  });
}
```

---

**Next vertical:** 3.3 (Category Taxonomy) — Hierarchical category system for transaction classification.
