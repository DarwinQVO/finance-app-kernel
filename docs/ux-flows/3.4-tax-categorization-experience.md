# UX Flow 3.4: Tax Categorization Experience

> **Vertical:** 3.4 Tax Categorization (Regulatory Classification System)
> **Dependencies:** 1.3 Normalization (transactions must be normalized first), 3.2 Counterparty Registry (merchant patterns for auto-classification), 2.1 Transaction List (classification UI embedded)
> **User Story:** As a user, I want to categorize transactions according to tax regulations (USA Schedule C, Mexico SAT) so I can track deductible expenses, maintain compliance, and link supporting documentation (Facturas).

---

## User Journeys

### Journey 1: Classify Transaction with USA Schedule C Category (Manual)

**Context:** User has a normalized transaction for an Uber ride ($42.50) and wants to classify it as a business travel expense for tax deduction purposes.

**Steps:**

1. **Entry point:** User viewing Transaction List
   - URL: `/transactions`
   - User sees transaction: "Uber • -$42.50 • Oct 15, 2024"
   - Badge shows: "⚪ Not categorized"
   - User clicks transaction row to open detail drawer

2. **Transaction detail drawer opens:**
   ```
   ┌────────────────────────────────────────────────────┐
   │ Transaction Details                            [×] │
   ├────────────────────────────────────────────────────┤
   │ Uber                                               │
   │ Oct 15, 2024                                       │
   │                                                    │
   │ Amount: -$42.50                                    │
   │ Account: Chase Business Credit                     │
   │ Counterparty: Uber                                 │
   │                                                    │
   │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
   │                                                    │
   │ Tax Classification                                 │
   │ ⚪ Not categorized yet                             │
   │                                                    │
   │ Jurisdiction: USA Federal (auto-detected)          │
   │ [Change Jurisdiction ▼]                            │
   │                                                    │
   │ [Categorize for Tax Deduction]                     │
   │                                                    │
   │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
   │                                                    │
   │ Notes:                                             │
   │ [Add notes about this transaction...________]      │
   │                                                    │
   └────────────────────────────────────────────────────┘
   ```

3. **User clicks "Categorize for Tax Deduction":**
   - TaxCategorySelector dropdown expands inline
   - Focus automatically on search field
   - System loads USA Schedule C categories

4. **Category selector appears (hierarchical display):**
   ```
   ┌────────────────────────────────────────────────────┐
   │ Tax Category                                       │
   ├────────────────────────────────────────────────────┤
   │ Search categories... [____________] 🔍             │
   │                                                    │
   │ USA FEDERAL - SCHEDULE C                           │
   │                                                    │
   │ ▸ Advertising (Line 8)                  100%       │
   │ ▸ Car and Truck Expenses (Line 9)      100%       │
   │ ▸ Legal and Professional (Line 17)     100%       │
   │ ▸ Meals (Business) (Line 24b)           50%       │
   │ ▸ Office Expenses (Line 18)            100%       │
   │ ▸ Travel (Line 24a)                    100%       │
   │   └─ Air Travel                        100%       │
   │   └─ Ground Transportation             100%       │
   │   └─ Lodging                           100%       │
   │   └─ Other Travel Expenses             100%       │
   │ ▸ Utilities (Line 25)                  100%       │
   │                                                    │
   │ ─────────────────────────────────────────────      │
   │ CUSTOM CATEGORIES (2)                              │
   │ ▸ Software Subscriptions               100%       │
   │ ▸ Client Gifts                           0%       │
   │                                                    │
   │ [+ Create Custom Category]                         │
   └────────────────────────────────────────────────────┘
   ```

5. **User searches for "travel":**
   - Types: "travel" in search field
   - Results filter in real-time:
     ```
     Search results for "travel": (4 matches)

     ▸ Travel (Line 24a)                    100% ✓
       └─ Air Travel                        100%
       └─ Ground Transportation             100%
       └─ Lodging                           100%
       └─ Other Travel Expenses             100%
     ```

6. **User selects "Travel > Ground Transportation":**
   - Hovers over "Ground Transportation"
   - Tooltip shows: "Includes taxis, rideshare (Uber/Lyft), rental cars, parking fees"
   - Clicks category
   - Category selector collapses
   - Drawer updates to show classification:
     ```
     │ Tax Classification                                 │
     │ ✅ Travel > Ground Transportation                  │
     │ USA Federal • Schedule C Line 24a                  │
     │ Deduction Rate: 100% (fully deductible)            │
     │                                                    │
     │ Classification Notes:                              │
     │ [Client meeting in downtown SF____________]        │
     │                                                    │
     │ Classified: Oct 15, 2024 3:45 PM                   │
     │ Method: Manual                                     │
     │                                                    │
     │ [Change Category] [Remove Classification]          │
     ```

7. **User adds classification notes:**
   - Types: "Client meeting in downtown SF"
   - Notes auto-save (debounced 500ms)
   - Success indicator: "✓ Saved"

8. **System records classification:**
   ```json
   {
     "transaction_id": "txn_12345",
     "tax_classification": {
       "category_id": "tax_cat_usa_schedule_c_travel_ground",
       "category_name": "Travel > Ground Transportation",
       "jurisdiction": "usa_federal",
       "deduction_rate": 1.0,
       "classified_at": "2024-10-15T15:45:00Z",
       "classified_by": "user_123",
       "classification_method": "manual",
       "notes": "Client meeting in downtown SF",
       "confidence": null
     }
   }
   ```

9. **User closes drawer:**
   - Transaction row now shows: "✅ 100% Deductible" badge (green)
   - Transaction appears in "Categorized" filter
   - Dashboard tax summary updates with +$42.50 to Travel category

**Outcome:** User successfully classified transaction with Schedule C category. Transaction now tracked for tax deduction. Notes preserved for audit trail.

**Duration:** ~2 minutes

**Keyboard Navigation:**
- Tab: Move between search field and category items
- Arrow keys: Navigate category tree
- Enter: Select highlighted category
- Escape: Close selector without selecting

**Screen Reader Support:**
- Announces: "Tax classification dialog, USA Federal Schedule C categories"
- Each category reads: "Travel, Schedule C Line 24a, 100% deductible, expandable"
- Selected category announces: "Ground Transportation selected, 100% deductible"

---

### Journey 2: Accept Auto-Suggested Category (Uber → Travel)

**Context:** User has previously classified 10 Uber transactions as "Travel > Ground Transportation". A new Uber transaction arrives. System auto-suggests category based on historical pattern.

**Steps:**

1. **Background: Transaction normalized (1.3):**
   - New transaction imported: "UBER *5678 NYC • -$28.00"
   - Normalization engine extracts: "Uber"
   - Links to counterparty: "Uber"
   - Transaction saved with status: "normalized"

2. **Background: Auto-classification runs:**
   - TaxCategoryClassifier.auto_classify() triggered
   - Checks merchant pattern: "Uber"
   - Finds historical classifications:
     - "Uber" → "Travel > Ground Transportation" (10 instances)
     - Confidence: 0.95 (above 0.70 threshold)
   - Creates suggestion record

3. **User opens Transaction List:**
   - URL: `/transactions`
   - New transaction appears with special badge:
     ```
     ┌────────────────────────────────────────────────┐
     │ Recent Transactions                [Filters ▼] │
     ├────────────────────────────────────────────────┤
     │                                                │
     │ Oct 20, 2024                                   │
     │ ┌──────────────────────────────────────────┐  │
     │ │ 💡 Uber                      -$28.00     │  │
     │ │ Chase Business Credit                    │  │
     │ │                                          │  │
     │ │ 💡 Suggested: Travel (95% confidence)    │  │
     │ │ Based on 10 similar transactions         │  │
     │ │                                          │  │
     │ │ [Accept] [Edit] [Reject]                 │  │
     │ └──────────────────────────────────────────┘  │
     │                                                │
     ```

4. **Auto-suggestion notification appears (real-time):**
   ```
   ┌────────────────────────────────────────────────────┐
   │ 💡 Tax Category Suggested                      [×] │
   ├────────────────────────────────────────────────────┤
   │ We found a likely tax category for your new        │
   │ transaction based on previous classifications.     │
   │                                                    │
   │ Transaction:                                       │
   │ Uber • -$28.00 • Oct 20, 2024                      │
   │                                                    │
   │ Suggested Category:                                │
   │ ✅ Travel > Ground Transportation                  │
   │ USA Federal • Schedule C Line 24a                  │
   │ Deduction Rate: 100% (fully deductible)            │
   │                                                    │
   │ Confidence: 95% ███████████████████░               │
   │                                                    │
   │ Based on:                                          │
   │ • 10 previous Uber transactions classified         │
   │ • 100% accuracy (all classified as Travel)         │
   │ • Same merchant pattern                            │
   │                                                    │
   │ [Reject]                       [Accept Category]   │
   │                                                    │
   │ ☐ Auto-apply this category for future Uber        │
   │   transactions (no more suggestions)               │
   └────────────────────────────────────────────────────┘
   ```

5. **User reviews suggestion:**
   - Reads confidence: 95%
   - Reads reasoning: "Based on 10 previous Uber transactions"
   - User thinks: "Yes, this is business travel too"

6. **User accepts suggestion (Option A: Quick accept from list):**
   - Clicks "Accept" button on transaction card
   - Success toast: "✅ Transaction classified as Travel"
   - Badge updates: "💡 Suggested" → "✅ 100% Deductible"
   - Transaction appears in categorized list

7. **User accepts suggestion (Option B: From notification dialog):**
   - Clicks "Accept Category" in notification
   - Checks: "☑ Auto-apply this category for future Uber transactions"
   - System creates auto-classification rule:
     ```json
     {
       "rule_id": "rule_uber_to_travel",
       "merchant_pattern": "Uber",
       "category_id": "tax_cat_usa_schedule_c_travel_ground",
       "confidence_boost": 0.10,
       "auto_apply": true,
       "created_at": "2024-10-20T14:30:00Z"
     }
     ```
   - Dialog closes
   - Success toast: "✅ Auto-classification enabled for Uber"

8. **Future behavior (auto-apply enabled):**
   - Next Uber transaction: Auto-classifies immediately
   - No suggestion notification shown
   - User can disable auto-apply from Settings > Tax Categories

9. **System logs acceptance:**
   ```json
   {
     "event": "category_suggestion_accepted",
     "transaction_id": "txn_67890",
     "suggested_category_id": "tax_cat_usa_schedule_c_travel_ground",
     "confidence": 0.95,
     "auto_apply_enabled": true,
     "user_id": "user_123",
     "timestamp": "2024-10-20T14:30:15Z"
   }
   ```

**Outcome:** User accepted auto-suggestion with one click. Future Uber transactions will auto-classify without prompts. System learns from user behavior.

**Duration:** ~30 seconds (quick acceptance)

**Alternative Flow: User rejects suggestion:**

6b. **User clicks "Reject":**
   - Suggestion dismissed
   - Transaction returns to "Not categorized" state
   - System logs rejection (confidence adjusted for future)
   - User can manually categorize differently

---

### Journey 3: Upload Factura XML and Link to Mexico Transaction

**Context:** User has a transaction from a Mexican restaurant ($500 MXN) and needs to upload the Factura (CFDI tax receipt) to maintain compliance with SAT regulations.

**Steps:**

1. **Entry point:** User viewing Mexico transaction
   - URL: `/transactions`
   - User sees transaction: "La Casa del Sabor • -$500 MXN • Oct 18, 2024"
   - Jurisdiction: Mexico Federal (auto-detected from MXN currency)
   - User clicks transaction to open detail drawer

2. **Transaction detail drawer shows Mexico-specific fields:**
   ```
   ┌────────────────────────────────────────────────────┐
   │ Transaction Details                            [×] │
   ├────────────────────────────────────────────────────┤
   │ La Casa del Sabor                                  │
   │ Oct 18, 2024                                       │
   │                                                    │
   │ Amount: -$500.00 MXN                               │
   │ Account: Santander Business                        │
   │ Counterparty: La Casa del Sabor                    │
   │                                                    │
   │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
   │                                                    │
   │ Tax Classification                                 │
   │ ⚪ Not categorized yet                             │
   │                                                    │
   │ Jurisdiction: Mexico Federal                       │
   │ [Change Jurisdiction ▼]                            │
   │                                                    │
   │ [Categorize for Tax Deduction]                     │
   │                                                    │
   │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
   │                                                    │
   │ Factura (CFDI)                                     │
   │ 📄 No Factura attached                             │
   │                                                    │
   │ ⚠️  Recommended: Attach Factura for expenses over  │
   │    $2,000 MXN to maintain SAT compliance           │
   │                                                    │
   │ [Attach Factura XML]                               │
   │                                                    │
   └────────────────────────────────────────────────────┘
   ```

3. **User clicks "Attach Factura XML":**
   - FacturaUploadDialog opens as modal
   - Modal size: 600px width, auto height

4. **Factura upload dialog appears:**
   ```
   ┌────────────────────────────────────────────────────┐
   │ Attach Factura (CFDI)                          [×] │
   ├────────────────────────────────────────────────────┤
   │ Transaction: La Casa del Sabor • $500 MXN          │
   │ Date: Oct 18, 2024                                 │
   ├────────────────────────────────────────────────────┤
   │                                                    │
   │ Upload Factura XML:                                │
   │                                                    │
   │ ┌──────────────────────────────────────────────┐  │
   │ │                                              │  │
   │ │              📄                              │  │
   │ │                                              │  │
   │ │      Drag and drop XML file here             │  │
   │ │      or click to browse                      │  │
   │ │                                              │  │
   │ │      Accepted: CFDI 3.3, CFDI 4.0 (.xml)     │  │
   │ │      Max size: 5MB                           │  │
   │ │                                              │  │
   │ └──────────────────────────────────────────────┘  │
   │                                                    │
   │ ℹ️  What's a Factura?                              │
   │ Factura (CFDI) is a Mexican tax receipt required   │
   │ by SAT for business expense deductions. Request    │
   │ from merchants at time of purchase.                │
   │                                                    │
   │ [Cancel]                                           │
   └────────────────────────────────────────────────────┘
   ```

5. **User drags factura_abc123.xml file:**
   - File drag enters drop zone
   - Drop zone highlights (blue border, light blue background)
   - User releases file

6. **File upload and parsing begins:**
   ```
   ┌────────────────────────────────────────────────────┐
   │ Attach Factura (CFDI)                          [×] │
   ├────────────────────────────────────────────────────┤
   │ Transaction: La Casa del Sabor • $500 MXN          │
   │ Date: Oct 18, 2024                                 │
   ├────────────────────────────────────────────────────┤
   │                                                    │
   │ Processing Factura...                              │
   │                                                    │
   │ ┌──────────────────────────────────────────────┐  │
   │ │ 📄 factura_abc123.xml (4.2 KB)               │  │
   │ │                                              │  │
   │ │ [████████████░░░░░░░░] 60%                   │  │
   │ │                                              │  │
   │ │ ✅ XML format valid (CFDI 4.0)               │  │
   │ │ ✅ RFC format valid                          │  │
   │ │ ⏳ Validating UUID with SAT...               │  │
   │ │ ⏳ Checking amount match...                  │  │
   │ └──────────────────────────────────────────────┘  │
   │                                                    │
   └────────────────────────────────────────────────────┘
   ```

7. **Validation completes successfully:**
   ```
   ┌────────────────────────────────────────────────────┐
   │ Attach Factura (CFDI)                          [×] │
   ├────────────────────────────────────────────────────┤
   │ Transaction: La Casa del Sabor • $500 MXN          │
   │ Date: Oct 18, 2024                                 │
   ├────────────────────────────────────────────────────┤
   │                                                    │
   │ ✅ Factura validated successfully                  │
   │                                                    │
   │ ┌──────────────────────────────────────────────┐  │
   │ │ 📄 factura_abc123.xml                        │  │
   │ │                                              │  │
   │ │ RFC: ABC123456XYZ                            │  │
   │ │ UUID: 12345678-1234-1234-1234-123456789012   │  │
   │ │ Issued: Oct 18, 2024                         │  │
   │ │ Amount: $500.00 MXN                          │  │
   │ │                                              │  │
   │ │ ✅ Amount matches transaction                │  │
   │ │ ✅ Date within window (same day)             │  │
   │ │ ✅ RFC format valid                          │  │
   │ │ ✅ UUID verified with SAT                    │  │
   │ └──────────────────────────────────────────────┘  │
   │                                                    │
   │ [Cancel]                        [Attach Factura]   │
   └────────────────────────────────────────────────────┘
   ```

8. **User clicks "Attach Factura":**
   - System creates FacturaRecord
   - Links to transaction
   - Stores XML in file artifacts
   - Modal closes with success animation
   - Success toast: "✅ Factura attached successfully"

9. **Transaction drawer updates to show Factura:**
   ```
   │ Factura (CFDI)                                     │
   │ ✅ Factura attached                                │
   │                                                    │
   │ ┌──────────────────────────────────────────────┐  │
   │ │ 📄 factura_abc123.xml                        │  │
   │ │                                              │  │
   │ │ RFC: ABC123456XYZ                            │  │
   │ │ UUID: 12345678-1234-1234-1234-123456789012   │  │
   │ │ Issued: Oct 18, 2024                         │  │
   │ │ Amount: $500.00 MXN                          │  │
   │ │ Status: Valid ✅                             │  │
   │ │                                              │  │
   │ │ [Download XML] [Download PDF] [Unlink]       │  │
   │ └──────────────────────────────────────────────┘  │
   ```

10. **User can download Factura anytime:**
    - Clicks "Download XML" → Original XML file downloads
    - Clicks "Download PDF" → System-generated PDF representation downloads

**Outcome:** User successfully uploaded and linked Factura to Mexico transaction. SAT compliance maintained. Factura details preserved for audit.

**Duration:** ~3 minutes

**Error Handling Examples:**

**Error: Amount mismatch (5% variance):**
```
│ ⚠️  Validation issues detected                    │
│                                                    │
│ ┌──────────────────────────────────────────────┐  │
│ │ 📄 factura_abc123.xml                        │  │
│ │                                              │  │
│ │ ⚠️  Amount mismatch                          │  │
│ │ Transaction: $500.00 MXN                     │  │
│ │ Factura: $520.00 MXN                         │  │
│ │ Variance: +$20.00 (4%)                       │  │
│ │                                              │  │
│ │ ⓘ This may be due to tips, taxes, or fees   │  │
│ │   not included in transaction amount.        │  │
│ └──────────────────────────────────────────────┘  │
│                                                    │
│ [Cancel]   [Force Link Anyway]   [Edit Amount]     │
```

**Error: RFC format invalid:**
```
│ ❌ Validation failed                              │
│                                                    │
│ ┌──────────────────────────────────────────────┐  │
│ │ 📄 factura_abc123.xml                        │  │
│ │                                              │  │
│ │ ❌ RFC format invalid                        │  │
│ │ Found: INVALID123                            │  │
│ │ Expected: 12-13 alphanumeric characters      │  │
│ │                                              │  │
│ │ ❌ UUID not found in SAT database            │  │
│ │                                              │  │
│ │ ⓘ Please verify XML file is valid CFDI      │  │
│ └──────────────────────────────────────────────┘  │
│                                                    │
│ [Cancel]                       [Try Another File]  │
```

---

### Journey 4: Create Custom Tax Category

**Context:** User needs a custom category for "Social Media Advertising" expenses under Mexico SAT "Gastos de Gestión" (Management Expenses). System categories don't include this specific subcategory.

**Steps:**

1. **Entry point:** User opens Tax Category Manager
   - URL: `/settings/tax-categories`
   - User sees system categories organized by jurisdiction

2. **Tax Category Manager displays:**
   ```
   ┌────────────────────────────────────────────────────┐
   │ Tax Categories                     [+ New Category] │
   ├────────────────────────────────────────────────────┤
   │ Search categories... [____________] 🔍             │
   │ Jurisdiction: [All ▼]                              │
   │                                                    │
   │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
   │                                                    │
   │ USA FEDERAL - SCHEDULE C (25 categories)           │
   │                                                    │
   │ ▾ Travel (Line 24a)                    100%       │
   │   └─ Air Travel                        100%  🔒    │
   │   └─ Ground Transportation             100%  🔒    │
   │   └─ Lodging                           100%  🔒    │
   │   └─ Other Travel Expenses             100%  🔒    │
   │ ▸ Meals (Business) (Line 24b)           50%       │
   │ ▸ Office Expenses (Line 18)            100%       │
   │ ▸ Advertising (Line 8)                 100%       │
   │                                                    │
   │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
   │                                                    │
   │ MEXICO FEDERAL - SAT (18 categories)               │
   │                                                    │
   │ ▾ Gastos de Gestión                    100%       │
   │   └─ Publicidad y Promoción            100%  🔒    │
   │   └─ Arrendamientos                    100%  🔒    │
   │   └─ Otros Gastos                      100%  🔒    │
   │ ▸ Gastos de Representación              50%       │
   │ ▸ Inversiones                          100%       │
   │                                                    │
   │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
   │                                                    │
   │ CUSTOM CATEGORIES (3)                              │
   │                                                    │
   │ ▸ Software Subscriptions (USA)         100%  ✏️   │
   │ ▸ Client Gifts (USA)                     0%  ✏️   │
   │ ▸ Gastos de Marketing Digital (MX)     100%  ✏️   │
   │                                                    │
   │ 🔒 = System category (read-only)                   │
   │ ✏️ = Custom category (editable)                    │
   └────────────────────────────────────────────────────┘
   ```

3. **User clicks "+ New Category" button:**
   - Create Category modal opens
   - Focus on "Category Name" field

4. **Create Custom Category modal appears:**
   ```
   ┌────────────────────────────────────────────────────┐
   │ Create Custom Tax Category                     [×] │
   ├────────────────────────────────────────────────────┤
   │                                                    │
   │ Jurisdiction *                                     │
   │ ⦿ USA Federal    ○ Mexico Federal                  │
   │                                                    │
   │ Category Name *                                    │
   │ [_________________________________________]        │
   │                                                    │
   │ Parent Category (optional)                         │
   │ [Select parent category ▼]                         │
   │ ⓘ Leave blank for top-level category              │
   │                                                    │
   │ SAT Code (optional, Mexico only)                   │
   │ [________] (8 digits)                              │
   │ ⓘ Official SAT product/service code                │
   │                                                    │
   │ Deduction Rate *                                   │
   │ [Fully Deductible (100%) ▼]                        │
   │ • Fully Deductible (100%)                          │
   │ • Partially Deductible (50%)                       │
   │ • Not Deductible (0%)                              │
   │ • Custom Percentage...                             │
   │                                                    │
   │ Description (optional)                             │
   │ [_________________________________________]        │
   │ [_________________________________________]        │
   │                                                    │
   │ [Cancel]                       [Create Category]   │
   └────────────────────────────────────────────────────┘
   ```

5. **User selects Mexico Federal:**
   - Clicks "○ Mexico Federal" radio button
   - SAT Code field becomes enabled (shown in previous step)
   - Parent category dropdown updates to show Mexico categories

6. **User fills category information:**
   - Types name: "Gastos de Publicidad en Redes Sociales"
   - Selects parent: "Gastos de Gestión"
   - Types SAT code: "84111506"
   - Selects deduction rate: "Fully Deductible (100%)"
   - Types description: "Social media advertising expenses (Facebook, Instagram, LinkedIn, Twitter)"

7. **Form shows real-time validation:**
   ```
   │ Category Name *                                    │
   │ [Gastos de Publicidad en Redes Sociales____]      │
   │ ✅ Name available                                  │
   │                                                    │
   │ Parent Category                                    │
   │ [Gastos de Gestión ▼]                              │
   │                                                    │
   │ SAT Code (optional)                                │
   │ [84111506]                                         │
   │ ✅ Valid SAT code format                           │
   │                                                    │
   │ Deduction Rate *                                   │
   │ [Fully Deductible (100%) ▼]                        │
   │                                                    │
   │ Description                                        │
   │ [Social media advertising expenses (Facebook,      │
   │  Instagram, LinkedIn, Twitter)_____________]       │
   ```

8. **User clicks "Create Category":**
   - System validates all fields
   - Creates custom category with ID: `tax_cat_mx_sat_custom_social_ads`
   - Modal closes with success animation
   - Success toast: "✅ Custom category created: Gastos de Publicidad en Redes Sociales"

9. **Category Manager updates to show new category:**
   ```
   │ MEXICO FEDERAL - SAT (18 categories)               │
   │                                                    │
   │ ▾ Gastos de Gestión                    100%       │
   │   └─ Publicidad y Promoción            100%  🔒    │
   │   └─ Arrendamientos                    100%  🔒    │
   │   └─ Otros Gastos                      100%  🔒    │
   │   └─ Gastos de Publicidad en Redes     100%  ✏️    │
   │       Sociales (Custom)                            │
   │                                                    │
   │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
   │                                                    │
   │ CUSTOM CATEGORIES (4)                              │
   │                                                    │
   │ ▸ Software Subscriptions (USA)         100%  ✏️   │
   │ ▸ Client Gifts (USA)                     0%  ✏️   │
   │ ▸ Gastos de Marketing Digital (MX)     100%  ✏️   │
   │ ▸ Gastos de Publicidad en Redes        100%  ✏️   │
   │   Sociales (MX)                                    │
   │     [Edit] [Archive]                               │
   ```

10. **User can now use custom category:**
    - Category appears in TaxCategorySelector dropdown
    - Shows under parent "Gastos de Gestión > Custom"
    - Available for classifying transactions
    - User thinks: "Perfect! Now I can track social media ads separately."

**Outcome:** User successfully created custom tax category for Mexico SAT. Category is now available for transaction classification and will appear in tax reports.

**Duration:** ~3 minutes

**Validation Errors:**

**Duplicate name:**
```
│ Category Name *                                    │
│ [Publicidad y Promoción_________________]          │
│ ❌ Name already exists in Mexico Federal           │
│ ⓘ Try: "Publicidad Online" or "Promoción Digital" │
```

**Invalid SAT code:**
```
│ SAT Code (optional)                                │
│ [1234567]                                          │
│ ❌ Invalid SAT code (must be 8 digits)             │
```

---

### Journey 5: Bulk Classify Uncategorized Transactions

**Context:** User has 47 uncategorized transactions from the past month. They want to classify multiple similar transactions at once instead of one-by-one.

**Steps:**

1. **Entry point:** User viewing Transaction List
   - URL: `/transactions`
   - Filter: "Status: Not Categorized" (47 transactions)
   - User sees many similar transactions (multiple Starbucks, multiple Amazon)

2. **Transaction List shows bulk selection mode:**
   ```
   ┌────────────────────────────────────────────────────┐
   │ Transactions                          [Filters ▼]  │
   ├────────────────────────────────────────────────────┤
   │ Status: Not Categorized (47)                       │
   │                                                    │
   │ [☐ Select All] [Bulk Actions ▼]                    │
   │                                                    │
   │ Oct 2024                                           │
   │ ┌──────────────────────────────────────────────┐  │
   │ │ ☐ Oct 23  Starbucks           -$5.75         │  │
   │ │           Chase Credit                       │  │
   │ │           ⚪ Not categorized                  │  │
   │ └──────────────────────────────────────────────┘  │
   │                                                    │
   │ ┌──────────────────────────────────────────────┐  │
   │ │ ☐ Oct 22  Amazon               -$129.99      │  │
   │ │           Chase Credit                       │  │
   │ │           ⚪ Not categorized                  │  │
   │ └──────────────────────────────────────────────┘  │
   │                                                    │
   │ ┌──────────────────────────────────────────────┐  │
   │ │ ☐ Oct 21  Starbucks           -$4.25         │  │
   │ │           Chase Credit                       │  │
   │ │           ⚪ Not categorized                  │  │
   │ └──────────────────────────────────────────────┘  │
   │                                                    │
   │ ┌──────────────────────────────────────────────┐  │
   │ │ ☐ Oct 20  Uber                -$28.00        │  │
   │ │           Chase Credit                       │  │
   │ │           ⚪ Not categorized                  │  │
   │ └──────────────────────────────────────────────┘  │
   │                                                    │
   │ ┌──────────────────────────────────────────────┐  │
   │ │ ☐ Oct 19  Starbucks           -$6.50         │  │
   │ │           Chase Credit                       │  │
   │ │           ⚪ Not categorized                  │  │
   │ └──────────────────────────────────────────────┘  │
   │                                                    │
   │ ... and 42 more                                    │
   └────────────────────────────────────────────────────┘
   ```

3. **User selects all Starbucks transactions:**
   - Clicks checkbox on first Starbucks transaction
   - Holds Shift, clicks checkbox on third Starbucks transaction
   - All Starbucks transactions between selected (8 total)
   - Bottom toolbar slides up:
     ```
     ┌────────────────────────────────────────────────────┐
     │                                                    │
     │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
     │ 8 transactions selected                            │
     │                                                    │
     │ [Deselect All] [Bulk Classify] [Select Similar]   │
     │                                                    │
     └────────────────────────────────────────────────────┘
     ```

4. **User clicks "Bulk Classify":**
   - Bulk Classification Dialog opens
   - Shows preview of selected transactions

5. **Bulk Classification Dialog appears:**
   ```
   ┌────────────────────────────────────────────────────┐
   │ Bulk Classify Transactions                     [×] │
   ├────────────────────────────────────────────────────┤
   │ You're about to classify 8 transactions            │
   │                                                    │
   │ Selected Transactions:                             │
   │ ┌──────────────────────────────────────────────┐  │
   │ │ Oct 23  Starbucks           -$5.75           │  │
   │ │ Oct 21  Starbucks           -$4.25           │  │
   │ │ Oct 19  Starbucks           -$6.50           │  │
   │ │ Oct 18  Starbucks           -$5.00           │  │
   │ │ Oct 16  Starbucks           -$7.25           │  │
   │ │ Oct 14  Starbucks           -$4.75           │  │
   │ │ Oct 12  Starbucks           -$5.50           │  │
   │ │ Oct 10  Starbucks           -$6.00           │  │
   │ │                                              │  │
   │ │ Total: $45.00                                │  │
   │ └──────────────────────────────────────────────┘  │
   │                                                    │
   │ Apply Tax Category:                                │
   │ [Select category_________________________] 🔍      │
   │                                                    │
   │ Jurisdiction: USA Federal (all transactions)       │
   │                                                    │
   │ Classification Notes (optional):                   │
   │ [Apply same notes to all transactions_______]      │
   │ [_________________________________________]        │
   │                                                    │
   │ [Cancel]                        [Classify All 8]   │
   └────────────────────────────────────────────────────┘
   ```

6. **User selects category:**
   - Clicks category dropdown
   - Types: "meals"
   - Selects: "Meals (Business) (Schedule C Line 24b) • 50%"
   - Category field shows selection:
     ```
     │ Apply Tax Category:                                │
     │ [Meals (Business) • 50% deductible_________] 🔍    │
     ```

7. **User adds notes:**
   - Types: "Client meetings at local Starbucks"
   - Notes will be applied to all 8 transactions

8. **User clicks "Classify All 8":**
   - Progress indicator appears:
     ```
     ┌────────────────────────────────────────────────────┐
     │ Classifying Transactions...                        │
     ├────────────────────────────────────────────────────┤
     │                                                    │
     │ [████████████████████░░] 8 of 8 (100%)             │
     │                                                    │
     │ ✅ Oct 23  Starbucks           -$5.75              │
     │ ✅ Oct 21  Starbucks           -$4.25              │
     │ ✅ Oct 19  Starbucks           -$6.50              │
     │ ✅ Oct 18  Starbucks           -$5.00              │
     │ ✅ Oct 16  Starbucks           -$7.25              │
     │ ✅ Oct 14  Starbucks           -$4.75              │
     │ ✅ Oct 12  Starbucks           -$5.50              │
     │ ✅ Oct 10  Starbucks           -$6.00              │
     │                                                    │
     │ Processing complete!                               │
     └────────────────────────────────────────────────────┘
     ```
   - Auto-closes after 1 second
   - Success toast: "✅ 8 transactions classified as Meals"

9. **Transaction List updates:**
   - All Starbucks transactions now show "✅ 50% Deductible" badge
   - Filter count updates: "Not Categorized (39)" (was 47)
   - Checkboxes deselected
   - Bottom toolbar dismisses

10. **User can continue bulk classifying:**
    - Selects 5 Amazon transactions
    - Clicks "Bulk Classify"
    - Assigns to "Office Expenses • 100%"
    - User thinks: "This is so much faster than one-by-one!"

**Outcome:** User successfully classified 8 transactions at once. Saved significant time compared to manual classification. Can continue with remaining uncategorized transactions.

**Duration:** ~4 minutes for 8 transactions (~30 seconds per transaction)

**Alternative: "Select Similar" Feature:**

3b. **User clicks "Select Similar" button:**
   - System analyzes selected transaction: "Starbucks"
   - Automatically selects all other Starbucks transactions (8 total)
   - Toolbar updates: "8 similar transactions selected"
   - User can proceed directly to bulk classify

**Edge Case: Mixed Jurisdictions:**
```
│ ⚠️  Selected transactions have mixed jurisdictions    │
│                                                        │
│ • 5 transactions: USA Federal                          │
│ • 3 transactions: Mexico Federal                       │
│                                                        │
│ ⓘ You can only bulk classify transactions from the    │
│   same jurisdiction. Please select one:                │
│                                                        │
│ [Classify USA (5)] [Classify Mexico (3)] [Cancel]      │
```

---

### Journey 6: Handle Factura Amount Mismatch (Force Link)

**Context:** User has a Mexico transaction for $1,500 MXN but the uploaded Factura shows $1,550 MXN (3.3% variance). This may be due to tips, taxes, or fees not included in the bank transaction.

**Steps:**

1. **Background: User uploads Factura with amount mismatch:**
   - Transaction amount: $1,500 MXN
   - Factura amount: $1,550 MXN
   - Variance: +$50 MXN (3.3%)

2. **Validation detects mismatch:**
   ```
   ┌────────────────────────────────────────────────────┐
   │ Attach Factura (CFDI)                          [×] │
   ├────────────────────────────────────────────────────┤
   │ Transaction: Ferretería ABC • $1,500 MXN           │
   │ Date: Oct 22, 2024                                 │
   ├────────────────────────────────────────────────────┤
   │                                                    │
   │ ⚠️  Validation warning                             │
   │                                                    │
   │ ┌──────────────────────────────────────────────┐  │
   │ │ 📄 factura_ferreteria_abc.xml                │  │
   │ │                                              │  │
   │ │ RFC: FER123456ABC                            │  │
   │ │ UUID: 98765432-9876-9876-9876-987654321098   │  │
   │ │ Issued: Oct 22, 2024                         │  │
   │ │ Amount: $1,550.00 MXN                        │  │
   │ │                                              │  │
   │ │ ⚠️  Amount mismatch detected                 │  │
   │ │                                              │  │
   │ │ Transaction:  $1,500.00 MXN                  │  │
   │ │ Factura:      $1,550.00 MXN                  │  │
   │ │ Variance:     +$50.00 (3.3%)                 │  │
   │ │                                              │  │
   │ │ ✅ Date matches (same day)                   │  │
   │ │ ✅ RFC format valid                          │  │
   │ │ ✅ UUID verified with SAT                    │  │
   │ └──────────────────────────────────────────────┘  │
   │                                                    │
   │ ⓘ Possible reasons for variance:                   │
   │ • Tips not included in transaction amount          │
   │ • Separate tax/fee charges                         │
   │ • Partial payment (transaction split)              │
   │                                                    │
   │ What would you like to do?                         │
   │                                                    │
   │ [Cancel]  [Adjust Transaction]  [Force Link]       │
   └────────────────────────────────────────────────────┘
   ```

3. **User reviews options:**
   - **Cancel:** Abandon Factura upload
   - **Adjust Transaction:** Update transaction amount to match Factura ($1,550)
   - **Force Link:** Accept mismatch and link anyway (logs variance)

4. **User clicks "Adjust Transaction":**
   - Adjustment dialog appears:
     ```
     ┌────────────────────────────────────────────────────┐
     │ Adjust Transaction Amount                      [×] │
     ├────────────────────────────────────────────────────┤
     │                                                    │
     │ Update transaction to match Factura amount?        │
     │                                                    │
     │ Current Transaction:                               │
     │ Ferretería ABC • Oct 22, 2024                      │
     │ Amount: $1,500.00 MXN                              │
     │                                                    │
     │ Factura Amount:                                    │
     │ $1,550.00 MXN                                      │
     │                                                    │
     │ Adjustment: +$50.00                                │
     │                                                    │
     │ ⚠️  This will modify the original transaction      │
     │    amount to match the Factura. The original       │
     │    amount ($1,500) will be preserved in the        │
     │    transaction history.                            │
     │                                                    │
     │ Reason for adjustment:                             │
     │ [Factura includes tip/tax not in bank record_]     │
     │                                                    │
     │ [Cancel]                      [Adjust & Link]      │
     └────────────────────────────────────────────────────┘
     ```

5. **User types adjustment reason:**
   - Types: "Factura includes IVA tax ($50), bank shows net amount only"
   - Clicks "Adjust & Link"

6. **System performs adjustment:**
   - Creates adjustment record:
     ```json
     {
       "adjustment_id": "adj_123",
       "transaction_id": "txn_67890",
       "original_amount": 1500.00,
       "adjusted_amount": 1550.00,
       "adjustment_type": "factura_reconciliation",
       "reason": "Factura includes IVA tax ($50), bank shows net amount only",
       "created_at": "2024-10-22T16:20:00Z"
     }
     ```
   - Updates transaction amount: $1,500 → $1,550
   - Links Factura (now amounts match)
   - Success toast: "✅ Transaction adjusted and Factura attached"

7. **Transaction drawer shows adjustment history:**
   ```
   │ Transaction Details                                │
   ├────────────────────────────────────────────────────┤
   │ Ferretería ABC                                     │
   │ Oct 22, 2024                                       │
   │                                                    │
   │ Amount: -$1,550.00 MXN                             │
   │ ⚠️  Adjusted from $1,500.00                        │
   │ [View Adjustment History]                          │
   │                                                    │
   │ Account: Santander Business                        │
   │ Counterparty: Ferretería ABC                       │
   │                                                    │
   │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
   │                                                    │
   │ Factura (CFDI)                                     │
   │ ✅ Factura attached                                │
   │                                                    │
   │ ┌──────────────────────────────────────────────┐  │
   │ │ 📄 factura_ferreteria_abc.xml                │  │
   │ │                                              │  │
   │ │ RFC: FER123456ABC                            │  │
   │ │ UUID: 98765432-9876-9876-9876-987654321098   │  │
   │ │ Issued: Oct 22, 2024                         │  │
   │ │ Amount: $1,550.00 MXN                        │  │
   │ │ Status: Valid ✅ (Amount adjusted)           │  │
   │ │                                              │  │
   │ │ [Download XML] [Download PDF] [Unlink]       │  │
   │ └──────────────────────────────────────────────┘  │
   ```

**Alternative Flow: Force Link Without Adjustment:**

4b. **User clicks "Force Link":**
   - Confirmation dialog appears:
     ```
     ┌────────────────────────────────────────────────────┐
     │ Force Link Factura                             [×] │
     ├────────────────────────────────────────────────────┤
     │                                                    │
     │ Link Factura despite amount mismatch?              │
     │                                                    │
     │ Transaction: $1,500.00 MXN                         │
     │ Factura:     $1,550.00 MXN                         │
     │ Variance:    +$50.00 (3.3%)                        │
     │                                                    │
     │ ⚠️  The transaction amount will NOT be changed.    │
     │    The variance will be logged for your records.   │
     │                                                    │
     │ Reason for variance:                               │
     │ [Optional explanation_____________________]        │
     │                                                    │
     │ [Cancel]                          [Force Link]     │
     └────────────────────────────────────────────────────┘
     ```
   - User types reason: "IVA included in Factura, not in bank"
   - Clicks "Force Link"
   - Factura linked with variance logged
   - Transaction amount unchanged ($1,500)

**Outcome:** User successfully resolved amount mismatch by adjusting transaction to match Factura. Adjustment history preserved for audit trail. Alternative: Force link without adjustment if user prefers.

**Duration:** ~2 minutes

---

## Wireframes

### Wireframe 1: TaxCategorySelector Dropdown (Hierarchical Display)

```
┌────────────────────────────────────────────────────────────────┐
│ Tax Category                                              [×]  │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│ Search categories...  [travel_______________] 🔍  [Clear]      │
│                                                                │
│ Jurisdiction: [USA Federal ▼]                                  │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ SEARCH RESULTS (4)                                             │
│                                                                │
│ ▾ Travel (Line 24a)                              100%  [?]    │
│   │                                                            │
│   ├─ Air Travel                                  100%  [?]    │
│   │  ⓘ Flights, airline fees, baggage charges                 │
│   │  [Select]                                                 │
│   │                                                            │
│   ├─ Ground Transportation ←─────────────────┐   100%  [?]    │
│   │  ⓘ Taxis, rideshare (Uber/Lyft),         │                │
│   │    rental cars, parking, tolls            │                │
│   │  [Select] ←─────────────── HIGHLIGHTED ───┘                │
│   │                                                            │
│   ├─ Lodging                                    100%  [?]    │
│   │  ⓘ Hotels, Airbnb, business travel lodging               │
│   │  [Select]                                                 │
│   │                                                            │
│   └─ Other Travel Expenses                      100%  [?]    │
│      ⓘ Meals while traveling, tips, misc expenses             │
│      [Select]                                                 │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ LEGEND:                                                        │
│ 100% = Fully deductible    50% = Partially deductible         │
│ 0% = Not deductible        [?] = View IRS guidelines          │
│                                                                │
│ [Cancel]                                                       │
└────────────────────────────────────────────────────────────────┘

INTERACTION NOTES:
- Search field: Live filter as user types (debounced 300ms)
- Category tree: Click parent to expand/collapse children
- Hover effect: Light blue background on category rows
- Deduction rate badge: Color-coded (green=100%, yellow=50%, gray=0%)
- [?] icon: Tooltip with IRS/SAT guidelines for category
- Keyboard: Tab through categories, Enter to select, Escape to close
- Screen reader: "Ground Transportation, child of Travel, 100% deductible"

RESPONSIVE DESIGN:
- Desktop: Fixed width 600px, max height 70vh, scrollable
- Tablet: Full width minus 32px margin
- Mobile: Full screen modal with native scroll

EMPTY STATE:
If search returns no results:
┌────────────────────────────────────────────────┐
│ No categories match "xyz"                      │
│                                                │
│ Try:                                           │
│ • Different search terms                       │
│ • Check spelling                               │
│ • Browse all categories (clear search)         │
│                                                │
│ [Clear Search] [Create Custom Category]        │
└────────────────────────────────────────────────┘
```

---

### Wireframe 2: Auto-Suggestion Notification (Confidence Score)

```
┌────────────────────────────────────────────────────────────────┐
│ 💡 Tax Category Suggested                                 [×]  │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│ We found a likely tax category for your transaction           │
│ based on previous classifications.                             │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ TRANSACTION                                                    │
│ ┌──────────────────────────────────────────────────────────┐  │
│ │ Uber • -$28.00 • Oct 20, 2024                            │  │
│ │ Chase Business Credit                                    │  │
│ └──────────────────────────────────────────────────────────┘  │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ SUGGESTED CATEGORY                                             │
│ ┌──────────────────────────────────────────────────────────┐  │
│ │ ✅ Travel > Ground Transportation                        │  │
│ │ USA Federal • Schedule C Line 24a                        │  │
│ │ Deduction Rate: 100% (fully deductible)                  │  │
│ │                                                          │  │
│ │ CONFIDENCE SCORE                                         │  │
│ │ 95% ████████████████████░ Very High                      │  │
│ │                                                          │  │
│ │ ─────────────────────────────────────────────            │  │
│ │ WHY THIS SUGGESTION?                                     │  │
│ │ • 10 previous Uber transactions classified as Travel     │  │
│ │ • 100% accuracy (all Uber → Travel)                      │  │
│ │ • Same merchant pattern detected                         │  │
│ │ • Same account (Chase Business Credit)                   │  │
│ └──────────────────────────────────────────────────────────┘  │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ OPTIONS                                                        │
│                                                                │
│ ☐ Auto-apply this category for future Uber transactions       │
│   (no more suggestions - categorize automatically)            │
│                                                                │
│ ☐ Add classification notes                                    │
│   [Optional: reason for this classification_____________]      │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ [Reject Suggestion]                     [✓ Accept Category]   │
│                                                                │
└────────────────────────────────────────────────────────────────┘

VISUAL DESIGN:
- Confidence bar: Color gradient (red 0-50%, yellow 50-70%, green 70-100%)
- 95% = Very High, 80-94% = High, 70-79% = Medium, <70% = Low (not shown)
- Icon: 💡 for suggestions, ✅ for accepted, ❌ for rejected

INTERACTION:
- Auto-dismiss: Never (requires user action)
- Keyboard: Tab to buttons, Enter to accept, Escape to dismiss (reject)
- Screen reader: "Tax category suggestion. Confidence: 95 percent, very high"

LOADING STATE:
While checking for suggestion:
┌────────────────────────────────────────────────┐
│ 💡 Checking for tax category suggestions...    │
│ [Spinner animation] Please wait               │
└────────────────────────────────────────────────┘
```

---

### Wireframe 3: Transaction Detail with Tax Classification Badge

```
┌────────────────────────────────────────────────────────────────┐
│ Transaction Details                                        [×] │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│ ┌──────────────────────────────────────────────────────────┐  │
│ │ TRANSACTION HEADER                                       │  │
│ │                                                          │  │
│ │ Uber                                                     │  │
│ │ Oct 15, 2024 • 2:45 PM                                   │  │
│ │                                                          │  │
│ │ -$42.50                ✅ 100% Deductible ←── BADGE      │  │
│ └──────────────────────────────────────────────────────────┘  │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ BASIC INFORMATION                                              │
│ Account:       Chase Business Credit                           │
│ Counterparty:  Uber                                            │
│ Status:        Cleared                                         │
│ Normalized:    Yes ✓                                           │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ TAX CLASSIFICATION                                             │
│                                                                │
│ ┌──────────────────────────────────────────────────────────┐  │
│ │ ✅ Travel > Ground Transportation                        │  │
│ │ USA Federal • Schedule C Line 24a                        │  │
│ │                                                          │  │
│ │ Deduction Rate:  100% (fully deductible)                 │  │
│ │ Deductible Amount: $42.50                                │  │
│ │                                                          │  │
│ │ Classification Notes:                                    │  │
│ │ Client meeting in downtown SF                            │  │
│ │                                                          │  │
│ │ ─────────────────────────────────────────────            │  │
│ │ Classified: Oct 15, 2024 3:45 PM                         │  │
│ │ Method: Manual                                           │  │
│ │ By: You                                                  │  │
│ │                                                          │  │
│ │ [Change Category] [Remove Classification]                │  │
│ └──────────────────────────────────────────────────────────┘  │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ FACTURA (CFDI)                                                 │
│ 📄 No Factura attached (USA transaction)                       │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ NOTES                                                          │
│ [Add additional notes about this transaction___________]       │
│                                                                │
└────────────────────────────────────────────────────────────────┘

BADGE VARIATIONS:
✅ 100% Deductible  (green background, white text)
⚠️  50% Deductible  (yellow background, dark text)
⭕ 0% Deductible    (gray background, dark text)
⚪ Not categorized  (white background, gray border, gray text)
💡 Suggested       (blue background, white text)

RESPONSIVE DESIGN:
- Desktop: Drawer 480px width, slides from right
- Tablet: Drawer 400px width
- Mobile: Full screen modal, slides from bottom

KEYBOARD NAVIGATION:
- Tab: Move between interactive elements
- Enter: Activate buttons
- Escape: Close drawer

SCREEN READER:
- Badge announces: "Tax classification: 100% deductible, Travel, Ground Transportation"
- Reads full path: "USA Federal, Schedule C Line 24a"
```

---

### Wireframe 4: TaxCategoryManager Tree View (System vs Custom)

```
┌────────────────────────────────────────────────────────────────┐
│ Tax Categories                             [+ New Category]    │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│ Search categories...  [____________] 🔍   [Clear]              │
│                                                                │
│ Jurisdiction: [All ▼]     Sort: [Alphabetical ▼]               │
│ ☐ Show archived categories                                     │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ ▾ USA FEDERAL - SCHEDULE C (25 categories) ─────────── 🔒     │
│   │                                                            │
│   ├─ ▸ Advertising (Line 8)                     100%  🔒      │
│   │                                                            │
│   ├─ ▸ Car and Truck Expenses (Line 9)          100%  🔒      │
│   │                                                            │
│   ├─ ▸ Legal and Professional (Line 17)         100%  🔒      │
│   │                                                            │
│   ├─ ▾ Meals (Business) (Line 24b)               50%  🔒      │
│   │   └─ Meals with Clients                      50%  🔒      │
│   │                                                            │
│   ├─ ▸ Office Expenses (Line 18)                100%  🔒      │
│   │                                                            │
│   ├─ ▾ Travel (Line 24a)                        100%  🔒      │
│   │   ├─ Air Travel                             100%  🔒      │
│   │   ├─ Ground Transportation                  100%  🔒      │
│   │   ├─ Lodging                                100%  🔒      │
│   │   └─ Other Travel Expenses                  100%  🔒      │
│   │                                                            │
│   └─ ▸ Utilities (Line 25)                      100%  🔒      │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ ▾ MEXICO FEDERAL - SAT (18 categories) ────────────── 🔒      │
│   │                                                            │
│   ├─ ▾ Gastos de Gestión                        100%  🔒      │
│   │   ├─ Publicidad y Promoción                 100%  🔒      │
│   │   ├─ Arrendamientos                         100%  🔒      │
│   │   ├─ Otros Gastos                           100%  🔒      │
│   │   └─ Gastos de Publicidad en Redes          100%  ✏️      │
│   │       Sociales (CUSTOM)                                    │
│   │       [Edit] [Archive]                                     │
│   │                                                            │
│   ├─ ▸ Gastos de Representación                  50%  🔒      │
│   │                                                            │
│   └─ ▸ Inversiones                              100%  🔒      │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ ▾ CUSTOM CATEGORIES (4) ──────────────────────────── ✏️       │
│   │                                                            │
│   ├─ Software Subscriptions (USA Federal)       100%  ✏️      │
│   │   12 transactions • Created Oct 1, 2024                    │
│   │   [Edit] [Archive] [View Transactions]                     │
│   │                                                            │
│   ├─ Client Gifts (USA Federal)                   0%  ✏️      │
│   │   3 transactions • Created Oct 5, 2024                     │
│   │   [Edit] [Archive] [View Transactions]                     │
│   │                                                            │
│   ├─ Gastos de Marketing Digital (Mexico)       100%  ✏️      │
│   │   8 transactions • Created Oct 10, 2024                    │
│   │   [Edit] [Archive] [View Transactions]                     │
│   │                                                            │
│   └─ Gastos de Publicidad en Redes (Mexico)     100%  ✏️      │
│       Sociales                                                 │
│       0 transactions • Created Oct 15, 2024                    │
│       [Edit] [Archive]                                         │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ LEGEND:                                                        │
│ 🔒 = System category (read-only)                               │
│ ✏️ = Custom category (editable)                                │
│ 100% = Fully deductible    50% = Partially    0% = Not        │
│                                                                │
└────────────────────────────────────────────────────────────────┘

INTERACTION:
- Click category name: Expand/collapse children
- Hover: Highlight row with light background
- System categories: No edit/delete buttons (read-only)
- Custom categories: Show edit/archive buttons
- Drag-and-drop: Reorder custom categories (not system)

KEYBOARD NAVIGATION:
- Arrow keys: Navigate tree
- Space: Expand/collapse category
- Enter: Edit selected custom category
- Delete: Archive selected custom category (with confirmation)

EMPTY STATE (no custom categories):
┌────────────────────────────────────────────────┐
│ No custom categories yet                       │
│                                                │
│ Create custom categories to track expenses     │
│ specific to your business needs.               │
│                                                │
│ [+ Create First Custom Category]               │
└────────────────────────────────────────────────┘
```

---

### Wireframe 5: Create Custom Category Modal

```
┌────────────────────────────────────────────────────────────────┐
│ Create Custom Tax Category                                [×] │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│ JURISDICTION *                                                 │
│ ⦿ USA Federal    ○ Mexico Federal                              │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ CATEGORY NAME *                                                │
│ [Social Media Advertising_____________________________]        │
│ ✅ Name available                                              │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ PARENT CATEGORY (optional)                                     │
│ [Select parent category ▼]                                     │
│ ⓘ Leave blank for top-level category, or nest under existing  │
│   category for better organization                             │
│                                                                │
│ Currently selected: Advertising (Schedule C Line 8)            │
│ Full path: USA Federal > Advertising > Social Media Ads        │
│                                                                │
│ [Clear Selection]                                              │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ SAT CODE (optional, Mexico only)                               │
│ [________] (8 digits)                                          │
│ ⓘ Official SAT product/service code for Mexican tax filings   │
│ (Grayed out for USA jurisdiction)                              │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ DEDUCTION RATE *                                               │
│ [Fully Deductible (100%) ▼]                                    │
│                                                                │
│ Options:                                                       │
│ • Fully Deductible (100%) ─ Most business expenses            │
│ • Partially Deductible (50%) ─ Business meals, entertainment  │
│ • Not Deductible (0%) ─ Personal expenses                     │
│ • Custom Percentage... ─ Specify exact percentage             │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ DESCRIPTION (optional)                                         │
│ [Expenses for social media advertising campaigns including     │
│  Facebook, Instagram, LinkedIn, Twitter, and other platforms]  │
│  ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━  │
│                                                                │
│ 180 characters remaining                                       │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ ⓘ Custom categories are visible only to you and can be        │
│   edited or archived at any time.                              │
│                                                                │
│ [Cancel]                                  [Create Category]    │
│                                                                │
└────────────────────────────────────────────────────────────────┘

VALIDATION STATES:

NAME FIELD - Available:
[Social Media Advertising_____________________________]
✅ Name available

NAME FIELD - Duplicate:
[Advertising_________________________________________]
❌ Name already exists in USA Federal
ⓘ Try: "Online Advertising" or "Digital Advertising"

NAME FIELD - Invalid:
[_________________________________________________]
❌ Category name is required

SAT CODE - Valid (Mexico):
[84111506]
✅ Valid SAT code format

SAT CODE - Invalid (Mexico):
[1234567]
❌ Invalid SAT code (must be 8 digits)

LOADING STATE (while creating):
┌────────────────────────────────────────────┐
│ Creating category...                       │
│ [Spinner] Please wait                      │
└────────────────────────────────────────────┘
```

---

### Wireframe 6: FacturaUploadDialog (Drag-Drop XML)

```
┌────────────────────────────────────────────────────────────────┐
│ Attach Factura (CFDI)                                      [×] │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│ TRANSACTION                                                    │
│ ┌──────────────────────────────────────────────────────────┐  │
│ │ La Casa del Sabor                                        │  │
│ │ Oct 18, 2024 • $500.00 MXN                               │  │
│ │ Santander Business                                       │  │
│ └──────────────────────────────────────────────────────────┘  │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ UPLOAD FACTURA XML                                             │
│                                                                │
│ ┌──────────────────────────────────────────────────────────┐  │
│ │                                                          │  │
│ │                         📄                               │  │
│ │                                                          │  │
│ │              Drag and drop XML file here                 │  │
│ │              or click to browse                          │  │
│ │                                                          │  │
│ │              Accepted: CFDI 3.3, CFDI 4.0 (.xml)         │  │
│ │              Max size: 5MB                               │  │
│ │                                                          │  │
│ │  [Drag state: Normal - gray border, white background]   │  │
│ └──────────────────────────────────────────────────────────┘  │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ ℹ️  WHAT'S A FACTURA?                                          │
│                                                                │
│ A Factura (CFDI - Comprobante Fiscal Digital por Internet)    │
│ is a Mexican tax receipt required by SAT for business          │
│ expense deductions. Request from merchants at time of          │
│ purchase.                                                      │
│                                                                │
│ [Learn more about Facturas →]                                  │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ [Cancel]                                                       │
│                                                                │
└────────────────────────────────────────────────────────────────┘

DRAG STATES:

1. DRAG ENTER (file dragged over drop zone):
│ ┌──────────────────────────────────────────────────────────┐  │
│ │                                                          │  │
│ │                         📄↓                              │  │
│ │                                                          │  │
│ │              Drop XML file here                          │  │
│ │                                                          │  │
│ │  [Blue border (3px), light blue background (#E3F2FD)]   │  │
│ └──────────────────────────────────────────────────────────┘  │

2. FILE SELECTED (via browse):
│ ┌──────────────────────────────────────────────────────────┐  │
│ │ 📄 factura_abc123.xml (4.2 KB)                           │  │
│ │                                                          │  │
│ │ [████████████████████] 100%                              │  │
│ │ Ready to upload                                          │  │
│ │                                                          │  │
│ │ [Change File] [Upload]                                   │  │
│ └──────────────────────────────────────────────────────────┘  │

3. UPLOADING:
│ ┌──────────────────────────────────────────────────────────┐  │
│ │ 📄 factura_abc123.xml (4.2 KB)                           │  │
│ │                                                          │  │
│ │ [███████░░░░░░░░░░░░░] 35%                               │  │
│ │ Uploading...                                             │  │
│ │                                                          │  │
│ │ [Cancel Upload]                                          │  │
│ └──────────────────────────────────────────────────────────┘  │

4. ERROR STATE:
│ ┌──────────────────────────────────────────────────────────┐  │
│ │ ❌ Upload failed                                         │  │
│ │                                                          │  │
│ │ Error: File too large (6.2 MB exceeds 5 MB limit)       │  │
│ │                                                          │  │
│ │ [Try Again]                                              │  │
│ └──────────────────────────────────────────────────────────┘  │

ACCESSIBILITY:
- Keyboard: Tab to drop zone, Space/Enter to open file picker
- Screen reader: "Factura upload area. Drag and drop XML file or press enter to browse"
- ARIA: role="button" aria-label="Upload Factura XML file"
```

---

### Wireframe 7: Factura Validation Feedback (RFC, UUID, Amount)

```
┌────────────────────────────────────────────────────────────────┐
│ Attach Factura (CFDI)                                      [×] │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│ TRANSACTION                                                    │
│ La Casa del Sabor • Oct 18, 2024 • $500.00 MXN                │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ VALIDATION RESULTS                                             │
│                                                                │
│ ┌──────────────────────────────────────────────────────────┐  │
│ │ 📄 factura_abc123.xml                                    │  │
│ │                                                          │  │
│ │ FACTURA DETAILS                                          │  │
│ │ RFC:    ABC123456XYZ                                     │  │
│ │ UUID:   12345678-1234-1234-1234-123456789012             │  │
│ │ Issued: Oct 18, 2024                                     │  │
│ │ Amount: $500.00 MXN                                      │  │
│ │                                                          │  │
│ │ ─────────────────────────────────────────────            │  │
│ │ VALIDATION STATUS                                        │  │
│ │                                                          │  │
│ │ ✅ XML Format Valid (CFDI 4.0)                           │  │
│ │ ✅ RFC Format Valid (13 characters)                      │  │
│ │ ✅ UUID Format Valid (UUIDv4)                            │  │
│ │ ✅ UUID Verified with SAT Database                       │  │
│ │ ✅ Amount Matches Transaction ($500.00)                  │  │
│ │ ✅ Date Within Window (same day)                         │  │
│ │ ✅ Digital Signature Valid (Sello Digital)               │  │
│ │                                                          │  │
│ │ ─────────────────────────────────────────────            │  │
│ │ STATUS: ✅ VALID - READY TO ATTACH                       │  │
│ └──────────────────────────────────────────────────────────┘  │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ [Cancel]                                  [Attach Factura]    │
│                                                                │
└────────────────────────────────────────────────────────────────┘

ERROR STATE (Multiple Issues):

│ ┌──────────────────────────────────────────────────────────┐  │
│ │ 📄 factura_invalid.xml                                   │  │
│ │                                                          │  │
│ │ FACTURA DETAILS                                          │  │
│ │ RFC:    INVALID123                                       │  │
│ │ UUID:   not-a-valid-uuid                                 │  │
│ │ Issued: Oct 25, 2024                                     │  │
│ │ Amount: $520.00 MXN                                      │  │
│ │                                                          │  │
│ │ ─────────────────────────────────────────────            │  │
│ │ VALIDATION STATUS                                        │  │
│ │                                                          │  │
│ │ ✅ XML Format Valid (CFDI 4.0)                           │  │
│ │ ❌ RFC Format Invalid                                    │  │
│ │    Expected: 12-13 alphanumeric characters               │  │
│ │    Found: "INVALID123" (10 characters)                   │  │
│ │ ❌ UUID Format Invalid                                   │  │
│ │    Expected: UUIDv4 format                               │  │
│ │    Found: "not-a-valid-uuid"                             │  │
│ │ ⚠️  UUID Not Verified with SAT                           │  │
│ │    (Skipped due to format error)                         │  │
│ │ ⚠️  Amount Mismatch                                      │  │
│ │    Transaction: $500.00 MXN                              │  │
│ │    Factura:     $520.00 MXN                              │  │
│ │    Variance:    +$20.00 (4%)                             │  │
│ │ ❌ Date Outside Window                                   │  │
│ │    Expected: Oct 18 ± 7 days (Oct 11-25)                │  │
│ │    Found: Oct 25 (7 days late)                           │  │
│ │ ⚠️  Digital Signature Not Verified                       │  │
│ │    (Skipped due to other errors)                         │  │
│ │                                                          │  │
│ │ ─────────────────────────────────────────────            │  │
│ │ STATUS: ❌ INVALID - CANNOT ATTACH                       │  │
│ │                                                          │  │
│ │ ⓘ Please verify this is a valid CFDI file from SAT.     │  │
│ └──────────────────────────────────────────────────────────┘  │
│                                                                │
│ [Cancel]                              [Try Another File]       │

WARNING STATE (Amount Mismatch within tolerance):

│ ┌──────────────────────────────────────────────────────────┐  │
│ │ 📄 factura_variance.xml                                  │  │
│ │                                                          │  │
│ │ VALIDATION STATUS                                        │  │
│ │                                                          │  │
│ │ ✅ XML Format Valid (CFDI 4.0)                           │  │
│ │ ✅ RFC Format Valid                                      │  │
│ │ ✅ UUID Verified with SAT                                │  │
│ │ ⚠️  Amount Mismatch (within tolerance)                   │  │
│ │    Transaction: $500.00 MXN                              │  │
│ │    Factura:     $520.00 MXN                              │  │
│ │    Variance:    +$20.00 (4%)                             │  │
│ │                                                          │  │
│ │ ⓘ Possible reasons:                                      │  │
│ │   • Tips included in Factura                             │  │
│ │   • Separate tax/fee charges                             │  │
│ │   • Partial payment (transaction split)                  │  │
│ │                                                          │  │
│ │ ─────────────────────────────────────────────            │  │
│ │ STATUS: ⚠️  VALID WITH WARNINGS                          │  │
│ └──────────────────────────────────────────────────────────┘  │
│                                                                │
│ [Cancel]  [Adjust Transaction]  [Force Link Anyway]            │
```

---

### Wireframe 8: Bulk Classification Dialog (Multi-Select)

```
┌────────────────────────────────────────────────────────────────┐
│ Bulk Classify Transactions                                 [×] │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│ You're about to classify 8 transactions                        │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ SELECTED TRANSACTIONS                                          │
│                                                                │
│ ┌──────────────────────────────────────────────────────────┐  │
│ │ Oct 23  Starbucks           -$5.75    [×]                │  │
│ │ Oct 21  Starbucks           -$4.25    [×]                │  │
│ │ Oct 19  Starbucks           -$6.50    [×]                │  │
│ │ Oct 18  Starbucks           -$5.00    [×]                │  │
│ │ Oct 16  Starbucks           -$7.25    [×]                │  │
│ │ Oct 14  Starbucks           -$4.75    [×]                │  │
│ │ Oct 12  Starbucks           -$5.50    [×]                │  │
│ │ Oct 10  Starbucks           -$6.00    [×]                │  │
│ │                                                          │  │
│ │ Total Amount: -$45.00                                    │  │
│ │ Date Range: Oct 10 - Oct 23, 2024                        │  │
│ │                                                          │  │
│ │ [×] = Remove from selection                              │  │
│ └──────────────────────────────────────────────────────────┘  │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ APPLY TAX CATEGORY                                             │
│                                                                │
│ Tax Category *                                                 │
│ [Meals (Business) • 50% deductible_______________] 🔍          │
│                                                                │
│ Jurisdiction: USA Federal (all transactions)                   │
│ ✅ All transactions are in the same jurisdiction               │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ CLASSIFICATION NOTES (optional)                                │
│                                                                │
│ [Client meetings at local Starbucks_____________________]      │
│ [_______________________________________________________]      │
│                                                                │
│ ⓘ These notes will be applied to all 8 transactions           │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ SUMMARY                                                        │
│                                                                │
│ Category: Meals (Business) • Schedule C Line 24b               │
│ Deduction Rate: 50% (partially deductible)                     │
│ Total Deductible: $22.50 (50% of $45.00)                      │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ [Cancel]                                  [Classify All 8 →]   │
│                                                                │
└────────────────────────────────────────────────────────────────┘

PROGRESS STATE (during classification):

┌────────────────────────────────────────────────────────────────┐
│ Classifying Transactions...                                    │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│ [████████████████████░░] 8 of 8 (100%)                         │
│                                                                │
│ ✅ Oct 23  Starbucks           -$5.75                          │
│ ✅ Oct 21  Starbucks           -$4.25                          │
│ ✅ Oct 19  Starbucks           -$6.50                          │
│ ✅ Oct 18  Starbucks           -$5.00                          │
│ ✅ Oct 16  Starbucks           -$7.25                          │
│ ✅ Oct 14  Starbucks           -$4.75                          │
│ ✅ Oct 12  Starbucks           -$5.50                          │
│ ✅ Oct 10  Starbucks           -$6.00                          │
│                                                                │
│ Processing complete! Closing in 2 seconds...                   │
│                                                                │
└────────────────────────────────────────────────────────────────┘

ERROR STATE (mixed jurisdictions):

│ ⚠️  VALIDATION ERROR                                           │
│                                                                │
│ Selected transactions have mixed jurisdictions:                │
│                                                                │
│ • 5 transactions: USA Federal                                  │
│ • 3 transactions: Mexico Federal                               │
│                                                                │
│ ⓘ You can only bulk classify transactions from the same       │
│   jurisdiction. Please select one group:                       │
│                                                                │
│ [Classify USA (5 transactions)]                                │
│ [Classify Mexico (3 transactions)]                             │
│ [Cancel]                                                       │
```

---

### Wireframe 9: Tax Summary Widget (Dashboard)

```
┌────────────────────────────────────────────────────────────────┐
│ Tax Summary - 2024                              [View Full →]  │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│ TOTAL DEDUCTIONS                                               │
│ ┌──────────────────────────────────────────────────────────┐  │
│ │ $42,850.00                                               │  │
│ │ 87% of transactions categorized                          │  │
│ └──────────────────────────────────────────────────────────┘  │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ BY JURISDICTION                                                │
│                                                                │
│ ┌──────────────────────────────────────────────────────────┐  │
│ │ 🇺🇸 USA Federal                           $38,200.00     │  │
│ │ Schedule C • 142 transactions                            │  │
│ │ [████████████████████████████░░] 89% categorized         │  │
│ └──────────────────────────────────────────────────────────┘  │
│                                                                │
│ ┌──────────────────────────────────────────────────────────┐  │
│ │ 🇲🇽 Mexico Federal                         $4,650.00     │  │
│ │ SAT • 23 transactions                                    │  │
│ │ [████████████████████░░░░░░░] 78% categorized            │  │
│ │ ⚠️  5 transactions missing Facturas                      │  │
│ └──────────────────────────────────────────────────────────┘  │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ TOP DEDUCTION CATEGORIES (USA)                                 │
│                                                                │
│ ┌──────────────────────────────────────────────────────────┐  │
│ │ 1. Travel                              $12,450.00   29%  │  │
│ │    [█████████████████████████████░░░░░░░░░░░░░░░░░░]     │  │
│ │    45 transactions • 100% deductible                     │  │
│ └──────────────────────────────────────────────────────────┘  │
│                                                                │
│ ┌──────────────────────────────────────────────────────────┐  │
│ │ 2. Office Expenses                      $8,920.00   21%  │  │
│ │    [█████████████████████░░░░░░░░░░░░░░░░░░░░░░░░░]     │  │
│ │    32 transactions • 100% deductible                     │  │
│ └──────────────────────────────────────────────────────────┘  │
│                                                                │
│ ┌──────────────────────────────────────────────────────────┐  │
│ │ 3. Meals (Business)                     $3,280.00    8%  │  │
│ │    [████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░]     │  │
│ │    28 transactions • 50% deductible ($1,640 actual)      │  │
│ └──────────────────────────────────────────────────────────┘  │
│                                                                │
│ ┌──────────────────────────────────────────────────────────┐  │
│ │ 4. Advertising                          $7,100.00   17%  │  │
│ │    [████████████████████░░░░░░░░░░░░░░░░░░░░░░░░░]     │  │
│ │    18 transactions • 100% deductible                     │  │
│ └──────────────────────────────────────────────────────────┘  │
│                                                                │
│ ┌──────────────────────────────────────────────────────────┐  │
│ │ 5. Utilities                            $6,450.00   15%  │  │
│ │    [███████████████░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░░]     │  │
│ │    19 transactions • 100% deductible                     │  │
│ └──────────────────────────────────────────────────────────┘  │
│                                                                │
│ [View All Categories →]                                        │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ UNCATEGORIZED TRANSACTIONS                                     │
│                                                                │
│ ⚠️  23 transactions not categorized ($3,120.00)                │
│ [Categorize Now →]                                             │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ ACTIONS                                                        │
│ [Export Tax Report] [View by Month] [Settings]                │
│                                                                │
└────────────────────────────────────────────────────────────────┘

INTERACTION:
- Click category: View all transactions in that category
- Click jurisdiction: Filter to USA or Mexico transactions
- Click "View Full": Navigate to detailed tax report page
- Hover bars: Tooltip with exact amounts and percentages

RESPONSIVE:
- Desktop: Full width widget (2 column layout)
- Tablet: Single column, stacked sections
- Mobile: Compact view with collapsible sections

EMPTY STATE (no categorized transactions):
┌────────────────────────────────────────────────┐
│ Tax Summary - 2024                             │
├────────────────────────────────────────────────┤
│                                                │
│ No transactions categorized yet                │
│                                                │
│ Start categorizing transactions to track       │
│ deductible expenses and maintain tax records.  │
│                                                │
│ [Categorize Transactions]                      │
│                                                │
└────────────────────────────────────────────────┘
```

---

### Wireframe 10: Multi-Jurisdiction Switching (USA ↔ Mexico)

```
┌────────────────────────────────────────────────────────────────┐
│ Transaction Details                                        [×] │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│ Amazon Web Services                                            │
│ Oct 22, 2024                                                   │
│                                                                │
│ Amount: -$89.50 USD                                            │
│ Account: Chase Business Credit (USA)                           │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ TAX CLASSIFICATION                                             │
│                                                                │
│ ⚪ Not categorized yet                                         │
│                                                                │
│ ┌──────────────────────────────────────────────────────────┐  │
│ │ JURISDICTION SELECTOR                                    │  │
│ │                                                          │  │
│ │ Primary Jurisdiction: [USA Federal ▼]                    │  │
│ │                                                          │  │
│ │ Auto-detected from account country                       │  │
│ │                                                          │  │
│ │ Available Jurisdictions:                                 │  │
│ │ ⦿ 🇺🇸 USA Federal (Schedule C)                           │  │
│ │ ○ 🇲🇽 Mexico Federal (SAT)                               │  │
│ │                                                          │  │
│ │ ⓘ Select jurisdiction to view appropriate tax           │  │
│ │   categories and compliance requirements                 │  │
│ └──────────────────────────────────────────────────────────┘  │
│                                                                │
│ [Categorize with USA Federal Categories]                       │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ FACTURA (CFDI)                                                 │
│ 📄 Not applicable (USA transaction)                            │
│                                                                │
└────────────────────────────────────────────────────────────────┘

SWITCHED TO MEXICO:

┌────────────────────────────────────────────────────────────────┐
│ Transaction Details                                        [×] │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│ Restaurante El Patio                                           │
│ Oct 22, 2024                                                   │
│                                                                │
│ Amount: -$850.00 MXN                                           │
│ Account: Santander Business (Mexico)                           │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ TAX CLASSIFICATION                                             │
│                                                                │
│ ⚪ Not categorized yet                                         │
│                                                                │
│ ┌──────────────────────────────────────────────────────────┐  │
│ │ JURISDICTION SELECTOR                                    │  │
│ │                                                          │  │
│ │ Primary Jurisdiction: [Mexico Federal ▼]                 │  │
│ │                                                          │  │
│ │ Auto-detected from account country                       │  │
│ │                                                          │  │
│ │ Available Jurisdictions:                                 │  │
│ │ ○ 🇺🇸 USA Federal (Schedule C)                           │  │
│ │ ⦿ 🇲🇽 Mexico Federal (SAT)                               │  │
│ │                                                          │  │
│ │ ⓘ Select jurisdiction to view appropriate tax           │  │
│ │   categories and compliance requirements                 │  │
│ └──────────────────────────────────────────────────────────┘  │
│                                                                │
│ [Categorize with Mexico SAT Categories]                        │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ FACTURA (CFDI)                                                 │
│ 📄 No Factura attached                                         │
│                                                                │
│ ℹ️  Factura required for SAT compliance                        │
│ [Attach Factura XML]                                           │
│                                                                │
└────────────────────────────────────────────────────────────────┘

CROSS-BORDER WARNING:

┌────────────────────────────────────────────────────────────────┐
│ Transaction Details                                        [×] │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│ Airbnb (Mexico City)                                           │
│ Oct 22, 2024                                                   │
│                                                                │
│ Amount: -$125.00 USD                                           │
│ Account: Chase Business Credit (USA)                           │
│                                                                │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                │
│ TAX CLASSIFICATION                                             │
│                                                                │
│ ⚪ Not categorized yet                                         │
│                                                                │
│ ┌──────────────────────────────────────────────────────────┐  │
│ │ JURISDICTION SELECTOR                                    │  │
│ │                                                          │  │
│ │ Primary Jurisdiction: [Mexico Federal ▼]                 │  │
│ │                                                          │  │
│ │ ⚠️  CROSS-BORDER TRANSACTION DETECTED                    │  │
│ │                                                          │  │
│ │ Account: USA (Chase Business Credit)                     │  │
│ │ Selected Jurisdiction: Mexico Federal                    │  │
│ │                                                          │  │
│ │ ⓘ This is a USA account transaction being classified    │  │
│ │   under Mexico tax law. This may affect tax filings.     │  │
│ │                                                          │  │
│ │ Recommended: Use USA Federal jurisdiction unless you     │  │
│ │ have specific cross-border tax requirements.             │  │
│ │                                                          │  │
│ │ [Switch to USA Federal] [Continue with Mexico]           │  │
│ └──────────────────────────────────────────────────────────┘  │
│                                                                │
└────────────────────────────────────────────────────────────────┘

INTERACTION:
- Jurisdiction auto-detected from account.country
- User can override jurisdiction (shows warning if mismatch)
- Category selector updates based on selected jurisdiction
- Factura fields shown/hidden based on jurisdiction (Mexico only)

KEYBOARD:
- Tab: Navigate jurisdiction options
- Arrow keys: Select jurisdiction
- Enter: Confirm selection
```

---

## Additional UX Considerations

### Loading States

**Category Selector Loading:**
```
┌────────────────────────────────────────────────┐
│ Tax Category                               [×] │
├────────────────────────────────────────────────┤
│                                                │
│ Loading categories...                          │
│ [Spinner animation]                            │
│                                                │
└────────────────────────────────────────────────┘
```

**Auto-Suggestion Checking:**
```
┌────────────────────────────────────────────────┐
│ 💡 Checking for suggestions...                 │
│ [Spinner] Please wait                          │
└────────────────────────────────────────────────┘
```

**Factura Validation Processing:**
```
┌────────────────────────────────────────────────┐
│ Validating Factura...                          │
│ [████████████░░░░░░░░] 60%                     │
│ ✅ XML parsed                                  │
│ ⏳ Validating with SAT...                      │
└────────────────────────────────────────────────┘
```

---

### Empty States

**No Custom Categories:**
```
┌────────────────────────────────────────────────┐
│              No custom categories              │
│                                                │
│         Create custom categories to            │
│      track expenses specific to your           │
│              business needs.                   │
│                                                │
│      [+ Create First Custom Category]          │
└────────────────────────────────────────────────┘
```

**No Uncategorized Transactions:**
```
┌────────────────────────────────────────────────┐
│              All caught up!                    │
│                                                │
│      All transactions are categorized.         │
│         Great work on maintaining              │
│           tax compliance records!              │
│                                                │
│          [View Tax Summary →]                  │
└────────────────────────────────────────────────┘
```

---

### Error States

**Network Error During Category Load:**
```
┌────────────────────────────────────────────────┐
│ ❌ Failed to load categories                   │
│                                                │
│ Unable to connect to server.                   │
│ Please check your internet connection.         │
│                                                │
│ [Retry] [Use Cached Categories]                │
└────────────────────────────────────────────────┘
```

**SAT Validation Service Down:**
```
┌────────────────────────────────────────────────┐
│ ⚠️  SAT validation service unavailable         │
│                                                │
│ Factura XML format validated successfully,     │
│ but unable to verify UUID with SAT database.   │
│                                                │
│ [Attach Anyway] [Try Again Later] [Cancel]     │
└────────────────────────────────────────────────┘
```

**Bulk Classification Partial Failure:**
```
┌────────────────────────────────────────────────┐
│ ⚠️  Partial Success                            │
│                                                │
│ ✅ 6 of 8 transactions classified              │
│ ❌ 2 transactions failed                       │
│                                                │
│ Failed transactions:                           │
│ • Oct 12 Starbucks -$5.50 (already classified) │
│ • Oct 10 Starbucks -$6.00 (transaction locked) │
│                                                │
│ [View Failed Transactions] [Done]              │
└────────────────────────────────────────────────┘
```

---

### Accessibility Features

**Screen Reader Announcements:**
- "Tax category selector opened. USA Federal Schedule C categories loaded. 25 categories available."
- "Auto-suggestion: Travel, Ground Transportation. Confidence 95%, very high."
- "Factura validation complete. All checks passed. Ready to attach."
- "Bulk classification: 8 of 8 transactions classified successfully."

**Keyboard Shortcuts:**
- `C`: Open category selector (when transaction detail focused)
- `F`: Attach Factura (Mexico transactions only)
- `Escape`: Close modal/drawer
- `Enter`: Confirm selection
- `Arrow keys`: Navigate lists and trees
- `Tab`: Move between fields
- `Space`: Expand/collapse tree nodes

**Focus Management:**
- Auto-focus on search field when category selector opens
- Return focus to trigger button when modal closes
- Trap focus within modal (Tab cycles through modal elements only)
- Clear focus indicators (2px blue outline on focused elements)

**Color Contrast:**
- All text meets WCAG AA standards (4.5:1 for normal, 3:1 for large)
- Badge colors: Green #059669 (100%), Yellow #D97706 (50%), Gray #6B7280 (0%)
- Error red: #DC2626, Warning yellow: #F59E0B, Success green: #10B981

**ARIA Labels:**
- `role="dialog"` for modals
- `aria-label="Tax category selector"` on dropdowns
- `aria-live="polite"` for success toasts
- `aria-live="assertive"` for error messages
- `aria-describedby` linking fields to help text

---

## Notes

**Design System Alignment:**
- Uses 8px grid system (padding/margin: 8px, 16px, 24px, 32px)
- Typography: System font stack (SF Pro, Segoe UI, Roboto)
- Headings: 24px (H1), 20px (H2), 16px (H3), 14px (body), 12px (small)
- Border radius: 8px (cards), 6px (buttons), 4px (inputs)
- Shadows: 0 1px 3px rgba(0,0,0,0.1) (cards), 0 4px 6px rgba(0,0,0,0.1) (modals)

**Performance:**
- Category selector: Lazy load custom categories (load on demand)
- Search: Debounce 300ms to avoid excessive filtering
- Bulk classification: Batch API calls (max 50 transactions per batch)
- Factura upload: Chunk large files (1MB chunks for files >5MB)

**Mobile Considerations:**
- Touch targets: Minimum 44x44px for all interactive elements
- Bottom sheets: Modals slide from bottom on mobile (<768px)
- Simplified bulk selection: Long-press to enter selection mode
- Sticky headers: Keep jurisdiction selector visible while scrolling

---

**File:** `/Users/darwinborges/Description/docs/ux-flows/3.4-tax-categorization-experience.md`
**Lines:** 1,232
**Status:** Complete with 6 user journeys, 10 wireframes, accessibility features, and responsive design notes.
