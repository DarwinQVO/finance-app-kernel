# UX Flow 3.5: Relationships Experience

> **Vertical:** 3.5 Relationships (Transaction-to-Transaction Linking)
> **Dependencies:** 1.3 Normalization (transactions must be normalized first), 3.1 Account Registry (validate account ownership), 3.2 Counterparty Registry (merchant patterns for detection)
> **User Story:** As a user, I want to link related transactions (transfers, FX conversions, reimbursements) so I can prevent double-counting in analytics, track currency exchanges, and understand money movement patterns.

---

## Introduction

### Feature Overview

The Relationships feature enables users to connect related transactions, solving critical financial tracking problems:

**Without Relationships:**
- Transfers appear as both expenses and income, inflating totals
- FX conversions lose exchange rate context
- Reimbursements appear disconnected from original expenses
- Analytics reports contain duplicate counts

**With Relationships:**
- Transfers automatically excluded from income/expense calculations
- FX conversion rates preserved with gain/loss tracking
- Reimbursements linked with clear audit trail
- Accurate financial reports with one-click exclusion toggle

### User Value Proposition

**Time Savings:**
- Auto-detection identifies 90%+ of transfers without manual work
- One-click acceptance of suggested links
- Batch detection runs on upload (zero wait time)

**Accuracy Gains:**
- Eliminate double-counting errors in dashboards
- Preserve historical FX rates for multi-currency reporting
- Track split expenses and reimbursements accurately

**Insight Generation:**
- Visualize transfer chains (BofA → Wise → Stripe)
- Compare actual vs. market FX rates
- Identify patterns in money movement

### Multi-Domain Applicability

This pattern applies universally to **paired record linking with confidence scoring**:

| Domain | Use Case | Relationship Types |
|--------|----------|-------------------|
| **Finance** | Transfer detection, FX tracking | transfer, fx_conversion, reimbursement, split |
| **Healthcare** | Claim-payment linking | claim_payment, referral, prescription_refill |
| **Legal** | Case relationships | parent_child, document_version, billing_payment |
| **Research** | Citation networks | cites, derived_from, replicates, extends |
| **E-commerce** | Order-return linking | return, refund, split_shipment, replacement |

---

## User Journeys

### Journey 1: Accept Auto-Detected Transfer (Happy Path)

**Context:** Sarah uploads her October Bank of America statement showing a $1,000 transfer to Wise. Later that day, she uploads her Wise statement showing the $1,000 deposit. The system auto-detects the transfer pair.

**User Goal:** Confirm the transfer relationship with minimal effort.

**Steps:**

1. **Background: Sarah uploads BofA statement** (2:00 PM)
   - Statement shows: "Oct 15 • Transfer to Wise • -$1,000"
   - System creates canonical transaction `txn_bofa_001`
   - TransferDetector runs but finds no matches (only one side exists)

2. **Sarah uploads Wise statement** (2:15 PM)
   - Statement shows: "Oct 15 • Deposit from Bank • +$1,000"
   - System creates canonical transaction `txn_wise_002`
   - TransferDetector runs automatically in background

3. **Auto-detection analysis** (takes ~150ms):
   ```
   Matching criteria:
   ✓ Same amount: $1,000 (perfect match)
   ✓ Opposite signs: - vs + (debit vs credit)
   ✓ Different accounts: BofA vs Wise
   ✓ Same user: Sarah
   ✓ Same date: Oct 15

   Confidence score: 95% (very high)
   → Create suggestion
   ```

4. **Sarah sees notification** (appears at top of screen):
   ```
   ┌─────────────────────────────────────────────────────────┐
   │ 🔗 Transfer Detected                                [×] │
   ├─────────────────────────────────────────────────────────┤
   │                                                         │
   │ We found a likely transfer between your accounts:       │
   │                                                         │
   │ From: BofA Checking        -$1,000  Oct 15, 2024       │
   │       "Transfer to Wise"                                │
   │                                                         │
   │ To:   Wise USD             +$1,000  Oct 15, 2024       │
   │       "Deposit from Bank"                               │
   │                                                         │
   │ Confidence: 95% ████████████████████░                   │
   │                                                         │
   │ Linking these transactions will:                        │
   │ • Exclude them from income/expense totals               │
   │ • Show them as a transfer in analytics                  │
   │                                                         │
   │ [Dismiss]                       [Link as Transfer]      │
   └─────────────────────────────────────────────────────────┘
   ```

5. **Sarah reviews the suggestion**:
   - Checks amounts: Both $1,000 ✓
   - Checks dates: Same day ✓
   - Checks accounts: BofA → Wise ✓
   - Thinks: "Yes, this is the same transfer"

6. **Sarah clicks "Link as Transfer"**:
   - Button shows loading spinner briefly
   - Notification dismisses with smooth slide-up animation
   - Success toast appears (top-right): "✓ Transfer linked"

7. **System creates relationship**:
   ```json
   {
     "relationship_id": "rel_001",
     "txn_1_id": "txn_bofa_001",
     "txn_2_id": "txn_wise_002",
     "type": "transfer",
     "confidence": 0.95,
     "detection_method": "auto",
     "linked_at": "2024-10-15T14:15:30Z"
   }
   ```

8. **Sarah views Transaction List**:
   ```
   ┌────────────────────────────────────────────────────────┐
   │ Recent Transactions                         [Filters ▼] │
   ├────────────────────────────────────────────────────────┤
   │                                                        │
   │ October 15, 2024                                       │
   │ ┌──────────────────────────────────────────────────┐  │
   │ │ 🔗 BofA Checking                    -$1,000.00   │  │
   │ │ Transfer to Wise                                 │  │
   │ │ Linked: Transfer to Wise USD                     │  │
   │ └──────────────────────────────────────────────────┘  │
   │                                                        │
   │ ┌──────────────────────────────────────────────────┐  │
   │ │ 🔗 Wise USD                         +$1,000.00   │  │
   │ │ Deposit from Bank                                │  │
   │ │ Linked: Transfer from BofA Checking              │  │
   │ └──────────────────────────────────────────────────┘  │
   └────────────────────────────────────────────────────────┘
   ```

9. **Sarah opens dashboard**:
   - October expenses: $3,240 (excludes $1,000 transfer) ✓
   - October income: $5,100 (excludes $1,000 transfer) ✓
   - Transfer widget shows: "Transfers this month: $1,000"

**Outcome:** Sarah successfully linked a transfer with one click. Analytics now exclude the transfer, preventing double-counting. Duration: ~30 seconds.

**Accessibility:**
- Screen reader: "Transfer detected notification. 95% confidence. Link as Transfer button."
- Keyboard: Tab to button, Enter to accept, Escape to dismiss
- High contrast: Orange notification border, clear white background

---

### Journey 2: Accept FX Conversion with Market Rate Comparison

**Context:** Marcus converts $1,000 USD to MXN in his Wise account, receiving $18,500 MXN. The system auto-detects the FX conversion and compares his rate to the market rate to show gain/loss.

**User Goal:** Confirm the FX conversion and understand if he got a good rate.

**Steps:**

1. **Background: Marcus uploads Wise statement** (showing both sides of conversion)
   ```
   Oct 16 • Convert to MXN   • -$1,000.00 USD
   Oct 16 • Converted from USD • +$18,500.00 MXN
   ```

2. **System creates both transactions**:
   - `txn_wise_usd_003`: -$1,000 USD
   - `txn_wise_mxn_004`: +$18,500 MXN

3. **Auto-detection runs** (FX mode):
   ```
   Matching criteria:
   ✓ Different currencies: USD vs MXN
   ✓ Same date: Oct 16
   ✓ Same institution: Wise
   ✓ Opposite signs: - vs +
   ✓ Same user

   Exchange rate calculated: 18,500 / 1,000 = 18.5 MXN/USD
   Market rate (fetched from API): 18.3 MXN/USD
   Variance: +1.1% (user got better rate)

   Confidence: 98% (very high)
   → Create FX suggestion
   ```

4. **Marcus sees notification**:
   ```
   ┌─────────────────────────────────────────────────────────┐
   │ 💱 FX Conversion Detected                           [×] │
   ├─────────────────────────────────────────────────────────┤
   │                                                         │
   │ Currency exchange identified:                           │
   │                                                         │
   │ From: Wise USD            -$1,000.00  Oct 16, 2024     │
   │ To:   Wise MXN           +$18,500.00  Oct 16, 2024     │
   │                                                         │
   │ Your Rate:     18.5 MXN/USD                            │
   │ Market Rate:   18.3 MXN/USD (Oct 16)                   │
   │ Difference:    +1.1% ✓ You got a better rate!          │
   │                                                         │
   │ Gain: +$200 MXN (~$10.93 USD)                          │
   │                                                         │
   │ Confidence: 98% ███████████████████▓                    │
   │                                                         │
   │ [Dismiss]                  [Link as FX Conversion]      │
   └─────────────────────────────────────────────────────────┘
   ```

5. **Marcus reviews FX details**:
   - Sees he got 18.5 rate vs 18.3 market (+1.1% better)
   - Gain: +$200 MXN (~$10.93 USD) shown in green
   - Thinks: "Nice! Wise gave me a good rate"

6. **Marcus clicks "Link as FX Conversion"**:
   - System creates relationship with FX details
   - Success toast: "✓ FX conversion linked"

7. **System stores FX relationship**:
   ```json
   {
     "relationship_id": "rel_002",
     "type": "fx_conversion",
     "confidence": 0.98,
     "fx_details": {
       "from_currency": "USD",
       "to_currency": "MXN",
       "from_amount": 1000.00,
       "to_amount": 18500.00,
       "exchange_rate": 18.5,
       "rate_source": "calculated",
       "market_rate": 18.3,
       "fx_gain_loss": 200.00
     }
   }
   ```

8. **Marcus opens transaction detail**:
   ```
   ┌─────────────────────────────────────────────────────────┐
   │ Transaction Detail                                  [×] │
   ├─────────────────────────────────────────────────────────┤
   │                                                         │
   │ Wise USD                                                │
   │ Oct 16, 2024                                            │
   │                                                         │
   │ Amount: -$1,000.00 USD                                  │
   │ Account: Wise USD                                       │
   │                                                         │
   │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
   │                                                         │
   │ 💱 FX Conversion                                        │
   │ ┌───────────────────────────────────────────────────┐  │
   │ │                                                   │  │
   │ │ Converted to: +$18,500.00 MXN                    │  │
   │ │ Oct 16, 2024                                      │  │
   │ │                                                   │  │
   │ │ Exchange Rate:  18.5 MXN/USD                     │  │
   │ │ Market Rate:    18.3 MXN/USD                     │  │
   │ │                                                   │  │
   │ │ FX Gain: +$200 MXN (~$10.93 USD) ✓               │  │
   │ │                                                   │  │
   │ │ [View MXN Transaction →]              [Unlink]   │  │
   │ └───────────────────────────────────────────────────┘  │
   │                                                         │
   └─────────────────────────────────────────────────────────┘
   ```

9. **Marcus views FX report** (Settings > Reports > FX Conversions):
   ```
   ┌────────────────────────────────────────────────────────┐
   │ FX Conversions - October 2024                          │
   ├────────────────────────────────────────────────────────┤
   │                                                        │
   │ Oct 16 • USD → MXN                                     │
   │ $1,000 USD → $18,500 MXN                              │
   │ Rate: 18.5 (Market: 18.3) • Gain: +$10.93            │
   │                                                        │
   │ Total FX Gain this month: +$10.93                     │
   └────────────────────────────────────────────────────────┘
   ```

**Outcome:** Marcus linked FX conversion and learned he got a favorable rate. System preserved exchange rate history and calculated gain. Duration: ~1 minute.

**Key Insight:** Showing market rate comparison adds educational value and helps users evaluate their FX providers.

---

### Journey 3: Manually Link Reimbursement (Different Amounts)

**Context:** Elena paid $47.32 for client dinner on her personal card. Two weeks later, her employer reimbursed her $50.00 (rounded up to nearest $5). Auto-detection missed this due to amount mismatch and time delay.

**User Goal:** Manually link the expense to reimbursement for complete audit trail.

**Steps:**

1. **Elena views Transaction List**:
   - Sees: "Oct 10 • Personal Visa • -$47.32 • Restaurant expense"
   - Sees: "Oct 24 • Business Checking • +$50.00 • Expense reimbursement"
   - No auto-suggestion appeared (too different: $47.32 vs $50, 14-day gap)

2. **Elena opens expense transaction detail**:
   ```
   ┌─────────────────────────────────────────────────────────┐
   │ Transaction Detail                                  [×] │
   ├─────────────────────────────────────────────────────────┤
   │                                                         │
   │ Restaurant - Client Dinner                              │
   │ Oct 10, 2024                                            │
   │                                                         │
   │ Amount: -$47.32                                         │
   │ Account: Personal Visa                                  │
   │ Counterparty: Restaurant Name                           │
   │                                                         │
   │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
   │                                                         │
   │ Relationships                                           │
   │ No linked transactions yet                              │
   │                                                         │
   │ [Link to Transaction]                                   │
   │                                                         │
   └─────────────────────────────────────────────────────────┘
   ```

3. **Elena clicks "Link to Transaction"**:
   - Manual link dialog opens
   - Focus auto-set on search field

4. **Link Transaction Dialog - Step 1: Search**:
   ```
   ┌─────────────────────────────────────────────────────────┐
   │ Link Transaction                                    [×] │
   ├─────────────────────────────────────────────────────────┤
   │                                                         │
   │ Current Transaction:                                    │
   │ Personal Visa • -$47.32 • Oct 10, 2024                 │
   │ "Restaurant - Client Dinner"                            │
   │                                                         │
   │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
   │                                                         │
   │ Link to Transaction:                                    │
   │ ┌─────────────────────────────────────────────────┐    │
   │ │ 🔍 Search by description, amount, or date...    │    │
   │ └─────────────────────────────────────────────────┘    │
   │                                                         │
   │ Recent Transactions:                                    │
   │ ○ Business Checking  +$50.00  Oct 24, 2024            │
   │   "Expense reimbursement"                              │
   │                                                         │
   │ ○ Personal Visa  -$125.00  Oct 22, 2024               │
   │   "Office supplies"                                     │
   │                                                         │
   │ ○ Business Checking  +$1,200.00  Oct 18, 2024         │
   │   "Client payment"                                      │
   │                                                         │
   │               [Cancel]  [Next: Select Type →]          │
   │                         (disabled until selection)     │
   └─────────────────────────────────────────────────────────┘
   ```

5. **Elena searches "reimbursement"**:
   ```
   │ ┌─────────────────────────────────────────────────┐    │
   │ │ 🔍 reimbursement                                │    │
   │ └─────────────────────────────────────────────────┘    │
   │                                                         │
   │ Search Results (1):                                     │
   │ ⦿ Business Checking  +$50.00  Oct 24, 2024            │
   │   "Expense reimbursement"                              │
   │   14 days after current transaction                    │
   ```

6. **Elena selects the reimbursement**:
   - Radio button fills
   - "Next" button becomes enabled
   - Clicks "Next: Select Type"

7. **Link Transaction Dialog - Step 2: Select Type**:
   ```
   ┌─────────────────────────────────────────────────────────┐
   │ Link Transaction                                    [×] │
   ├─────────────────────────────────────────────────────────┤
   │                                                         │
   │ Linking:                                                │
   │ Personal Visa • -$47.32 • Oct 10                       │
   │ ↕                                                       │
   │ Business Checking • +$50.00 • Oct 24                   │
   │                                                         │
   │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
   │                                                         │
   │ Relationship Type: *                                    │
   │                                                         │
   │ ⦿ Reimbursement                                        │
   │   Original expense reimbursed by employer/client        │
   │                                                         │
   │ ○ Transfer                                             │
   │   Money moved between your own accounts                 │
   │                                                         │
   │ ○ FX Conversion                                        │
   │   Currency exchange transaction                         │
   │                                                         │
   │ ○ Split                                                │
   │   Expense split across multiple accounts                │
   │                                                         │
   │ ○ Correction                                           │
   │   Adjustment or reversal of original charge             │
   │                                                         │
   │ ○ Other                                                │
   │   Custom relationship (requires note)                   │
   │                                                         │
   │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
   │                                                         │
   │ ⚠️ Amount Difference: +$2.68                           │
   │ This is expected for reimbursements with rounding.      │
   │                                                         │
   │ Notes (optional):                                       │
   │ ┌─────────────────────────────────────────────────┐    │
   │ │ Employer rounds reimbursements to nearest $5    │    │
   │ └─────────────────────────────────────────────────┘    │
   │                                                         │
   │        [← Back]  [Cancel]  [Create Link]               │
   └─────────────────────────────────────────────────────────┘
   ```

8. **Elena confirms details**:
   - Reimbursement type: Selected ✓
   - Amount warning: Acknowledged (expected rounding)
   - Notes: Added explanation
   - Clicks "Create Link"

9. **System creates manual relationship**:
   ```json
   {
     "relationship_id": "rel_003",
     "txn_1_id": "txn_personal_005",
     "txn_2_id": "txn_business_006",
     "type": "reimbursement",
     "confidence": null,
     "detection_method": "manual",
     "notes": "Employer rounds reimbursements to nearest $5",
     "linked_by": "user_elena",
     "linked_at": "2024-10-25T16:45:00Z"
   }
   ```

10. **Dialog closes, success toast shows**:
    - "✓ Reimbursement linked"
    - Both transaction cards update immediately

11. **Elena views updated transaction detail**:
    ```
    ┌─────────────────────────────────────────────────────────┐
    │ Transaction Detail: Personal Visa                   [×] │
    ├─────────────────────────────────────────────────────────┤
    │                                                         │
    │ Restaurant - Client Dinner                              │
    │ Oct 10, 2024 • -$47.32                                  │
    │                                                         │
    │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
    │                                                         │
    │ 💰 Reimbursement                                        │
    │ ┌───────────────────────────────────────────────────┐  │
    │ │                                                   │  │
    │ │ Reimbursed by: Business Checking                 │  │
    │ │ Oct 24, 2024 • +$50.00                           │  │
    │ │                                                   │  │
    │ │ Amount difference: +$2.68                        │  │
    │ │ Note: Employer rounds reimbursements to nearest $5│ │
    │ │                                                   │  │
    │ │ [View Reimbursement →]                [Unlink]   │  │
    │ └───────────────────────────────────────────────────┘  │
    │                                                         │
    └─────────────────────────────────────────────────────────┘
    ```

**Outcome:** Elena successfully linked reimbursement despite amount mismatch and time delay. Notes preserved context for future reference. Duration: ~2 minutes.

**Key Learning:** Manual linking handles edge cases auto-detection misses (different amounts, long delays, complex patterns).

---

### Journey 4: Handle Multiple Transfer Candidates

**Context:** David made three $100 payments on the same day. System detects multiple potential transfer matches and presents them for user selection.

**User Goal:** Identify the correct transfer pair among ambiguous matches.

**Steps:**

1. **Background: David's transactions (Oct 20)**:
   ```
   BofA Checking:  -$100  "Transfer out"
   Wise USD:       +$100  "Deposit"
   Chase Savings:  +$100  "Deposit"
   Venmo:          +$100  "Payment received"
   ```

2. **Auto-detection runs**:
   ```
   BofA -$100 could match:
   - Wise +$100 (confidence: 0.88)
   - Chase +$100 (confidence: 0.88)
   - Venmo +$100 (confidence: 0.75, lower due to different institution)

   → Multiple candidates found
   → Show selection UI (don't auto-suggest single option)
   ```

3. **David sees notification**:
   ```
   ┌─────────────────────────────────────────────────────────┐
   │ 🔗 Multiple Transfer Matches Found                  [×] │
   ├─────────────────────────────────────────────────────────┤
   │                                                         │
   │ We found several possible transfers for:                │
   │                                                         │
   │ BofA Checking • -$100 • Oct 20, 2024                   │
   │ "Transfer out"                                          │
   │                                                         │
   │ Could be linked to:                                     │
   │                                                         │
   │ ○ Wise USD         +$100  Oct 20, 2024  88% match     │
   │   "Deposit"                                             │
   │                                                         │
   │ ○ Chase Savings    +$100  Oct 20, 2024  88% match     │
   │   "Deposit"                                             │
   │                                                         │
   │ ○ Venmo            +$100  Oct 20, 2024  75% match     │
   │   "Payment received"                                    │
   │                                                         │
   │ ○ None of these (dismiss)                              │
   │                                                         │
   │ [Cancel]                         [Link Selected]        │
   └─────────────────────────────────────────────────────────┘
   ```

4. **David reviews candidates**:
   - Wise: 88% match - could be it
   - Chase: 88% match - also possible
   - Venmo: 75% match - probably not (this was client payment)
   - Thinks: "Let me check my Wise app..."

5. **David checks Wise app** (on phone):
   - Confirms: Oct 20 deposit from BofA
   - Returns to desktop app

6. **David selects Wise option**:
   - Clicks radio button next to "Wise USD"
   - "Link Selected" button becomes enabled
   - Clicks "Link Selected"

7. **System creates relationship**:
   ```json
   {
     "relationship_id": "rel_004",
     "txn_1_id": "txn_bofa_007",
     "txn_2_id": "txn_wise_008",
     "type": "transfer",
     "confidence": 0.88,
     "detection_method": "auto",
     "user_confirmed": true,
     "confirmation_method": "multiple_choice"
   }
   ```

8. **Success toast**: "✓ Transfer linked to Wise USD"

9. **Remaining candidates dismissed**:
   - Chase +$100 remains unlinked (possibly different transfer)
   - Venmo +$100 remains unlinked (client payment, not transfer)

**Outcome:** David successfully disambiguated multiple transfer candidates. Other transactions remain unlinked for potential future matching. Duration: ~45 seconds (plus external verification).

**Key Insight:** Multiple candidates require user decision. System presents options ranked by confidence but doesn't auto-guess.

---

### Journey 5: Unlink Transaction Relationship

**Context:** Amanda accidentally accepted a transfer suggestion that was incorrect. She needs to unlink the relationship.

**User Goal:** Remove incorrect relationship and restore transactions to independent state.

**Steps:**

1. **Amanda realizes mistake**:
   - Sees: "BofA Checking -$500 linked to Wise USD +$500"
   - But checking her statements: These are actually two different transactions
   - BofA: Payment to contractor
   - Wise: Client payment received
   - They just happen to be same amount, same day

2. **Amanda opens BofA transaction detail**:
   ```
   ┌─────────────────────────────────────────────────────────┐
   │ Transaction Detail                                  [×] │
   ├─────────────────────────────────────────────────────────┤
   │                                                         │
   │ BofA Checking                                           │
   │ Oct 18, 2024 • -$500.00                                 │
   │ "Payment to contractor"                                 │
   │                                                         │
   │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
   │                                                         │
   │ 🔗 Transfer Relationship                                │
   │ ┌───────────────────────────────────────────────────┐  │
   │ │                                                   │  │
   │ │ Linked to: Wise USD                              │  │
   │ │ Oct 18, 2024 • +$500.00                          │  │
   │ │ "Client payment"                                  │  │
   │ │                                                   │  │
   │ │ Confidence: 85% (auto-detected)                  │  │
   │ │ Linked: Oct 18, 2024 2:15 PM                     │  │
   │ │                                                   │  │
   │ │ [View Wise Transaction]               [Unlink]   │  │
   │ └───────────────────────────────────────────────────┘  │
   │                                                         │
   └─────────────────────────────────────────────────────────┘
   ```

3. **Amanda clicks "Unlink" button**:
   - Confirmation dialog appears (prevents accidental unlink)

4. **Unlink Confirmation Dialog**:
   ```
   ┌─────────────────────────────────────────────────────────┐
   │ Unlink Transfer?                                    [×] │
   ├─────────────────────────────────────────────────────────┤
   │                                                         │
   │ This will remove the transfer relationship between:     │
   │                                                         │
   │ • BofA Checking  -$500  Oct 18, 2024                   │
   │   "Payment to contractor"                               │
   │                                                         │
   │ • Wise USD       +$500  Oct 18, 2024                   │
   │   "Client payment"                                      │
   │                                                         │
   │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
   │                                                         │
   │ After unlinking:                                        │
   │ • Both transactions will be counted separately          │
   │   in income/expense analytics                           │
   │ • You can re-link them later if needed                  │
   │ • Unlink operation will be logged for audit             │
   │                                                         │
   │ Why are you unlinking? (optional)                       │
   │ ┌─────────────────────────────────────────────────┐    │
   │ │ These are different transactions, not a transfer│    │
   │ └─────────────────────────────────────────────────┘    │
   │                                                         │
   │        [Cancel]               [Unlink Transactions]     │
   └─────────────────────────────────────────────────────────┘
   ```

5. **Amanda adds note**: "These are different transactions, not a transfer"

6. **Amanda clicks "Unlink Transactions"**:
   - Button shows loading spinner briefly
   - Dialog closes
   - Success toast: "✓ Transfer unlinked"

7. **System soft-deletes relationship**:
   ```json
   {
     "relationship_id": "rel_005",
     "deleted_at": "2024-10-19T09:30:00Z",
     "deleted_by": "user_amanda",
     "deletion_reason": "These are different transactions, not a transfer"
   }
   ```

8. **Amanda views updated transaction detail**:
   ```
   ┌─────────────────────────────────────────────────────────┐
   │ Transaction Detail                                  [×] │
   ├─────────────────────────────────────────────────────────┤
   │                                                         │
   │ BofA Checking                                           │
   │ Oct 18, 2024 • -$500.00                                 │
   │ "Payment to contractor"                                 │
   │                                                         │
   │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
   │                                                         │
   │ Relationships                                           │
   │ No linked transactions                                  │
   │                                                         │
   │ [Link to Transaction]                                   │
   │                                                         │
   └─────────────────────────────────────────────────────────┘
   ```

9. **Amanda views dashboard**:
   - October expenses now include $500 contractor payment ✓
   - October income includes $500 client payment ✓
   - Analytics show accurate totals

**Outcome:** Amanda successfully unlinked incorrect relationship. Both transactions now counted separately in analytics. Audit trail preserved. Duration: ~1 minute.

**Key Learning:** Unlink operation is reversible through re-linking. Soft delete preserves history for compliance.

---

### Journey 6: View Linked Transactions in Detail

**Context:** James has a complex transfer chain (BofA → Wise USD → Wise MXN → Scotia) and wants to understand the complete flow.

**User Goal:** Visualize the transfer chain and see all linked relationships.

**Steps:**

1. **James opens BofA transaction** (origin of chain):
   ```
   ┌─────────────────────────────────────────────────────────┐
   │ Transaction Detail                                  [×] │
   ├─────────────────────────────────────────────────────────┤
   │                                                         │
   │ BofA Checking                                           │
   │ Oct 15, 2024 • -$1,000.00                               │
   │ "International transfer"                                │
   │                                                         │
   │ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
   │                                                         │
   │ 🔗 Transfer Chain (3 hops)                              │
   │ ┌───────────────────────────────────────────────────┐  │
   │ │                                                   │  │
   │ │ 1. BofA Checking → Wise USD                      │  │
   │ │    -$1,000 → +$1,000  Oct 15                     │  │
   │ │    Confidence: 95% (auto)                        │  │
   │ │                                                   │  │
   │ │ 2. Wise USD → Wise MXN                           │  │
   │ │    -$1,000 USD → +$18,500 MXN  Oct 16           │  │
   │ │    Rate: 18.5 MXN/USD (FX conversion)            │  │
   │ │    Confidence: 98% (auto)                        │  │
   │ │                                                   │  │
   │ │ 3. Wise MXN → Scotia MXN                         │  │
   │ │    -$18,500 → +$18,500  Oct 17                  │  │
   │ │    Confidence: 95% (auto)                        │  │
   │ │                                                   │  │
   │ │ [View Full Chain Diagram]                        │  │
   │ └───────────────────────────────────────────────────┘  │
   │                                                         │
   └─────────────────────────────────────────────────────────┘
   ```

2. **James clicks "View Full Chain Diagram"**:
   - Full-screen modal opens with visual flowchart

3. **Transfer Chain Visualization**:
   ```
   ┌─────────────────────────────────────────────────────────┐
   │ Transfer Chain: BofA → Wise USD → Wise MXN → Scotia[×]│
   ├─────────────────────────────────────────────────────────┤
   │                                                         │
   │     ┌──────────────┐                                    │
   │     │ BofA Checking│                                    │
   │     │  -$1,000.00  │                                    │
   │     │  Oct 15      │                                    │
   │     └──────┬───────┘                                    │
   │            │ Transfer (95%)                             │
   │            │ Same day                                   │
   │            ▼                                            │
   │     ┌──────────────┐                                    │
   │     │  Wise USD    │                                    │
   │     │  +$1,000.00  │                                    │
   │     │  Oct 15      │                                    │
   │     └──────┬───────┘                                    │
   │            │ FX Conversion (98%)                        │
   │            │ Rate: 18.5 MXN/USD                         │
   │            │ +1 day                                     │
   │            ▼                                            │
   │     ┌──────────────┐                                    │
   │     │  Wise MXN    │                                    │
   │     │ +$18,500.00  │                                    │
   │     │  Oct 16      │                                    │
   │     └──────┬───────┘                                    │
   │            │ Transfer (95%)                             │
   │            │ +1 day                                     │
   │            ▼                                            │
   │     ┌──────────────┐                                    │
   │     │ Scotia MXN   │                                    │
   │     │ +$18,500.00  │                                    │
   │     │  Oct 17      │                                    │
   │     └──────────────┘                                    │
   │                                                         │
   │ Summary:                                                │
   │ • Total transfers: 3                                    │
   │ • Total time: 2 days                                    │
   │ • FX conversions: 1 (USD → MXN)                        │
   │ • Final amount: $18,500 MXN (~$1,000 USD)              │
   │                                                         │
   │ [Export as PDF]  [Share]  [Close]                      │
   └─────────────────────────────────────────────────────────┘
   ```

4. **James clicks on "Wise USD → Wise MXN" node**:
   - FX conversion details expand inline

5. **Expanded FX Details**:
   ```
   │     ┌──────────────┐                                    │
   │     │  Wise USD    │                                    │
   │     │  -$1,000.00  │                                    │
   │     │  Oct 15      │                                    │
   │     └──────┬───────┘                                    │
   │            │                                            │
   │            │ 💱 FX Conversion Details:                  │
   │            │ ┌────────────────────────────────┐        │
   │            │ │ Rate: 18.5 MXN/USD            │        │
   │            │ │ Market: 18.3 MXN/USD          │        │
   │            │ │ Gain: +$200 MXN (~$10.93 USD) │        │
   │            │ │ Date: Oct 16, 2024 9:15 AM    │        │
   │            │ └────────────────────────────────┘        │
   │            ▼                                            │
   ```

6. **James exports chain as PDF**:
   - Clicks "Export as PDF"
   - PDF generates with full chain diagram + details
   - Saved: "Transfer_Chain_Oct15-17_2024.pdf"
   - Use case: Attach to tax filing as supporting documentation

**Outcome:** James visualized complete transfer chain with FX conversion details. Exported PDF for records. Duration: ~2 minutes.

**Key Insight:** Chain visualization helps users understand complex multi-hop transfers for compliance and record-keeping.

---

## Wireframes

### Wireframe 1: Transfer Suggestion Notification (Banner)

```
┌─────────────────────────────────────────────────────────────────┐
│ [App Header with logo and user menu]                           │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ ┌─────────────────────────────────────────────────────────┐    │
│ │ 🔗 Transfer Detected                                [×] │    │
│ ├─────────────────────────────────────────────────────────┤    │
│ │                                                         │    │
│ │ We found a likely transfer between your accounts:       │    │
│ │                                                         │    │
│ │ From: BofA Checking        -$1,000  Oct 15, 2024       │    │
│ │       "Transfer to Wise"                                │    │
│ │                                                         │    │
│ │ To:   Wise USD             +$1,000  Oct 15, 2024       │    │
│ │       "Deposit from Bank"                               │    │
│ │                                                         │    │
│ │ Confidence: 95% ████████████████████░                   │    │
│ │                                                         │    │
│ │ Linking these transactions will:                        │    │
│ │ • Exclude them from income/expense totals               │    │
│ │ • Show them as a transfer in analytics                  │    │
│ │                                                         │    │
│ │ [Dismiss]                       [Link as Transfer]      │    │
│ │ (gray button)                   (blue primary button)   │    │
│ └─────────────────────────────────────────────────────────┘    │
│                                                                 │
│ [Transaction List content below...]                            │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

Visual Specs:
- Background: White with subtle orange border-left (4px)
- Shadow: 0 2px 8px rgba(0,0,0,0.1)
- Position: Fixed top, below header
- Width: 600px max, centered
- Animation: Slide down from top (300ms ease-out)
- Auto-dismiss: After 30 seconds (if no interaction)
- Close button: X icon, top-right, gray on hover

Confidence Bar:
- Height: 8px
- Filled: Blue gradient (#0066CC → #0052A3)
- Empty: Light gray (#E5E5E5)
- Border-radius: 4px

Button Styles:
- Dismiss: Gray background (#F5F5F5), dark text, hover: #E5E5E5
- Link as Transfer: Blue (#0066CC), white text, hover: #0052A3
- Both: 16px padding vertical, 24px horizontal, border-radius: 6px
```

**Accessibility:**
- ARIA role: "alert"
- Screen reader: "Transfer detected notification. 95% confidence. BofA Checking to Wise USD. Link as Transfer button."
- Keyboard: Tab to focus buttons, Enter to activate, Escape to dismiss
- Focus indicator: 2px blue outline on focused element

---

### Wireframe 2: FX Conversion Suggestion with Rate Details

```
┌─────────────────────────────────────────────────────────────────┐
│ 💱 FX Conversion Detected                                   [×] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ Currency exchange identified:                                   │
│                                                                 │
│ ┌─────────────────────────────────────────────────────────┐    │
│ │ From: Wise USD            -$1,000.00  Oct 16, 2024     │    │
│ │       "Convert to MXN"                                  │    │
│ │                                                         │    │
│ │                         ↓                               │    │
│ │                                                         │    │
│ │ To:   Wise MXN           +$18,500.00  Oct 16, 2024     │    │
│ │       "Converted from USD"                              │    │
│ └─────────────────────────────────────────────────────────┘    │
│                                                                 │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                 │
│ Exchange Rate Comparison:                                       │
│                                                                 │
│ ┌─────────────────────────────────────────────────────────┐    │
│ │                                                         │    │
│ │ Your Rate:     18.5 MXN/USD                            │    │
│ │ Market Rate:   18.3 MXN/USD (Oct 16, 2024)             │    │
│ │                                                         │    │
│ │ ┌─────────────────────────────────────────────┐        │    │
│ │ │ 18.3        18.4        18.5 ★             │        │    │
│ │ │ ├─────────────┼───────────┼────────────┤   │        │    │
│ │ │ Market       Mid         Your Rate         │        │    │
│ │ └─────────────────────────────────────────────┘        │    │
│ │                                                         │    │
│ │ Difference:    +1.1% ✓                                 │    │
│ │ You got a better rate than the market average!          │    │
│ │                                                         │    │
│ │ FX Gain: +$200.00 MXN (~$10.93 USD)                    │    │
│ │                                                         │    │
│ └─────────────────────────────────────────────────────────┘    │
│                                                                 │
│ Confidence: 98% ███████████████████▓                            │
│                                                                 │
│ [Dismiss]                         [Link as FX Conversion]       │
└─────────────────────────────────────────────────────────────────┘

Visual Specs:
- FX icon: 💱 (currency exchange emoji) or custom SVG
- Rate comparison box: Light blue background (#F0F8FF)
- Gain indicator: Green text (#16A34A) with checkmark icon
- Rate visualization: Interactive slider showing position
- Market rate: Gray dot, Your rate: Blue star
- Scale: Linear from min to max rate (±5% from market)

Color Codes:
- Gain (positive): Green (#16A34A)
- Loss (negative): Red (#DC2626)
- Neutral: Gray (#6B7280)

Interaction:
- Hover on rate slider: Tooltip shows "You saved $10.93 vs market rate"
- Click "Learn More": Opens help article on FX rates
```

---

### Wireframe 3: Transaction Detail with Relationship Panel

```
┌─────────────────────────────────────────────────────────────────┐
│ Transaction Detail                                          [×] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ BofA Checking                                                   │
│ Oct 15, 2024 • 2:30 PM                                          │
│                                                                 │
│ Amount:        -$1,000.00                                       │
│ Account:       BofA Checking (...4567)                          │
│ Counterparty:  Wise Inc                                         │
│ Category:      Transfer (excluded from analytics)               │
│                                                                 │
│ Description:                                                    │
│ "Transfer to Wise for international payment"                    │
│                                                                 │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                 │
│ 🔗 Transfer Relationship                                        │
│                                                                 │
│ ┌───────────────────────────────────────────────────────────┐  │
│ │                                                           │  │
│ │ Linked to:                                                │  │
│ │                                                           │  │
│ │ ┌─────────────────────────────────────────────────────┐  │  │
│ │ │ Wise USD                                            │  │  │
│ │ │ Oct 15, 2024 • +$1,000.00                           │  │  │
│ │ │ "Deposit from BofA"                                 │  │  │
│ │ │                                                     │  │  │
│ │ │ [View Transaction →]                                │  │  │
│ │ └─────────────────────────────────────────────────────┘  │  │
│ │                                                           │  │
│ │ Relationship Type: Transfer                               │  │
│ │ Detection Method:  Auto-detected (95% confidence)         │  │
│ │ Linked:            Oct 15, 2024 2:35 PM (5 min ago)       │  │
│ │                                                           │  │
│ │ Analytics Impact:                                         │  │
│ │ ✓ Excluded from expense totals                            │  │
│ │ ✓ Shown in "Transfers" report                             │  │
│ │                                                           │  │
│ │ [Unlink]                                                  │  │
│ │ (gray text button)                                        │  │
│ │                                                           │  │
│ └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                 │
│ Notes:                                                          │
│ ┌───────────────────────────────────────────────────────────┐  │
│ │ Add notes about this transaction...                       │  │
│ └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│ [Edit Transaction]  [Delete Transaction]                       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

Visual Specs:
- Panel: Light gray background (#F9FAFB)
- Border: 1px solid #E5E7EB
- Border-radius: 8px
- Padding: 16px
- Linked transaction card: White background, subtle shadow
- Icon: 🔗 or custom SVG chain icon

Hover States:
- "View Transaction →": Underline, cursor pointer
- Unlink button: Red text (#DC2626) on hover
- Linked card: Slight shadow increase (0 2px 8px rgba(0,0,0,0.15))

States:
- No relationship: Show "No linked transactions" + "Link to Transaction" button
- Has relationship: Show relationship panel as above
- Multiple relationships: Stack multiple cards vertically
```

---

### Wireframe 4: Manual Link Dialog (Search Step)

```
┌─────────────────────────────────────────────────────────────────┐
│ Link Transaction                                            [×] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ Step 1 of 2: Select Transaction                                │
│ ●━━━━━━━━━━━━━━━○                                              │
│                                                                 │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                 │
│ Current Transaction:                                            │
│ ┌───────────────────────────────────────────────────────────┐  │
│ │ Personal Visa • -$47.32 • Oct 10, 2024                    │  │
│ │ "Restaurant - Client Dinner"                               │  │
│ └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│ Link to Transaction:                                            │
│ ┌───────────────────────────────────────────────────────────┐  │
│ │ 🔍 Search by description, amount, or date...              │  │
│ │                                              [Clear]       │  │
│ └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│ Filters:                                                        │
│ [Date Range: All ▼]  [Account: All ▼]  [Amount: Any ▼]        │
│                                                                 │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                 │
│ Recent Transactions:                                            │
│                                                                 │
│ ○ Business Checking      +$50.00      Oct 24, 2024            │
│   "Expense reimbursement"                                       │
│   14 days after current transaction                            │
│                                                                 │
│ ○ Personal Visa          -$125.00     Oct 22, 2024            │
│   "Office supplies"                                             │
│   12 days after current transaction                            │
│                                                                 │
│ ○ Business Checking      +$1,200.00   Oct 18, 2024            │
│   "Client payment received"                                     │
│   8 days after current transaction                             │
│                                                                 │
│ [Show 10 more transactions...]                                 │
│                                                                 │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                 │
│              [Cancel]  [Next: Select Type →]                    │
│                        (disabled until selection)              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

Visual Specs:
- Progress indicator: Two dots, filled = completed, outlined = current
- Search input: Large (48px height), prominent
- Clear button: Gray X icon, appears on input focus
- Filter dropdowns: Inline, compact (32px height)
- Transaction cards: Radio button on left, hover highlights full card
- Selected state: Blue background (#EBF5FF), blue radio button
- Relative time: Gray text (e.g., "14 days after")

Search Behavior:
- Debounced: 300ms delay after typing stops
- Searches: description, counterparty, amount, date
- Highlights: Bold matching text in results
- Empty state: "No transactions found. Try different search terms."

Keyboard Navigation:
- Arrow keys: Navigate transaction list
- Enter: Select highlighted transaction
- Tab: Move between search, filters, results
- Escape: Close dialog
```

---

### Wireframe 5: Manual Link Dialog (Preview Step)

```
┌─────────────────────────────────────────────────────────────────┐
│ Link Transaction                                            [×] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ Step 2 of 2: Select Relationship Type                          │
│ ●━━━━━━━━━━━━━━━●                                              │
│                                                                 │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                 │
│ Linking:                                                        │
│                                                                 │
│ ┌───────────────────────────────────────────────────────────┐  │
│ │ Personal Visa • -$47.32 • Oct 10                          │  │
│ │ "Restaurant - Client Dinner"                               │  │
│ └───────────────────────────────────────────────────────────┘  │
│                           ↕                                     │
│ ┌───────────────────────────────────────────────────────────┐  │
│ │ Business Checking • +$50.00 • Oct 24                      │  │
│ │ "Expense reimbursement"                                    │  │
│ └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                 │
│ Relationship Type: *                                            │
│                                                                 │
│ ┌───────────────────────────────────────────────────────────┐  │
│ │ ⦿ Reimbursement                                           │  │
│ │   Original expense reimbursed by employer/client          │  │
│ │                                                           │  │
│ │ ○ Transfer                                                │  │
│ │   Money moved between your own accounts                   │  │
│ │                                                           │  │
│ │ ○ FX Conversion                                           │  │
│ │   Currency exchange transaction                           │  │
│ │                                                           │  │
│ │ ○ Split                                                   │  │
│ │   Expense split across multiple accounts                  │  │
│ │                                                           │  │
│ │ ○ Correction                                              │  │
│ │   Adjustment or reversal of original charge               │  │
│ │                                                           │  │
│ │ ○ Other                                                   │  │
│ │   Custom relationship (requires note)                     │  │
│ └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│ ⚠️ Amount Difference: +$2.68                                   │
│ This is common for reimbursements with rounding policies.      │
│                                                                 │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                 │
│ Notes (optional):                                               │
│ ┌───────────────────────────────────────────────────────────┐  │
│ │ Employer rounds reimbursements to nearest $5              │  │
│ │                                                           │  │
│ │                                                           │  │
│ └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│       [← Back]  [Cancel]  [Create Link]                        │
│                           (blue primary button)                │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

Visual Specs:
- Transaction cards: White background, connected by double arrow (↕)
- Relationship type cards: Padded, hover: light blue background
- Selected type: Blue border-left (4px), blue radio button
- Warning banner: Light yellow background (#FEF3C7), amber text
- Notes textarea: 3 rows default, auto-expand, 500 char limit
- Back button: Gray, Cancel: Gray, Create Link: Blue

Validation:
- Type required: "Create Link" disabled until type selected
- Notes required for "Other" type
- Amount warning: Shows if >10% difference, not blocking

Type Descriptions:
- Hover on type: Tooltip with examples
- Example: "Reimbursement: Dinner expense → employer payment"
```

---

### Wireframe 6: Multiple Candidates Selection UI

```
┌─────────────────────────────────────────────────────────────────┐
│ 🔗 Multiple Transfer Matches Found                          [×] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ We found several possible transfers for:                        │
│                                                                 │
│ ┌───────────────────────────────────────────────────────────┐  │
│ │ BofA Checking • -$100.00 • Oct 20, 2024                   │  │
│ │ "Transfer out"                                             │  │
│ └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│ Could be linked to:                                             │
│                                                                 │
│ ┌───────────────────────────────────────────────────────────┐  │
│ │ ○ Wise USD              +$100.00      Oct 20, 2024        │  │
│ │   "Deposit from bank"                                      │  │
│ │   ┌─────────────────────────────────────────────────┐     │  │
│ │   │ Match Quality: 88%  ████████████████████░░      │     │  │
│ │   │ ✓ Same amount  ✓ Same date  ✓ Opposite signs  │     │  │
│ │   └─────────────────────────────────────────────────┘     │  │
│ └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│ ┌───────────────────────────────────────────────────────────┐  │
│ │ ○ Chase Savings         +$100.00      Oct 20, 2024        │  │
│ │   "Deposit"                                                │  │
│ │   ┌─────────────────────────────────────────────────┐     │  │
│ │   │ Match Quality: 88%  ████████████████████░░      │     │  │
│ │   │ ✓ Same amount  ✓ Same date  ✓ Opposite signs  │     │  │
│ │   └─────────────────────────────────────────────────┘     │  │
│ └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│ ┌───────────────────────────────────────────────────────────┐  │
│ │ ○ Venmo                 +$100.00      Oct 20, 2024        │  │
│ │   "Payment received"                                       │  │
│ │   ┌─────────────────────────────────────────────────┐     │  │
│ │   │ Match Quality: 75%  ███████████████░░░░░░       │     │  │
│ │   │ ✓ Same amount  ✓ Same date  ⚠️  Different bank │     │  │
│ │   └─────────────────────────────────────────────────┘     │  │
│ └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│ ┌───────────────────────────────────────────────────────────┐  │
│ │ ○ None of these (dismiss)                                 │  │
│ └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                 │
│ Need help deciding?                                             │
│ Check your bank statements or account history to confirm        │
│ which deposit matches this transfer.                            │
│                                                                 │
│ [Cancel]                                  [Link Selected]       │
│                                           (disabled until sel)  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

Visual Specs:
- Candidate cards: White background, blue border on hover
- Selected card: Blue background (#EBF5FF), blue border (2px)
- Match quality bar: Blue gradient, aligned right in collapse box
- Criteria checkmarks: Green (#16A34A), warnings: Amber (#F59E0B)
- Collapse box: Light gray background (#F9FAFB), expanded by default
- "None of these": Gray border, italic text

Match Quality Indicators:
- 90-100%: Excellent match (dark green)
- 80-89%: Good match (light green)
- 70-79%: Fair match (yellow)
- <70%: Weak match (gray)

Interaction:
- Click card: Select (radio button fills)
- Click match quality: Expand/collapse criteria
- Hover: Blue border, cursor pointer
- Keyboard: Arrow keys to navigate, Space to select
```

---

### Wireframe 7: Unlink Confirmation Dialog

```
┌─────────────────────────────────────────────────────────────────┐
│ Unlink Transfer?                                            [×] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ This will remove the transfer relationship between:             │
│                                                                 │
│ ┌───────────────────────────────────────────────────────────┐  │
│ │ • BofA Checking  -$500  Oct 18, 2024                      │  │
│ │   "Payment to contractor"                                  │  │
│ │                                                           │  │
│ │ • Wise USD       +$500  Oct 18, 2024                      │  │
│ │   "Client payment"                                         │  │
│ └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                 │
│ After unlinking:                                                │
│                                                                 │
│ ✓ Both transactions will be counted separately                 │
│   in income/expense analytics                                   │
│                                                                 │
│ ✓ You can re-link them later if needed                         │
│                                                                 │
│ ✓ Unlink operation will be logged for audit                    │
│                                                                 │
│ ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━ │
│                                                                 │
│ Why are you unlinking? (optional)                              │
│ This helps us improve auto-detection.                          │
│                                                                 │
│ ┌───────────────────────────────────────────────────────────┐  │
│ │ ○ These are different transactions, not a transfer        │  │
│ │ ○ Linked to wrong transaction by mistake                  │  │
│ │ ○ Want to link to a different transaction                 │  │
│ │ ○ Other reason (please specify below)                     │  │
│ └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│ Additional notes (optional):                                    │
│ ┌───────────────────────────────────────────────────────────┐  │
│ │                                                           │  │
│ │                                                           │  │
│ └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│       [Cancel]                       [Unlink Transactions]      │
│       (gray button)                  (red button)              │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

Visual Specs:
- Transaction cards: Light gray background (#F9FAFB)
- Checkmarks: Green (#16A34A), listed vertically
- Reason radio buttons: Single-select, blue when selected
- Notes textarea: 2 rows, 300 char limit, auto-expand
- Cancel button: Gray (#6B7280), hover: #4B5563
- Unlink button: Red (#DC2626), white text, hover: #B91C1C

Validation:
- No validation required (reason is optional)
- Unlink button always enabled
- If "Other reason" selected, notes textarea gets focus

Confirmation:
- Pressing Enter: Confirms unlink (dangerous action)
- Pressing Escape: Cancels dialog
- Focus trap: Tab cycles within dialog

Success State:
- Dialog closes with fade-out
- Success toast: "✓ Transfer unlinked"
- Transaction cards update immediately (remove relationship panel)
```

---

### Wireframe 8: Transfer Chain Visualization

```
┌─────────────────────────────────────────────────────────────────┐
│ Transfer Chain: BofA → Wise USD → Wise MXN → Scotia        [×] │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ ┌───────────────────────────────────────────────────────────┐  │
│ │                                                           │  │
│ │         ┌──────────────────────┐                         │  │
│ │         │   BofA Checking      │                         │  │
│ │         │   -$1,000.00 USD     │                         │  │
│ │         │   Oct 15, 2024       │                         │  │
│ │         │   2:30 PM            │                         │  │
│ │         └──────────┬───────────┘                         │  │
│ │                    │                                      │  │
│ │                    │ 🔗 Transfer                          │  │
│ │                    │ Confidence: 95%                      │  │
│ │                    │ Same day                             │  │
│ │                    │                                      │  │
│ │                    ▼                                      │  │
│ │         ┌──────────────────────┐                         │  │
│ │         │   Wise USD           │                         │  │
│ │         │   +$1,000.00 USD     │                         │  │
│ │         │   Oct 15, 2024       │                         │  │
│ │         │   2:30 PM            │                         │  │
│ │         └──────────┬───────────┘                         │  │
│ │                    │                                      │  │
│ │                    │ 💱 FX Conversion                     │  │
│ │                    │ Rate: 18.5 MXN/USD                   │  │
│ │                    │ Market: 18.3 MXN/USD                 │  │
│ │                    │ Gain: +$10.93 USD ✓                  │  │
│ │                    │ +1 day                               │  │
│ │                    │                                      │  │
│ │                    ▼                                      │  │
│ │         ┌──────────────────────┐                         │  │
│ │         │   Wise MXN           │                         │  │
│ │         │   +$18,500.00 MXN    │                         │  │
│ │         │   Oct 16, 2024       │                         │  │
│ │         │   9:15 AM            │                         │  │
│ │         └──────────┬───────────┘                         │  │
│ │                    │                                      │  │
│ │                    │ 🔗 Transfer                          │  │
│ │                    │ Confidence: 95%                      │  │
│ │                    │ +1 day                               │  │
│ │                    │                                      │  │
│ │                    ▼                                      │  │
│ │         ┌──────────────────────┐                         │  │
│ │         │   Scotia MXN         │                         │  │
│ │         │   +$18,500.00 MXN    │                         │  │
│ │         │   Oct 17, 2024       │                         │  │
│ │         │   11:00 AM           │                         │  │
│ │         └──────────────────────┘                         │  │
│ │                                                           │  │
│ └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│ Summary:                                                        │
│ ┌───────────────────────────────────────────────────────────┐  │
│ │ Total hops:         3 transfers                           │  │
│ │ Total time:         2 days                                │  │
│ │ FX conversions:     1 (USD → MXN)                         │  │
│ │ Starting amount:    $1,000.00 USD                         │  │
│ │ Final amount:       $18,500.00 MXN (~$1,008.93 USD)       │  │
│ │ Net gain:           +$8.93 USD (FX gain)                  │  │
│ └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│ [Export as PDF]  [Export as CSV]  [Share Link]  [Close]       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

Visual Specs:
- Chain area: Light blue background (#F0F8FF)
- Transaction boxes: White, rounded corners (8px), shadow
- Connectors: Blue lines (2px), with arrow heads
- Icons: 🔗 for transfer, 💱 for FX conversion
- FX details: Expandable, green text for gain
- Summary box: White background, border-top separator

Interaction:
- Click transaction box: Expand to show full details
- Click FX node: Expand to show rate comparison
- Hover connector: Highlight both connected transactions
- Zoom controls: +/- buttons for large chains

Export Options:
- PDF: Full visual diagram with summary
- CSV: Tabular data with all transaction details
- Share Link: Generate read-only link (expires in 7 days)
```

---

### Wireframe 9: Analytics Dashboard with "Exclude Transfers" Toggle

```
┌─────────────────────────────────────────────────────────────────┐
│ Financial Dashboard - October 2024                              │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│ ┌───────────────────────────────────────────────────────────┐  │
│ │ Analytics Settings                                        │  │
│ │                                                           │  │
│ │ ☑ Exclude transfers from income/expense calculations     │  │
│ │   (Recommended for accurate reporting)                    │  │
│ │                                                           │  │
│ │ [Learn More]                                              │  │
│ └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│ ┌─────────────────────────┬─────────────────────────────────┐  │
│ │ Total Income            │ Total Expenses                  │  │
│ │                         │                                 │  │
│ │ $5,100.00               │ $3,240.00                       │  │
│ │ ▲ 5.2% vs last month    │ ▼ 2.1% vs last month           │  │
│ │                         │                                 │  │
│ │ Transfers excluded: 2   │ Transfers excluded: 2           │  │
│ │ ($2,500 not counted)    │ ($2,500 not counted)            │  │
│ └─────────────────────────┴─────────────────────────────────┘  │
│                                                                 │
│ ┌───────────────────────────────────────────────────────────┐  │
│ │ Net Income                                                │  │
│ │                                                           │  │
│ │ +$1,860.00                                                │  │
│ │ ▲ 12.3% vs last month                                     │  │
│ │                                                           │  │
│ │ [View Details →]                                          │  │
│ └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│ ┌───────────────────────────────────────────────────────────┐  │
│ │ 📊 Spending by Category (Transfers Excluded)              │  │
│ │                                                           │  │
│ │ ████████████░░░ Groceries        $890  (27.5%)           │  │
│ │ ██████░░░░░░░░░ Dining Out       $540  (16.7%)           │  │
│ │ ████░░░░░░░░░░░ Utilities        $380  (11.7%)           │  │
│ │ ███░░░░░░░░░░░░ Transportation   $320  (9.9%)            │  │
│ │                                                           │  │
│ └───────────────────────────────────────────────────────────┘  │
│                                                                 │
│ ┌───────────────────────────────────────────────────────────┐  │
│ │ 🔗 Money Movement (Transfers & FX)                        │  │
│ │                                                           │  │
│ │ Transfers:          4 ($2,500 total)                      │  │
│ │ FX Conversions:     2 ($1,500 total)                      │  │
│ │ Total FX Gain:      +$18.45                               │  │
│ │                                                           │  │
│ │ [View Transfers Report →]                                 │  │
│ └───────────────────────────────────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘

Visual Specs:
- Toggle: Checkbox (checked by default), blue when enabled
- Excluded count: Gray text, smaller font, below main total
- Money Movement widget: Light blue background, separate section
- Trend indicators: Green ▲ (up), red ▼ (down), with percentage
- Learn More: Link, opens tooltip with explanation

Toggle Behavior:
- ON (default): Transfers excluded, shows accurate income/expense
- OFF: Transfers included, shows inflated totals (with warning)

Warning (when toggle OFF):
```
⚠️ Warning: Including transfers may double-count money movement.
   We recommend keeping this toggle ON for accurate reporting.
```

Interaction:
- Click toggle: Refresh dashboard with new data
- Hover "X transfers excluded": Tooltip listing excluded transactions
- Click "View Transfers Report": Navigate to detailed transfer list
```

---

### Wireframe 10: Mobile Transaction Detail with Relationship Card

```
┌─────────────────────────────────┐
│ ← Transaction Detail        ⋮   │ (Header: 56px)
├─────────────────────────────────┤
│                                 │
│ BofA Checking                   │
│ Oct 15, 2024 • 2:30 PM          │
│                                 │
│ -$1,000.00                      │ (Large: 32px font)
│                                 │
│ Account:    BofA Checking       │
│ Category:   Transfer            │
│                                 │
│ Description:                    │
│ Transfer to Wise for            │
│ international payment           │
│                                 │
│ ─────────────────────────────── │
│                                 │
│ 🔗 Transfer                     │
│                                 │
│ ┌─────────────────────────────┐ │
│ │ Linked to:                  │ │
│ │                             │ │
│ │ Wise USD                    │ │
│ │ +$1,000.00                  │ │
│ │ Oct 15, 2024                │ │
│ │                             │ │
│ │ [View Transaction →]        │ │
│ │                             │ │
│ │ Auto-detected (95%)         │ │
│ │ Excluded from analytics ✓   │ │
│ └─────────────────────────────┘ │
│                                 │
│ [Unlink]                        │ (Full-width button)
│                                 │
│ ─────────────────────────────── │
│                                 │
│ Notes                           │
│ ┌─────────────────────────────┐ │
│ │ Add notes...                │ │
│ └─────────────────────────────┘ │
│                                 │
│                                 │
│ [Edit Transaction]              │ (Full-width button)
│ [Delete Transaction]            │ (Full-width button, red)
│                                 │
└─────────────────────────────────┘

Visual Specs:
- Viewport: 375px width (iPhone SE)
- Font sizes: Amount: 32px, labels: 14px, values: 16px
- Relationship card: Light gray background (#F9FAFB)
- Card padding: 16px
- Button height: 48px (touch-friendly)
- Spacing: 16px between sections

Mobile Optimizations:
- Large touch targets: 48x48px minimum
- Swipe gestures: Swipe left on relationship card to reveal "Unlink" action
- Bottom sheet: Unlink confirmation slides up from bottom
- Sticky header: Header stays fixed on scroll
- Loading states: Skeleton screens during data fetch

Responsive Breakpoints:
- Mobile: <768px (single column, full-width cards)
- Tablet: 768-1024px (two columns, medium cards)
- Desktop: >1024px (as shown in earlier wireframes)
```

---

## Key Interactions

### Auto-Suggestion Appearance After Upload

**Trigger:** User uploads statement containing potential transfer/FX conversion

**Flow:**
1. User clicks "Upload Statement" → File picker opens
2. User selects file → Upload starts (progress bar)
3. File parsed → Observations created → Normalization runs
4. TransferDetector runs in background (async, ~150ms)
5. If candidate found with confidence ≥70%:
   - Notification appears at top of screen
   - Slide-down animation (300ms ease-out)
   - Auto-focuses "Link" button for keyboard users
6. If no candidates: No notification (silent)

**Timing:**
- Upload → Normalization: ~2-5 seconds (depending on file size)
- Normalization → Detection: ~150ms (background)
- Detection → Notification: Instant (real-time via WebSocket)

**User doesn't wait:**
- Can continue browsing while detection runs
- Notification appears when ready
- Multiple notifications stack vertically

---

### Click "Link as Transfer" to Accept

**Interaction:**
1. User clicks "Link as Transfer" button
2. Button state: "Link as Transfer" → Loading spinner → Disabled
3. API call: `POST /api/relationships` (payload: txn IDs, type, confidence)
4. Response time: ~100ms p95
5. Success:
   - Button: Checkmark icon (500ms)
   - Notification: Slide-up fade-out (300ms)
   - Toast: "✓ Transfer linked" (top-right, 3-second auto-dismiss)
   - Transaction cards: Update immediately (optimistic UI)
6. Error:
   - Button: Reset to "Link as Transfer"
   - Error toast: "Failed to link transfer. Try again." (red)

**Optimistic UI:**
- Relationship panel appears instantly (before API response)
- If API fails: Revert change + show error

**Keyboard:**
- Tab to button → Enter to activate
- Escape to dismiss notification

---

### Click "Dismiss" to Reject Suggestion

**Interaction:**
1. User clicks "Dismiss" button
2. Notification: Fade-out (200ms)
3. API call: `POST /api/relationships/dismiss` (log dismissal)
4. System: Don't re-suggest same pair for 30 days
5. Transaction remains unlinked

**Dismiss Tracking:**
```json
{
  "event": "suggestion_dismissed",
  "txn_1_id": "txn_001",
  "txn_2_id": "txn_002",
  "confidence": 0.95,
  "dismissed_at": "2024-10-15T14:30:00Z",
  "user_id": "user_darwin"
}
```

**User Intent:**
- Dismiss = "These are not related"
- System learns: Lower confidence for similar patterns

---

### Search for Transactions in Manual Link Dialog

**Interaction:**
1. User types in search field
2. Debounce: Wait 300ms after last keystroke
3. API call: `GET /api/transactions/search?q={query}&user_id={user_id}`
4. Results appear below (animated fade-in)
5. Highlight matching text in results (bold)

**Search Scope:**
- Transaction description
- Counterparty name
- Amount (exact or approximate)
- Date (flexible: "oct 15", "last week", "2024-10")
- Account name

**Example Queries:**
- "reimbursement" → Matches description
- "$50" → Matches amount ±$5
- "oct 24" → Matches date
- "wise" → Matches account or counterparty

**Empty State:**
```
No transactions found.

Try:
• Different search terms
• Adjusting date range filter
• Checking account filter
```

---

### Select Relationship Type (6 Types)

**Types:**

1. **Transfer**
   - Icon: 🔗
   - Use: Money moved between own accounts
   - Example: BofA → Wise
   - Analytics: Excluded from income/expense

2. **FX Conversion**
   - Icon: 💱
   - Use: Currency exchange
   - Example: USD → MXN
   - Analytics: Excluded, FX gain/loss tracked

3. **Reimbursement**
   - Icon: 💰
   - Use: Expense reimbursed later
   - Example: Personal expense → employer payment
   - Analytics: Both counted separately (expense + income)

4. **Split**
   - Icon: ✂️
   - Use: Expense split across accounts
   - Example: Dinner split 60/40 on two cards
   - Analytics: Can group as single expense (optional)

5. **Correction**
   - Icon: ↩️
   - Use: Adjustment or reversal
   - Example: Original charge → refund
   - Analytics: Can net to zero (optional)

6. **Other**
   - Icon: ❓
   - Use: Custom relationship
   - Example: Any edge case
   - Analytics: User-defined behavior
   - **Required:** Notes field must be filled

**Selection UI:**
- Radio buttons (single-select)
- Hover: Light blue background
- Selected: Blue border-left (4px), blue radio button
- Click anywhere on card to select

---

### Preview Link Before Creation

**Preview Screen:**
```
Linking:

[Transaction 1 Card]
      ↕
[Transaction 2 Card]

Type: [Selected Type]
Notes: [Optional Notes]

⚠️ Amount Difference: [If applicable]

[← Back] [Create Link]
```

**Validation:**
- Type required
- Notes required if type = "Other"
- Amount warning (informational, not blocking)

**User Can:**
- Review both transactions
- Change relationship type
- Add notes
- Go back to change transaction selection

---

### Unlink with Confirmation

**Flow:**
1. User clicks "Unlink" in relationship panel
2. Confirmation dialog appears (modal overlay)
3. User reviews consequences:
   - Both transactions counted separately in analytics
   - Can re-link later
   - Operation logged for audit
4. User optionally adds reason for unlinking
5. User clicks "Unlink Transactions" (red button)
6. Dialog closes, success toast appears
7. Relationship panel disappears from both transactions

**Soft Delete:**
- Relationship record: `deleted_at` timestamp set
- Not permanently deleted (audit trail)
- Can query deleted relationships: `include_deleted=true`

---

### Navigate Between Linked Transactions

**Methods:**

1. **Click "View Transaction →" button**
   - Opens linked transaction detail in same panel
   - Back button returns to origin transaction
   - Breadcrumb: "Transaction A > Transaction B"

2. **Click transaction card in relationship panel**
   - Same as above

3. **Navigate chain (for multi-hop transfers)**
   - Click "View Full Chain" → Opens chain visualization
   - Click any node in chain → Opens that transaction detail
   - Chain diagram stays accessible (sticky sidebar)

**Navigation States:**
- Origin transaction: Highlighted in chain
- Current transaction: Blue border
- Visited transactions: Gray background

---

## Edge Cases

### Amount Mismatch Warning (Fees)

**Scenario:** Transfer amounts differ due to fees

**Example:**
- BofA: -$1,000
- Wise: +$998 (Wise charged $2 fee)

**Detection:**
- Confidence: 80% (lower due to mismatch)
- Still auto-suggested (above 70% threshold)

**Warning UI:**
```
⚠️ Amount Mismatch: -$2.00

From: BofA  -$1,000.00
To:   Wise  +$998.00

This may be due to transfer fees.
Common for international transfers.

[Link Anyway] [Dismiss]
```

**User Actions:**
1. **Link Anyway** (most common)
   - Accept relationship with note about fee
   - Analytics: Both amounts excluded

2. **Dismiss**
   - Reject suggestion
   - User can manually create separate fee transaction (advanced)

**Threshold:**
- <2% difference: Show warning, allow link
- 2-5% difference: Show stronger warning, allow link
- >5% difference: Confidence <50%, don't auto-suggest

---

### Delayed Transfer Warning (>3 Days)

**Scenario:** Transfer takes longer than expected

**Example:**
- BofA: Oct 15 (-$1,000)
- Wise: Oct 19 (+$1,000) — 4-day delay

**Detection:**
- Confidence: 85% (lower due to delay)
- Still auto-suggested

**Warning UI:**
```
🕐 Delayed Transfer: 4 days

From: BofA Checking  Oct 15
To:   Wise USD       Oct 19

Longer than typical 1-2 day processing.
Common for international or weekend transfers.

[Link as Transfer] [Dismiss]
```

**Thresholds:**
- Same day: No warning (confidence: 95%)
- 1-2 days: No warning (confidence: 90%)
- 3-5 days: Show warning (confidence: 85%)
- 6-7 days: Show stronger warning (confidence: 75%)
- >7 days: Don't auto-suggest (confidence <50%)

---

### Multiple Candidates (Ambiguous Matches)

**Scenario:** Multiple transactions match criteria

**Example:**
- BofA: -$100
- Three $100 deposits same day (Wise, Chase, Venmo)

**System Behavior:**
- Show all candidates ranked by confidence
- User picks correct one (or "None")
- Don't auto-link without user confirmation

**Ranking Logic:**
```python
def rank_candidates(candidates):
    """Rank by confidence, then by institution match, then by time proximity"""
    return sorted(candidates, key=lambda c: (
        -c.confidence,  # Higher confidence first
        c.same_institution,  # Same bank/institution
        -abs(c.time_diff_minutes)  # Closer time
    ))
```

**UI Features:**
- Match quality percentage shown
- Criteria checkmarks visible
- "None of these" option
- Help text: "Check your statements to confirm"

---

### Already Linked Transaction Error

**Scenario:** User tries to link transaction that's already linked

**Example:**
- txn_001 already linked to txn_002
- User tries to link txn_001 to txn_003

**Error UI:**
```
❌ Cannot Link Transaction

This transaction is already linked:
• txn_001 (BofA Checking -$1,000)
  Existing: Transfer to Wise USD (rel_001)

You must unlink the existing relationship first.

[View Existing Link] [Cancel]
```

**User Actions:**
1. **View Existing Link**
   - Opens transaction detail showing current relationship
   - User can unlink if incorrect

2. **Cancel**
   - Close error dialog
   - Return to link dialog

**System Constraint:**
- One active relationship per transaction
- Prevents conflicting links
- Soft-deleted relationships don't block (can re-link)

---

### Chain Transfer Visualization

**Scenario:** Multiple linked transfers (BofA → Wise → Scotia)

**Detection:**
- Each pair linked independently
- System infers chain from linked pairs

**Chain Query:**
```python
def get_transfer_chain(start_txn_id):
    """Follow relationships to build transfer chain"""
    chain = [start_txn_id]
    current = start_txn_id

    while True:
        # Find next link
        rel = get_relationship_by_txn(current)
        if not rel:
            break

        # Add other transaction to chain
        next_txn = rel.txn_2_id if rel.txn_1_id == current else rel.txn_1_id
        chain.append(next_txn)
        current = next_txn

        # Prevent infinite loops
        if len(chain) > 10:
            break

    return chain
```

**Visualization:**
- Vertical flowchart (mobile-friendly)
- Transaction boxes connected by arrows
- FX conversion nodes highlighted
- Summary stats at bottom

**Export Options:**
- PDF: Full diagram for records
- CSV: Tabular data for analysis
- Share link: Read-only view (expires 7 days)

---

### FX Rate Variance Warning (>10% from Market)

**Scenario:** User's FX rate significantly differs from market

**Example:**
- User rate: 18.5 MXN/USD
- Market rate: 16.5 MXN/USD
- Variance: +12.1% (too high, possible error)

**Warning UI:**
```
⚠️ Unusual Exchange Rate

Your Rate:    18.5 MXN/USD
Market Rate:  16.5 MXN/USD (Oct 16)
Variance:     +12.1%

This rate is significantly different from market average.
Please verify this FX conversion is correct.

Possible reasons:
• Premium service fee
• Data entry error
• Different conversion date

[Link Anyway] [Edit Amounts] [Dismiss]
```

**Thresholds:**
- <5% variance: No warning (normal spread)
- 5-10% variance: Info message (may be premium service)
- >10% variance: Warning (likely error)
- >25% variance: Error (almost certainly wrong)

**User Actions:**
1. **Link Anyway:** Accept despite variance
2. **Edit Amounts:** Go back to fix transaction amounts
3. **Dismiss:** Reject FX conversion link

---

## Multi-Domain Applicability

### Finance (This Implementation)

**Use Cases:**
- Transfer detection between accounts
- FX conversion with rate tracking
- Split expense linking
- Reimbursement reconciliation

**Relationship Types:**
- transfer, fx_conversion, reimbursement, split, correction, other

**Key Metrics:**
- Auto-detection accuracy: ≥90%
- False positive rate: <10%
- User acceptance rate: ≥70%

---

### Healthcare

**Use Cases:**
- Insurance claim ↔ payment linking
- Referral ↔ specialist visit
- Original prescription ↔ refill
- Test ↔ follow-up test

**Relationship Types:**
- claim_payment, referral, prescription_refill, test_followup

**Example:**
```
Claim Submitted:  -$500 (Oct 1)
Payment Received: +$450 (Nov 15) — 90% coverage

Relationship: claim_payment
Notes: "Insurance covered 90%, patient responsibility $50"
```

**Detection Logic:**
- Match claim ID in payment description
- Amount ±10% (coinsurance variance)
- Date window: 30-90 days
- Confidence scoring similar to finance

---

### Legal

**Use Cases:**
- Parent case ↔ child case
- Original brief ↔ amended brief
- Billing ↔ payment reconciliation
- Cross-references between cases

**Relationship Types:**
- parent_child, document_version, billing_payment, cross_reference

**Example:**
```
Parent Case: Smith v. Jones (case_001)
Child Case:  Smith v. Jones Corp (case_002)

Relationship: parent_child
Notes: "Filed child case after discovering corporate liability"
```

**Detection Logic:**
- Match case numbers in documents
- Same parties or related parties
- Similar filing dates
- Manual linking primary (less auto-detection)

---

### Research

**Use Cases:**
- Paper ↔ cited papers (citation network)
- Source dataset ↔ derived dataset
- Pilot study ↔ full study
- Replication studies

**Relationship Types:**
- cites, derived_from, replicates, extends

**Example:**
```
My Paper:    "Neural Networks for Finance" (paper_001)
Cited Paper: "Deep Learning Fundamentals" (paper_002)

Relationship: cites
Notes: "Cited in introduction, methodology section"
Confidence: 98% (auto-detected from bibliography)
```

**Detection Logic:**
- Parse bibliography for DOIs/titles
- Match against paper database
- Extract citation context
- High confidence (bibliography parsing is accurate)

---

### E-commerce

**Use Cases:**
- Order ↔ return
- Payment ↔ refund
- Order ↔ split shipments
- Original item ↔ replacement

**Relationship Types:**
- return, refund, split_shipment, replacement

**Example:**
```
Order:  Laptop ($1,200) — Oct 15
Return: Laptop ($1,200) — Oct 25

Relationship: return
Notes: "Dead pixels on arrival, full refund processed"
Refund: +$1,200 (Oct 27)
```

**Detection Logic:**
- Match order ID in return description
- Opposite amounts (order negative, refund positive)
- Date window: 30-90 days (return window)
- High confidence if order ID matches

---

## Success Metrics

### Auto-Detection Accuracy
- **Goal:** ≥90% precision (suggested links are correct)
- **Measure:** User accept rate on auto-suggestions
- **Calculation:** accepted_suggestions / total_suggestions
- **Target:** 90-95% acceptance rate

### Manual Link Volume
- **Goal:** <10% of transfers require manual linking
- **Measure:** manual_links / total_links ratio
- **Calculation:** manual_count / (auto_count + manual_count)
- **Target:** <10% manual intervention

### Analytics Correctness
- **Goal:** 100% of dashboards exclude transfers by default
- **Measure:** Default toggle state + no user reports of double-counting
- **Verification:** Automated tests + user feedback monitoring

### User Adoption
- **Goal:** ≥70% of eligible transaction pairs linked within 7 days
- **Measure:** linked_pairs / detected_pairs ratio (7-day window)
- **Calculation:** Cohort analysis of new transactions

### Performance
- **Goal:** p95 latencies within targets
- **Targets:**
  - Auto-detect on upload: <200ms
  - Manual link creation: <150ms
  - Relationship query: <50ms
  - Analytics exclusion: <300ms
- **Measure:** Server-side instrumentation (Prometheus/Grafana)

### Confidence Calibration
- **Goal:** Confidence scores accurately predict user acceptance
- **Measure:** Acceptance rate by confidence band
- **Expected:**
  - 90-100% confidence → 95%+ acceptance
  - 80-89% confidence → 85%+ acceptance
  - 70-79% confidence → 70%+ acceptance
- **Calibration:** Adjust scoring algorithm quarterly

---

## Accessibility Compliance

### WCAG 2.2 Level AA Requirements

**Visual:**
- Color contrast: 4.5:1 for text, 3:1 for UI components
- Confidence bars: Blue gradient + percentage text (not color-only)
- Warning banners: Icon + text (not color-only)
- Focus indicators: 2px blue outline, 3:1 contrast

**Keyboard:**
- All interactions keyboard-accessible
- Tab order: Logical left-to-right, top-to-bottom
- Escape: Close dialogs/notifications
- Enter/Space: Activate buttons
- Arrow keys: Navigate lists (transaction selection)

**Screen Reader:**
- ARIA landmarks: role="alert" for notifications
- ARIA labels: "Transfer suggestion, 95% confidence"
- Live regions: Announce dynamic content (new suggestions)
- Button labels: "Link as Transfer" (not just "Link")
- Status messages: "✓ Transfer linked" announced

**Touch:**
- Touch targets: 48x48px minimum
- Swipe gestures: Swipe left to unlink (mobile)
- Pinch-to-zoom: Enabled for chain visualization
- No hover-only UI: All hover tooltips also tap-accessible

**Cognitive:**
- Clear language: "Transfer" not "Relationship Type A"
- Progressive disclosure: Step-by-step link creation
- Undo support: Unlink operation reversible
- Help text: Context-sensitive tooltips

---

## Mobile Responsive Design

### Breakpoints
- Mobile: <768px (single column)
- Tablet: 768-1024px (two columns)
- Desktop: >1024px (three columns)

### Mobile Optimizations

**Notification:**
- Full-width banner (16px margin)
- Stacks vertically if multiple
- Swipe-to-dismiss gesture
- 56px touch-friendly buttons

**Transaction Detail:**
- Single column layout
- Large font sizes (32px amount)
- Full-width buttons (48px height)
- Sticky header on scroll

**Link Dialog:**
- Bottom sheet (slides up from bottom)
- Two-step wizard with progress indicator
- Large search field (48px height)
- Easy tap targets for transaction cards

**Chain Visualization:**
- Vertical flow (not horizontal)
- Pinch-to-zoom enabled
- Swipe to navigate nodes
- Export via share sheet (native OS)

---

## Performance Targets

### Latency (p95)
- Auto-detect on upload: <200ms
- Manual link creation: <150ms
- Relationship query: <50ms
- Analytics exclusion query: <300ms
- Chain visualization: <500ms

### Database Optimization
- Partial indexes on active relationships (WHERE deleted_at IS NULL)
- Composite indexes for analytics queries
- Query plan analysis for complex exclusion queries

### Caching Strategy
- Redis cache for relationship lookups (5-minute TTL)
- Invalidate on link/unlink operations
- Cache-aside pattern for read-heavy operations

### Background Processing
- Transfer detection: Async job (low priority)
- FX rate fetching: Batched (hourly)
- Analytics aggregation: Pre-computed (daily)

---

## Future Enhancements

### Phase 2: Advanced Features

**Bulk Link Operations:**
- Select multiple transaction pairs
- Bulk accept/reject suggestions
- CSV import for manual links

**Smart Suggestions:**
- ML-based pattern learning
- User-specific confidence thresholds
- Merchant-based auto-rules

**Enhanced Chain Visualization:**
- Interactive timeline view
- Sankey diagram for flow analysis
- Export to Excel with formatting

**Audit & Compliance:**
- Relationship change history viewer
- Compliance report generation (SOX, GDPR)
- Bulk export for tax filing

### Phase 3: Cross-Domain Expansion

**Healthcare Module:**
- Claim-payment reconciliation
- Insurance coverage tracking
- Provider network analysis

**Legal Module:**
- Case relationship mapping
- Document version control
- Time-billing reconciliation

**Research Module:**
- Citation network visualization
- Dataset lineage tracking
- Collaboration mapping

---

**Document Version:** 1.0
**Last Updated:** 2025-10-24
**Status:** ✅ Complete
**Dependencies:** Vertical 3.5 Relationships, UX Flow 3.3 Series Registry, UX Flow 3.4 Tax Categorization
