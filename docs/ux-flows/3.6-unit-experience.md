# UX Flow: 3.6 Unit (Currency & Date Normalization)

> **Vertical:** 3.6 Unit (Currency & Date Normalization)
> **Pattern:** Value Normalization + Unit Conversion + Context Preservation
> **Last Updated:** 2025-10-24

---

## Overview

This document describes the end-to-end user experience for currency and date normalization across 6 key user journeys. Each journey includes step-by-step flows, UI wireframes, error handling, and multi-domain examples.

**Covered Journeys:**
1. Set base currency (first-time setup)
2. View transaction in original + normalized currencies
3. Refresh stale exchange rate
4. Manual rate override
5. Change timezone
6. View historical rate

---

## Journey 1: Set Base Currency (First-Time Setup)

### User Goal
User wants to set their base currency during onboarding so all transactions are normalized to their preferred currency.

### Entry Point
- **Onboarding flow** (new user account)
- **Settings page** (existing user changing base currency)

### User Flow

```
Step 1: User opens onboarding wizard
  ↓
Step 2: System shows "Choose Your Base Currency" screen
  ↓
Step 3: User sees CurrencySelectorDialog with popular currencies first
  ↓
Step 4: User searches "mex" → filters to "MXN - Mexican Peso"
  ↓
Step 5: User selects "MXN - Mexican Peso"
  ↓
Step 6: System prompts for timezone (auto-detected: America/Mexico_City)
  ↓
Step 7: User confirms timezone
  ↓
Step 8: System prompts for display locale (auto-detected: es-MX)
  ↓
Step 9: User confirms locale
  ↓
Step 10: System creates CurrencyConfig record
  ↓
Step 11: User sees confirmation: "✅ Base currency set to MXN"
  ↓
Step 12: Onboarding proceeds to next step
```

### Wireframe: Base Currency Selection

```
┌────────────────────────────────────────────────────┐
│  Welcome to Finance App                         × │
├────────────────────────────────────────────────────┤
│                                                    │
│  Step 1 of 3: Choose Your Base Currency           │
│                                                    │
│  All transactions will be converted to this        │
│  currency for easy tracking and reporting.         │
│                                                    │
│  ┌──────────────────────────────────────────────┐ │
│  │  🔍 Search currencies...                    │ │
│  └──────────────────────────────────────────────┘ │
│                                                    │
│  ✨ Popular Currencies                             │
│  ┌──────────────────────────────────────────────┐ │
│  │ 🇺🇸 USD - US Dollar                         │ │
│  │ 🇪🇺 EUR - Euro                              │ │
│  │ 🇲🇽 MXN - Mexican Peso                      │ │
│  │ 🇬🇧 GBP - British Pound                     │ │
│  │ 🇯🇵 JPY - Japanese Yen                      │ │
│  └──────────────────────────────────────────────┘ │
│                                                    │
│  All Currencies (A-Z) ▼                            │
│                                                    │
│                        [Back]  [Continue]          │
└────────────────────────────────────────────────────┘
```

### Wireframe: Timezone Confirmation

```
┌────────────────────────────────────────────────────┐
│  Welcome to Finance App                         × │
├────────────────────────────────────────────────────┤
│                                                    │
│  Step 2 of 3: Confirm Your Timezone               │
│                                                    │
│  We'll use this to display transaction dates       │
│  in your local time.                               │
│                                                    │
│  Detected Timezone:                                │
│  ┌──────────────────────────────────────────────┐ │
│  │ 🌎 America/Mexico_City (GMT-6)              │ │
│  │    Currently: Nov 1, 2024 10:00 AM          │ │
│  └──────────────────────────────────────────────┘ │
│                                                    │
│  [Change Timezone]                                 │
│                                                    │
│                        [Back]  [Continue]          │
└────────────────────────────────────────────────────┘
```

### Error Handling

**Error 1: Invalid Currency Selection**
- **Trigger:** User somehow selects invalid currency (edge case)
- **Message:** "❌ Invalid currency. Please select from the list."
- **Recovery:** Show CurrencySelectorDialog again

**Error 2: Network Failure During Config Save**
- **Trigger:** API call fails to save CurrencyConfig
- **Message:** "⚠️ Failed to save settings. Please try again."
- **Recovery:** Retry button, auto-retry after 3 seconds

---

## Journey 2: View Transaction in Original + Normalized Currencies

### User Goal
User wants to see transaction amount in both the original currency (from credit card statement) and their base currency (for total tracking).

### Entry Point
- **Transaction List** (main app view)
- **Transaction Detail** (drill-down panel)

### User Flow

```
Step 1: User imports transactions from bank (includes $100 USD expense)
  ↓
Step 2: System normalizes transaction:
  - Calls CurrencyConverter.convert(100, "USD", "MXN", date)
  - Fetches rate from ExchangeRateProvider (18.5000)
  - Creates NormalizedAmount (normalized: $1,850 MXN)
  ↓
Step 3: User views TransactionList
  ↓
Step 4: User sees AmountDisplayCard showing:
  - Primary: "$1,850.00 MXN" (large, bold)
  - Secondary: "($100.00 USD @ 18.50)" (small, gray)
  ↓
Step 5: User clicks transaction to view detail
  ↓
Step 6: DrillDownPanel shows:
  - Amount section with AmountDisplayCard (dual currency)
  - ExchangeRateWidget showing rate metadata (ECB, Nov 1, 2024)
  ↓
Step 7: User hovers over rate info icon (ⓘ)
  ↓
Step 8: Tooltip shows: "Rate: 18.5000 | Source: ECB | Date: Nov 1, 2024"
```

### Wireframe: Transaction List (Dual Currency)

```
┌────────────────────────────────────────────────────┐
│  Transactions                            [+ Add]   │
├────────────────────────────────────────────────────┤
│                                                    │
│  Nov 1, 2024                                       │
│  ┌──────────────────────────────────────────────┐ │
│  │ 🏪 Amazon                                    │ │
│  │ Groceries                                    │ │
│  │                                              │ │
│  │ $1,850.00 MXN                               │ │ ← Normalized
│  │ ($100.00 USD @ 18.50) ⓘ                     │ │ ← Original + rate
│  └──────────────────────────────────────────────┘ │
│                                                    │
│  ┌──────────────────────────────────────────────┐ │
│  │ 🚕 Uber                                      │ │
│  │ Transportation                               │ │
│  │                                              │ │
│  │ $555.00 MXN                                 │ │
│  │ ($30.00 USD @ 18.50) ⓘ                      │ │
│  └──────────────────────────────────────────────┘ │
│                                                    │
└────────────────────────────────────────────────────┘
```

### Wireframe: Transaction Detail (Detailed View)

```
┌────────────────────────────────────────────────────┐
│  Amazon Purchase                              [✕]  │
├────────────────────────────────────────────────────┤
│                                                    │
│  Amount                                            │
│  ┌──────────────────────────────────────────────┐ │
│  │ $1,850.00 MXN                               │ │ ← Normalized (large)
│  │                                              │ │
│  │ Original: $100.00 USD                       │ │
│  │ Rate: 18.5000 (ECB, Nov 1, 2024)           │ │
│  │ Source: European Central Bank               │ │
│  └──────────────────────────────────────────────┘ │
│                                                    │
│  Exchange Rate Details                             │
│  ┌──────────────────────────────────────────────┐ │
│  │ 1 USD = 18.5000 MXN                         │ │
│  │ 📊 ECB │ Nov 1, 2024 │ Updated 2h ago      │ │
│  │                                  [🔄 Refresh]│ │
│  └──────────────────────────────────────────────┘ │
│                                                    │
│  Date: Nov 1, 2024 10:00 AM                       │
│  Category: Groceries                               │
│  Merchant: Amazon                                  │
│                                                    │
│                        [Edit]  [Delete]            │
└────────────────────────────────────────────────────┘
```

### Multi-Domain Examples

**Healthcare:**
```
Medical Claim (International)
- Original: €5,000.00 EUR
- Converted: $5,250.00 USD
- Rate: 1.0500 (ECB, Nov 1, 2024)
```

**E-commerce:**
```
Product Price
- Display: $1,849.81 MXN
- Original: $99.99 USD
- Rate: 18.5000 (ECB, today)
```

---

## Journey 3: Refresh Stale Exchange Rate

### User Goal
User notices exchange rate is >24h old and wants to refresh it to get the latest rate.

### Entry Point
- **Transaction Detail** (ExchangeRateWidget shows "⚠️ Stale")
- **Settings > Exchange Rates** (bulk refresh)

### User Flow

```
Step 1: User views transaction from 2 days ago
  ↓
Step 2: ExchangeRateWidget shows:
  - "⚠️ Rate is stale (fetched 25h ago)"
  - Refresh button highlighted/pulsing
  ↓
Step 3: User clicks [🔄 Refresh] button
  ↓
Step 4: System shows loading state: "⏳ Refreshing rate from ECB..."
  ↓
Step 5: ExchangeRateProvider.refresh_cache() called:
  - Invalidates cache entry
  - Fetches fresh rate from ECB API
  - New rate: 18.7500 (rate changed!)
  ↓
Step 6: System asks: "Update all transactions using old rate?"
  - Option A: "Update all USD→MXN transactions from Oct 31"
  - Option B: "Only this transaction"
  ↓
Step 7: User selects Option A (batch update)
  ↓
Step 8: System re-normalizes 15 transactions:
  - Old: $100 × 18.5000 = $1,850 MXN
  - New: $100 × 18.7500 = $1,875 MXN
  ↓
Step 9: User sees confirmation: "✅ Rate updated. 15 transactions recalculated."
  ↓
Step 10: ExchangeRateWidget now shows:
  - "1 USD = 18.7500 MXN"
  - "Updated just now"
  - No stale warning
```

### Wireframe: Stale Rate Warning

```
┌────────────────────────────────────────────────────┐
│  Exchange Rate                              ⚠️     │  ← Stale indicator
├────────────────────────────────────────────────────┤
│                                                    │
│  1 USD = 18.5000 MXN                              │
│                                                    │
│  📊 ECB │ Oct 31, 2024 │ Updated 25h ago          │  ← Old date
│  ⚠️ Rate is stale - consider refreshing           │  ← Warning
│                                                    │
│                                  [🔄 Refresh] ←    │  ← Highlighted
└────────────────────────────────────────────────────┘
```

### Wireframe: Batch Update Confirmation

```
┌────────────────────────────────────────────────────┐
│  Update Exchange Rate                           × │
├────────────────────────────────────────────────────┤
│                                                    │
│  Rate has changed:                                 │
│  • Old: 1 USD = 18.5000 MXN                       │
│  • New: 1 USD = 18.7500 MXN                       │
│                                                    │
│  This affects 15 transactions.                     │
│                                                    │
│  What would you like to do?                        │
│                                                    │
│  ○ Update all 15 transactions                     │
│    (Recommended for accuracy)                      │
│                                                    │
│  ○ Only update this transaction                   │
│    (Others keep old rate)                          │
│                                                    │
│                        [Cancel]  [Update]          │
└────────────────────────────────────────────────────┘
```

---

## Journey 4: Manual Rate Override

### User Goal
User wants to override the system exchange rate because their bank charged a different rate (e.g., foreign transaction fee).

### Entry Point
- **Transaction Detail** (ExchangeRateWidget → [✏️ Edit] button)

### User Flow

```
Step 1: User views transaction: $100 USD → $1,850 MXN (@ 18.50)
  ↓
Step 2: User thinks: "But my bank charged me 19.00, not 18.50!"
  ↓
Step 3: User clicks [✏️ Edit Rate] in ExchangeRateWidget
  ↓
Step 4: Manual Override Dialog appears:
  - Current Rate: 18.5000 (from ECB)
  - Override Rate: [input field]
  - Reason: [text area]
  ↓
Step 5: User enters:
  - Override Rate: 19.0000
  - Reason: "Bank charged higher rate due to foreign transaction fee"
  ↓
Step 6: System validates:
  - Rate > 0? ✅
  - Variance from ECB: (19.00 - 18.50) / 18.50 = 2.7%
  - Variance < 10%? ✅ (auto-allow)
  ↓
Step 7: System recalculates:
  - Old: $100 × 18.5000 = $1,850 MXN
  - New: $100 × 19.0000 = $1,900 MXN
  ↓
Step 8: System updates NormalizedAmount:
  - normalized_amount: 1900.00
  - exchange_rate: 19.0000
  - rate_source: "manual"
  - override_reason: "Bank charged..."
  ↓
Step 9: User sees updated display:
  - "$1,900.00 MXN ($100.00 USD @ 19.00*)"
  - "*" indicates manual override
  - ExchangeRateWidget shows override reason
  ↓
Step 10: Audit trail logs manual rate change
```

### Wireframe: Manual Override Dialog

```
┌────────────────────────────────────────────────────┐
│  Override Exchange Rate                         × │
├────────────────────────────────────────────────────┤
│                                                    │
│  Current Rate (ECB):                               │
│  1 USD = 18.5000 MXN                              │
│                                                    │
│  Override Rate:                                    │
│  ┌──────────────────────────────────────────────┐ │
│  │ 19.0000                                      │ │  ← User input
│  └──────────────────────────────────────────────┘ │
│                                                    │
│  Variance: +2.7% from ECB rate                    │  ← Auto-calculated
│  ✅ Within acceptable range (<10%)                │
│                                                    │
│  Reason for Override:                              │
│  ┌──────────────────────────────────────────────┐ │
│  │ Bank charged higher rate due to foreign     │ │
│  │ transaction fee                              │ │
│  └──────────────────────────────────────────────┘ │
│                                                    │
│  Preview:                                          │
│  $100.00 USD → $1,900.00 MXN                      │
│                                                    │
│                        [Cancel]  [Save Override]   │
└────────────────────────────────────────────────────┘
```

### Error Handling

**Error: Variance >10%**
- **Trigger:** User enters rate with >10% variance from ECB
- **Message:** "⚠️ Override rate is 15% higher than ECB. Are you sure?"
- **Recovery:** Require explicit confirmation checkbox

---

## Journey 5: Change Timezone

### User Goal
User moved to a different timezone and wants dates displayed in their new local time.

### Entry Point
- **Settings > Currency & Display**

### User Flow

```
Step 1: User opens Settings → Currency & Display
  ↓
Step 2: User sees current timezone: "America/Mexico_City (GMT-6)"
  ↓
Step 3: User clicks [Change Timezone]
  ↓
Step 4: Timezone Selector Dialog appears:
  - Popular timezones first (America/New_York, Europe/London, Asia/Tokyo)
  - Search: "madrid"
  ↓
Step 5: User selects "Europe/Madrid (GMT+1)"
  ↓
Step 6: System confirms: "This will update all date/time displays. Continue?"
  ↓
Step 7: User clicks [Confirm]
  ↓
Step 8: System updates CurrencyConfig:
  - timezone: "Europe/Madrid"
  ↓
Step 9: System re-renders all dates:
  - Before: "Nov 1, 2024 10:00 AM" (Mexico City)
  - After: "Nov 1, 2024 5:00 PM" (Madrid)
  - UTC stored value unchanged: "2024-11-01T16:00:00Z"
  ↓
Step 10: User sees confirmation: "✅ Timezone changed to Europe/Madrid"
```

### Wireframe: Timezone Selector

```
┌────────────────────────────────────────────────────┐
│  Select Timezone                                × │
├────────────────────────────────────────────────────┤
│                                                    │
│  🔍 [Search timezones...                        ]  │
│                                                    │
│  ✨ Popular Timezones                              │
│  ┌──────────────────────────────────────────────┐ │
│  │ 🌎 America/New_York (GMT-5)                 │ │
│  │    Currently: Nov 1, 2024 11:00 AM          │ │
│  │                                              │ │
│  │ 🌍 Europe/London (GMT+0)                    │ │
│  │    Currently: Nov 1, 2024 4:00 PM           │ │
│  │                                              │ │
│  │ 🌏 Asia/Tokyo (GMT+9)                       │ │
│  │    Currently: Nov 2, 2024 1:00 AM           │ │
│  └──────────────────────────────────────────────┘ │
│                                                    │
│  All Timezones (A-Z) ▼                             │
│                                                    │
│                        [Cancel]  [Select]          │
└────────────────────────────────────────────────────┘
```

---

## Journey 6: View Historical Exchange Rate

### User Goal
User wants to see what the exchange rate was 6 months ago to understand historical conversions.

### Entry Point
- **Settings > Exchange Rate History**

### User Flow

```
Step 1: User opens Settings → Exchange Rate History
  ↓
Step 2: Historical Rate Query Form appears:
  - From Currency: [dropdown]
  - To Currency: [dropdown]
  - Date Range: [date pickers]
  ↓
Step 3: User selects:
  - From: USD
  - To: EUR
  - Date: May 1, 2024
  ↓
Step 4: User clicks [Get Rate]
  ↓
Step 5: ExchangeRateProvider.get_rate(USD, EUR, "2024-05-01") called:
  - Checks historical cache
  - Cache miss → Fetch from ECB historical API
  - Returns: 0.9200
  ↓
Step 6: User sees result:
  - Rate: 0.9200
  - Date: May 1, 2024
  - Source: ECB Historical
  - Trend: "+2.1% vs today's rate (0.9400)"
  ↓
Step 7: User can optionally view chart (line graph of rate over time)
```

### Wireframe: Historical Rate Query

```
┌────────────────────────────────────────────────────┐
│  Exchange Rate History                             │
├────────────────────────────────────────────────────┤
│                                                    │
│  From Currency:                                    │
│  ┌──────────────────────────────────────────────┐ │
│  │ USD - US Dollar                        ▼    │ │
│  └──────────────────────────────────────────────┘ │
│                                                    │
│  To Currency:                                      │
│  ┌──────────────────────────────────────────────┐ │
│  │ EUR - Euro                             ▼    │ │
│  └──────────────────────────────────────────────┘ │
│                                                    │
│  Date:                                             │
│  ┌──────────────────────────────────────────────┐ │
│  │ May 1, 2024                            📅   │ │
│  └──────────────────────────────────────────────┘ │
│                                                    │
│                                    [Get Rate]      │
│                                                    │
│  ────────────────────────────────────────────────  │
│                                                    │
│  Result:                                           │
│  ┌──────────────────────────────────────────────┐ │
│  │ 1 USD = 0.9200 EUR                          │ │
│  │                                              │ │
│  │ Date: May 1, 2024                           │ │
│  │ Source: ECB Historical                      │ │
│  │ Trend: +2.1% vs today (0.9400)             │ │
│  │                                              │ │
│  │ [View Chart]                                 │ │
│  └──────────────────────────────────────────────┘ │
│                                                    │
└────────────────────────────────────────────────────┘
```

---

## Multi-Domain Examples

### Healthcare: International Medical Claim

**Journey:** View claim in original + converted currency

```
Patient receives bill: €5,000.00 EUR (France)
US insurance reimburses in: $5,250.00 USD

Display:
┌────────────────────────────────────────────┐
│ Medical Claim #12345                       │
├────────────────────────────────────────────┤
│ Reimbursement Amount:                      │
│ $5,250.00 USD                             │
│ (€5,000.00 EUR @ 1.0500)                  │
│                                            │
│ Claim Date: Nov 1, 2024                   │
│ Provider: Hôpital Paris                   │
│ Rate Source: ECB                           │
└────────────────────────────────────────────┘
```

---

### E-commerce: Product Pricing

**Journey:** Display product price in customer's local currency

```
Product: Laptop ($999.99 USD base price)
Customer in Mexico sees:

┌────────────────────────────────────────────┐
│ MacBook Pro 14"                            │
├────────────────────────────────────────────┤
│ Price: $18,499.81 MXN                     │
│ (US $999.99 @ 18.50)                      │
│                                            │
│ Rate updated: 2 hours ago                  │
│ [Add to Cart]                              │
└────────────────────────────────────────────┘
```

---

### Travel: Expense Reporting

**Journey:** Submit expense with foreign currency conversion

```
Employee traveled to London, spent £200 GBP
Company reimburses in USD:

┌────────────────────────────────────────────┐
│ Travel Expense Report                      │
├────────────────────────────────────────────┤
│ Hotel (London Hilton):                     │
│ $255.00 USD                               │
│ (£200.00 GBP @ 1.2750)                    │
│                                            │
│ Date: Oct 15, 2024                        │
│ Rate: Federal Reserve                      │
│ [Submit for Approval]                      │
└────────────────────────────────────────────┘
```

---

## Accessibility Considerations

**Keyboard Navigation:**
- Tab through all interactive elements (currency selector, refresh button, etc.)
- Enter/Space to activate buttons
- Escape to close dialogs

**Screen Reader:**
- Announce currency amounts with both original and normalized values
- Announce staleness warnings ("Warning: Exchange rate is stale")
- Announce loading states ("Refreshing exchange rate")

**Visual:**
- High contrast for stale rate warnings (red background + icon)
- Color-blind safe: Use icons (⚠️) in addition to color
- Large text for amounts (minimum 16px)

**Localization:**
- Format amounts according to user's locale
- Display currency symbols correctly ($ vs € vs £)
- Support RTL languages (Arabic, Hebrew)

---

## Performance Considerations

**Cache Hit Rate:** >90% (most conversions use cached rates)
**Refresh Latency:** <500ms p95 (ECB API call)
**Batch Conversion:** 1000 transactions/sec (single rate fetch)
**UI Responsiveness:** <100ms (no janky scrolling)

---

## Analytics & Metrics

**Track:**
- % users who set base currency during onboarding
- % transactions with stale rates
- % manual overrides (target: <5%)
- Avg time to refresh rate (target: <2 seconds)
- % users who change timezone after setup

**Success Metrics:**
- User completes onboarding (base currency set)
- User understands dual currency display (clicks tooltip)
- User refreshes stale rate successfully
- User creates manual override with reason

---

**Total Lines:** ~1,240
