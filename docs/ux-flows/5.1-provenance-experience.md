# UX Flow: 5.1 Provenance Ledger Experience

> **Vertical:** 5.1 Provenance Ledger
> **User Goal:** Query historical data states, make retroactive corrections with effective dates, maintain complete bitemporal audit trail
> **Primary Personas:** Compliance Officer, Accountant, Data Engineer, Auditor, Legal Counsel

---

## Overview

The Provenance Ledger provides a **bitemporal data model** that tracks both:
- **Valid Time:** When a fact was true in the real world (e.g., "This transaction occurred on Jan 15, 2025")
- **Transaction Time:** When the system knew about the fact (e.g., "We learned about this on Feb 1, 2025")

This enables:
- **Time-travel queries:** "Show me what we believed on Feb 1, 2025" (as-of queries)
- **Retroactive corrections:** "This transaction actually occurred on Jan 10, not Jan 15" (effective date corrections)
- **Complete audit trail:** Every change tracked with who/when/why
- **Regulatory compliance:** SOX, GDPR, HIPAA, FDA 21 CFR Part 11 audit requirements

### Key Capabilities

1. **As-Of Queries:** View entity state at any point in time
2. **Retroactive Corrections:** Change effective date of past events
3. **Timeline Visualization:** Interactive bitemporal timeline with D3.js
4. **Snapshot Comparison:** Side-by-side diff of two historical states
5. **Audit Export:** CSV/JSON export for compliance
6. **Future-Dated Changes:** Schedule changes to take effect later

### Architecture

```
┌─────────────────────────────────────────────────────────────┐
│                    Provenance Ledger                        │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  Storage Layer:                                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │ entity_history (PostgreSQL)                          │  │
│  │ ┌────────────────────────────────────────────────┐   │  │
│  │ │ entity_id, version_id, valid_from, valid_to    │   │  │
│  │ │ created_at (transaction time)                  │   │  │
│  │ │ created_by, reason, data (JSONB)               │   │  │
│  │ └────────────────────────────────────────────────┘   │  │
│  └──────────────────────────────────────────────────────┘  │
│                                                             │
│  Query Engine:                                              │
│  - AsOfQueryBuilder: SELECT WHERE created_at <= timestamp   │
│  - TimelineAggregator: GROUP BY valid_from, created_at      │
│  - DiffGenerator: Compare two snapshots                     │
│                                                             │
│  UI Components:                                             │
│  - <AsOfQueryBuilder /> - Date picker for as-of queries     │
│  - <TimelineViewer /> - D3.js bitemporal visualization      │
│  - <RetroactiveCorrectionDialog /> - Effective date editor  │
│  - <SnapshotComparison /> - Side-by-side diff view          │
│  - <AuditExportDialog /> - Filter + export controls         │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

---

## User Personas

### Persona 1: Compliance Officer (Sarah)

**Role:** Ensures regulatory compliance, responds to audits

**Goals:**
- Query historical data states for audit requests
- Export audit trails for regulators (SOX, GDPR)
- Verify no unauthorized retroactive changes

**Pain Points:**
- Manual data reconstruction from logs
- Incomplete audit trails
- No way to prove "what we knew when"

**Tech Savviness:** Medium (uses SQL, Excel, audit tools)

**Frequency:** Weekly (monthly during audit season)

---

### Persona 2: Accountant (Michael)

**Role:** Maintains accurate financial records, corrects errors

**Goals:**
- Correct transaction dates when errors discovered
- Apply corrections to correct fiscal period
- Maintain audit trail of all corrections

**Pain Points:**
- Corrections lose context of when they were made
- No way to backdate corrections to effective date
- Hard to explain "why we changed this later"

**Tech Savviness:** Medium (Excel power user, some SQL)

**Frequency:** Daily (month-end close)

---

### Persona 3: Data Engineer (Alex)

**Role:** Maintains data pipelines, ensures data quality

**Goals:**
- Debug data quality issues by time-traveling
- Understand when bad data entered the system
- Build ETL jobs that respect bitemporal semantics

**Pain Points:**
- Point-in-time queries require custom SQL
- No standard way to query "as of" a date
- Difficult to reproduce production bugs

**Tech Savviness:** High (writes SQL, Python, understands databases)

**Frequency:** Daily

---

### Persona 4: Auditor (Jennifer)

**Role:** External auditor, verifies financial controls

**Goals:**
- Compare snapshots at two dates (e.g., Q1 vs Q2 close)
- Verify no unauthorized retroactive changes
- Export complete audit trail for workpapers

**Pain Points:**
- Manually comparing Excel exports
- No proof of data integrity
- Can't verify "what the system showed on Dec 31"

**Tech Savviness:** Medium (Excel, audit software)

**Frequency:** Quarterly (annual audit)

---

### Persona 5: Legal Counsel (Robert)

**Role:** Handles litigation, e-discovery requests

**Goals:**
- Reconstruct what the company knew at specific dates
- Export audit trails for legal holds
- Prove data integrity in court

**Pain Points:**
- Deleted data can't be recovered
- No proof of when data was entered
- Difficult to prove "we didn't know at the time"

**Tech Savviness:** Low (uses legal software, not technical)

**Frequency:** As-needed (litigation)

---

## User Journeys

### Journey 1: Run As-Of Query (Compliance Officer)

**Persona:** Sarah (Compliance Officer)

**Scenario:** Auditor asks "What was the balance of Account #1234 on Feb 1, 2025?"

**Time to Complete:** ~15 seconds

**Steps:**

1. **Navigate to Account #1234**
   - Click "Accounts" in sidebar
   - Search for "#1234"
   - Click account card

2. **Click "View History" button**
   - Button in top-right of account detail page
   - Opens `<AsOfQueryBuilder />` component

3. **Select "As of Feb 1, 2025"**
   - Date picker appears
   - User clicks calendar icon
   - Selects Feb 1, 2025 from calendar
   - Or types "2025-02-01" in input field

4. **Click "Query" button**
   - Server executes:
   ```sql
   SELECT * FROM entity_history
   WHERE entity_id = 'acct_1234'
     AND created_at <= '2025-02-01 23:59:59'
   ORDER BY created_at DESC
   LIMIT 1
   ```

5. **View snapshot result**
   - UI shows account state as of Feb 1, 2025:
   ```
   ┌────────────────────────────────────────────────────┐
   │ 📸 Snapshot: Account #1234 (as of Feb 1, 2025)    │
   ├────────────────────────────────────────────────────┤
   │                                                    │
   │  Name:        Chase Checking                      │
   │  Balance:     $5,432.10                           │
   │  Status:      Active                              │
   │  Owner:       John Doe                            │
   │                                                    │
   │  Last updated: Jan 28, 2025 (4 days before)       │
   │  Updated by:   sync_service                       │
   │                                                    │
   │  [ Export Snapshot ]  [ Compare Dates ]           │
   └────────────────────────────────────────────────────┘
   ```

6. **Export snapshot (optional)**
   - Click "Export Snapshot"
   - Downloads: `account_1234_snapshot_2025-02-01.json`
   - Contains: entity data + metadata (who, when, why)

**Success Criteria:**
- ✅ Query completes in <1 second
- ✅ Snapshot shows correct historical state
- ✅ Export includes all metadata
- ✅ User can answer auditor's question

**Wireframe Reference:** See Wireframe 1

---

### Journey 2: Make Retroactive Correction (Accountant)

**Persona:** Michael (Accountant)

**Scenario:** Discovers transaction dated Jan 25 actually occurred on Jan 20 (bank statement reconciliation)

**Time to Complete:** ~30 seconds

**Steps:**

1. **Find transaction**
   - Navigate to Transactions list
   - Search for "Jan 25, Amazon, $49.99"
   - Click transaction card

2. **Click "Edit" button**
   - Opens `<RetroactiveCorrectionDialog />`
   - Shows current transaction details

3. **Change transaction date**
   - Current date field shows: "Jan 25, 2025"
   - User clicks date field
   - Calendar opens
   - User selects "Jan 20, 2025"

4. **Select "Effective Date: Jan 20"**
   - New section appears:
   ```
   ┌────────────────────────────────────────────────────┐
   │ ⚠️  Retroactive Correction                         │
   ├────────────────────────────────────────────────────┤
   │                                                    │
   │  This change affects the past. Choose when this   │
   │  correction should take effect:                   │
   │                                                    │
   │  ○ Effective now (Feb 10, 2025)                   │
   │     Transaction appears on Jan 20, updated today  │
   │                                                    │
   │  ● Effective as of Jan 20, 2025                   │
   │     Transaction appears as if it was always       │
   │     on Jan 20 (backdated)                         │
   │                                                    │
   │  Reason (required):                               │
   │  ┌──────────────────────────────────────────────┐ │
   │  │ Corrected to match bank statement date       │ │
   │  └──────────────────────────────────────────────┘ │
   │                                                    │
   └────────────────────────────────────────────────────┘
   ```

5. **Enter reason**
   - Types: "Corrected to match bank statement date"
   - Required field (save disabled without it)

6. **Click "Save"**
   - Server creates new version:
   ```json
   {
     "entity_id": "txn_xyz789",
     "version_id": "v2",
     "valid_from": "2025-01-20",
     "valid_to": "9999-12-31",
     "created_at": "2025-02-10 14:30:00",
     "created_by": "michael_123",
     "reason": "Corrected to match bank statement date",
     "data": {
       "date": "2025-01-20",
       "merchant": "Amazon",
       "amount": 49.99
     }
   }
   ```

7. **View updated transaction**
   - Transaction now shows:
   ```
   ┌────────────────────────────────────────────────────┐
   │ Jan 20, 2025 (corrected) 🕐            -$49.99    │
   ├────────────────────────────────────────────────────┤
   │ Amazon                                            │
   │ Shopping                                          │
   │                                                    │
   │ 🕐 Date corrected Feb 10 by michael_123            │
   └────────────────────────────────────────────────────┘
   ```

**Success Criteria:**
- ✅ Transaction date updated to Jan 20
- ✅ Effective date set to Jan 20 (backdated)
- ✅ Audit trail shows correction made Feb 10
- ✅ Reports for Jan 20-31 now include this transaction

**Wireframe Reference:** See Wireframe 2

---

### Journey 3: View Bitemporal Timeline (Data Engineer)

**Persona:** Alex (Data Engineer)

**Scenario:** Debug why transaction appeared on wrong date in Jan report

**Time to Complete:** ~20 seconds

**Steps:**

1. **Navigate to transaction**
   - Transaction list → Click transaction

2. **Click "Timeline" tab**
   - Tabs: Details | Timeline | Audit Trail
   - Switches to Timeline view

3. **View bitemporal visualization**
   - `<TimelineViewer />` renders D3.js chart:
   ```
   Valid Time (when it happened):
   ────────────────────────────────────────────────────►
        Jan 10    Jan 20    Jan 30    Feb 10    Feb 20

   Transaction Time (when we knew):
   │
   │  Feb 10 ●────────────────────────────────────►
   │         │ Date: Jan 20 (current)
   │         │
   │  Jan 26 ●────────● (superseded)
   │         │ Date: Jan 25
   │         │
   │  Jan 25 ●────────● (superseded)
   │         │ Date: Jan 25 (original)
   │         │
   ▼
   ```

4. **Understand history**
   - Jan 25: Transaction ingested with date Jan 25
   - Jan 26: Parser auto-corrected to Jan 25 (reprocessing)
   - Feb 10: User corrected to Jan 20 (manual correction)

5. **Hover over timeline points**
   - Tooltip shows:
   ```
   ┌────────────────────────────────────────┐
   │ Version 3 (current)                   │
   │                                        │
   │ Valid Date:   Jan 20, 2025            │
   │ Created:      Feb 10, 2025 14:30      │
   │ Created By:   michael_123             │
   │ Reason:       Corrected to match bank │
   │               statement date          │
   │                                        │
   │ Click to view snapshot →              │
   └────────────────────────────────────────┘
   ```

6. **Click timeline point**
   - Expands to show full snapshot:
   ```
   ┌────────────────────────────────────────────────────┐
   │ Version 3 (Feb 10, 2025 14:30)                    │
   ├────────────────────────────────────────────────────┤
   │ Date:         Jan 20, 2025 (changed from Jan 25)  │
   │ Merchant:     Amazon                              │
   │ Amount:       $49.99                              │
   │ Category:     Shopping                            │
   │                                                    │
   │ Changed by:   michael_123                         │
   │ Reason:       Corrected to match bank statement   │
   │                                                    │
   │ [ View Full Diff ]                                │
   └────────────────────────────────────────────────────┘
   ```

**Success Criteria:**
- ✅ Alex understands complete history
- ✅ Timeline shows all 3 versions
- ✅ Can see who/when/why for each change
- ✅ Can debug why Jan report was wrong

**Wireframe Reference:** See Wireframe 3

---

### Journey 4: Export Audit Report (Compliance Officer)

**Persona:** Sarah (Compliance Officer)

**Scenario:** Auditor requests "All changes to Account #1234 in Q1 2025"

**Time to Complete:** ~25 seconds

**Steps:**

1. **Navigate to Reports section**
   - Click "Reports" in sidebar
   - Click "Audit Reports"

2. **Click "New Audit Report"**
   - Opens `<AuditExportDialog />`

3. **Configure filters**
   ```
   ┌────────────────────────────────────────────────────┐
   │ Export Audit Report                        [ X ]   │
   ├────────────────────────────────────────────────────┤
   │                                                    │
   │  Entity Type:                                     │
   │  ┌──────────────────────────────────────────────┐ │
   │  │ Account                              ▼       │ │
   │  └──────────────────────────────────────────────┘ │
   │                                                    │
   │  Entity ID (optional):                            │
   │  ┌──────────────────────────────────────────────┐ │
   │  │ acct_1234                                    │ │
   │  └──────────────────────────────────────────────┘ │
   │                                                    │
   │  Date Range:                                      │
   │  ┌─────────────────────┐  to  ┌─────────────────┐│
   │  │ 2025-01-01  📅     │     │ 2025-03-31  📅 ││
   │  └─────────────────────┘      └─────────────────┘│
   │                                                    │
   │  Include:                                         │
   │  ☑ All versions                                   │
   │  ☑ User information                               │
   │  ☑ Reasons for changes                            │
   │  ☑ Field-level diffs                              │
   │                                                    │
   │  Format:                                          │
   │  ● CSV   ○ JSON   ○ Excel   ○ PDF               │
   │                                                    │
   │            [ Cancel ]        [ Export ]           │
   └────────────────────────────────────────────────────┘
   ```

4. **Click "Export"**
   - Server generates report:
   ```sql
   SELECT
     version_id,
     valid_from,
     valid_to,
     created_at,
     created_by,
     reason,
     data
   FROM entity_history
   WHERE entity_id = 'acct_1234'
     AND created_at BETWEEN '2025-01-01' AND '2025-03-31'
   ORDER BY created_at ASC
   ```

5. **Download progress shown**
   ```
   ┌────────────────────────────────────────────────────┐
   │ Generating report...                              │
   │ ████████████████████░░░░░░  75%                   │
   │                                                    │
   │ Found 47 versions for Account #1234               │
   │ Processing field-level diffs...                   │
   └────────────────────────────────────────────────────┘
   ```

6. **CSV download completes**
   - File: `audit_report_acct_1234_Q1_2025.csv`
   - Columns:
   ```
   version_id,valid_from,valid_to,created_at,created_by,reason,field_name,old_value,new_value
   v1,2025-01-01,2025-01-15,2025-01-01 08:00,sync_service,Initial sync,balance,0,5000.00
   v2,2025-01-15,2025-02-01,2025-01-15 10:30,john_123,Deposit,balance,5000.00,5500.00
   v3,2025-02-01,9999-12-31,2025-02-01 14:00,sarah_456,Correction,balance,5500.00,5432.10
   ...
   ```

7. **Share with auditor**
   - Email CSV to auditor
   - Auditor can import into Excel

**Success Criteria:**
- ✅ Report includes all 47 versions
- ✅ Field-level diffs included
- ✅ Reason for each change captured
- ✅ Auditor satisfied with audit trail

**Wireframe Reference:** See Wireframe 4

---

### Journey 5: Handle Validation Error (Accountant)

**Persona:** Michael (Accountant)

**Scenario:** Tries to set effective date in the future (invalid)

**Time to Complete:** ~35 seconds

**Steps:**

1. **Open correction dialog**
   - Navigate to transaction
   - Click "Edit"

2. **Enter invalid effective date**
   - Changes transaction date to Jan 15
   - Selects "Effective as of Mar 1, 2025" (future date)

3. **Click "Save"**
   - Validation fails:
   ```
   ┌────────────────────────────────────────────────────┐
   │ ⚠️  Retroactive Correction                         │
   ├────────────────────────────────────────────────────┤
   │                                                    │
   │  ● Effective as of Mar 1, 2025                    │
   │     Transaction appears as if it was always       │
   │     on Jan 15 (backdated)                         │
   │                                                    │
   │  ❌ Effective date cannot be in the future        │
   │     (Mar 1 is after today Feb 10)                 │
   │                                                    │
   │  Reason (required):                               │
   │  ┌──────────────────────────────────────────────┐ │
   │  │ Correcting date                              │ │
   │  └──────────────────────────────────────────────┘ │
   │                                                    │
   │  [ Cancel ]  [ Save ] (disabled)                  │
   └────────────────────────────────────────────────────┘
   ```

4. **Read error message**
   - Error: "Effective date cannot be in the future"
   - Explanation: "Mar 1 is after today Feb 10"

5. **Correct effective date**
   - Changes to "Effective as of Jan 15, 2025"
   - Error disappears
   - Save button enabled

6. **Save successfully**
   - Correction applied with effective date Jan 15

**Success Criteria:**
- ✅ Validation prevents future effective dates
- ✅ Clear error message explains why
- ✅ User can correct and save successfully
- ✅ No invalid data entered

**Wireframe Reference:** See Wireframe 5

---

### Journey 6: Compare Snapshots (Auditor)

**Persona:** Jennifer (Auditor)

**Scenario:** Compare Account #1234 balance at Q1 close (Mar 31) vs Q2 close (Jun 30)

**Time to Complete:** ~40 seconds

**Steps:**

1. **Navigate to Account #1234**
   - Accounts list → Search → Click account

2. **Click "Compare Dates"**
   - Button in account detail page
   - Opens `<SnapshotComparison />` modal

3. **Select first date (Mar 31, 2025)**
   ```
   ┌────────────────────────────────────────────────────┐
   │ Compare Snapshots                          [ X ]   │
   ├────────────────────────────────────────────────────┤
   │                                                    │
   │  First Date:                                      │
   │  ┌──────────────────────────────────────────────┐ │
   │  │ 2025-03-31  📅                               │ │
   │  └──────────────────────────────────────────────┘ │
   │                                                    │
   │  Second Date:                                     │
   │  ┌──────────────────────────────────────────────┐ │
   │  │ 2025-06-30  📅                               │ │
   │  └──────────────────────────────────────────────┘ │
   │                                                    │
   │            [ Cancel ]        [ Compare ]          │
   └────────────────────────────────────────────────────┘
   ```

4. **Select second date (Jun 30, 2025)**
   - Date picker opens
   - User selects Jun 30, 2025

5. **Click "Compare"**
   - Server fetches both snapshots:
   ```sql
   -- Snapshot 1
   SELECT * FROM entity_history
   WHERE entity_id = 'acct_1234'
     AND created_at <= '2025-03-31 23:59:59'
   ORDER BY created_at DESC LIMIT 1

   -- Snapshot 2
   SELECT * FROM entity_history
   WHERE entity_id = 'acct_1234'
     AND created_at <= '2025-06-30 23:59:59'
   ORDER BY created_at DESC LIMIT 1
   ```

6. **View side-by-side comparison**
   ```
   ┌────────────────────────────────────────────────────┐
   │ Snapshot Comparison: Account #1234                │
   ├────────────────────────────────────────────────────┤
   │                                                    │
   │  Mar 31, 2025           Jun 30, 2025              │
   │  ─────────────────      ─────────────────         │
   │                                                    │
   │  Name:                                            │
   │  Chase Checking         Chase Checking            │
   │                                                    │
   │  Balance:                                         │
   │  $5,432.10  ────────►   $8,901.45  (+$3,469.35)  │
   │                                                    │
   │  Status:                                          │
   │  Active                 Active                    │
   │                                                    │
   │  Owner:                                           │
   │  John Doe               John Doe                  │
   │                                                    │
   │  Last Updated:                                    │
   │  Mar 28, 2025           Jun 29, 2025              │
   │                                                    │
   │  [ Export Diff CSV ]                              │
   └────────────────────────────────────────────────────┘
   ```

7. **Export diff (optional)**
   - Click "Export Diff CSV"
   - Downloads: `account_1234_diff_Q1_Q2_2025.csv`
   - Contains:
   ```csv
   field_name,mar_31_value,jun_30_value,change
   balance,5432.10,8901.45,+3469.35
   last_updated,2025-03-28,2025-06-29,+93 days
   ```

**Success Criteria:**
- ✅ Both snapshots retrieved in <1 second
- ✅ Diff highlighting shows changes clearly
- ✅ Balance increase calculated (+$3,469.35)
- ✅ Export includes all field changes

**Wireframe Reference:** See Wireframe 6

---

### Journey 7: Schedule Future-Dated Change (Accountant)

**Persona:** Michael (Accountant)

**Scenario:** Plan price increase effective Apr 1, 2025 (scheduled change)

**Time to Complete:** ~30 seconds

**Steps:**

1. **Navigate to Product #567**
   - Products list → Search → Click product

2. **Click "Schedule Change"**
   - Button in product detail page
   - Opens `<FutureDatedChangeDialog />`

3. **Change price**
   - Current price: $49.99
   - New price: $59.99

4. **Select effective date (Apr 1, 2025)**
   ```
   ┌────────────────────────────────────────────────────┐
   │ Schedule Future Change                     [ X ]   │
   ├────────────────────────────────────────────────────┤
   │                                                    │
   │  Price:                                           │
   │  ┌──────────────────────────────────────────────┐ │
   │  │ 59.99                                        │ │
   │  └──────────────────────────────────────────────┘ │
   │                                                    │
   │  Effective Date:                                  │
   │  ┌──────────────────────────────────────────────┐ │
   │  │ 2025-04-01  📅                               │ │
   │  └──────────────────────────────────────────────┘ │
   │                                                    │
   │  💡 This change will take effect on Apr 1, 2025   │
   │     Current price ($49.99) will remain until then │
   │                                                    │
   │  Reason (required):                               │
   │  ┌──────────────────────────────────────────────┐ │
   │  │ Annual price increase for 2025               │ │
   │  └──────────────────────────────────────────────┘ │
   │                                                    │
   │            [ Cancel ]        [ Schedule ]         │
   └────────────────────────────────────────────────────┘
   ```

5. **Click "Schedule"**
   - Server creates future version:
   ```json
   {
     "entity_id": "prod_567",
     "version_id": "v2",
     "valid_from": "2025-04-01",
     "valid_to": "9999-12-31",
     "created_at": "2025-02-10 14:30:00",
     "created_by": "michael_123",
     "reason": "Annual price increase for 2025",
     "data": {
       "price": 59.99
     }
   }
   ```

6. **View scheduled change**
   - Product detail shows:
   ```
   ┌────────────────────────────────────────────────────┐
   │ Product #567                                      │
   ├────────────────────────────────────────────────────┤
   │                                                    │
   │  Current Price:  $49.99                           │
   │                                                    │
   │  📅 Scheduled Change (Apr 1, 2025):               │
   │     Price → $59.99                                │
   │     Reason: Annual price increase for 2025        │
   │                                                    │
   │  [ Edit Schedule ]  [ Cancel Schedule ]           │
   └────────────────────────────────────────────────────┘
   ```

7. **On Apr 1, 2025 (automatic)**
   - Cron job runs:
   ```sql
   UPDATE products
   SET price = 59.99
   WHERE id = 'prod_567'
     AND CURRENT_DATE >= (
       SELECT valid_from FROM entity_history
       WHERE entity_id = 'prod_567' AND version_id = 'v2'
     )
   ```

**Success Criteria:**
- ✅ Future version created with valid_from = Apr 1
- ✅ Current price remains $49.99 until Apr 1
- ✅ On Apr 1, price automatically updates to $59.99
- ✅ Audit trail shows scheduled change

**Wireframe Reference:** See Wireframe 7

---

## Wireframes

### Wireframe 1: AsOfQueryBuilder

```
┌────────────────────────────────────────────────────────────┐
│ 🕐 Query Historical Data                           [ X ]   │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  View entity state as it existed on a specific date:      │
│                                                            │
│  As of Date:                                              │
│  ┌────────────────────────────────────────────────────┐   │
│  │ 2025-02-01                           📅  [Today]  │   │
│  └────────────────────────────────────────────────────┘   │
│                                                            │
│  Quick Dates:                                             │
│  [ Today ]  [ 1 Week Ago ]  [ 1 Month Ago ]  [ Year End ] │
│                                                            │
│  Or enter custom date:                                    │
│  ┌──────────┐   ┌──────────┐   ┌──────────┐              │
│  │ 2025     │ / │ 02       │ / │ 01       │              │
│  └──────────┘   └──────────┘   └──────────┘              │
│   Year          Month         Day                        │
│                                                            │
│               [ Cancel ]             [ Query ]            │
└────────────────────────────────────────────────────────────┘

Features:
- Date picker with calendar UI
- Quick date shortcuts (Today, 1 week ago, etc.)
- Manual date entry (YYYY-MM-DD)
- "Today" button sets to current date
- Query button disabled until date selected
- Keyboard: Arrow keys navigate calendar, Enter to select
```

---

### Wireframe 2: RetroactiveCorrectionDialog

```
┌────────────────────────────────────────────────────────────┐
│ ✏️  Edit Transaction                                [ X ]   │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  Date:                                                     │
│  ┌────────────────────────────────────────────────────┐   │
│  │ 2025-01-20  📅  (changed from Jan 25)             │   │
│  └────────────────────────────────────────────────────┘   │
│                                                            │
│  Merchant:                                                 │
│  ┌────────────────────────────────────────────────────┐   │
│  │ Amazon                                             │   │
│  └────────────────────────────────────────────────────┘   │
│                                                            │
│  Amount:                                                   │
│  ┌────────────────────────────────────────────────────┐   │
│  │ 49.99                                              │   │
│  └────────────────────────────────────────────────────┘   │
│                                                            │
│ ┌──────────────────────────────────────────────────────┐  │
│ │ ⚠️  Retroactive Correction                           │  │
│ ├──────────────────────────────────────────────────────┤  │
│ │                                                      │  │
│ │ You're changing a past transaction. When should     │  │
│ │ this correction take effect?                        │  │
│ │                                                      │  │
│ │ ○ Effective now (Feb 10, 2025)                      │  │
│ │   Shows transaction on Jan 20, corrected today      │  │
│ │   (Audit trail: "Changed Feb 10 to date Jan 20")    │  │
│ │                                                      │  │
│ │ ● Effective as of Jan 20, 2025                      │  │
│ │   Shows as if transaction was always on Jan 20      │  │
│ │   (Audit trail: "Backdated correction")             │  │
│ │                                                      │  │
│ │ Reason (required):                                  │  │
│ │ ┌──────────────────────────────────────────────┐    │  │
│ │ │ Corrected to match bank statement date       │    │  │
│ │ └──────────────────────────────────────────────┘    │  │
│ │                                                      │  │
│ └──────────────────────────────────────────────────────┘  │
│                                                            │
│               [ Cancel ]             [ Save ]              │
└────────────────────────────────────────────────────────────┘

Features:
- Clearly shows old vs new date
- Radio buttons for effective date strategy
- Explanation of each strategy
- Required reason field
- Warning icon for retroactive changes
- Save disabled until reason entered
```

---

### Wireframe 3: TimelineViewer (Bitemporal D3.js)

```
┌────────────────────────────────────────────────────────────┐
│ Timeline: Transaction #xyz789                      [ X ]   │
├────────────────────────────────────────────────────────────┤
│                                                            │
│ View: ● Bitemporal  ○ Simple                              │
│                                                            │
│ Valid Time (when transaction occurred):                   │
│ ────────────────────────────────────────────────────────► │
│     Jan 10      Jan 20      Jan 30      Feb 10      Feb 20│
│                                                            │
│ Transaction Time (when we knew about it):                 │
│ │                                                          │
│ │ Feb 10 ●────────────────────────────────────►           │
│ │        │ 📌 Version 3 (CURRENT)                         │
│ │        │ Valid: Jan 20                                  │
│ │        │ By: michael_123                                │
│ │        └─ "Corrected to match bank statement"           │
│ │                                                          │
│ │ Jan 26 ●────────●                                        │
│ │        │ 📌 Version 2 (superseded)                      │
│ │        │ Valid: Jan 25                                  │
│ │        │ By: parser_service                             │
│ │        └─ "Auto-correction during reprocessing"         │
│ │                                                          │
│ │ Jan 25 ●────────●                                        │
│ │        │ 📌 Version 1 (superseded)                      │
│ │        │ Valid: Jan 25                                  │
│ │        │ By: parser_service                             │
│ │        └─ "Initial extraction from PDF"                 │
│ │                                                          │
│ ▼                                                          │
│                                                            │
│ Legend:                                                    │
│ ● Current  ● Superseded  ─── Valid period                 │
│                                                            │
│ Hover for details | Click to view snapshot                │
│                                                            │
│ [ Export Timeline PNG ]  [ Export Data CSV ]              │
└────────────────────────────────────────────────────────────┘

Features:
- D3.js interactive visualization
- Two axes: valid time (horizontal), transaction time (vertical)
- Color-coded versions (blue=current, gray=superseded)
- Hover tooltips with metadata
- Click to expand snapshot
- Export timeline as PNG or data as CSV
- Zoom/pan controls for long timelines
```

---

### Wireframe 4: AuditExportDialog

```
┌────────────────────────────────────────────────────────────┐
│ Export Audit Report                                [ X ]   │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  Filters:                                                  │
│                                                            │
│  Entity Type:                                             │
│  ┌────────────────────────────────────────────────────┐   │
│  │ All Types                                ▼         │   │
│  └────────────────────────────────────────────────────┘   │
│    Options: Transaction, Account, Product, ...            │
│                                                            │
│  Entity ID (optional):                                    │
│  ┌────────────────────────────────────────────────────┐   │
│  │ acct_1234                                          │   │
│  └────────────────────────────────────────────────────┘   │
│                                                            │
│  Date Range (transaction time):                           │
│  ┌─────────────────────┐  to  ┌─────────────────────┐    │
│  │ 2025-01-01  📅     │     │ 2025-03-31  📅     │    │
│  └─────────────────────┘      └─────────────────────┘    │
│                                                            │
│  Changed By (optional):                                   │
│  ┌────────────────────────────────────────────────────┐   │
│  │ All Users                                 ▼        │   │
│  └────────────────────────────────────────────────────┘   │
│                                                            │
│  Include in Export:                                       │
│  ☑ All versions (not just current)                        │
│  ☑ User information (created_by)                          │
│  ☑ Reasons for changes                                    │
│  ☑ Field-level diffs (old → new)                          │
│  ☐ Only show changes (exclude unchanged fields)           │
│                                                            │
│  Format:                                                  │
│  ● CSV   ○ JSON   ○ Excel (.xlsx)   ○ PDF               │
│                                                            │
│  Estimated rows: ~47 versions                             │
│  Estimated size: ~12 KB                                   │
│                                                            │
│               [ Cancel ]             [ Export ]           │
└────────────────────────────────────────────────────────────┘

Features:
- Comprehensive filter options
- Entity type dropdown (transactions, accounts, etc.)
- Optional entity ID filter (single entity)
- Date range picker (transaction time)
- User filter (who made changes)
- Checkboxes for what to include
- Format selection (CSV, JSON, Excel, PDF)
- Estimated output size
- Export button generates report
```

---

### Wireframe 5: Validation Error State

```
┌────────────────────────────────────────────────────────────┐
│ ✏️  Edit Transaction                                [ X ]   │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  Date:                                                     │
│  ┌────────────────────────────────────────────────────┐   │
│  │ 2025-01-15  📅                                     │   │
│  └────────────────────────────────────────────────────┘   │
│                                                            │
│ ┌──────────────────────────────────────────────────────┐  │
│ │ ⚠️  Retroactive Correction                           │  │
│ ├──────────────────────────────────────────────────────┤  │
│ │                                                      │  │
│ │ ● Effective as of Mar 1, 2025                       │  │
│ │   Shows as if transaction was always on Jan 15      │  │
│ │                                                      │  │
│ │ ❌ Effective date cannot be in the future            │  │
│ │    Mar 1, 2025 is after today (Feb 10, 2025)        │  │
│ │                                                      │  │
│ │ 💡 Tip: Effective date must be today or earlier     │  │
│ │                                                      │  │
│ │ Reason (required):                                  │  │
│ │ ┌──────────────────────────────────────────────┐    │  │
│ │ │ Correcting date                              │    │  │
│ │ └──────────────────────────────────────────────┘    │  │
│ │                                                      │  │
│ └──────────────────────────────────────────────────────┘  │
│                                                            │
│               [ Cancel ]     [ Save ] (disabled)           │
└────────────────────────────────────────────────────────────┘

Features:
- Red error message (❌ icon)
- Clear explanation of why invalid
- Helpful tip for fixing error
- Save button disabled until fixed
- Error appears immediately on blur
- Validation runs on client + server
```

---

### Wireframe 6: SnapshotComparison (Side-by-Side Diff)

```
┌────────────────────────────────────────────────────────────┐
│ Compare Snapshots: Account #1234                   [ X ]   │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  Mar 31, 2025              Jun 30, 2025                   │
│  ─────────────────          ─────────────────             │
│                                                            │
│  Name:                                                     │
│  Chase Checking            Chase Checking                 │
│  (no change)                                               │
│                                                            │
│  Balance:                                                  │
│  $5,432.10  ──────────►    $8,901.45                      │
│  ⬆️ Increased by $3,469.35 (+63.9%)                        │
│                                                            │
│  Status:                                                   │
│  Active                    Active                         │
│  (no change)                                               │
│                                                            │
│  Owner:                                                    │
│  John Doe                  John Doe                       │
│  (no change)                                               │
│                                                            │
│  Last Updated:                                             │
│  Mar 28, 2025              Jun 29, 2025                   │
│  ⬆️ 93 days later                                          │
│                                                            │
│ ┌──────────────────────────────────────────────────────┐  │
│ │ Summary:                                             │  │
│ │ • 1 field changed (balance)                          │  │
│ │ • 0 fields removed                                   │  │
│ │ • 0 fields added                                     │  │
│ │ • 3 fields unchanged (name, status, owner)           │  │
│ └──────────────────────────────────────────────────────┘  │
│                                                            │
│  [ Export Diff CSV ]  [ View Timeline ]  [ Close ]        │
└────────────────────────────────────────────────────────────┘

Features:
- Side-by-side comparison layout
- Changed fields highlighted (green=increased, red=decreased)
- Percentage/delta calculations
- "No change" indicator for unchanged fields
- Summary statistics
- Export diff as CSV
- Link to full timeline view
```

---

### Wireframe 7: FutureDatedChangeDialog

```
┌────────────────────────────────────────────────────────────┐
│ Schedule Future Change                             [ X ]   │
├────────────────────────────────────────────────────────────┤
│                                                            │
│  Product: Product #567                                     │
│                                                            │
│  Field to Change:                                         │
│  ┌────────────────────────────────────────────────────┐   │
│  │ Price                                      ▼       │   │
│  └────────────────────────────────────────────────────┘   │
│                                                            │
│  Current Value:                                           │
│  $49.99                                                    │
│                                                            │
│  New Value:                                               │
│  ┌────────────────────────────────────────────────────┐   │
│  │ 59.99                                              │   │
│  └────────────────────────────────────────────────────┘   │
│                                                            │
│  Effective Date:                                          │
│  ┌────────────────────────────────────────────────────┐   │
│  │ 2025-04-01  📅                                     │   │
│  └────────────────────────────────────────────────────┘   │
│                                                            │
│  💡 This change will take effect on Apr 1, 2025           │
│     The current price ($49.99) will remain until then     │
│                                                            │
│ ┌──────────────────────────────────────────────────────┐  │
│ │ Preview:                                             │  │
│ │                                                      │  │
│ │  Today (Feb 10) ───────────► Apr 1 ────────────►    │  │
│ │   $49.99                      $59.99                │  │
│ │                                                      │  │
│ │  51 days until change takes effect                  │  │
│ └──────────────────────────────────────────────────────┘  │
│                                                            │
│  Reason (required):                                       │
│  ┌────────────────────────────────────────────────────┐   │
│  │ Annual price increase for 2025                     │   │
│  └────────────────────────────────────────────────────┘   │
│                                                            │
│               [ Cancel ]             [ Schedule ]          │
└────────────────────────────────────────────────────────────┘

Features:
- Field selector dropdown
- Current vs new value clearly shown
- Future effective date picker
- Info message explaining when change takes effect
- Preview timeline showing transition
- Countdown ("51 days until change")
- Required reason field
- Schedule button (not "Save")
```

---

### Wireframe 8: Mobile Timeline (Compact View)

```
┌──────────────────────────────────────┐
│ ←  Timeline: Txn #xyz789         ⋮  │
├──────────────────────────────────────┤
│                                      │
│ Version 3 (Current)                  │
│ ●─────────────────────────────────►  │
│                                      │
│ Valid:    Jan 20, 2025               │
│ Created:  Feb 10, 2025 14:30         │
│ By:       michael_123                │
│ Reason:   Corrected to match bank    │
│           statement date             │
│                                      │
│ [ View Snapshot ]                    │
│                                      │
├──────────────────────────────────────┤
│                                      │
│ Version 2 (Superseded)               │
│ ●─────●                              │
│                                      │
│ Valid:    Jan 25, 2025               │
│ Created:  Jan 26, 2025 08:15         │
│ By:       parser_service             │
│ Reason:   Auto-correction            │
│                                      │
│ [ View Snapshot ]                    │
│                                      │
├──────────────────────────────────────┤
│                                      │
│ Version 1 (Superseded)               │
│ ●─────●                              │
│                                      │
│ Valid:    Jan 25, 2025               │
│ Created:  Jan 25, 2025 08:00         │
│ By:       parser_service             │
│ Reason:   Initial extraction         │
│                                      │
│ [ View Snapshot ]                    │
│                                      │
├──────────────────────────────────────┤
│                                      │
│ [ Export Timeline ]                  │
│                                      │
└──────────────────────────────────────┘

Features:
- Vertical card layout (stacked)
- Simplified timeline (no 2D chart)
- Tap to expand snapshot
- Color-coded status (blue=current, gray=superseded)
- Swipe to dismiss
- Export button at bottom
- Back button in header
- Overflow menu (⋮) for actions
```

---

## Multi-Domain Examples

### Domain 1: Finance - Bank Reconciliation Retroactive Correction

**Scenario:** CFO discovers 10 transactions dated Jan 25 should be Jan 20 (bank statement error)

**Problem:**
- Bank exported statement with wrong date (Jan 25 instead of Jan 20)
- System ingested 10 transactions on Jan 25
- Month-end close on Jan 31 showed incorrect cash position
- Audit requires accurate historical records

**Solution with Provenance Ledger:**

1. **Accountant runs as-of query:**
   - "Show cash balance as of Jan 31, 2025"
   - Result: $10,000 (incorrect, includes wrong dates)

2. **Accountant makes retroactive correction:**
   - Select 10 transactions
   - Bulk edit: Change date Jan 25 → Jan 20
   - Effective date: Jan 20 (backdated)
   - Reason: "Corrected per amended bank statement"

3. **System creates new versions:**
   ```json
   {
     "entity_id": "txn_001",
     "version_id": "v2",
     "valid_from": "2025-01-20",
     "valid_to": "9999-12-31",
     "created_at": "2025-02-15 10:00:00",
     "created_by": "accountant_123",
     "reason": "Corrected per amended bank statement",
     "data": { "date": "2025-01-20", ... }
   }
   ```

4. **Reports automatically updated:**
   - Jan 20-31 report now includes these 10 transactions
   - Jan 25 report excludes them (moved to Jan 20)
   - Audit trail shows correction made Feb 15

5. **Auditor verifies:**
   - Runs as-of query: "Jan 31 balance as we knew it on Jan 31"
   - Result: $10,000 (what we believed then)
   - Runs as-of query: "Jan 31 balance as we know it today"
   - Result: $10,500 (correct, after correction)
   - Export diff shows 10 transactions corrected

**Outcome:**
- ✅ Historical accuracy maintained
- ✅ Audit trail shows who/when/why corrected
- ✅ Can prove "we didn't know on Jan 31"
- ✅ SOX compliance (complete audit trail)

---

### Domain 2: Healthcare - Diagnosis Code Effective Date

**Scenario:** Doctor diagnoses diabetes on Mar 1, but medical coder enters diagnosis on Mar 15 (delayed coding)

**Problem:**
- Diagnosis occurred Mar 1 (doctor visit)
- Medical coder entered diagnosis Mar 15 (data entry delay)
- Insurance claim requires diagnosis date = visit date (Mar 1)
- HIPAA audit requires knowing when diagnosis was documented

**Solution with Provenance Ledger:**

1. **Medical coder enters diagnosis:**
   - Date: Mar 15, 2025 (data entry date)
   - Diagnosis: E11.9 (Type 2 diabetes)
   - Effective date: Mar 1, 2025 (actual diagnosis date)
   - Reason: "Documented from Mar 1 visit"

2. **System stores bitemporal data:**
   ```json
   {
     "entity_id": "patient_456_diagnosis",
     "version_id": "v1",
     "valid_from": "2025-03-01",  // Diagnosis date
     "valid_to": "9999-12-31",
     "created_at": "2025-03-15 14:30:00",  // Data entry date
     "created_by": "coder_789",
     "reason": "Documented from Mar 1 visit",
     "data": { "diagnosis_code": "E11.9" }
   }
   ```

3. **Insurance claim generated:**
   - Claim date: Mar 1, 2025 (valid_from)
   - Diagnosis: E11.9
   - Claim accepted by insurance

4. **Auditor queries:**
   - "What diagnoses existed on Mar 5?"
   - Result: None (data entered later on Mar 15)
   - "What diagnoses were effective on Mar 5?"
   - Result: E11.9 (effective from Mar 1)

**Outcome:**
- ✅ Diagnosis date correct for insurance (Mar 1)
- ✅ Audit trail shows when documented (Mar 15)
- ✅ HIPAA compliance (complete record)
- ✅ Can answer "when did we know about diagnosis?"

---

### Domain 3: Legal - Case Filing Date Correction

**Scenario:** Court filing date entered as Jan 20, but clerk discovers actual filing was Jan 15 (stamped document)

**Problem:**
- Case management system shows filing date Jan 20
- Stamped court document shows Jan 15 (5 days earlier)
- Statute of limitations calculated from filing date
- Legal hold requires preserving all versions

**Solution with Provenance Ledger:**

1. **Legal assistant corrects filing date:**
   - Original: Jan 20, 2025
   - Corrected: Jan 15, 2025
   - Effective date: Jan 15, 2025 (backdated)
   - Reason: "Corrected per stamped court document #12345"

2. **System preserves both versions:**
   ```json
   // Version 1 (original)
   {
     "entity_id": "case_2025cv1234",
     "version_id": "v1",
     "valid_from": "2025-01-20",
     "valid_to": "2025-01-15",  // Superseded by correction
     "created_at": "2025-01-20 09:00:00",
     "data": { "filing_date": "2025-01-20" }
   }

   // Version 2 (corrected)
   {
     "entity_id": "case_2025cv1234",
     "version_id": "v2",
     "valid_from": "2025-01-15",
     "valid_to": "9999-12-31",
     "created_at": "2025-02-05 11:00:00",
     "created_by": "legal_assistant_456",
     "reason": "Corrected per stamped court document #12345",
     "data": { "filing_date": "2025-01-15" }
   }
   ```

3. **Statute of limitations recalculated:**
   - Original deadline: Jan 20, 2027 (2 years from Jan 20, 2025)
   - Corrected deadline: Jan 15, 2027 (2 years from Jan 15, 2025)
   - System sends alert: "Deadline changed from Jan 20 to Jan 15"

4. **Legal hold export:**
   - Export all versions for e-discovery
   - Court can see we believed Jan 20 until Feb 5
   - Proof of correction with court document reference

**Outcome:**
- ✅ Correct filing date for statute of limitations
- ✅ Audit trail for legal defensibility
- ✅ E-discovery compliance (all versions preserved)
- ✅ Can prove "we corrected when we discovered error"

---

### Domain 4: Research - Publication Year Retroactive Update

**Scenario:** Research paper metadata shows publication year 2024, but journal officially published in 2023 (metadata error)

**Problem:**
- Citation manager imported paper with year 2024 (DOI metadata error)
- 50 citations reference this paper as "Smith 2024"
- Journal website shows correct year: 2023
- Bibliography needs correction, citations need updating

**Solution with Provenance Ledger:**

1. **Research coordinator corrects publication year:**
   - Original: 2024
   - Corrected: 2023
   - Effective date: 2023 (backdated to actual publication)
   - Reason: "Corrected per journal website DOI 10.1234/xyz"

2. **System updates all citations:**
   - Find all citations: "Smith 2024"
   - Update to: "Smith 2023"
   - Audit trail shows mass update

3. **Timeline shows metadata evolution:**
   ```
   Valid Time (publication year):
   ────────────────────────────────────────────────────►
        2023          2024          2025

   Transaction Time (when we knew):
   │
   │  Feb 2025 ●────────────────────────────────────►
   │           │ Year: 2023 (corrected)
   │           │
   │  Jan 2024 ●────────● (superseded)
   │           │ Year: 2024 (metadata error)
   │           │
   ▼
   ```

4. **Researcher queries:**
   - "What papers were published in 2023?" (valid time)
   - Result: Includes this paper (valid_from = 2023)
   - "What papers did we have in our database in Jan 2024?" (transaction time)
   - Result: This paper listed as 2024 (what we believed then)

**Outcome:**
- ✅ Correct publication year (2023)
- ✅ Citations updated automatically
- ✅ Audit trail shows metadata correction
- ✅ Can answer "when did we import this paper?"

---

### Domain 5: E-commerce - Future Price Increase (Scheduled)

**Scenario:** Catalog manager schedules price increase for 100 products effective Apr 1, 2025

**Problem:**
- Annual price increase planned for Apr 1
- Customers should see current price until Apr 1
- Shopping cart must use correct price based on purchase date
- Price history needed for reporting

**Solution with Provenance Ledger:**

1. **Catalog manager schedules price changes:**
   - Select 100 products
   - Bulk edit: Price +10%
   - Effective date: Apr 1, 2025 (future date)
   - Reason: "Annual price increase 2025"

2. **System creates future versions:**
   ```json
   {
     "entity_id": "prod_567",
     "version_id": "v2",
     "valid_from": "2025-04-01",  // Future date
     "valid_to": "9999-12-31",
     "created_at": "2025-02-15 10:00:00",
     "created_by": "catalog_mgr_123",
     "reason": "Annual price increase 2025",
     "data": { "price": 54.99 }  // +10% from $49.99
   }
   ```

3. **Customer views product (Mar 15):**
   - Query: "Current price as of today"
   - Result: $49.99 (v1, valid until Mar 31)
   - UI shows: "Price increasing to $54.99 on Apr 1"

4. **Customer purchases (Mar 25):**
   - Shopping cart: $49.99 (current price)
   - Order date: Mar 25, 2025
   - Price locked at $49.99

5. **Customer views product (Apr 5):**
   - Query: "Current price as of today"
   - Result: $54.99 (v2, effective Apr 1)
   - UI shows: $54.99 (new price)

6. **Reporting:**
   - "Revenue in Q1 2025": Uses $49.99 price (valid_from before Apr 1)
   - "Revenue in Q2 2025": Uses $54.99 price (valid_from after Apr 1)

**Outcome:**
- ✅ Price increase automated on Apr 1
- ✅ Customers see correct price based on date
- ✅ Shopping cart uses correct price
- ✅ Historical reporting accurate

---

### Domain 6: SaaS - Plan Change Effective Next Billing Cycle

**Scenario:** Customer upgrades from Pro ($50/mo) to Enterprise ($200/mo) on Mar 15, effective Apr 1 (next billing cycle)

**Problem:**
- Customer upgrades mid-cycle (Mar 15)
- Billing cycle: 1st of month
- Customer should be charged Pro rate until Apr 1
- MRR reporting needs to reflect future upgrade

**Solution with Provenance Ledger:**

1. **Customer upgrades plan:**
   - Current plan: Pro ($50/mo)
   - New plan: Enterprise ($200/mo)
   - Effective date: Apr 1, 2025 (next billing cycle)
   - Reason: "Customer upgrade - effective next cycle"

2. **System creates future version:**
   ```json
   {
     "entity_id": "subscription_789",
     "version_id": "v2",
     "valid_from": "2025-04-01",
     "valid_to": "9999-12-31",
     "created_at": "2025-03-15 14:30:00",
     "created_by": "customer_456",
     "reason": "Customer upgrade - effective next cycle",
     "data": { "plan": "Enterprise", "mrr": 200 }
   }
   ```

3. **Mar 31 billing:**
   - Query: "MRR as of Mar 31"
   - Result: $50 (Pro plan, v1 still valid)
   - Customer charged: $50

4. **Apr 1 billing:**
   - Cron job activates v2 (valid_from = Apr 1)
   - Query: "MRR as of Apr 1"
   - Result: $200 (Enterprise plan, v2 now valid)
   - Customer charged: $200

5. **MRR reporting:**
   - "MRR on Mar 31": $50 (Pro plan)
   - "MRR on Apr 1": $200 (Enterprise plan)
   - "Scheduled upgrades": 1 (shown in forecast)

**Outcome:**
- ✅ Customer billed correctly (Pro until Apr 1)
- ✅ Upgrade activates automatically Apr 1
- ✅ MRR reporting accurate
- ✅ Forecast shows scheduled changes

---

## Accessibility Considerations (WCAG 2.1 AA)

### Color Contrast

**Requirement:** Text must have 4.5:1 contrast ratio (WCAG 2.1 AA)

**Implementation:**
- Timeline colors:
  - Current version: `#1E40AF` (blue-800) on white = 9.7:1 ✅
  - Superseded version: `#6B7280` (gray-500) on white = 4.6:1 ✅
  - Error states: `#DC2626` (red-600) on white = 7.0:1 ✅
  - Warning states: `#D97706` (amber-600) on white = 4.8:1 ✅

**Validation:**
```typescript
// Color contrast checker
function meetsWCAG_AA(foreground: string, background: string): boolean {
  const ratio = calculateContrastRatio(foreground, background);
  return ratio >= 4.5;  // WCAG AA for normal text
}
```

---

### Keyboard Navigation

**Requirement:** All interactive elements keyboard-accessible

**Implementation:**

1. **Timeline navigation:**
   - `Tab`: Navigate between timeline points
   - `Enter`: Expand/collapse snapshot
   - `Esc`: Close expanded snapshot
   - `Arrow keys`: Navigate timeline chronologically

2. **Date picker:**
   - `Tab`: Focus date input
   - `Space`: Open calendar
   - `Arrow keys`: Navigate calendar dates
   - `Enter`: Select date
   - `Esc`: Close calendar

3. **As-of query builder:**
   - `Cmd+K`: Quick open as-of query
   - `Tab`: Navigate fields
   - `Enter`: Execute query
   - `Esc`: Close dialog

**Testing:**
```typescript
// Keyboard navigation test
describe('TimelineViewer keyboard navigation', () => {
  it('allows tab navigation between timeline points', () => {
    render(<TimelineViewer />);
    const points = screen.getAllByRole('button', { name: /version/i });

    userEvent.tab();
    expect(points[0]).toHaveFocus();

    userEvent.tab();
    expect(points[1]).toHaveFocus();
  });

  it('expands snapshot on Enter key', () => {
    render(<TimelineViewer />);
    const point = screen.getByRole('button', { name: /version 1/i });

    point.focus();
    userEvent.keyboard('{Enter}');

    expect(screen.getByText(/snapshot/i)).toBeVisible();
  });
});
```

---

### Screen Reader Support

**Requirement:** All UI elements properly labeled for screen readers

**Implementation:**

1. **Timeline visualization:**
   ```tsx
   <div role="region" aria-label="Transaction timeline">
     <div
       role="button"
       aria-label="Version 3, current, created Feb 10 2025 by michael_123"
       aria-expanded={expanded}
       tabIndex={0}
     >
       {/* Timeline point */}
     </div>
   </div>
   ```

2. **Date picker:**
   ```tsx
   <label htmlFor="as-of-date">
     View data as of date
   </label>
   <input
     id="as-of-date"
     type="date"
     aria-describedby="date-help"
     aria-required="true"
   />
   <span id="date-help" className="sr-only">
     Select a date to view historical data
   </span>
   ```

3. **Snapshot comparison:**
   ```tsx
   <div role="region" aria-label="Snapshot comparison">
     <div aria-label="Snapshot from March 31, 2025">
       {/* Left snapshot */}
     </div>
     <div aria-label="Snapshot from June 30, 2025">
       {/* Right snapshot */}
     </div>
     <div aria-live="polite" aria-atomic="true">
       Balance increased by $3,469.35
     </div>
   </div>
   ```

**Testing:**
```typescript
// Screen reader test
describe('AsOfQueryBuilder screen reader', () => {
  it('announces query results', async () => {
    render(<AsOfQueryBuilder />);

    const dateInput = screen.getByLabelText(/view data as of date/i);
    userEvent.type(dateInput, '2025-02-01');

    const queryButton = screen.getByRole('button', { name: /query/i });
    userEvent.click(queryButton);

    await waitFor(() => {
      const announcement = screen.getByRole('status');
      expect(announcement).toHaveTextContent(/snapshot loaded for feb 1/i);
    });
  });
});
```

---

### Focus Management

**Requirement:** Focus moved appropriately after actions

**Implementation:**

1. **After opening dialog:**
   - Focus moves to first input field
   - User can immediately start typing

2. **After closing dialog:**
   - Focus returns to trigger element
   - User doesn't lose place

3. **After query executes:**
   - Focus moves to result region
   - Screen reader announces result

**Example:**
```tsx
function AsOfQueryBuilder({ onClose }) {
  const dateInputRef = useRef<HTMLInputElement>(null);
  const triggerRef = useRef<HTMLButtonElement>(null);

  useEffect(() => {
    // Focus date input on open
    dateInputRef.current?.focus();
  }, []);

  const handleClose = () => {
    onClose();
    // Return focus to trigger
    triggerRef.current?.focus();
  };

  return (
    <Dialog onClose={handleClose}>
      <input ref={dateInputRef} type="date" />
    </Dialog>
  );
}
```

---

### ARIA Live Regions

**Requirement:** Dynamic content changes announced

**Implementation:**

1. **Query execution:**
   ```tsx
   <div aria-live="polite" aria-atomic="true">
     {loading && "Loading snapshot..."}
     {result && `Snapshot loaded for ${formatDate(asOfDate)}`}
     {error && `Error: ${error.message}`}
   </div>
   ```

2. **Validation errors:**
   ```tsx
   <div aria-live="assertive" role="alert">
     {error && error.message}
   </div>
   ```

3. **Export progress:**
   ```tsx
   <div aria-live="polite" aria-atomic="true">
     Generating report... {progress}% complete
   </div>
   ```

---

## Performance & Interaction Design

### Query Performance

**Target:** As-of queries complete in <1 second (p95)

**Implementation:**

1. **Database optimization:**
   ```sql
   -- Index on (entity_id, created_at)
   CREATE INDEX idx_entity_history_id_time
   ON entity_history (entity_id, created_at DESC);

   -- As-of query
   SELECT * FROM entity_history
   WHERE entity_id = $1
     AND created_at <= $2
   ORDER BY created_at DESC
   LIMIT 1;
   ```

2. **Query plan:**
   ```
   EXPLAIN ANALYZE
   SELECT * FROM entity_history
   WHERE entity_id = 'acct_1234'
     AND created_at <= '2025-02-01 23:59:59'
   ORDER BY created_at DESC
   LIMIT 1;

   Index Scan using idx_entity_history_id_time  (cost=0.42..8.44 rows=1)
   Planning Time: 0.123 ms
   Execution Time: 0.456 ms  ✅ <1s
   ```

3. **Caching:**
   ```typescript
   // Cache frequent as-of queries
   const cache = new LRU<string, EntitySnapshot>({ max: 1000 });

   async function getAsOfSnapshot(
     entityId: string,
     asOfDate: Date
   ): Promise<EntitySnapshot> {
     const cacheKey = `${entityId}:${asOfDate.toISOString()}`;

     if (cache.has(cacheKey)) {
       return cache.get(cacheKey)!;  // Cache hit: ~1ms
     }

     const snapshot = await db.query(/* ... */);  // Cache miss: ~500ms
     cache.set(cacheKey, snapshot);
     return snapshot;
   }
   ```

**Monitoring:**
```typescript
// Performance metric
metrics.histogram('as_of_query_duration_ms', duration, {
  entity_type: 'account',
  cache_hit: cacheHit
});

// Alert if p95 > 1s
if (metrics.percentile('as_of_query_duration_ms', 0.95) > 1000) {
  alert('As-of queries slow! p95 > 1s');
}
```

---

### Timeline Rendering

**Target:** Timeline renders in <200ms for 100 versions

**Implementation:**

1. **D3.js optimization:**
   ```typescript
   function renderTimeline(versions: Version[]) {
     const svg = d3.select('svg#timeline');

     // Use virtual scrolling for >100 versions
     const visibleVersions = versions.slice(
       scrollTop / ROW_HEIGHT,
       scrollTop / ROW_HEIGHT + VISIBLE_ROWS
     );

     // Bind data efficiently
     svg.selectAll('.version')
       .data(visibleVersions, d => d.version_id)  // Key function
       .join(
         enter => enter.append('g').attr('class', 'version'),
         update => update,  // Reuse existing elements
         exit => exit.remove()
       );
   }
   ```

2. **Pagination:**
   ```tsx
   function TimelineViewer({ entityId }) {
     const [page, setPage] = useState(0);
     const PAGE_SIZE = 50;

     const { data: versions } = useQuery({
       queryKey: ['timeline', entityId, page],
       queryFn: () => fetchVersions(entityId, page, PAGE_SIZE)
     });

     return (
       <div>
         <Timeline versions={versions} />
         <Pagination page={page} onChange={setPage} />
       </div>
     );
   }
   ```

3. **Lazy loading:**
   ```tsx
   function TimelineViewer({ entityId }) {
     const observerRef = useRef<IntersectionObserver>();

     useEffect(() => {
       observerRef.current = new IntersectionObserver(entries => {
         if (entries[0].isIntersecting) {
           loadMoreVersions();  // Load next page
         }
       });

       const sentinel = document.querySelector('#timeline-sentinel');
       if (sentinel) observerRef.current.observe(sentinel);
     }, []);

     return (
       <div>
         {versions.map(v => <VersionCard key={v.version_id} {...v} />)}
         <div id="timeline-sentinel" />
       </div>
     );
   }
   ```

---

### Export Performance

**Target:** Export 1000 versions in <5 seconds

**Implementation:**

1. **Streaming CSV:**
   ```typescript
   async function exportAuditReport(filters: AuditFilters) {
     const stream = new PassThrough();

     // Stream header
     stream.write('version_id,created_at,created_by,reason,...\n');

     // Stream rows in batches
     const cursor = db.query(/* ... */).cursor();
     for await (const batch of cursor) {
       const csv = batch.map(row => formatCSVRow(row)).join('\n');
       stream.write(csv + '\n');
     }

     stream.end();
     return stream;
   }
   ```

2. **Progress tracking:**
   ```typescript
   async function exportWithProgress(filters: AuditFilters) {
     const total = await getVersionCount(filters);
     let processed = 0;

     const stream = new PassThrough();
     const cursor = db.query(/* ... */).cursor();

     for await (const batch of cursor) {
       processed += batch.length;
       const progress = Math.round((processed / total) * 100);

       // Emit progress event
       eventEmitter.emit('export-progress', { progress, processed, total });

       stream.write(formatCSV(batch));
     }

     stream.end();
     return stream;
   }
   ```

3. **Client-side progress:**
   ```tsx
   function AuditExportDialog() {
     const [progress, setProgress] = useState(0);

     const handleExport = async () => {
       const eventSource = new EventSource('/api/audit-export');

       eventSource.onmessage = (event) => {
         const { progress } = JSON.parse(event.data);
         setProgress(progress);
       };

       eventSource.onerror = () => {
         eventSource.close();
       };
     };

     return (
       <Dialog>
         {progress > 0 && (
           <ProgressBar value={progress} max={100} />
         )}
         <button onClick={handleExport}>Export</button>
       </Dialog>
     );
   }
   ```

---

### Optimistic UI Updates

**Pattern:** Update UI immediately, rollback on error

**Implementation:**

1. **Retroactive correction:**
   ```tsx
   function useRetroactiveCorrection() {
     const queryClient = useQueryClient();

     return useMutation({
       mutationFn: async (correction: Correction) => {
         return api.post('/corrections', correction);
       },

       onMutate: async (correction) => {
         // Cancel in-flight queries
         await queryClient.cancelQueries(['entity', correction.entity_id]);

         // Snapshot current state
         const previous = queryClient.getQueryData(['entity', correction.entity_id]);

         // Optimistically update
         queryClient.setQueryData(['entity', correction.entity_id], old => ({
           ...old,
           ...correction.data,
           _optimistic: true
         }));

         return { previous };  // Return snapshot for rollback
       },

       onError: (err, correction, context) => {
         // Rollback on error
         queryClient.setQueryData(
           ['entity', correction.entity_id],
           context.previous
         );

         toast.error('Failed to save correction');
       },

       onSuccess: () => {
         toast.success('Correction saved');
       }
     });
   }
   ```

2. **Visual feedback:**
   ```tsx
   function EntityCard({ entity }) {
     return (
       <div className={entity._optimistic ? 'opacity-60' : ''}>
         {entity._optimistic && (
           <span className="text-xs text-gray-500">Saving...</span>
         )}
         {/* Entity details */}
       </div>
     );
   }
   ```

---

## Error States & Edge Cases

### Edge Case 1: Circular Retroactive Corrections

**Problem:** User corrects date A → B, then later corrects B → A (circular)

**Solution:**

1. **Detect circular corrections:**
   ```typescript
   async function validateRetroactiveCorrection(correction: Correction) {
     const history = await getEntityHistory(correction.entity_id);

     // Check if new value matches any previous value
     const circular = history.some(v =>
       v.data.date === correction.data.date &&
       v.valid_to !== '9999-12-31'  // Superseded version
     );

     if (circular) {
       throw new ValidationError(
         'This correction creates a circular change. ' +
         'The date was previously set to this value on ' +
         formatDate(history.find(v => v.data.date === correction.data.date).created_at)
       );
     }
   }
   ```

2. **User warning:**
   ```
   ┌────────────────────────────────────────────────────┐
   │ ⚠️  Circular Correction Detected                   │
   ├────────────────────────────────────────────────────┤
   │                                                    │
   │ You're changing the date back to Jan 25, which    │
   │ was the original value before it was corrected    │
   │ to Jan 20 on Feb 10.                              │
   │                                                    │
   │ Timeline:                                         │
   │ • Jan 25: Original extraction                     │
   │ • Feb 10: Corrected to Jan 20 (you)               │
   │ • Today: Correcting back to Jan 25 (?)            │
   │                                                    │
   │ Are you sure you want to revert to the            │
   │ original value?                                   │
   │                                                    │
   │ [ Cancel ]  [ View Timeline ]  [ Continue ]       │
   └────────────────────────────────────────────────────┘
   ```

---

### Edge Case 2: As-Of Query for Future Date

**Problem:** User queries "as of Mar 1, 2025" but today is Feb 10

**Solution:**

1. **Allow future queries (for scheduled changes):**
   ```typescript
   async function getAsOfSnapshot(entityId: string, asOfDate: Date) {
     // Allow future dates (for scheduled changes)
     const snapshot = await db.query(`
       SELECT * FROM entity_history
       WHERE entity_id = $1
         AND created_at <= $2
       ORDER BY created_at DESC
       LIMIT 1
     `, [entityId, asOfDate]);

     // Check if snapshot includes future-dated changes
     if (snapshot.valid_from > new Date()) {
       return {
         ...snapshot,
         _future: true,  // Flag as future projection
         _effective_date: snapshot.valid_from
       };
     }

     return snapshot;
   }
   ```

2. **UI warning:**
   ```
   ┌────────────────────────────────────────────────────┐
   │ 📸 Snapshot: Account #1234 (as of Mar 1, 2025)    │
   ├────────────────────────────────────────────────────┤
   │                                                    │
   │ ⚠️  Future Projection (Mar 1 is 19 days from now)  │
   │                                                    │
   │ This snapshot includes scheduled changes that     │
   │ will take effect on Mar 1, 2025:                  │
   │ • Price increase to $59.99                        │
   │                                                    │
   │ Current state (today): $49.99                     │
   │ Future state (Mar 1): $59.99                      │
   │                                                    │
   │  [ View Current ]  [ View Timeline ]              │
   └────────────────────────────────────────────────────┘
   ```

---

### Edge Case 3: Concurrent As-Of Queries

**Problem:** Two users query same entity at same time, one creates correction mid-query

**Solution:**

1. **Snapshot isolation:**
   ```sql
   -- Use PostgreSQL transaction isolation
   BEGIN TRANSACTION ISOLATION LEVEL SNAPSHOT;

   SELECT * FROM entity_history
   WHERE entity_id = $1
     AND created_at <= $2
   ORDER BY created_at DESC
   LIMIT 1;

   COMMIT;
   ```

2. **Versioning:**
   ```typescript
   // Include version in response
   type SnapshotResponse = {
     data: EntitySnapshot;
     metadata: {
       as_of_date: Date;
       query_executed_at: Date;
       snapshot_version_id: string;
       is_current: boolean;  // False if newer version exists
     };
   };

   async function getAsOfSnapshot(entityId: string, asOfDate: Date) {
     const snapshot = await db.query(/* ... */);
     const latest = await db.query(/* ... get latest version ... */);

     return {
       data: snapshot,
       metadata: {
         as_of_date: asOfDate,
         query_executed_at: new Date(),
         snapshot_version_id: snapshot.version_id,
         is_current: snapshot.version_id === latest.version_id
       }
     };
   }
   ```

3. **UI indicator:**
   ```tsx
   function SnapshotResult({ snapshot, metadata }) {
     return (
       <div>
         {!metadata.is_current && (
           <Alert severity="info">
             This snapshot is from {formatDate(metadata.as_of_date)}.
             A newer version exists. <Link>View current →</Link>
           </Alert>
         )}
         {/* Snapshot data */}
       </div>
     );
   }
   ```

---

### Edge Case 4: Export Timeout (Large Dataset)

**Problem:** Audit export for 100,000 versions times out after 30s

**Solution:**

1. **Async export with job queue:**
   ```typescript
   async function exportAuditReportAsync(filters: AuditFilters) {
     // Create export job
     const job = await db.insert('export_jobs', {
       id: uuid(),
       user_id: getCurrentUser().id,
       filters: JSON.stringify(filters),
       status: 'pending',
       created_at: new Date()
     });

     // Enqueue background job
     await queue.enqueue('export-audit-report', {
       job_id: job.id,
       filters
     });

     return { job_id: job.id };
   }
   ```

2. **Background worker:**
   ```typescript
   queue.process('export-audit-report', async (task) => {
     const { job_id, filters } = task.data;

     // Update job status
     await db.update('export_jobs', job_id, { status: 'processing' });

     try {
       // Generate CSV in batches
       const filePath = `/tmp/export_${job_id}.csv`;
       const stream = fs.createWriteStream(filePath);

       const cursor = db.query(/* ... */).cursor();
       for await (const batch of cursor) {
         stream.write(formatCSV(batch));
       }
       stream.end();

       // Upload to S3
       const url = await s3.upload(filePath);

       // Update job
       await db.update('export_jobs', job_id, {
         status: 'completed',
         download_url: url,
         completed_at: new Date()
       });

       // Notify user
       await sendEmail(task.user_id, {
         subject: 'Audit report ready',
         body: `Your export is ready: ${url}`
       });

     } catch (error) {
       await db.update('export_jobs', job_id, {
         status: 'failed',
         error: error.message
       });
     }
   });
   ```

3. **UI polling:**
   ```tsx
   function AuditExportDialog() {
     const [jobId, setJobId] = useState<string | null>(null);

     const { data: job } = useQuery({
       queryKey: ['export-job', jobId],
       queryFn: () => fetchExportJob(jobId),
       enabled: !!jobId,
       refetchInterval: 2000  // Poll every 2s
     });

     const handleExport = async () => {
       const { job_id } = await exportAuditReportAsync(filters);
       setJobId(job_id);
     };

     return (
       <Dialog>
         {job?.status === 'processing' && (
           <div>
             <Spinner />
             Generating report... This may take a few minutes.
           </div>
         )}

         {job?.status === 'completed' && (
           <div>
             ✅ Report ready!
             <a href={job.download_url} download>Download CSV</a>
           </div>
         )}

         {job?.status === 'failed' && (
           <Alert severity="error">
             Export failed: {job.error}
           </Alert>
         )}
       </Dialog>
     );
   }
   ```

---

## Mobile Experience

### Responsive Design

**Breakpoints:**
- Mobile: <640px (1 column)
- Tablet: 640-1024px (2 columns)
- Desktop: >1024px (3 columns)

**Implementation:**

1. **Timeline (Mobile):**
   ```tsx
   function TimelineViewer({ versions }) {
     const isMobile = useMediaQuery('(max-width: 640px)');

     if (isMobile) {
       return <TimelineList versions={versions} />;  // Vertical list
     }

     return <TimelineChart versions={versions} />;  // D3.js chart
   }
   ```

2. **Snapshot comparison (Mobile):**
   ```
   Mobile Layout (Stacked):

   ┌──────────────────────────────┐
   │ 📸 Mar 31, 2025              │
   ├──────────────────────────────┤
   │ Name:    Chase Checking      │
   │ Balance: $5,432.10           │
   │ Status:  Active              │
   └──────────────────────────────┘

   ┌──────────────────────────────┐
   │ 📸 Jun 30, 2025              │
   ├──────────────────────────────┤
   │ Name:    Chase Checking      │
   │ Balance: $8,901.45           │
   │ Status:  Active              │
   └──────────────────────────────┘

   ┌──────────────────────────────┐
   │ Changes:                     │
   │ ⬆️ Balance +$3,469.35         │
   └──────────────────────────────┘
   ```

3. **Responsive date picker:**
   ```tsx
   function AsOfQueryBuilder() {
     const isMobile = useMediaQuery('(max-width: 640px)');

     return (
       <DatePicker
         mode={isMobile ? 'native' : 'calendar'}
         // Mobile: <input type="date"> (native picker)
         // Desktop: Custom calendar UI
       />
     );
   }
   ```

---

### Touch Gestures

**Implementation:**

1. **Swipe to view timeline:**
   ```tsx
   function EntityCard({ entity }) {
     const { bind } = useSwipeable({
       onSwipedLeft: () => {
         router.push(`/entities/${entity.id}/timeline`);
       }
     });

     return (
       <div {...bind()}>
         {/* Entity details */}
         <span className="text-xs text-gray-500">
           ← Swipe to view timeline
         </span>
       </div>
     );
   }
   ```

2. **Pinch to zoom timeline:**
   ```tsx
   function TimelineChart({ versions }) {
     const [zoom, setZoom] = useState(1);

     const { bind } = usePinch({
       onPinch: ({ offset: [scale] }) => {
         setZoom(Math.max(0.5, Math.min(3, scale)));
       }
     });

     return (
       <svg {...bind()} transform={`scale(${zoom})`}>
         {/* Timeline visualization */}
       </svg>
     );
   }
   ```

---

## References

### Standards & Compliance

1. **Bitemporal Data Model:**
   - Snodgrass, R. T. (1999). *Developing Time-Oriented Database Applications in SQL*. Morgan Kaufmann.
   - Johnston, T. (2014). *Bitemporal Data: Theory and Practice*. Morgan Kaufmann.

2. **Regulatory Requirements:**
   - SOX (Sarbanes-Oxley): 15 U.S.C. § 7241 (audit trail requirements)
   - GDPR: Article 15 (right to access historical data)
   - HIPAA: 45 CFR § 164.312 (audit controls)
   - FDA 21 CFR Part 11: Electronic records audit trails

3. **WCAG 2.1:**
   - W3C Web Accessibility Initiative: https://www.w3.org/WAI/WCAG21/quickref/
   - Contrast ratios: https://www.w3.org/WAI/WCAG21/Understanding/contrast-minimum

### Technical References

1. **PostgreSQL Temporal Queries:**
   - https://www.postgresql.org/docs/current/rangetypes.html
   - https://wiki.postgresql.org/wiki/Temporal_query

2. **D3.js Timeline Visualization:**
   - https://observablehq.com/@d3/zoomable-area-chart
   - https://github.com/d3/d3-time

3. **React Query (Optimistic Updates):**
   - https://tanstack.com/query/latest/docs/react/guides/optimistic-updates

### Design Patterns

1. **Event Sourcing:**
   - Fowler, M. (2005). *Event Sourcing*. https://martinfowler.com/eaaDev/EventSourcing.html

2. **CQRS (Command Query Responsibility Segregation):**
   - Young, G. (2010). *CQRS Documents*. https://cqrs.files.wordpress.com/2010/11/cqrs_documents.pdf

---

**Document Version:** 1.0
**Last Updated:** 2025-02-10
**Author:** Personal OS v1 Design Team
**Word Count:** 15,847 words
**Line Count:** 1,847 lines

---

## Appendix: SQL Schema

```sql
-- Bitemporal entity history table
CREATE TABLE entity_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  entity_id TEXT NOT NULL,
  entity_type TEXT NOT NULL,
  version_id TEXT NOT NULL,

  -- Bitemporal timestamps
  valid_from TIMESTAMPTZ NOT NULL,  -- Valid time (when fact was true)
  valid_to TIMESTAMPTZ NOT NULL DEFAULT '9999-12-31',  -- End of valid period
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),  -- Transaction time (when we knew)

  -- Audit trail
  created_by TEXT NOT NULL,
  reason TEXT,

  -- Entity data (JSONB for flexibility)
  data JSONB NOT NULL,

  -- Metadata
  metadata JSONB,

  -- Indexes
  CONSTRAINT fk_entity FOREIGN KEY (entity_id) REFERENCES entities(id)
);

-- Indexes for fast queries
CREATE INDEX idx_entity_history_id_time
ON entity_history (entity_id, created_at DESC);

CREATE INDEX idx_entity_history_valid_time
ON entity_history (entity_id, valid_from, valid_to);

CREATE INDEX idx_entity_history_created_by
ON entity_history (created_by);

-- As-of query function
CREATE FUNCTION get_as_of_snapshot(
  p_entity_id TEXT,
  p_as_of_date TIMESTAMPTZ
) RETURNS TABLE (
  version_id TEXT,
  valid_from TIMESTAMPTZ,
  valid_to TIMESTAMPTZ,
  created_at TIMESTAMPTZ,
  created_by TEXT,
  reason TEXT,
  data JSONB
) AS $$
BEGIN
  RETURN QUERY
  SELECT
    eh.version_id,
    eh.valid_from,
    eh.valid_to,
    eh.created_at,
    eh.created_by,
    eh.reason,
    eh.data
  FROM entity_history eh
  WHERE eh.entity_id = p_entity_id
    AND eh.created_at <= p_as_of_date
  ORDER BY eh.created_at DESC
  LIMIT 1;
END;
$$ LANGUAGE plpgsql;
```

---

**End of Document**
